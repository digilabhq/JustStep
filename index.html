<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="default" name="apple-mobile-web-app-status-bar-style"/>
<meta content="var(--primary)" name="theme-color"/>
<title>JustStep</title>
<link href="manifest.json" rel="manifest"/>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
        /* Theme Variables */
        :root {
            --primary: #2563eb;
            --primary-light: #93c5fd;
            --primary-dark: #1e40af;
            --primary-darker: #1d4ed8;
            --primary-medium: #3b82f6;
        }

        [data-theme="green"] {
            --primary: #10b981;
            --primary-light: #6ee7b7;
            --primary-dark: #059669;
            --primary-darker: #047857;
            --primary-medium: #10b981;
        }

        [data-theme="pink"] {
            --primary: #ec4899;
            --primary-light: #f9a8d4;
            --primary-dark: #db2777;
            --primary-darker: #be185d;
            --primary-medium: #ec4899;
        }

        [data-theme="purple"] {
            --primary: #8b5cf6;
            --primary-light: #c4b5fd;
            --primary-dark: #7c3aed;
            --primary-darker: #6d28d9;
            --primary-medium: #8b5cf6;
        }

        [data-theme="red"] {
            --primary: #ef4444;
            --primary-light: #fca5a5;
            --primary-dark: #dc2626;
            --primary-darker: #b91c1c;
            --primary-medium: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide number input spinner arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e8e8e8;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: #1a1a1a;
            min-height: 100vh;
            position: relative;
            padding-bottom: 70px;
        }

        /* App Logo Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
            padding: 10px 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            gap: 8px;
            z-index: 101;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
        }

        .app-header-left {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .app-header-right {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-45%);
            display: flex;
            align-items: center;
        }

        .info-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            margin-top: 2px;
        }

        .info-icon:hover {
            border-color: white;
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .app-version {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }

        .app-logo {
            font-size: 24px;
        }

        .app-name {
            font-size: 22px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }

        /* Navigation */
        .nav-container {
            background: #2d2d2d;
            border-bottom: 1px solid #3d3d3d;
            position: sticky;
            top: 56px;
            z-index: 100;
        }

        .nav-tabs {
            display: flex;
        }

        .nav-tabs.first-row {
            border-bottom: 1px solid #3d3d3d;
        }

        .nav-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 500;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .nav-tab.active {
            color: var(--primary-light);
            border-bottom: 2px solid var(--primary);
        }

        .screen {
            display: none;
            padding: 12px;
            animation: fadeIn 0.3s;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Typography */
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.3px;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 14px;
            margin-bottom: 12px;
        }

        /* Daily Logging Screen */
        .date-selector {
            background: #2d2d2d;
            padding: 5px 8px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .date-selector span {
            filter: brightness(1.5) contrast(1.2);
        }

        .date-selector input {
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #e8e8e8;
            color-scheme: dark;
        }

        .activities-container {
            margin-bottom: 12px;
        }

        .activity-card {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 6px;
            position: relative;
            animation: slideIn 0.3s ease;
            transition: all 0.2s;
        }
        
        .activity-card:hover {
            transform: translateX(2px);
            border-left-color: var(--primary-light);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        .activity-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 4px;
        }

        .activity-card-title {
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remove-activity {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .remove-activity:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .activity-type-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            background: #1a1a1a;
            color: #e8e8e8;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color-scheme: dark;
        }

        /* Accordion Styles */
        .activity-accordion {
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            overflow: hidden;
            background: #1a1a1a;
        }

        .accordion-category {
            border-bottom: 1px solid #2d2d2d;
        }

        .accordion-category:last-child {
            border-bottom: none;
        }

        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: transparent;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .accordion-header:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        .accordion-header.active {
            background: rgba(16, 185, 129, 0.05);
        }

        .accordion-title {
            font-size: 13px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .accordion-count {
            font-size: 11px;
            color: #6b7280;
            margin-left: 8px;
            font-weight: 500;
        }

        .accordion-arrow {
            font-size: 12px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
            color: var(--primary-light);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #1a1a1a;
        }

        .accordion-content.active {
            max-height: 500px;
        }

        .accordion-item {
            padding: 10px 14px;
            border-bottom: 1px solid #2d2d2d;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #9ca3af;
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-item:hover {
            background: #2d2d2d;
            color: #e8e8e8;
            padding-left: 18px;
        }

        .accordion-item.selected {
            background: rgba(96, 165, 250, 0.1);
            color: var(--primary-light);
            font-weight: 600;
        }

        /* Sub-Accordion Styles (for nested exercises) */
        .sub-accordion {
            border-bottom: 1px solid #2d2d2d;
        }

        .sub-accordion:last-child {
            border-bottom: none;
        }

        .sub-accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: transparent;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .sub-accordion-header:hover {
            background: #2d2d2d;
            padding-left: 18px;
        }

        .sub-accordion-title {
            font-size: 14px;
            color: #9ca3af;
            font-weight: 500;
        }

        .sub-accordion-arrow {
            font-size: 10px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .sub-accordion-header.active .sub-accordion-arrow {
            transform: rotate(90deg);
        }

        .sub-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #1a1a1a;
        }

        .sub-accordion-content.active {
            max-height: 600px;
        }

        .quick-log-btn {
            width: calc(100% - 28px);
            margin: 8px 14px;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .quick-log-btn:hover {
            background: var(--primary-dark);
        }

        .sub-exercise-divider {
            margin: 8px 14px;
            padding: 4px 0;
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .activity-type-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            background: #2d2d2d;
            color: #e8e8e8;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .activity-type-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .activity-value-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .activity-value-input input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            background: #2d2d2d;
            color: #e8e8e8;
            color-scheme: dark;
        }

        .activity-value-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .activity-value-input .unit {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            min-width: 40px;
        }

        /* Combined Buttons Row */
        .combined-buttons-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .add-activity-button {
            flex: 1;
            padding: 10px;
            background: transparent;
            color: var(--primary-light);
            border: 1px dashed #3d3d3d;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-activity-button:hover {
            background: rgba(16, 185, 129, 0.05);
            border-color: var(--primary-light);
        }

        .add-activity-button:active {
            transform: scale(0.98);
        }

        .log-button {
            flex: 2;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .log-button:active {
            transform: scale(0.98);
            background: var(--primary-darker);
        }

        .workout-confirmed {
            padding: 10px 12px;
            background: #1e3a5f;
            border-radius: 12px;
            color: var(--primary-light);
            font-weight: 600;
            font-size: 14px;
            text-align: center;
        }

        /* Dashboard Screen - Always 3 columns */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        /* Smaller cards on mobile for better fit */
        @media (max-width: 600px) {
            .stats-grid {
                gap: 8px;
            }
            
            .stat-card {
                padding: 5px 3px;
                min-height: 52px;
            }
            
            .stat-value {
                font-size: 15px;
            }
            
            .stat-label {
                font-size: 8px;
            }
        }

        .stat-card {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            padding: 5px 3px;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 60px;
            aspect-ratio: 1.4 / 1;
        }

        /* Gold border for custom/favorite cards */
        .stat-card#custom-card-1,
        .stat-card#custom-card-2,
        .stat-card#custom-card-3 {
            border-left-color: #d4af37;
        }

        .stat-star {
            font-size: 12px;
            margin-bottom: 2px;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #e8e8e8;
            margin-bottom: 3px;
            text-align: center;
            line-height: 1;
        }

        .stat-label {
            font-size: 9px;
            color: #9ca3af;
            text-transform: capitalize;
            letter-spacing: 0.2px;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }

        .stat-trend {
            font-size: 10px;
            margin-top: 2px;
            text-align: center;
        }

        .progress-card {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .progress-percentage {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-light);
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #3d3d3d;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light) 0%, var(--primary) 100%);
            border-radius: 8px;
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #9ca3af;
        }

        .milestone-list {
            margin-top: 12px;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #3d3d3d;
        }

        .milestone-item:last-child {
            border-bottom: none;
        }

        .milestone-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
        }

        .milestone-text {
            font-size: 14px;
            font-weight: 500;
            color: #e8e8e8;
        }

        /* Activity Report (Collapsible) - matches Habit Report style */
        .activity-report-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            font-size: 18px;
            font-weight: 600;
            color: #e8e8e8;
            padding: 4px 0;
        }

        .activity-report-toggle:hover {
            color: var(--primary-light);
        }

        .activity-report-content {
            max-height: 0;
            overflow-y: hidden;
            overflow-x: visible;
            transition: max-height 0.3s ease;
        }

        .activity-report-content.expanded {
            max-height: 2000px;
        }

        .activity-summary-list {
            margin-top: 20px;
            width: 100%;
        }

        /* Calendar View */
        .calendar-header {
            text-align: center;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            color: #9ca3af;
        }

        .calendar-month-year {
            font-size: 20px;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .calendar-day-label {
            text-align: center;
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            padding: 5px 0;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-left: 3px solid #6b7280;
            position: relative;
            cursor: pointer;
            color: #e8e8e8;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            transform: translateX(2px);
            border-left-color: var(--primary-light);
        }

        .calendar-day.has-activity {
            border-left-color: var(--primary);
            background: rgba(30, 58, 95, 0.5);
        }

        .calendar-day.today {
            border-left-color: var(--primary-light);
            font-weight: 700;
        }

        .calendar-day.other-month {
            color: #4b5563;
        }

        .activity-dots {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }

        .activity-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--primary);
        }

        .habit-checks {
            position: absolute;
            top: 3px;
            right: 3px;
            font-size: 7px;
            letter-spacing: -1px;
            line-height: 7px;
            font-weight: 700;
        }

        /* Goals Screen */
        .settings-card {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            padding: 10px 14px;
            transition: all 0.2s;
        }
        
        .pals-profile-card {
            background: var(--card);
            border: 1px solid rgba(255,255,255,0.08);
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            transition: all 0.2s;
        }
        
        .habit-item {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .habit-item:hover {
            transform: translateX(2px);
            border-left-color: var(--primary-light);
        }
        
        .goal-input {
            margin-bottom: 12px;
        }

        .goal-input label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #e8e8e8;
            margin-bottom: 8px;
        }

        .goal-description {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .goal-input input, .goal-input select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            background: #2d2d2d;
            color: #e8e8e8;
            color-scheme: dark;
        }

        /* Theme Selector */
        .theme-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 6px;
            border: 2px solid #3d3d3d;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
        }

        .theme-option:hover {
            background: rgba(255, 255, 255, 0.03);
            border-color: #4b5563;
        }

        .theme-option.active {
            border-color: var(--primary-light);
            background: rgba(96, 165, 250, 0.1);
        }

        .theme-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .theme-option span {
            font-size: 12px;
            font-weight: 500;
            color: #9ca3af;
        }

        .theme-option.active span {
            color: #e8e8e8;
        }

        .save-button {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            letter-spacing: 0.3px;
        }

        .save-button:active {
            transform: scale(0.98);
            background: #333;
        }

        .info-box {
            margin-top: 32px;
            padding: 5px;
            background: #2d2d2d;
            border-radius: 12px;
        }

        .info-box-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .info-box-content {
            font-size: 13px;
            color: #9ca3af;
            line-height: 1.8;
        }

        /* Milestone Notification */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        .milestone-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 320px;
            z-index: 1000;
            display: none;
        }

        .milestone-notification.show {
            display: block;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .milestone-icon-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 40px;
        }

        .milestone-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .milestone-description {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .milestone-close {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .export-button {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            color: #e8e8e8;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            letter-spacing: 0.3px;
        }

        .export-button:active {
            transform: scale(0.98);
            background: #2d2d2d;
        }
        
        .habit-add-button {
            width: 100%;
            padding: 8px 14px;
            background: #2d2d2d;
            color: var(--primary-light);
            border: 1px solid #3d3d3d;
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .habit-add-button:hover {
            background: rgba(16, 185, 129, 0.05);
            border-left-color: var(--primary-light);
        }
        
        .habit-add-button:active {
            transform: scale(0.98);
        }

        .success-message {
            background: #1e3a5f;
            color: var(--primary);
            padding: 5px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            display: none;
            text-align: center;
        }

        .success-message.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .error-message {
            background: #3d1f1f;
            color: #ef4444;
            padding: 5px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            display: none;
            text-align: center;
        }

        .error-message.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Leaderboard Redesign */
        .leaderboard-toggle .toggle-btn.active {
            background: var(--primary-dark) !important;
            color: white !important;
        }

        .leaderboard-toggle .toggle-btn:hover {
            background: #3d3d3d;
        }

        .leaderboard-item-card {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            padding: 8px 10px;
            transition: all 0.2s;
        }
        
        .leaderboard-item-card:hover {
            transform: translateX(2px);
        }

        .leaderboard-item-card.highlight {
            background: rgba(16, 185, 129, 0.08);
        }
        
        /* Medal colors for ranks 1-3 */
        .leaderboard-item-card.rank-1 {
            border-left-color: #fbbf24;
        }
        
        .leaderboard-item-card.rank-1.highlight {
            background: rgba(251, 191, 36, 0.08);
        }
        
        .leaderboard-item-card.rank-1 .leaderboard-rank {
            color: #fbbf24;
        }
        
        .leaderboard-item-card.rank-1 .leaderboard-progress-fill {
            background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
        }
        
        .leaderboard-item-card.rank-2 {
            border-left-color: #9ca3af;
        }
        
        .leaderboard-item-card.rank-2.highlight {
            background: rgba(156, 163, 175, 0.08);
        }
        
        .leaderboard-item-card.rank-2 .leaderboard-rank {
            color: #9ca3af;
        }
        
        .leaderboard-item-card.rank-2 .leaderboard-progress-fill {
            background: linear-gradient(90deg, #d1d5db 0%, #9ca3af 100%);
        }
        
        .leaderboard-item-card.rank-3 {
            border-left-color: #f97316;
        }
        
        .leaderboard-item-card.rank-3.highlight {
            background: rgba(249, 115, 22, 0.08);
        }
        
        .leaderboard-item-card.rank-3 .leaderboard-rank {
            color: #f97316;
        }
        
        .leaderboard-item-card.rank-3 .leaderboard-progress-fill {
            background: linear-gradient(90deg, #fb923c 0%, #f97316 100%);
        }
        
        /* Rank 4+ use primary green */
        .leaderboard-item-card.rank-regular {
            border-left-color: var(--primary);
        }
        
        .leaderboard-item-card.rank-regular.highlight {
            border-left-color: #34d399;
        }
        
        .leaderboard-item-card.rank-regular .leaderboard-progress-fill {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .leaderboard-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .leaderboard-rank {
            font-size: 14px;
            font-weight: 700;
            color: #9ca3af;
            min-width: 18px;
        }

        .leaderboard-name {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: #e8e8e8;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .leaderboard-value {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
        }

        .leaderboard-progress-bar {
            width: 100%;
            height: 3px;
            background: #1a1a1a;
            border-radius: 2px;
            overflow: hidden;
        }

        .leaderboard-progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* PALS Section */
        .pals-section {
            background: #2d2d2d;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .pal-card {
            background: var(--card);
            border-radius: 5px;
            padding: 0;
            margin-bottom: 3px;
            border: 1px solid #3d3d3d;
            border-left: 2px solid var(--primary);
            transition: all 0.2s;
            overflow: hidden;
        }

        .pal-card:hover {
            border-left-color: var(--primary-light);
            background: #333;
            transform: translateX(2px);
        }

        .pal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 5px;
            min-height: 30px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .pal-header:hover {
            background: transparent;
        }

        .pal-expand-icon {
            font-size: 14px;
            color: #6b7280;
            margin-left: 6px;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .pal-card:hover .pal-expand-icon {
            color: var(--primary-light);
            transform: translateX(2px);
        }

        .pal-card.expanded {
            border-left-color: var(--primary-light);
        }

        .pal-card.expanded .pal-expand-icon {
            color: var(--primary-light);
        }

        .pal-name {
            font-size: 13px;
            font-weight: 600;
            color: #e8e8e8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pal-code {
            font-size: 10px;
            color: #6b7280;
            font-weight: 400;
            margin-top: 2px;
        }

        .pal-quick-stats {
            font-size: 10px;
            color: #6b7280;
            white-space: nowrap;
        }

        .pal-divider {
            color: #4b5563;
            font-size: 11px;
            margin: 0 4px;
        }

        .pal-header-info {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pal-stats-expanded {
            display: none;
            padding: 8px;
            background: #1a1a1a;
            border-top: 1px solid #1a1a1a;
        }

        .pal-card.expanded .pal-stats-expanded {
            display: block;
        }

        .pal-id-display {
            font-size: 10px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .pal-activity-report {
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .pal-activity-header {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 12px;
            padding: 4px 0;
            border-bottom: 1px solid #2d2d2d;
            font-weight: 600;
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pal-activity-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 16px;
            padding: 8px 0;
            border-bottom: 1px solid #1a1a1a;
            font-size: 13px;
        }

        .pal-activity-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .pal-activity-col-name {
            color: #9ca3af;
            font-weight: 400;
        }

        .pal-activity-col-value {
            font-weight: 500;
            text-align: right;
            min-width: 60px;
            font-variant-numeric: tabular-nums;
        }

        .pal-activity-header .pal-activity-col-value {
            color: #6b7280;
        }

        .pal-activity-col-value.pal-week {
            color: #34d399;
        }

        .pal-activity-col-value.pal-month {
            color: var(--primary-light);
        }

        .pal-activity-col-value.pal-total {
            color: #e8e8e8;
            font-weight: 600;
        }

        .pal-actions {
            display: flex;
            gap: 8px;
            padding-top: 8px;
        }

        .pal-btn {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #3d3d3d;
            background: transparent;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            color: #9ca3af;
        }

        .pal-btn:hover {
            background: rgba(255, 255, 255, 0.03);
            border-color: #4b5563;
        }

        .pal-btn-remove {
            color: #f87171;
            border-color: #7f1d1d;
        }

        .pal-btn-remove:hover {
            background: rgba(127, 29, 29, 0.1);
            border-color: #991b1b;
        }

        .pal-btn:active {
            transform: scale(0.97);
        }

        .refresh-all-btn {
            width: 100%;
            padding: 10px;
            background: transparent;
            color: var(--primary-light);
            border: 1px solid #2d2d2d;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.15s;
        }

        .refresh-all-btn:hover {
            background: rgba(96, 165, 250, 0.05);
            border-color: #3d3d3d;
        }

        .refresh-all-btn:active {
            transform: scale(0.98);
        }

        .refresh-all-btn:disabled {
            background: transparent;
            color: #4b5563;
            border-color: #2d2d2d;
            cursor: not-allowed;
        }
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 6px;
            border: 1px solid #2d2d2d;
            transition: all 0.15s;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.02);
            border-color: #3d3d3d;
        }

        .leaderboard-rank {
            font-size: 18px;
            font-weight: 500;
            min-width: 28px;
            color: #9ca3af;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-size: 14px;
            font-weight: 500;
            color: #e8e8e8;
            letter-spacing: -0.01em;
        }

        .leaderboard-code {
            font-size: 11px;
            color: #6b7280;
            font-weight: 400;
            margin-top: 2px;
        }

        .leaderboard-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-light);
            font-variant-numeric: tabular-nums;
        }

        /* Day Detail Modal */
        .day-detail-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 360px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .day-detail-modal.show {
            display: block;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .day-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3d3d3d;
        }

        .day-detail-date {
            font-size: 16px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .day-detail-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .day-detail-close:hover {
            background: #3d3d3d;
        }

        .day-activity-list {
            margin-bottom: 12px;
        }

        .day-activity-item {
            background: #1a1a1a;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 2px solid var(--primary);
            transition: all 0.2s;
        }

        .day-activity-item:hover {
            background: #252525;
            border-left-color: var(--primary-light);
        }

        .day-activity-info {
            flex: 1;
            min-width: 0;
        }

        .day-activity-type {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 1px;
            text-transform: capitalize;
            color: #e8e8e8;
            background: none !important;
            line-height: 1.2;
        }

        .day-activity-value {
            font-size: 11px;
            color: #9ca3af;
            line-height: 1.2;
        }

        .day-activity-delete {
            background: transparent;
            color: #ef4444;
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .day-activity-delete:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .day-totals {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            padding: 10px 12px;
            border-radius: 6px;
            margin-top: 12px;
        }

        .day-totals-title {
            font-size: 10px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }

        .day-totals-content {
            font-size: 11px;
            color: white;
            line-height: 1.4;
        }

        .empty-day {
            text-align: center;
            padding: 24px 12px;
            color: #6b7280;
        }

        .empty-day-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-day-text {
            font-size: 14px;
        }

        .calendar-hint {
            text-align: center;
            margin-top: 12px;
            margin-bottom: 12px;
            padding: 5px;
            background: #1e3a5f;
            border-radius: 12px;
            font-size: 13px;
            color: var(--primary-light);
            font-weight: 500;
        }

        /* Stats Toggle */
        .stats-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            background: #2d2d2d;
            padding: 3px;
            border-radius: 12px;
            border: 2px solid #3d3d3d;
        }

        .stats-toggle-btn {
            flex: 1;
            padding: 6px 12px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .stats-toggle-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Welcome Modal */
        .welcome-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .welcome-modal.show {
            display: block;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .welcome-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
            margin: -20px -16px 16px -16px;
            padding: 16px;
            border-radius: 20px 20px 0 0;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 0;
            letter-spacing: -0.5px;
        }

        .welcome-quote {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-light);
            margin: 16px 0;
            font-style: italic;
            line-height: 1.4;
        }

        .welcome-content {
            font-size: 15px;
            color: #d1d5db;
            line-height: 1.8;
            margin: 20px 0;
        }

        .welcome-highlight {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-light);
            margin: 20px 0;
            line-height: 1.6;
        }

        .welcome-tagline {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            margin: 16px 0 24px 0;
            letter-spacing: 0.5px;
        }

        .welcome-video-link {
            display: inline-block;
            color: var(--primary-light);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            transition: color 0.2s;
        }

        .welcome-video-link:hover {
            color: var(--primary-medium);
        }

        .welcome-button {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-darker) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .welcome-button:active {
            transform: scale(0.98);
        }

        /* Customize Dashboard Button */
        .customize-dashboard-btn {
            display: block;
            margin: -20px auto 0;
            background: none;
            border: none;
            color: #d4af37;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 16px;
            transition: color 0.2s;
            text-align: center;
        }

        .customize-dashboard-btn:hover {
            color: #c9a332;
        }

        /* Customize Modal */
        .customize-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            z-index: 1500;
            display: none;
        }

        .customize-modal.show {
            display: block;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .customize-modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #e8e8e8;
        }

        .customize-slot {
            margin-bottom: 12px;
        }

        .customize-slot-label {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 8px;
            display: block;
        }

        .customize-slot select {
            width: 100%;
            padding: 12px;
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 400;
            background: #2d2d2d;
            color: #e8e8e8;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .customize-slot select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .customize-slot select optgroup {
            color: #9ca3af;
            font-weight: 600;
            font-size: 12px;
            background: #1a1a1a;
        }
        
        .customize-slot select option {
            color: #e8e8e8;
            padding: 8px;
            background: #2d2d2d;
        }

        .customize-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .customize-modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .customize-modal-btn.save {
            background: var(--primary);
            color: white;
        }

        .customize-modal-btn.save:active {
            transform: scale(0.98);
            background: var(--primary-darker);
        }

        .customize-modal-btn.cancel {
            background: #3d3d3d;
            color: #e8e8e8;
        }

        .customize-modal-btn.cancel:active {
            transform: scale(0.98);
            background: #4d4d4d;
        }

        /* Weight Input Styles */
        .weight-input-section {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .weight-input-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .weight-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .weight-input-field {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #3d3d3d;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            background: #1a1a1a;
            color: #e8e8e8;
        }

        .weight-input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .weight-unit-label {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            min-width: 35px;
        }

        .weight-save-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-save-btn:active {
            transform: scale(0.98);
            background: var(--primary-darker);
        }

        .weight-save-btn-subtle {
            padding: 8px 16px;
            background: transparent;
            color: var(--primary-light);
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
            width: 100%;
        }

        .weight-save-btn-subtle:hover {
            background: #1e3a5f;
            border-color: var(--primary-light);
        }

        .weight-save-btn-subtle:active {
            transform: scale(0.98);
        }
        
        /* Weight Info Icon */
        .weight-info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }
        
        .weight-info-icon:hover {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary);
            border-color: var(--primary);
            transform: scale(1.1);
        }
        
        /* Weight Info Modal */
        .weight-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .weight-info-modal.active {
            display: flex;
        }
        
        .weight-info-content {
            background: #2d2d2d;
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            animation: slideUp 0.2s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .weight-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .weight-info-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .weight-info-close {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .weight-info-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .weight-info-list {
            list-style: none;
            padding: 0;
            margin: 0 0 16px 0;
        }
        
        .weight-info-list li {
            padding: 8px 0 8px 24px;
            position: relative;
            font-size: 14px;
            line-height: 1.6;
            color: #e8e8e8;
        }
        
        .weight-info-list li:before {
            content: "";
            position: absolute;
            left: 8px;
            color: var(--primary);
            font-weight: 700;
        }
        
        .weight-info-highlight {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            color: var(--primary);
            font-weight: 600;
        }
        
        /* Habit Info Icon & Modal (reuse weight info styles) */
        .habit-info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }
        
        .habit-info-icon:hover {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary);
            border-color: var(--primary);
            transform: scale(1.1);
        }
        
        .habit-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .habit-info-modal.active {
            display: flex;
        }
        
        .habit-info-content {
            background: #2d2d2d;
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            animation: slideUp 0.2s ease;
        }
        
        .habit-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .habit-info-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .habit-info-close {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .habit-info-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .habit-info-list {
            list-style: none;
            padding: 0;
            margin: 0 0 16px 0;
        }
        
        .habit-info-list li {
            padding: 8px 0 8px 24px;
            position: relative;
            font-size: 14px;
            line-height: 1.6;
            color: #e8e8e8;
        }
        
        .habit-info-list li:before {
            content: "";
            position: absolute;
            left: 8px;
            color: var(--primary);
            font-weight: 700;
        }
        
        .habit-info-highlight {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            color: var(--primary);
            font-weight: 600;
        }


        /* Trending Indicators */
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
        }

        .trend-indicator.up {
            color: #10b981;
        }

        .trend-indicator.down {
            color: #ef4444;
        }

        .trend-indicator.stable {
            color: #6b7280;
        }

        /* Bar Graph Comparison Styles */
        .comparison-section {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .comparison-header {
            font-size: 15px;
            font-weight: 700;
            color: #e8e8e8;
            margin-bottom: 12px;
            letter-spacing: -0.3px;
        }

        .comparison-graph {
            margin-bottom: 12px;
        }

        .comparison-graph:last-child {
            margin-bottom: 0;
        }

        .comparison-title {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .bar-label {
            font-size: 13px;
            font-weight: 600;
            color: #9ca3af;
            min-width: 80px;
        }

        .bar-container {
            flex: 1;
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .bar-fill.current-period {
            background: linear-gradient(90deg, var(--primary-light) 0%, var(--primary) 100%);
        }

        .bar-fill.previous-period {
            background: linear-gradient(90deg, #6b7280 0%, #9ca3af 100%);
        }

        .bar-value {
            font-size: 12px;
            font-weight: 700;
            color: #e8e8e8;
            width: 100px;
            text-align: right;
            flex-shrink: 0;
        }

        /* Number Count-Up Animation */
        .stat-card-value {
            animation: countUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Weight History Expandable Section */
        .weight-history-toggle {
            font-size: 12px;
            color: var(--primary-light);
            cursor: pointer;
            margin-top: 6px;
            text-align: center;
            font-weight: 600;
            user-select: none;
        }

        .weight-history-toggle:hover {
            color: var(--primary-medium);
        }

        .weight-history-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0;
        }

        .weight-history-list.expanded {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
            border-top: 1px solid #3d3d3d;
            padding-top: 12px;
        }

        .weight-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #2d2d2d;
            font-size: 13px;
        }

        .weight-entry:last-child {
            border-bottom: none;
        }

        .weight-entry-date {
            color: #9ca3af;
            font-weight: 600;
            min-width: 80px;
        }

        .weight-entry-value {
            color: #e8e8e8;
            font-weight: 700;
            flex: 1;
            text-align: center;
        }

        .weight-entry-actions {
            display: flex;
            gap: 6px;
        }

        .weight-entry-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-entry-edit {
            background: #1e3a5f;
            color: var(--primary-light);
        }

        .weight-entry-edit:hover {
            background: #2d5a8f;
        }

        .weight-entry-delete {
            background: #3d1f1f;
            color: #ef4444;
        }

        .weight-entry-delete:hover {
            background: #4d2626;
        }
        
        /* Weekly Report Modal */
        .weekly-report-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .weekly-report-modal.active {
            display: flex;
        }
        
        .weekly-report-container {
            background: var(--bg);
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            border-radius: 12px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            animation: slideUp 0.3s ease;
        }
        
        
        .weekly-report-body {
            flex: 1 1 auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
                    min-height: 0;
        }

        .weekly-report-footer {
            flex: 0 0 auto;
        }
.weekly-report-header {
            background: var(--bg-elevated);
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .weekly-report-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .weekly-report-date {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-light);
            letter-spacing: 1px;
        }
        
        

        .weekly-report-nav-btn {
            background: none;
            border: none;
            color: var(--primary-light);
            font-size: 16px;
            padding: 4px 6px;
            cursor: pointer;
            line-height: 1;
        }

        .weekly-report-nav-btn:disabled {
            color: #6b7280;
            opacity: 0.6;
            cursor: default;
        }
.weekly-report-chart-section {
            background: var(--bg);
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .weekly-report-chart-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-transform: uppercase;
            text-align: center;
        }
        
        .weekly-report-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100px;
            margin-bottom: 12px;
            padding: 0 20px;
            gap: 8px;
        }
        
        .weekly-report-chart-bar-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 100%;
        }
        
        .weekly-report-chart-bar {
            width: 4px;
            background: linear-gradient(180deg, var(--primary-light) 0%, var(--primary) 100%);
            border-radius: 4px 4px 0 0;
            min-height: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        
        .weekly-report-chart-labels {
            display: flex;
            justify-content: space-around;
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 600;
            padding: 0 20px;
            gap: 8px;
        }
        
        .weekly-report-chart-labels span {
            flex: 1;
            text-align: center;
        }
        
        .weekly-report-stats-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border);
        }
        
        .weekly-report-stat-column {
            background: var(--bg);
            padding: 24px 20px;
        }
        
        .weekly-report-stat-column-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            letter-spacing: 2px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            text-transform: uppercase;
        }
        
        .weekly-report-stat-item {
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto;
            gap: 12px;
            margin-bottom: 10px;
            font-size: 13px;
            align-items: baseline;
        }
        
        .weekly-report-stat-label {
            color: var(--text-secondary);
            text-align: left;
            min-width: 0;
            /* Allow full names to display (wrap instead of truncating) */
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            word-break: break-word;
        }
        
        .weekly-report-stat-value {
            color: var(--primary-light);
            font-weight: 700;
            text-align: right;
            white-space: nowrap;
            display: flex;
            align-items: baseline;
            justify-content: flex-end;
            gap: 6px;
            font-size: 9px;
        }
        
        
        .weekly-report-stat-comp {
            font-size: 0.75em;
            margin-left: 0;
            line-height: 1;
            white-space: nowrap;
        }
.weekly-report-actions {
            background: var(--bg-elevated);
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            position: sticky;
            bottom: 0;
        }
        
        .weekly-report-action-btn {
            flex: 1;
            padding: 12px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.5em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .weekly-report-action-btn:hover {
            background: #4d4d4d;
            border-color: #5d5d5d;
        }
        
        .weekly-report-action-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .weekly-report-action-btn.primary:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
<div class="app-container">
<!-- App Header -->
<div class="app-header">
<div class="app-header-left">
<span class="app-name">JustStep</span>
</div>
<div class="app-header-right">
<div class="info-icon" onclick="app.showWelcome()" title="About JustStep">i</div>

</div>
</div>
<!-- Navigation -->
<div class="nav-container">
<div class="nav-tabs first-row">
<button class="nav-tab active" onclick="app.showScreen('log')">Tracker</button>
<button class="nav-tab" onclick="app.showScreen('dashboard')">Dashboard</button>
<button class="nav-tab" onclick="app.showScreen('calendar')">Calendar</button>
</div>
<div class="nav-tabs">
<button class="nav-tab" onclick="app.showScreen('goals')">Goals</button>
<button class="nav-tab" onclick="app.showScreen('pals')">Pals</button>
<button class="nav-tab" onclick="app.showScreen('leaderboard')">Leaderboard</button>
</div>
</div>
<!-- Daily Logging Screen -->
<div class="screen active" id="log-screen">
<h1 style="display: flex; align-items: center; gap: 8px;">Track Activity <span class="info-icon" onclick="app.showTrackInfo()" title="How to track activities">i</span></h1>
<p class="subtitle">Record today's workout</p>
<div class="date-selector">
<span></span>
<input id="log-date" type="date" value=""/>
</div>
<div class="activities-container" id="activities-container">
<!-- Activity cards will be added here -->
</div>
<div class="combined-buttons-row">
<button class="add-activity-button" onclick="app.addActivityRow()">
<span style="font-size: 18px; margin-right: 6px;">+</span>
                Add
            </button>
<button class="log-button" onclick="app.saveLog()">Save Activity</button>
</div>
<!-- Weight Input Section -->
<div class="weight-input-section">
<div class="weight-input-header">
Track Weight
<span class="info-icon" onclick="app.toggleWeightInfoModal()" title="Weight tracking tips" style="margin-left: 6px; transform: scale(0.7);">i</span>
</div>
<div class="weight-input-row">
<input class="weight-input-field" id="weight-input" inputmode="decimal" min="0" placeholder="Enter weight" step="0.1" type="number"/>
<span class="weight-unit-label" id="weight-unit-display">lbs</span>
<button class="weight-save-btn" onclick="app.logWeight()">Save</button>
</div>
</div>
<!-- Weight Info Modal -->
<div class="weight-info-modal" id="weight-info-modal" onclick="if(event.target === this) app.toggleWeightInfoModal()">
<div class="weight-info-content">
<div class="weight-info-header">
<div class="weight-info-title">
<span></span>
Weight Tracking Tips
</div>
<button class="weight-info-close" onclick="app.toggleWeightInfoModal()"></button>
</div>
<ul class="weight-info-list">
<li>Weigh yourself weekly, not daily</li>
<li>Fridays work great for consistency</li>
<li>Same time each week (morning is best)</li>
<li>Daily weight fluctuates 2-5 lbs naturally</li>
</ul>
<div class="weight-info-highlight">
Weekly tracking shows real progress!
</div>
</div>
</div>
</div>
<!-- Track Activity Info Modal -->
<div class="weight-info-modal" id="track-info-modal" onclick="if(event.target === this) app.closeInfoModal('track-info-modal')">
<div class="weight-info-content">
<div class="weight-info-header">
<div class="weight-info-title">
<span></span>
Track Activity
</div>
<button class="weight-info-close" onclick="app.closeInfoModal('track-info-modal')"></button>
</div>
<div class="weight-info-list" style="padding: 16px; line-height: 1.8;">
<strong style="color: #60a5fa;">Two ways to log workouts:</strong><br><br>
 <strong>QUICK LOG:</strong> Log "Arm Day" without tracking individual exercises<br><br>
 <strong>DETAILED LOG:</strong> Track specific exercises with reps (e.g., Bicep Curls: 20 reps)<br><br>
<div class="weight-info-highlight">
Choose what works for your tracking style!
</div>
</div>
</div>
</div>

<!-- Dashboard Info Modal -->
<div class="weight-info-modal" id="dashboard-info-modal" onclick="if(event.target === this) app.closeInfoModal('dashboard-info-modal')">
<div class="weight-info-content">
<div class="weight-info-header">
<div class="weight-info-title">
<span></span>
Dashboard
</div>
<button class="weight-info-close" onclick="app.closeInfoModal('dashboard-info-modal')"></button>
</div>
<div class="weight-info-list" style="padding: 16px; line-height: 1.8;">
<strong style="color: #60a5fa;">Top Cards:</strong><br><br>
 <strong>Distance:</strong> Total distance from all cardio<br><br>
 <strong>Strength Days:</strong> Days with 2+ exercises logged<br><br>
 <strong>Steps:</strong> Total steps tracked<br><br>
<strong style="color: #60a5fa;">View Modes:</strong><br><br>
 <strong>This Week:</strong> (Sun-Today)<br><br>
 <strong>All Time:</strong> (Total)<br><br>
<div class="weight-info-highlight">
Toggle to see weekly or lifetime stats!
</div>
</div>
</div>
</div>

<!-- Goals Info Modal -->
<div class="weight-info-modal" id="goals-info-modal" onclick="if(event.target === this) app.closeInfoModal('goals-info-modal')">
<div class="weight-info-content">
<div class="weight-info-header">
<div class="weight-info-title">
<span></span>
Important Reminder
</div>
<button class="weight-info-close" onclick="app.closeInfoModal('goals-info-modal')"></button>
</div>
<div class="weight-info-list" style="padding: 16px; line-height: 1.8;">
<div class="weight-info-highlight" style="margin-bottom: 0;">
Always click "Save Settings" after making changes or adding categories/habits!
</div>
</div>
</div>
</div>

<!-- Leaderboard Info Modal -->
<div class="weight-info-modal" id="leaderboard-info-modal" onclick="if(event.target === this) app.closeInfoModal('leaderboard-info-modal')">
<div class="weight-info-content">
<div class="weight-info-header">
<div class="weight-info-title">
<span></span>
Leaderboard
</div>
<button class="weight-info-close" onclick="app.closeInfoModal('leaderboard-info-modal')"></button>
</div>
<div class="weight-info-list" style="padding: 16px; line-height: 1.8;">
<strong style="color: #60a5fa;">How rankings work:</strong><br><br>
 <strong>STEPS:</strong> Total steps in last 7 days<br><br>
 <strong>DISTANCE:</strong> Total miles/km from all cardio activities in last 7 days<br><br>
 <strong>WEIGHT:</strong> Weight change (% and lbs) based on selected period (Week/Month/Total)<br><br>
<strong style="color: #60a5fa;">Activity indicators:</strong><br><br>
 Updated within 16 hours<br>
 Updated 16-32 hours ago<br>
 Updated 32+ hours ago<br><br>
<div class="weight-info-highlight">
Rankings update daily. Add PALs to compete with friends!
</div>
</div>
</div>
</div>

<!-- Weekly Report Modal -->
<div class="weekly-report-modal" id="weekly-report-modal" onclick="if(event.target === this) app.closeWeeklyReport()">
    <div class="weekly-report-container" id="weekly-report-content">
        <!-- Content will be dynamically generated -->
    </div>
</div>

<!-- Dashboard Screen -->
<div class="screen" id="dashboard-screen">
<h1 style="display: flex; align-items: center; gap: 8px;">Dashboard <span class="info-icon" onclick="app.showDashboardInfo()" title="Dashboard explained">i</span></h1>
<p class="subtitle">Your progress overview</p>
<div class="stats-toggle">
<button class="stats-toggle-btn active" onclick="app.setStatsView('week')">This Week</button>
<button class="stats-toggle-btn" onclick="app.setStatsView('total')">All Time</button>
</div>
<div class="stats-grid">
<!-- Row 1: Fixed Cards -->
<div class="stat-card">
<div class="stat-value" id="stat-miles">0</div>
<div class="stat-label" id="stat-miles-label">Miles</div>
<div class="stat-trend" id="stat-miles-trend"></div>
</div>
<div class="stat-card">
<div class="stat-value" id="stat-workouts">0</div>
<div class="stat-label" id="stat-workouts-label">Strength Days</div>
<div class="stat-trend" id="stat-workouts-trend"></div>
</div>
<div class="stat-card">
<div class="stat-value" id="stat-steps">0</div>
<div class="stat-label" id="stat-steps-label">Steps</div>
<div class="stat-trend" id="stat-steps-trend"></div>
</div>
<!-- Row 2: Custom Cards (dynamically rendered) -->
<div class="stat-card" id="custom-card-1">
<div class="stat-value" id="custom-stat-1">0</div>
<div class="stat-label" id="custom-label-1">Push-ups</div>
<div class="stat-trend" id="custom-trend-1"></div>
</div>
<div class="stat-card" id="custom-card-2">
<div class="stat-value" id="custom-stat-2">0</div>
<div class="stat-label" id="custom-label-2">Pull-ups</div>
<div class="stat-trend" id="custom-trend-2"></div>
</div>
<div class="stat-card" id="custom-card-3">
<div class="stat-value" id="custom-stat-3">0</div>
<div class="stat-label" id="custom-label-3">Ab Wheel Rollout</div>
<div class="stat-trend" id="custom-trend-3"></div>
</div>
</div>
<div style="display: flex; gap: 12px; margin-bottom: 20px;">
    <button class="customize-dashboard-btn" onclick="app.openCustomizeModal()" style="flex: 1; margin: 0; background: #2d2d2d; border: 1px solid #3d3d3d; border-radius: 8px; padding: 12px 16px; color: #d4af37;">Customize Favorites</button>
    <button class="customize-dashboard-btn" onclick="app.showWeeklyReport()" style="flex: 1; margin: 0; background: var(--primary); border: 1px solid var(--primary); border-radius: 8px; padding: 12px 16px; color: white;">Weekly Report</button>
</div>
<!-- Comparison Bar Graphs -->
<div class="comparison-section">
<div class="comparison-header">Progress Comparison</div>
<div class="comparison-graph">
<div class="comparison-title">This Week vs Last Week</div>
<div class="bar-row">
<div class="bar-label">This Week</div>
<div class="bar-container">
<div class="bar-fill current-period" id="week-current-bar" style="width: 0%"></div>
</div>
<div class="bar-value" id="week-current-value">0</div>
</div>
<div class="bar-row">
<div class="bar-label">Last Week</div>
<div class="bar-container">
<div class="bar-fill previous-period" id="week-previous-bar" style="width: 0%"></div>
</div>
<div class="bar-value" id="week-previous-value">0</div>
</div>
</div>
<div class="comparison-graph">
<div class="comparison-title">This Month vs Last Month</div>
<div class="bar-row">
<div class="bar-label">This Month</div>
<div class="bar-container">
<div class="bar-fill current-period" id="month-current-bar" style="width: 0%"></div>
</div>
<div class="bar-value" id="month-current-value">0</div>
</div>
<div class="bar-row">
<div class="bar-label">Last Month</div>
<div class="bar-container">
<div class="bar-fill previous-period" id="month-previous-bar" style="width: 0%"></div>
</div>
<div class="bar-value" id="month-previous-value">0</div>
</div>
</div>
</div>
<!-- Weight Summary (if weight data exists) -->
<div class="progress-card" id="weight-summary-card" style="display: none;">
<div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 0;">
<span class="progress-title" style="margin: 0;">Weight</span>
<div style="display: flex; align-items: baseline; gap: 6px;">
<div id="weight-display-value" style="font-size: 32px; font-weight: 700; color: #e8e8e8;">--</div>
<div id="weight-display-unit" style="font-size: 14px; color: #9ca3af;">lbs</div>
<div id="weight-trend-indicator"></div>
</div>
</div>
<!-- Weight History Toggle -->
<div class="weight-history-toggle" id="weight-history-toggle" onclick="app.toggleWeightHistory()">
                    View History 
                </div>
<!-- Weight History List (expandable) -->
<div class="weight-history-list" id="weight-history-list">
<!-- Populated dynamically -->
</div>
</div>
<div class="progress-card">
<div class="progress-header">
<span class="progress-title">Annual Goal</span>
<span class="progress-percentage" id="annual-progress-percent">0%</span>
</div>
<div class="progress-bar-bg">
<div class="progress-bar-fill" id="annual-progress-bar" style="width: 0%"></div>
</div>
<div class="progress-details">
<span id="annual-progress-current">0</span>
<span id="annual-progress-goal">420</span>
</div>
</div>
</div>
<!-- Calendar Screen -->
<div class="screen" id="calendar-screen">
<div class="calendar-header">
<button class="calendar-nav" onclick="app.changeMonth(-1)"></button>
<div class="calendar-month-year" id="calendar-month-year">January 2026</div>
<button class="calendar-nav" onclick="app.changeMonth(1)"></button>
</div>
<div class="calendar-grid" id="calendar-grid">
<!-- Calendar will be generated here -->
</div>
<div class="calendar-hint">
                 Tap any day to see details
            </div>
<!-- Activity Report (Collapsible) -->
<div class="progress-card">
<div class="activity-report-toggle" id="activity-report-toggle" onclick="app.toggleActivityReport()">
<span>Activity Report</span>
<span></span>
</div>
<div class="activity-report-content" id="activity-report-content">
<div class="activity-summary-list" id="activity-summary-list">
<p style="text-align: center; color: #6b7280; font-size: 14px;">No activities logged yet.</p>
</div>
</div>
</div>
<!-- Habit Report (Collapsible) -->
<div class="progress-card">
<div class="activity-report-toggle" id="habit-report-toggle" onclick="app.toggleHabitReport()">
<span>Habit Report</span>
<span></span>
</div>
<div class="activity-report-content" id="habit-report-content">
<div class="activity-summary-list" id="habit-summary-list">
<p style="text-align: center; color: #6b7280; font-size: 14px;">No habits created yet.</p>
</div>
</div>
</div>
<h2>Recent Milestones</h2>
<div class="progress-card">
<div class="milestone-list" id="milestone-list">
<p style="text-align: center; color: #6b7280; font-size: 14px;">No milestones yet. Keep going!</p>
</div>
</div>
</div>
<!-- Goals Screen -->
<div class="screen" id="goals-screen">
<h1 style="display: flex; align-items: center; gap: 8px;">Goals <span class="info-icon" onclick="app.showGoalsInfo()" title="Important reminder">i</span></h1>
<p class="subtitle">Customize your goals and preferences</p>
<!-- Slim compact sections -->
<div style="display: flex; flex-direction: column; gap: 12px;">
<!-- Unit Preference - Inline -->
<div class="settings-card">
<div style="display: flex; justify-content: space-between; align-items: center;">
<label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Unit Preference</label>
<select id="unit-preference" style="width: 220px; padding: 6px 10px; border: 1px solid #3d3d3d; border-radius: 6px; font-size: 13px; font-weight: 600; background: #1a1a1a; color: #e8e8e8;">
<option value="miles">Miles</option>
<option value="km">Kilometers</option>
</select>
</div>
</div>
<!-- Initial Weight - Inline -->
<div class="settings-card">
<div style="display: flex; justify-content: space-between; align-items: center;">
<label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Initial Weight</label>
<div style="width: 220px; display: flex; align-items: center; gap: 0; padding: 6px 10px; border: 2px solid #3d3d3d; border-radius: 6px; background: #1a1a1a;">
<input id="initial-weight-preference" inputmode="decimal" placeholder="Enter initial weight" style="flex: 1; min-width: 0; border: none; outline: none; padding: 0; background: transparent; color: #e8e8e8; font-size: 13px; font-weight: 600;" type="number"/>
<span style="margin-left: 8px; font-size: 12px; color: #9ca3af; font-weight: 600;">lbs</span>
</div>
</div>
</div>
<!-- App Theme - Compact -->
<div class="settings-card">
<label style="font-size: 14px; font-weight: 600; color: #e8e8e8; display: block; margin-bottom: 8px;">App Theme</label>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
<button onclick="app.openThemeColorPicker()" style="padding: 8px 12px; background: #1a1a1a; color: #e8e8e8; border: 1px solid #3d3d3d; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
<span style="width: 16px; height: 16px; border-radius: 50%; background: var(--primary-dark); display: inline-block;"></span>
                            Choose
                        </button>
<button onclick="app.resetThemeToDefault()" style="padding: 8px 12px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Reset
                        </button>
</div>
</div>
<!-- Weekly Strength Days Target - Inline -->
<div class="settings-card">
<div style="display: flex; justify-content: space-between; align-items: center;">
<label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Weekly Strength Days Target</label>
<input id="workout-frequency" inputmode="numeric" placeholder="5" style="width: 80px; padding: 6px 10px; border: 1px solid #3d3d3d; border-radius: 6px; font-size: 13px; font-weight: 600; background: #1a1a1a; color: #e8e8e8; text-align: center;" type="number" value="5"/>
</div>
</div>
<!-- Monthly Mileage Target - Inline -->
<div class="settings-card">
<div style="display: flex; justify-content: space-between; align-items: center;">
<label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Monthly Mileage Target</label>
<input id="monthly-goal" inputmode="numeric" placeholder="35" style="width: 80px; padding: 6px 10px; border: 1px solid #3d3d3d; border-radius: 6px; font-size: 13px; font-weight: 600; background: #1a1a1a; color: #e8e8e8; text-align: center;" type="number" value="35"/>
</div>
</div>
<!-- Annual Mileage Target - Inline -->
<div class="settings-card">
<div style="display: flex; justify-content: space-between; align-items: center;">
<label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Annual Mileage Target</label>
<input id="annual-goal" inputmode="numeric" placeholder="420" style="width: 80px; padding: 6px 10px; border: 1px solid #3d3d3d; border-radius: 6px; font-size: 13px; font-weight: 600; background: #1a1a1a; color: #e8e8e8; text-align: center;" type="number" value="420"/>
</div>
</div>
</div>
<!-- Elegant divider line like monthly days section -->
<div style="margin: 12px 0; border-top: 1px solid #3d3d3d;"></div>
<!-- Make it a Habit Section -->
<div>
<div style="margin-bottom: 12px;">
<label style="font-size: 14px; font-weight: 600; color: #e8e8e8; display: flex; align-items: center; gap: 6px; margin-bottom: 0;">
Make it a Habit (Private)
<span class="info-icon" onclick="app.toggleHabitInfoModal()" title="How habits work" style="transform: scale(0.7);">i</span>
</label>
</div>
<div id="habits-list" style="display: flex; flex-direction: column; gap: 6px;">
<!-- Habits will be rendered here -->
</div>
<button class="habit-add-button" id="add-habit-btn" onclick="app.addHabit()">+ Add Habit</button>
</div>
<!-- Habit Info Modal -->
<div class="habit-info-modal" id="habit-info-modal" onclick="if(event.target === this) app.toggleHabitInfoModal()">
<div class="habit-info-content">
<div class="habit-info-header">
<div class="habit-info-title">
<span></span>
Daily Habits
</div>
<button class="habit-info-close" onclick="app.toggleHabitInfoModal()"></button>
</div>
<ul class="habit-info-list">
<li>Track up to 3 habits</li>
<li>Private - not shared with anyone</li>
<li>Check off in Calendar tab each day</li>
<li>Build consistency one day at a time!</li>
</ul>
<div class="habit-info-highlight">
View your progress in the Habit Report!
</div>
</div>
</div>
<!-- Elegant divider line -->
<div style="margin: 12px 0; border-top: 1px solid #3d3d3d;"></div>
<!-- Custom Activity Categories Section -->
<div>
<div style="margin-bottom: 12px;">
<label style="font-size: 14px; font-weight: 600; color: #e8e8e8; display: flex; align-items: center; gap: 6px; margin-bottom: 0;">
Custom Activity Categories
<span class="info-icon" onclick="app.toggleCustomCategoryInfoModal()" title="How custom categories work" style="transform: scale(0.7);">i</span>
</label>
</div>
<div id="custom-categories-list" style="display: flex; flex-direction: column; gap: 6px;">
<!-- Custom categories will be rendered here -->
</div>
<button class="habit-add-button" id="add-custom-category-btn" onclick="app.addCustomCategory()">+ Add Custom Category</button>
</div>
<!-- Custom Category Info Modal -->
<div class="habit-info-modal" id="custom-category-info-modal" onclick="if(event.target === this) app.toggleCustomCategoryInfoModal()">
<div class="habit-info-content">
<div class="habit-info-header">
<div class="habit-info-title">
Custom Categories
</div>
<button class="habit-info-close" onclick="app.toggleCustomCategoryInfoModal()"></button>
</div>
<ul class="habit-info-list">
<li>Create up to 3 custom categories</li>
<li>Add up to 5 exercises per category</li>
<li>Track with Reps, Distance, or Log Day</li>
<li>Use in Favorite Stats cards</li>
<li>Not shared with PALs</li>
</ul>
<div class="habit-info-highlight">
Perfect for unique exercises not in our list!
</div>
</div>
</div>
<!-- Elegant divider line -->
<div style="margin: 12px 0; border-top: 1px solid #3d3d3d;"></div>
<!-- Save Settings -->
<div class="settings-card" style="margin-top: 12px; text-align: center;">
<button class="save-button" onclick="app.saveGoals()" style="margin: 0;">Save Settings</button>
<div class="success-message" id="settings-success" style="margin-top: 8px;">Settings saved successfully!</div>
</div>
<!-- Elegant divider line -->
<div style="margin: 12px 0; border-top: 1px solid #3d3d3d;"></div>
<!-- Data Import/Export -->
<div style="display: flex; flex-direction: column; gap: 8px;">
<input accept=".json" id="import-file-input" onchange="app.handleImportFile(event)" style="display: none;" type="file"/>
<button class="export-button" onclick="document.getElementById('import-file-input').click()" style="padding: 8px 14px; font-size: 13px;">Import Data</button>
<button class="export-button" onclick="app.exportData()" style="padding: 8px 14px; font-size: 13px;">Export All Data</button>
</div>
<div class="success-message" id="import-success">Data imported successfully!</div>
</div>
<!-- PALS Screen -->
<div class="screen" id="pals-screen">
<h1>Pals</h1>
<p class="subtitle">Share your fitness journey with friends</p>
<!-- MY PROFILE Section - Slim Design -->
<div class="pals-section">
<h2 style="font-size: 14px; margin-bottom: 8px; color: var(--primary-light); font-weight: 600;">MY PROFILE</h2>
<!-- PAL Code Row -->
<div class="pals-profile-card">
<div style="display: flex; align-items: center; gap: 8px;">
<div style="flex: 1; min-width: 0;">
<div style="font-size: 12px; color: var(--text); margin-bottom: 4px; font-weight: 600;">PAL Code</div>
<div id="display-pal-code" style="font-size: 12px; color: rgba(255,255,255,0.75); font-weight: 500;">
                                Not set
                            </div>
</div>
<button id="pal-code-btn" onclick="app.handlePalCodeButton()" style="width: 55px; height: 32px; flex-shrink: 0; background: var(--primary-dark); color: white; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                            Set Code
                        </button>
</div>
</div>
<!-- Display Name Row -->
<div class="pals-profile-card">
<div style="display: flex; align-items: center; gap: 8px;">
<div style="flex: 1; min-width: 0;">
<div style="font-size: 12px; color: var(--text); margin-bottom: 4px; font-weight: 600;">Display Name</div>
<div id="display-display-name" style="font-size: 12px; color: rgba(255,255,255,0.75); font-weight: 500;">
                                Not set
                            </div>
</div>
<button onclick="app.editDisplayName()" style="width: 55px; height: 32px; flex-shrink: 0; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                            Edit
                        </button>
</div>
</div>
<!-- Show in Leaderboards Toggle -->
<div class="pals-profile-card" style="padding: 6px 6px;">
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
<div style="flex: 1; min-width: 0;">
<span style="font-size: 12px; color: var(--text); font-weight: 600; display: block;">Show in Leaderboards</span>
<span style="font-size: 11px; color: #6b7280; display: block; margin-top: 1px;">Compete globally with all JustStep users</span>
</div>
<div style="width: 55px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
<input id="join-leaderboard" onchange="app.toggleLeaderboard()" style="width: 20px; height: 20px; cursor: pointer; margin: 0;" type="checkbox"/>
</div>
</label>
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 10px;">
<div style="flex: 1; min-width: 0;">
<span style="font-size: 12px; color: var(--text); font-weight: 600; display: block;">Include Weight Leaderboard</span></div>
<div style="width: 55px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
<input id="join-weight-leaderboard" onchange="app.toggleWeightLeaderboardOptIn()" style="width: 20px; height: 20px; cursor: pointer; margin: 0;" type="checkbox"/>
</div>
</label>
<div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Requires Initial Weight in Goals and regular weigh-ins.</div>
</div>
<!-- Share Weight with Pals Toggle -->
<div class="pals-profile-card" style="padding: 6px 6px; margin-top: 6px;">
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
<div style="flex: 1; min-width: 0;">
<span style="font-size: 12px; color: var(--text); font-weight: 600; display: block;">Share Weight with Pals</span>
<span style="font-size: 11px; color: #6b7280; display: block; margin-top: 1px;">Let your pals see your current weight (not public)</span>
</div>
<div style="width: 55px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
<input id="share-weight-with-pals" onchange="app.toggleShareWeightWithPals()" style="width: 20px; height: 20px; cursor: pointer; margin: 0;" type="checkbox"/>
</div>
</label>
</div>
</div>
<!-- ADD PAL Section - Compact -->
<div class="pals-section">
<h2 style="font-size: 14px; margin-bottom: 8px; color: var(--primary-light); font-weight: 600;">ADD PAL</h2>
<div class="pals-profile-card">
<div style="display: flex; gap: 8px; align-items: center;">
<input id="add-pal-code" inputmode="numeric" maxlength="4" placeholder="Enter PAL Code..." style="flex: 1; min-width: 0; padding: 6px 10px; background: #1a1a1a; border: 1px solid #3d3d3d; border-radius: 6px; color: #e8e8e8; font-size: 13px; height: 32px; box-sizing: border-box;" type="tel"/>
<button onclick="app.addPal()" style="width: 55px; height: 32px; flex-shrink: 0; background: var(--primary-dark); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">
                            Add
                        </button>
</div>
</div>
<div class="success-message" id="add-pal-success" style="margin-top: 6px;">Pal added!</div>
<div class="error-message" id="add-pal-error" style="margin-top: 6px;"></div>
</div>
<!-- MY PALS List - Slim -->
<div class="pals-section">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
<h2 style="font-size: 14px; color: var(--primary-light); font-weight: 600; margin: 0;">MY PALS</h2>
<button onclick="app.refreshAllPals()" style="padding: 4px 10px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 5px; font-size: 11px; cursor: pointer; font-weight: 600;">
                         Refresh All
                    </button>
</div>
<div id="pals-list">
<p style="color: #6b7280; text-align: center; padding: 16px 0; font-size: 13px;">No pals yet. Add one above!</p>
</div>
</div>
</div>
<!-- Leaderboard Screen -->
<div class="screen" id="leaderboard-screen">
<h1 style="display: flex; align-items: center; gap: 8px;">Leaderboard <span class="info-icon" onclick="app.showLeaderboardInfo()" title="How rankings work">i</span></h1>
<p class="subtitle">Compete with JustStep users worldwide</p>
<!-- Toggle: Global / Friends -->
<div class="leaderboard-toggle" style="display: flex; gap: 8px; margin-bottom: 16px;">
<button class="toggle-btn active" id="lb-global-btn" onclick="app.setLeaderboardMode('global')" style="flex: 1; padding: 10px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Global
                </button>
<button class="toggle-btn" id="lb-friends-btn" onclick="app.setLeaderboardMode('friends')" style="flex: 1; padding: 10px; background: #2d2d2d; color: #9ca3af; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Friends
                </button>
</div>
<!-- Time Period & Metric Dropdowns -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
<select id="leaderboard-metric" onchange="app.renderLeaderboard()" style="padding: 10px; background: #2d2d2d; border: 1px solid #3d3d3d; border-radius: 8px; color: #e8e8e8; font-size: 14px; cursor: pointer;">
<option value="thisWeekDistance">Distance</option>
<option value="thisWeekSteps">Steps</option>
<option value="weight">Weight</option>
</select>
<select id="leaderboard-period" onchange="app.renderLeaderboard()" style="padding: 10px; background: #2d2d2d; border: 1px solid #3d3d3d; border-radius: 8px; color: #e8e8e8; font-size: 14px; cursor: pointer;">
<option value="week">This Week</option>
<option value="month">This Month</option>
<option value="total">All Time</option>
</select>
</div>
<!-- Leaderboard List -->
<div id="leaderboard-list" style="display: flex; flex-direction: column; gap: 6px;">
<p style="color: #6b7280; text-align: center; padding: 20px;">Loading leaderboard...</p>
</div>
</div>
</div>
<!-- Milestone Notification -->
<div class="overlay" id="overlay" onclick="app.closeMilestone()"></div>
<div class="milestone-notification" id="milestone-notification">
<div class="milestone-icon-large" id="milestone-icon"></div>
<div class="milestone-title" id="milestone-title">Milestone Reached</div>
<div class="milestone-description" id="milestone-description">Great work!</div>
<button class="milestone-close" onclick="app.closeMilestone()">Continue</button>
</div>
<!-- Day Detail Modal -->
<div class="overlay" id="day-overlay" onclick="app.closeDayDetail()"></div>
<div class="day-detail-modal" id="day-detail-modal">
<div class="day-detail-header">
<div class="day-detail-date" id="day-detail-date">January 15, 2026</div>
<button class="day-detail-close" onclick="app.closeDayDetail()"></button>
</div>
<div id="day-detail-content">
<!-- Content will be populated dynamically -->
</div>
</div>
<!-- Welcome Modal -->
<div class="overlay" id="welcome-overlay"></div>
<div class="welcome-modal" id="welcome-modal">
<div class="welcome-header">
<div class="welcome-title">Welcome to <span style="color: var(--primary); font-weight: 700;">J</span>ustStep</div>
</div>
<div class="welcome-content">
            Success isn't comfortable. Every workout, every mile, every rep you log here is a step closer to your goals!
            <br/><br/>
<span style="color: var(--primary); font-weight: 700;">J</span>ust take the next <span style="color: var(--primary); font-weight: 700;">S</span>tep.
        </div>
<div class="welcome-tagline">
            Track it. Own it. Grow.
        </div>
<a class="welcome-video-link" href="https://www.youtube.com/watch?v=ZuHHYRD6AHQ&amp;t=0" target="_blank">
            Watch  To Grow, You Must Suffer
        </a>
<button class="welcome-button" onclick="app.closeWelcome()">Let's Go</button>
<div style="text-align: center; color: #6b7280; font-size: 11px; margin-top: 16px;">
            v2.2.0
        </div>
</div>
<!-- Customize Dashboard Modal -->
<div class="overlay" id="customize-overlay" onclick="app.closeCustomizeModal()"></div>
<div class="customize-modal" id="customize-modal">
<div class="customize-modal-header"> Customize Your Favorites</div>
<div class="customize-slot">
<label class="customize-slot-label">Favorite 1</label>
<select id="custom-slot-1">
<optgroup label="Quick Log Categories">
<option value="arm">Arm Day</option>
<option value="back">Back Day</option>
<option value="chest">Chest Day</option>
<option value="core">Core Day</option>
<option value="fullbody">Full Body Day</option>
<option value="glutes">Glutes Day</option>
<option value="leg">Leg Day</option>
<option value="shoulder">Shoulder Day</option>
<option value="stretch">Stretch Day</option>
</optgroup>
<optgroup label="Arm Day Exercises">
<option value="arm-bicep-curls">Bicep Curls</option>
<option value="arm-forearm-curls">Forearm Curls</option>
<option value="arm-hammer-curls">Hammer Curls</option>
<option value="arm-tricep-dips">Tricep Dips</option>
<option value="arm-triceps-extensions">Triceps Extensions</option>
</optgroup>
<optgroup label="Back Day Exercises">
<option value="back-deadlifts">Deadlifts</option>
<option value="back-face-pulls">Face Pulls</option>
<option value="back-lat-pulldowns">Lat Pulldowns</option>
<option value="back-pullups">Pull-ups</option>
<option value="back-rows">Rows</option>
</optgroup>
<optgroup label="Chest Day Exercises">
<option value="chest-bench-press">Bench Press</option>
<option value="chest-chest-flys">Chest Flys</option>
<option value="chest-dips">Dips</option>
<option value="chest-incline-press">Incline Press</option>
<option value="chest-pushups">Push-ups</option>
</optgroup>
<optgroup label="Core Day Exercises">
<option value="core-ab-wheel-rollout">Ab Wheel Rollout</option>
<option value="core-leg-raises">Leg Raises</option>
<option value="core-planks">Planks</option>
<option value="core-russian-twists">Russian Twists</option>
<option value="core-situps">Sit-ups</option>
</optgroup>
<optgroup label="Glutes Day Exercises">
<option value="glutes-bulgarian-split-squats">Bulgarian Split Squats</option>
<option value="glutes-donkey-kicks">Donkey Kicks</option>
<option value="glutes-glute-bridges">Glute Bridges</option>
<option value="glutes-hip-thrusts">Hip Thrusts</option>
<option value="glutes-step-ups">Step-ups</option>
</optgroup>
<optgroup label="Leg Day Exercises">
<option value="legs-calf-raises">Calf Raises</option>
<option value="legs-leg-press">Leg Press</option>
<option value="legs-lunges">Lunges</option>
<option value="legs-romanian-deadlifts">Romanian Deadlifts</option>
<option value="legs-squats">Squats</option>
</optgroup>
<optgroup label="Shoulder Day Exercises">
<option value="shoulder-front-raises">Front Raises</option>
<option value="shoulder-lateral-raises">Lateral Raises</option>
<option value="shoulder-rear-delt-flys">Rear Delt Flys</option>
<option value="shoulder-shoulder-press">Shoulder Press</option>
<option value="shoulder-shrugs">Shrugs</option>
</optgroup>
<optgroup label="Cardio">
<option value="biking">Biking</option>
<option value="dog">Dog Walking</option>
<option value="hiking">Hiking</option>
<option value="run">Running</option>
<option value="walk">Walking</option>
</optgroup>
<optgroup label="Other">
<option value="stairs">Stairmaster</option>
</optgroup>
</select>
</div>
<div class="customize-slot">
<label class="customize-slot-label">Favorite 2</label>
<select id="custom-slot-2">
<optgroup label="Quick Log Categories">
<option value="arm">Arm Day</option>
<option value="back">Back Day</option>
<option value="chest">Chest Day</option>
<option value="core">Core Day</option>
<option value="fullbody">Full Body Day</option>
<option value="glutes">Glutes Day</option>
<option value="leg">Leg Day</option>
<option value="shoulder">Shoulder Day</option>
<option value="stretch">Stretch Day</option>
</optgroup>
<optgroup label="Arm Day Exercises">
<option value="arm-bicep-curls">Bicep Curls</option>
<option value="arm-forearm-curls">Forearm Curls</option>
<option value="arm-hammer-curls">Hammer Curls</option>
<option value="arm-tricep-dips">Tricep Dips</option>
<option value="arm-triceps-extensions">Triceps Extensions</option>
</optgroup>
<optgroup label="Back Day Exercises">
<option value="back-deadlifts">Deadlifts</option>
<option value="back-face-pulls">Face Pulls</option>
<option value="back-lat-pulldowns">Lat Pulldowns</option>
<option value="back-pullups">Pull-ups</option>
<option value="back-rows">Rows</option>
</optgroup>
<optgroup label="Chest Day Exercises">
<option value="chest-bench-press">Bench Press</option>
<option value="chest-chest-flys">Chest Flys</option>
<option value="chest-dips">Dips</option>
<option value="chest-incline-press">Incline Press</option>
<option value="chest-pushups">Push-ups</option>
</optgroup>
<optgroup label="Core Day Exercises">
<option value="core-ab-wheel-rollout">Ab Wheel Rollout</option>
<option value="core-leg-raises">Leg Raises</option>
<option value="core-planks">Planks</option>
<option value="core-russian-twists">Russian Twists</option>
<option value="core-situps">Sit-ups</option>
</optgroup>
<optgroup label="Glutes Day Exercises">
<option value="glutes-bulgarian-split-squats">Bulgarian Split Squats</option>
<option value="glutes-donkey-kicks">Donkey Kicks</option>
<option value="glutes-glute-bridges">Glute Bridges</option>
<option value="glutes-hip-thrusts">Hip Thrusts</option>
<option value="glutes-step-ups">Step-ups</option>
</optgroup>
<optgroup label="Leg Day Exercises">
<option value="legs-calf-raises">Calf Raises</option>
<option value="legs-leg-press">Leg Press</option>
<option value="legs-lunges">Lunges</option>
<option value="legs-romanian-deadlifts">Romanian Deadlifts</option>
<option value="legs-squats">Squats</option>
</optgroup>
<optgroup label="Shoulder Day Exercises">
<option value="shoulder-front-raises">Front Raises</option>
<option value="shoulder-lateral-raises">Lateral Raises</option>
<option value="shoulder-rear-delt-flys">Rear Delt Flys</option>
<option value="shoulder-shoulder-press">Shoulder Press</option>
<option value="shoulder-shrugs">Shrugs</option>
</optgroup>
<optgroup label="Cardio">
<option value="biking">Biking</option>
<option value="dog">Dog Walking</option>
<option value="hiking">Hiking</option>
<option value="run">Running</option>
<option value="walk">Walking</option>
</optgroup>
<optgroup label="Other">
<option value="stairs">Stairmaster</option>
</optgroup>
</select>
</div>
<div class="customize-slot">
<label class="customize-slot-label">Favorite 3</label>
<select id="custom-slot-3">
<optgroup label="Quick Log Categories">
<option value="arm">Arm Day</option>
<option value="back">Back Day</option>
<option value="chest">Chest Day</option>
<option value="core">Core Day</option>
<option value="fullbody">Full Body Day</option>
<option value="glutes">Glutes Day</option>
<option value="leg">Leg Day</option>
<option value="shoulder">Shoulder Day</option>
<option value="stretch">Stretch Day</option>
</optgroup>
<optgroup label="Arm Day Exercises">
<option value="arm-bicep-curls">Bicep Curls</option>
<option value="arm-forearm-curls">Forearm Curls</option>
<option value="arm-hammer-curls">Hammer Curls</option>
<option value="arm-tricep-dips">Tricep Dips</option>
<option value="arm-triceps-extensions">Triceps Extensions</option>
</optgroup>
<optgroup label="Back Day Exercises">
<option value="back-deadlifts">Deadlifts</option>
<option value="back-face-pulls">Face Pulls</option>
<option value="back-lat-pulldowns">Lat Pulldowns</option>
<option value="back-pullups">Pull-ups</option>
<option value="back-rows">Rows</option>
</optgroup>
<optgroup label="Chest Day Exercises">
<option value="chest-bench-press">Bench Press</option>
<option value="chest-chest-flys">Chest Flys</option>
<option value="chest-dips">Dips</option>
<option value="chest-incline-press">Incline Press</option>
<option value="chest-pushups">Push-ups</option>
</optgroup>
<optgroup label="Core Day Exercises">
<option value="core-ab-wheel-rollout">Ab Wheel Rollout</option>
<option value="core-leg-raises">Leg Raises</option>
<option value="core-planks">Planks</option>
<option value="core-russian-twists">Russian Twists</option>
<option value="core-situps">Sit-ups</option>
</optgroup>
<optgroup label="Glutes Day Exercises">
<option value="glutes-bulgarian-split-squats">Bulgarian Split Squats</option>
<option value="glutes-donkey-kicks">Donkey Kicks</option>
<option value="glutes-glute-bridges">Glute Bridges</option>
<option value="glutes-hip-thrusts">Hip Thrusts</option>
<option value="glutes-step-ups">Step-ups</option>
</optgroup>
<optgroup label="Leg Day Exercises">
<option value="legs-calf-raises">Calf Raises</option>
<option value="legs-leg-press">Leg Press</option>
<option value="legs-lunges">Lunges</option>
<option value="legs-romanian-deadlifts">Romanian Deadlifts</option>
<option value="legs-squats">Squats</option>
</optgroup>
<optgroup label="Shoulder Day Exercises">
<option value="shoulder-front-raises">Front Raises</option>
<option value="shoulder-lateral-raises">Lateral Raises</option>
<option value="shoulder-rear-delt-flys">Rear Delt Flys</option>
<option value="shoulder-shoulder-press">Shoulder Press</option>
<option value="shoulder-shrugs">Shrugs</option>
</optgroup>
<optgroup label="Cardio">
<option value="biking">Biking</option>
<option value="dog">Dog Walking</option>
<option value="hiking">Hiking</option>
<option value="run">Running</option>
<option value="walk">Walking</option>
</optgroup>
<optgroup label="Other">
<option value="stairs">Stairmaster</option>
</optgroup>
</select>
</div>
<div class="customize-modal-buttons">
<button class="customize-modal-btn cancel" onclick="app.closeCustomizeModal()">Cancel</button>
<button class="customize-modal-btn save" onclick="app.saveCustomCards()">Save Favorites</button>
</div>
</div>
<!-- Color Palette Modal -->
<div class="modal" id="color-palette-modal" style="display: none;">
<div class="modal-content" style="max-width: 340px;">
<h2 style="margin-bottom: 16px; font-size: 18px;">Select Color</h2>
<div id="color-palette-grid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; margin-bottom: 16px;">
<!-- Colors will be rendered here: 10 rows x 8 columns -->
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
<button onclick="app.closeColorPalette()" style="width: 100%; padding: 10px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Cancel
                </button>
<button onclick="app.confirmColorSelection()" style="width: 100%; padding: 10px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    OK
                </button>
</div>
</div>
</div>
<!-- Color Wheel Modal -->
<div class="modal" id="color-wheel-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
<div class="modal-content" style="max-width: 360px; text-align: center; background: #1a1a1a; padding: 24px; border-radius: 12px;">
<h2 style="margin-bottom: 16px; font-size: 18px; color: #e8e8e8;">Choose Your Color</h2>
<div style="display: flex; justify-content: center; margin-bottom: 16px; position: relative;">
<canvas height="280" id="color-wheel-canvas" style="cursor: crosshair; border-radius: 50%;" width="280"></canvas>
<!-- Magnifier Overlay -->
<div id="color-magnifier" style="display: none; position: absolute; width: 120px; height: 120px; border: 4px solid white; border-radius: 50%; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 10;">
<canvas id="magnifier-canvas" width="120" height="120" style="border-radius: 50%;"></canvas>
</div>
</div>
<div id="magnifier-instruction" style="display: none; font-size: 12px; color: #9ca3af; margin-bottom: 8px;">Drag to fine-tune your color</div>
<div id="selected-color-preview" style="width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 16px; border: 3px solid #3d3d3d; background: #2563eb;"></div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
<button onclick="app.closeColorWheel()" style="width: 100%; padding: 10px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Cancel
                </button>
<button onclick="app.confirmColorWheelSelection()" style="width: 100%; padding: 10px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    OK
                </button>
</div>
</div>
</div>
<script>
        // App Version
        const APP_VERSION = '2.2.0';
        
        // Main App Object
        const app = {
            data: {
                activities: [], // All logged activities
                weights: [], // Weight tracking: { date, weight, unit }
                goals: {
                    annualMiles: 420,
                    workoutFrequency: 5,
                    monthlyMiles: 35,
                    unitPreference: 'miles',
                    weightUnit: 'lbs',
                    initialWeight: null
                },
                habits: [], // Make it a Habit: { id, name, frequency: 'daily'|'weekly', completions: [dates] }
                customCategories: [], // Custom Activity Categories: { id, name, exercises: [{id, name, trackingType: 'reps'|'distance'|'logday'}] }
                milestones: [],
                currentView: {
                    screen: 'log',
                    statsView: 'week', // 'week' or 'total'
                    calendarMonth: new Date().getMonth(),
                    calendarYear: new Date().getFullYear()
                },
                customDashboardCards: ['pushups', 'pullups', 'rollerabs'], // Row 2 customizable cards
                themeColor: 'blue', // Theme color: blue, green, pink, orange, purple, red
                // PALS v1.7.0
                pals: {
                    myPalCode: '',
                    displayName: '',
                    joinedLeaderboard: false,
                    joinWeightLeaderboard: false,
                    shareWeightWithPals: false,
                    friends: [] // Array of {palCode, displayName, stats, lastSync}
                }
            },
            activityCounter: 0,
            habitCounter: 0,
            customCategoryCounter: 0,
            leaderboardMode: 'global', // 'global' or 'friends'
            firebase: null, // Firebase instance
            db: null, // Firestore instance

            // Initialize app
            init() {
                // Display version in header
                const vEl = document.getElementById('app-version-display');
                if (vEl) vEl.textContent = `v${APP_VERSION}`;

                console.log(`%cJustStep v${APP_VERSION}`, 'color: var(--primary); font-weight: bold; font-size: 14px;');
                
                // Initialize Firebase
                this.initFirebase();
                
                this.loadData();
                
                // Initialize stat label with user's unit preference
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                document.getElementById('stat-miles-label').textContent = `Distance (${unit})`;
                
                // Migrate old exercises to new structure (one-time, automatic)
                this.migrateOldExercises();
                // Ensure statsView is set before updating dashboard
                if (!this.data.currentView.statsView) {
                    this.data.currentView.statsView = 'week';
                }
                // Apply saved theme color
                if (this.data.themeColor) {
                    if (this.data.themeColor.startsWith('#')) {
                        // Custom hex color
                        this.applyCustomThemeColor(this.data.themeColor);
                    } else {
                        // Predefined theme name
                        this.applyTheme(this.data.themeColor);
                    }
                }
                this.checkWelcome();
                this.setupLogDate();
                this.updateWeightInputDisplay();
                this.addActivityRow();
                this.updateDashboard();
                this.renderCalendar();
                this.updateGoalsUI();
                this.initHabits(); // Initialize habits
                this.initCustomCategories(); // Initialize custom categories
                this.updatePalsUI();
                this.loadTheme();
                this.registerServiceWorker();
            },

            // Register service worker for auto-updates
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registered');
                            
                            // Check for updates every time app is opened
                            registration.update();
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }
            },

            // Check if welcome modal should show
            checkWelcome() {
                // Check if we've shown welcome today
                const today = new Date().toDateString();
                const lastShown = localStorage.getItem('lastWelcomeShown');
                
                // Show if never shown OR if it's a new calendar day
                if (!lastShown || lastShown !== today) {
                    this.showWelcome();
                }
            },

            // Show welcome modal (called by checkWelcome or info icon)
            showWelcome() {
                document.getElementById('welcome-overlay').classList.add('show');
                document.getElementById('welcome-modal').classList.add('show');
            },

            // Close welcome modal and save today's date
            closeWelcome() {
                document.getElementById('welcome-overlay').classList.remove('show');
                document.getElementById('welcome-modal').classList.remove('show');
                
                // Save today's date so we don't show again until tomorrow
                const today = new Date().toDateString();
                localStorage.setItem('lastWelcomeShown', today);
                
                // Check if we should show Sunday weekly report
                this.checkSundayWeeklyReport();
            },
            
            // Check if we should show the weekly report (Sundays only)
            checkSundayWeeklyReport() {
                const now = new Date();

                // Only show on Sundays (day 0)
                if (now.getDay() !== 0) return;

                // Today's Sunday date (YYYY-MM-DD)
                const sundayDate = now.toISOString().split('T')[0];

                // Check if we already showed the report for this Sunday
                const lastShownSunday = localStorage.getItem('lastWeeklyReportSunday');

                if (lastShownSunday !== sundayDate) {
                    // Show the weekly report after the welcome closes (brief delay)
                    setTimeout(() => {
                        this.showWeeklyReport();
                    }, 500);
                }
            },

            // Load data from localStorage
            loadData() {
                const saved = localStorage.getItem('justStepData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.data = { ...this.data, ...parsed };
                    // Ensure statsView exists (for users upgrading from old version)
                    if (!this.data.currentView.statsView) {
                        this.data.currentView.statsView = 'week';
                    }
                    // Ensure customDashboardCards exists (for users upgrading from v1.2.0)
                    if (!this.data.customDashboardCards) {
                        this.data.customDashboardCards = ['pushups', 'pullups', 'rollerabs'];
                    }
                    // Ensure weights array exists (for users upgrading to v1.4.0)
                    if (!this.data.weights) {
                        this.data.weights = [];
                    }
                    // Force weight unit to lbs (unit switching removed)
                    this.data.goals.weightUnit = 'lbs';
                    // Ensure initialWeight exists (for users upgrading to v1.7.0)
                    if (this.data.goals.initialWeight === undefined) {
                        this.data.goals.initialWeight = null;
                    }
                    // Ensure pals exists and friends array is preserved (for users upgrading to v1.7.0)
                    if (!this.data.pals) {
                        this.data.pals = {
                            myPalCode: '',
                            displayName: '',
                            joinedLeaderboard: false,
                            joinWeightLeaderboard: false,
                            friends: []
                        };
                    } else {
                        // Ensure required fields exist on pals (upgrade safety)
                        if (this.data.pals.myPalCode === undefined) this.data.pals.myPalCode = '';
                        if (this.data.pals.displayName === undefined) this.data.pals.displayName = '';
                        if (this.data.pals.joinedLeaderboard === undefined) this.data.pals.joinedLeaderboard = false;
                        if (this.data.pals.joinWeightLeaderboard === undefined) this.data.pals.joinWeightLeaderboard = false;
                        if (!this.data.pals.friends) this.data.pals.friends = [];
                    }
                }
            },

            // Migrate old single exercises to include category field
            migrateOldExercises() {
                const exerciseCategoryMap = {
                    'dips': 'chest',
                    'pullups': 'back',
                    'pushups': 'chest',
                    'rollerabs': 'core',
                    'situps': 'core',
                    'squats': 'legs'
                };
                
                let migrated = 0;
                this.data.activities.forEach(activity => {
                    // If it's an old exercise type without a category, add one
                    if (activity.type in exerciseCategoryMap && !activity.category) {
                        activity.category = exerciseCategoryMap[activity.type];
                        migrated++;
                    }
                });
                
                if (migrated > 0) {
                    this.saveData();
                    console.log(` Migrated ${migrated} exercises to new structure`);
                }
            },

            // Save data to localStorage
            saveData() {
                localStorage.setItem('justStepData', JSON.stringify(this.data));
            },

            // Setup log date input (FIXED: timezone-safe)
            setupLogDate() {
                const dateInput = document.getElementById('log-date');
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            },

            // Add activity row
            addActivityRow() {
                this.activityCounter++;
                const container = document.getElementById('activities-container');
                const isFirst = this.activityCounter === 1;
                
                const activityCard = document.createElement('div');
                activityCard.className = 'activity-card';
                activityCard.id = `activity-${this.activityCounter}`;
                
                activityCard.innerHTML = `
                    <div class="activity-card-header">
                        <span class="activity-card-title">Activity ${this.activityCounter}</span>
                        <button class="remove-activity" onclick="app.removeActivity(${this.activityCounter})" ${isFirst ? 'style="visibility: hidden;"' : ''}></button>
                    </div>
                    
                    <div class="activity-accordion" id="accordion-${this.activityCounter}">
                        <!-- Cardio Category -->
                        <div class="accordion-category">
                            <div class="accordion-header" onclick="app.toggleAccordion(${this.activityCounter}, 'cardio')">
                                <div>
                                    <span class="accordion-title">Cardio</span>
                                    <span class="accordion-count">(6)</span>
                                </div>
                                <span class="accordion-arrow"></span>
                            </div>
                            <div class="accordion-content" id="accordion-${this.activityCounter}-cardio">
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'biking', 'Biking')">Biking</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'dog', 'Dog Walking')">Dog Walking</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'hiking', 'Hiking')">Hiking</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'run', 'Running')">Running</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'stairs', 'Stairmaster')">Stairmaster</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'walk', 'Walking')">Walking</div>
                            </div>
                        </div>
                        
                        <!-- Strength Category -->
                        <div class="accordion-category">
                            <div class="accordion-header" onclick="app.toggleAccordion(${this.activityCounter}, 'strength')">
                                <div>
                                    <span class="accordion-title">Strength</span>
                                    <span class="accordion-count">(9)</span>
                                </div>
                                <span class="accordion-arrow"></span>
                            </div>
                            <div class="accordion-content" id="accordion-${this.activityCounter}-strength">
                                <div class="accordion-item" onclick="app.openExerciseModal(${this.activityCounter}, 'arm', 'Arm Day')">
                                    <span>Arm Day</span>
                                    <span style="float: right; color: #9ca3af;"></span>
                                </div>
                                <div class="accordion-item" onclick="app.openExerciseModal(${this.activityCounter}, 'back', 'Back Day')">
                                    <span>Back Day</span>
                                    <span style="float: right; color: #9ca3af;"></span>
                                </div>
                                <div class="accordion-item" onclick="app.openExerciseModal(${this.activityCounter}, 'chest', 'Chest Day')">
                                    <span>Chest Day</span>
                                    <span style="float: right; color: #9ca3af;"></span>
                                </div>
                                <div class="accordion-item" onclick="app.openExerciseModal(${this.activityCounter}, 'core', 'Core Day')">
                                    <span>Core Day</span>
                                    <span style="float: right; color: #9ca3af;"></span>
                                </div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'fullbody', 'Full Body Day')">
                                    <span>Full Body Day</span>
                                    <span style="float: right; color: #9ca3af;"></span>
                                </div>
                                <div class="accordion-item" onclick="app.openExerciseModal(${this.activityCounter}, 'glutes', 'Glutes Day')">
                                    <span>Glutes Day</span>
                                    <span style="float: right; color: #9ca3af;"></span>
                                </div>
                                <div class="accordion-item" onclick="app.openExerciseModal(${this.activityCounter}, 'leg', 'Leg Day')">
                                    <span>Leg Day</span>
                                    <span style="float: right; color: #9ca3af;"></span>
                                </div>
                                <div class="accordion-item" onclick="app.openExerciseModal(${this.activityCounter}, 'shoulder', 'Shoulder Day')">
                                    <span>Shoulder Day</span>
                                    <span style="float: right; color: #9ca3af;"></span>
                                </div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'stretch', 'Stretch Day')">
                                    <span>Stretch Day</span>
                                    <span style="float: right; color: #9ca3af;"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Steps Category -->
                        <div class="accordion-category">
                            <div class="accordion-header" onclick="app.toggleAccordion(${this.activityCounter}, 'steps')">
                                <div>
                                    <span class="accordion-title">Steps</span>
                                    <span class="accordion-count">(1)</span>
                                </div>
                                <span class="accordion-arrow"></span>
                            </div>
                            <div class="accordion-content" id="accordion-${this.activityCounter}-steps-cat">
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'steps', 'Steps')">Steps</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="selected-activity-${this.activityCounter}" style="margin-top: 12px; font-size: 13px; color: #6b7280; display: none;">
                        <span style="display: flex; justify-content: space-between; align-items: center;">
                            <span>
                                Selected: <span id="selected-name-${this.activityCounter}" style="color: var(--primary-light); font-weight: 600;"></span>
                            </span>
                            <span style="display: flex; gap: 6px;">
                                <button onclick="app.reopenAccordion(${this.activityCounter})" style="background: none; border: 1px solid #3d3d3d; color: #9ca3af; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                                    Change
                                </button>
                                ${isFirst ? `<button onclick="app.cancelActivity(${this.activityCounter})" style="background: none; border: 1px solid #3d3d3d; color: #ef4444; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;">Cancel</button>` : ''}
                            </span>
                        </span>
                    </div>
                    
                    <div id="value-input-${this.activityCounter}">
                        <!-- Value input will be inserted here -->
                    </div>
                    </div>
                    </div>
                `;
                
                container.appendChild(activityCard);
                
                // Add custom categories dynamically as top-level categories
                this.addCustomCategoriesToActivityCard(this.activityCounter);
            },

            // Add custom categories to activity card as top-level categories with theme-colored arrow
            addCustomCategoriesToActivityCard(activityId) {
                if (!this.data.customCategories || this.data.customCategories.length === 0) return;
                
                const accordion = document.getElementById(`accordion-${activityId}`);
                if (!accordion) return;
                
                // Add each custom category as a top-level category
                this.data.customCategories.forEach(category => {
                    if (!category.exercises || category.exercises.length === 0) return;
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'accordion-category';
                    categoryDiv.setAttribute('data-custom-category', 'true'); // Mark as custom
                    
                    const exerciseCount = category.exercises.length;
                    
                    let categoryHTML = `
                        <div class="accordion-header" onclick="app.toggleAccordion(${activityId}, 'custom-${category.id}')">
                            <div>
                                <span class="accordion-title">${category.name}</span>
                                <span class="accordion-count">(${exerciseCount})</span>
                            </div>
                            <span class="accordion-arrow" style="color: var(--primary);"></span>
                        </div>
                        <div class="accordion-content" id="accordion-${activityId}-custom-${category.id}">
                    `;
                    
                    // Add exercises with arrow and modal trigger
                    category.exercises.forEach(ex => {
                        categoryHTML += `
                            <div class="accordion-item" onclick="app.selectCustomExercise(${activityId}, ${category.id}, ${ex.id}, '${ex.name}', '${ex.trackingType}')">
                                <span>${ex.name}</span>
                                <span style="float: right; color: #9ca3af;"></span>
                            </div>
                        `;
                    });
                    
                    categoryHTML += '</div>';
                    categoryDiv.innerHTML = categoryHTML;
                    accordion.appendChild(categoryDiv);
                });
            },

            // Refresh custom categories in all existing activity rows
            refreshActivityRows() {
                // Find all activity accordions (only the main accordion containers, not nested ones)
                const logScreen = document.getElementById('log-screen');
                const activityCards = logScreen.querySelectorAll('[id^="accordion-"]:not([id*="-cardio"]):not([id*="-strength"]):not([id*="-steps"]):not([id*="-custom"])');
                
                activityCards.forEach(accordion => {
                    // Extract activity ID from accordion id (e.g., "accordion-1" -> "1")
                    const activityId = parseInt(accordion.id.replace('accordion-', ''));
                    
                    // Skip if not a number (means it's a nested accordion)
                    if (isNaN(activityId)) return;
                    
                    // Remove all existing custom category accordions using data attribute
                    const customCategories = accordion.querySelectorAll('[data-custom-category="true"]');
                    customCategories.forEach(cat => cat.remove());
                    
                    // Re-add custom categories
                    this.addCustomCategoriesToActivityCard(activityId);
                });
            },

            // Toggle accordion section
            toggleAccordion(id, category) {
                const header = event.target.closest('.accordion-header');
                const content = document.getElementById(`accordion-${id}-${category === 'steps' ? 'steps-cat' : category}`);
                const allContents = document.querySelectorAll(`#accordion-${id} .accordion-content`);
                const allHeaders = document.querySelectorAll(`#accordion-${id} .accordion-header`);
                
                // Close all other sections
                allContents.forEach(c => {
                    if (c !== content) {
                        c.classList.remove('active');
                    }
                });
                allHeaders.forEach(h => {
                    if (h !== header) {
                        h.classList.remove('active');
                    }
                });
                
                // Toggle this section
                header.classList.toggle('active');
                content.classList.toggle('active');
            },

            // Toggle sub-accordion for specific exercises
            toggleSubAccordion(id, subCategory) {
                const header = event.target.closest('.sub-accordion-header');
                const content = document.getElementById(`sub-accordion-${id}-${subCategory}`);
                
                if (!content) return; // Stretch Day has no sub-content
                
                // Toggle this sub-section
                header.classList.toggle('active');
                content.classList.toggle('active');
                
                // Prevent event from bubbling to parent accordion
                event.stopPropagation();
            },

            // Open exercise modal for category with sub-exercises
            openExerciseModal(activityId, categoryType, categoryName) {
                // Define exercises for each category
                const exerciseMap = {
                    'arm': {
                        exercises: [
                            { type: 'bicepcurls', name: 'Bicep Curls', category: 'arms' },
                            { type: 'forearmcurls', name: 'Forearm Curls', category: 'arms' },
                            { type: 'hammercurls', name: 'Hammer Curls', category: 'arms' },
                            { type: 'tricepdips', name: 'Tricep Dips', category: 'arms' },
                            { type: 'tricepsextensions', name: 'Triceps Extensions', category: 'arms' }
                        ]
                    },
                    'back': {
                        exercises: [
                            { type: 'deadlifts', name: 'Deadlifts', category: 'back' },
                            { type: 'facepulls', name: 'Face Pulls', category: 'back' },
                            { type: 'latpulldowns', name: 'Lat Pulldowns', category: 'back' },
                            { type: 'pullups', name: 'Pull-ups', category: 'back' },
                            { type: 'rows', name: 'Rows', category: 'back' }
                        ]
                    },
                    'chest': {
                        exercises: [
                            { type: 'benchpress', name: 'Bench Press', category: 'chest' },
                            { type: 'chestflys', name: 'Chest Flys', category: 'chest' },
                            { type: 'dips', name: 'Dips', category: 'chest' },
                            { type: 'inclinepress', name: 'Incline Press', category: 'chest' },
                            { type: 'pushups', name: 'Push-ups', category: 'chest' }
                        ]
                    },
                    'core': {
                        exercises: [
                            { type: 'abwheelrollout', name: 'Ab Wheel Rollout', category: 'core' },
                            { type: 'legraises', name: 'Leg Raises', category: 'core' },
                            { type: 'planks', name: 'Planks', category: 'core' },
                            { type: 'russiantwists', name: 'Russian Twists', category: 'core' },
                            { type: 'situps', name: 'Sit-ups', category: 'core' }
                        ]
                    },
                    'glutes': {
                        exercises: [
                            { type: 'bulgariansplitsquats', name: 'Bulgarian Split Squats', category: 'glutes' },
                            { type: 'donkeykicks', name: 'Donkey Kicks', category: 'glutes' },
                            { type: 'glutebridges', name: 'Glute Bridges', category: 'glutes' },
                            { type: 'hipthrusts', name: 'Hip Thrusts', category: 'glutes' },
                            { type: 'stepups', name: 'Step-ups', category: 'glutes' }
                        ]
                    },
                    'leg': {
                        exercises: [
                            { type: 'calfraises', name: 'Calf Raises', category: 'legs' },
                            { type: 'legpress', name: 'Leg Press', category: 'legs' },
                            { type: 'lunges', name: 'Lunges', category: 'legs' },
                            { type: 'romaniandeadlifts', name: 'Romanian Deadlifts', category: 'legs' },
                            { type: 'squats', name: 'Squats', category: 'legs' }
                        ]
                    },
                    'shoulder': {
                        exercises: [
                            { type: 'frontraises', name: 'Front Raises', category: 'shoulders' },
                            { type: 'lateralraises', name: 'Lateral Raises', category: 'shoulders' },
                            { type: 'reardeltflys', name: 'Rear Delt Flys', category: 'shoulders' },
                            { type: 'shoulderpress', name: 'Shoulder Press', category: 'shoulders' },
                            { type: 'shrugs', name: 'Shrugs', category: 'shoulders' }
                        ]
                    }
                };

                const categoryData = exerciseMap[categoryType];
                if (!categoryData) return;

                // Build modal HTML
                let modalHTML = `
                    <div class="overlay" id="exercise-modal-overlay" onclick="app.closeExerciseModal()" style="display: block;"></div>
                    <div class="customize-modal" id="exercise-modal" style="display: block; max-width: 400px;">
                        <div class="customize-modal-header">${categoryName} <button onclick="app.closeExerciseModal()" style="float: right; background: none; border: none; color: #e8e8e8; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;"></button></div>
                        <button onclick="app.selectActivity(${activityId}, '${categoryType}', '${categoryName}'); app.closeExerciseModal();" 
                                style="width: 100%; padding: 12px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; margin-bottom: 16px;">
                             Log "${categoryName}"
                        </button>
                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 12px; text-align: center;">Or track specific exercise:</div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                `;

                categoryData.exercises.forEach(ex => {
                    modalHTML += `
                        <div class="accordion-item" onclick="app.selectActivity(${activityId}, '${ex.type}', '${ex.name}', '${ex.category}'); app.closeExerciseModal();" style="cursor: pointer;">
                            ${ex.name}
                        </div>
                    `;
                });

                modalHTML += `
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            },

            // Close exercise modal
            closeExerciseModal() {
                const overlay = document.getElementById('exercise-modal-overlay');
                const modal = document.getElementById('exercise-modal');
                if (overlay) overlay.remove();
                if (modal) modal.remove();
            },

            // Select custom exercise (for custom categories)
            selectCustomExercise(activityId, categoryId, exerciseId, exerciseName, trackingType) {
                const exerciseKey = `custom-${categoryId}-${exerciseId}`;
                this.selectActivity(activityId, exerciseKey, exerciseName, `custom-${categoryId}`, trackingType);
            },

            // Select activity from accordion
            selectActivity(id, activityType, activityName, category, trackingType) {
                // Store the selected type
                const accordion = document.getElementById(`accordion-${id}`);
                accordion.dataset.selectedType = activityType;
                
                // Store category if provided (for new sub-exercises)
                if (category) {
                    accordion.dataset.selectedCategory = category;
                }
                
                // Store trackingType if provided (for custom exercises)
                if (trackingType) {
                    accordion.dataset.trackingType = trackingType;
                }
                
                // Update selected display
                const selectedDiv = document.getElementById(`selected-activity-${id}`);
                const selectedNameSpan = document.getElementById(`selected-name-${id}`);
                selectedDiv.style.display = 'block';
                selectedNameSpan.textContent = activityName;
                
                // Highlight selected item
                const allItems = accordion.querySelectorAll('.accordion-item');
                allItems.forEach(item => item.classList.remove('selected'));
                if (event && event.target) {
                    event.target.classList.add('selected');
                }
                
                // Close all accordions and sub-accordions
                const allContents = accordion.querySelectorAll('.accordion-content');
                const allHeaders = accordion.querySelectorAll('.accordion-header');
                const allSubContents = accordion.querySelectorAll('.sub-accordion-content');
                const allSubHeaders = accordion.querySelectorAll('.sub-accordion-header');
                allContents.forEach(c => c.classList.remove('active'));
                allHeaders.forEach(h => h.classList.remove('active'));
                allSubContents.forEach(c => c.classList.remove('active'));
                allSubHeaders.forEach(h => h.classList.remove('active'));
                
                // HIDE the entire accordion after selection (auto-collapse)
                accordion.style.display = 'none';
                
                // Update value inputs
                this.updateActivityInputs(id, activityType, trackingType);
            },

            // Re-open accordion to change selection
            reopenAccordion(id) {
                const accordion = document.getElementById(`accordion-${id}`);
                accordion.style.display = 'block';
            },

            // Cancel activity selection (for activity 1)
            cancelActivity(id) {
                const accordion = document.getElementById(`accordion-${id}`);
                const selectedDiv = document.getElementById(`selected-activity-${id}`);
                const valueContainer = document.getElementById(`value-input-${id}`);
                
                // Clear selected type
                delete accordion.dataset.selectedType;
                
                // Hide selected display
                selectedDiv.style.display = 'none';
                
                // Clear value input
                valueContainer.innerHTML = '';
                
                // Show accordion again
                accordion.style.display = 'block';
                
                // Remove selection highlights
                const allItems = accordion.querySelectorAll('.accordion-item');
                allItems.forEach(item => item.classList.remove('selected'));
            },

            // Update activity inputs based on type
            updateActivityInputs(id, activityType, trackingType) {
                const valueContainer = document.getElementById(`value-input-${id}`);
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                if (!activityType) {
                    valueContainer.innerHTML = '';
                    return;
                }
                
                // Handle custom exercises with explicit trackingType
                if (trackingType) {
                    if (trackingType === 'reps') {
                        valueContainer.innerHTML = `
                            <div class="activity-value-input">
                                <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                                <span class="unit">reps</span>
                            </div>
                        `;
                    } else if (trackingType === 'distance') {
                        valueContainer.innerHTML = `
                            <div class="activity-value-input">
                                <input type="number" step="0.1" placeholder="0.0" id="value-${id}" inputmode="decimal" />
                                <span class="unit">${unit}</span>
                            </div>
                        `;
                    } else if (trackingType === 'logday') {
                        // No input needed for log day
                        valueContainer.innerHTML = '';
                    }
                    return;
                }
                
                // For cardio activities (distance-based)
                if (['walk', 'run', 'dog', 'hiking', 'biking'].includes(activityType)) {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" step="0.1" placeholder="0.0" id="value-${id}" inputmode="decimal" />
                            <span class="unit">${unit}</span>
                        </div>
                    `;
                }
                // For stairs (floors)
                else if (activityType === 'stairs') {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                            <span class="unit">floors</span>
                        </div>
                    `;
                }
                // For steps
                else if (activityType === 'steps') {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                            <span class="unit">steps</span>
                        </div>
                    `;
                }
                // For exercises that track reps (all specific exercises + old ones)
                else if ([
                    // Old exercises (still supported for backwards compatibility)
                    'pushups', 'pullups', 'rollerabs', 'dips', 'squats', 'situps',
                    // New Arm exercises
                    'bicepcurls', 'forearmcurls', 'hammercurls', 'tricepdips', 'tricepsextensions',
                    // New Back exercises
                    'deadlifts', 'facepulls', 'latpulldowns', 'rows',
                    // New Chest exercises
                    'benchpress', 'chestflys', 'inclinepress',
                    // New Core exercises
                    'abwheelrollout', 'legraises', 'planks', 'russiantwists',
                    // New Glutes exercises
                    'bulgariansplitsquats', 'donkeykicks', 'glutebridges', 'hipthrusts', 'stepups',
                    // New Leg exercises
                    'calfraises', 'legpress', 'lunges', 'romaniandeadlifts',
                    // New Shoulder exercises
                    'frontraises', 'lateralraises', 'reardeltflys', 'shoulderpress', 'shrugs'
                ].includes(activityType)) {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                            <span class="unit">reps</span>
                        </div>
                    `;
                }
                // For workout days - no value input needed, but show nothing to avoid confusion
                else {
                    valueContainer.innerHTML = '';
                }
            },

            // Remove activity row
            removeActivity(id) {
                const activityCard = document.getElementById(`activity-${id}`);
                activityCard.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    activityCard.remove();
                }, 300);
            },

            // Save log
            saveLog() {
                const date = document.getElementById('log-date').value;
                if (!date) {
                    alert('Please select a date');
                    return;
                }

                const activities = [];
                const baseTimestamp = Date.now(); // Get timestamp once at start
                
                for (let i = 1; i <= this.activityCounter; i++) {
                    // Get type from accordion dataset (not from type-${i} element which doesn't exist)
                    const accordion = document.getElementById(`accordion-${i}`);
                    if (!accordion) continue;
                    
                    const type = accordion.dataset.selectedType;
                    if (!type) continue; // Skip if no activity selected

                    const activity = {
                        date: date,
                        type: type,
                        timestamp: new Date(baseTimestamp + i).toISOString() // Add i milliseconds to ensure uniqueness
                    };
                    
                    // Add category if it was stored (for new sub-exercises)
                    const category = accordion.dataset.selectedCategory;
                    if (category) {
                        activity.category = category;
                    }

                    // Get value for cardio and reps-based exercises
                    const valueElement = document.getElementById(`value-${i}`);
                    
                    // Get trackingType from accordion dataset (for custom exercises)
                    const trackingType = accordion.dataset.trackingType;
                    
                    // Define activities that REQUIRE a value
                    const requiresValue = [
                        'walk', 'run', 'dog', 'hiking', 'biking', 'stairs', 'steps',
                        // Old exercises
                        'pushups', 'pullups', 'rollerabs', 'dips', 'squats', 'situps',
                        // New exercises
                        'bicepcurls', 'forearmcurls', 'hammercurls', 'tricepdips', 'tricepsextensions',
                        'deadlifts', 'facepulls', 'latpulldowns', 'rows',
                        'benchpress', 'chestflys', 'inclinepress',
                        'abwheelrollout', 'legraises', 'planks', 'russiantwists',
                        'bulgariansplitsquats', 'donkeykicks', 'glutebridges', 'hipthrusts', 'stepups',
                        'calfraises', 'legpress', 'lunges', 'romaniandeadlifts',
                        'frontraises', 'lateralraises', 'reardeltflys', 'shoulderpress', 'shrugs'
                    ];
                    
                    // Check if custom exercise requires value based on trackingType
                    const isCustomExercise = type && type.startsWith('custom-');
                    const customRequiresValue = isCustomExercise && trackingType && (trackingType === 'reps' || trackingType === 'distance');
                    
                    if (valueElement) {
                        const value = parseFloat(valueElement.value);
                        if (value && value > 0) {
                            if (['walk', 'run', 'dog', 'hiking', 'biking'].includes(type)) {
                                // Convert to km for storage if in miles
                                activity.distance = this.data.goals.unitPreference === 'miles' ? value * 1.60934 : value;
                            } else if (type === 'stairs') {
                                activity.floors = value;
                            } else if (type === 'steps') {
                                activity.steps = value;
                            } else if (isCustomExercise && trackingType === 'distance') {
                                // Custom exercise with distance tracking
                                activity.distance = this.data.goals.unitPreference === 'miles' ? value * 1.60934 : value;
                            } else if (isCustomExercise && trackingType === 'reps') {
                                // Custom exercise with reps tracking
                                activity.reps = value;
                            } else if (requiresValue.includes(type)) {
                                // All other standard exercises use reps
                                activity.reps = value;
                            }
                        } else if (requiresValue.includes(type) || customRequiresValue) {
                            // ONLY skip if this activity type requires a value but none was entered
                            continue;
                        }
                    } else if (requiresValue.includes(type) || customRequiresValue) {
                        // No value element found, but activity requires value - skip it
                        continue;
                    }
                    // If we reach here, either:
                    // 1. Activity has a valid value, OR
                    // 2. Activity doesn't require a value (like Strength Days or custom logday exercises)

                    activities.push(activity);
                }

                if (activities.length === 0) {
                    alert('Please add at least one activity');
                    return;
                }

                // Add to data
                this.data.activities.push(...activities);
                this.saveData();

                // Sync to Firebase (PALS feature)
                this.syncMyStatsToFirebase();

                // Check for milestones
                this.checkMilestones();

                // Clear form
                document.getElementById('activities-container').innerHTML = '';
                this.activityCounter = 0;
                this.addActivityRow();

                // Update UI
                this.updateDashboard();
                this.renderCalendar();

                // Show success
                alert('Activity logged successfully!');
            },

            // Check for milestones
            checkMilestones() {
                const stats = this.calculateStats();
                const newMilestones = [];

                // Check mileage milestones (every 50)
                const milesAchieved = Math.floor(stats.totalDistance / 50) * 50;
                const lastMilageMilestone = this.data.milestones.filter(m => m.type === 'mileage').reduce((max, m) => Math.max(max, m.value), 0);
                
                if (milesAchieved > lastMilageMilestone && milesAchieved > 0) {
                    const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                    newMilestones.push({
                        type: 'mileage',
                        value: milesAchieved,
                        date: new Date().toISOString(),
                        icon: '',
                        title: `${milesAchieved} ${unit} Reached!`,
                        description: `You've logged ${milesAchieved} ${unit}. Keep up the great work!`
                    });
                }

                // Check strength day milestones (every 25 days)
                const strengthDaysAchieved = Math.floor(stats.totalStrengthDays / 25) * 25;
                const lastStrengthDayMilestone = this.data.milestones.filter(m => m.type === 'workout').reduce((max, m) => Math.max(max, m.value), 0);
                
                if (strengthDaysAchieved > lastStrengthDayMilestone && strengthDaysAchieved > 0) {
                    newMilestones.push({
                        type: 'workout',
                        value: strengthDaysAchieved,
                        date: new Date().toISOString(),
                        icon: '',
                        title: `${strengthDaysAchieved} Strength Days Completed!`,
                        description: `Amazing consistency! You've trained on ${strengthDaysAchieved} different days.`
                    });
                }

                // Add new milestones and show notification
                if (newMilestones.length > 0) {
                    this.data.milestones.push(...newMilestones);
                    this.saveData();
                    this.showMilestone(newMilestones[0]);
                }
            },

            // Show milestone notification
            showMilestone(milestone) {
                document.getElementById('milestone-icon').textContent = milestone.icon;
                document.getElementById('milestone-title').textContent = milestone.title;
                document.getElementById('milestone-description').textContent = milestone.description;
                document.getElementById('overlay').classList.add('show');
                document.getElementById('milestone-notification').classList.add('show');
            },

            // Close milestone
            closeMilestone() {
                document.getElementById('overlay').classList.remove('show');
                document.getElementById('milestone-notification').classList.remove('show');
            },

            // Calculate stats
            calculateStats() {
                const now = new Date();
                now.setHours(23, 59, 59, 999); // Set to end of today for comparisons
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                
                // ============================================
                // DATE PERIOD DEFINITIONS (v1.5.2)
                // ============================================
                
                // THIS CALENDAR WEEK (Sunday - Today)
                // For display: "This Week" toggle shows current calendar week progress
                const thisWeekStart = new Date(now);
                thisWeekStart.setDate(now.getDate() - now.getDay()); // This Sunday at midnight
                thisWeekStart.setHours(0, 0, 0, 0);
                
                // PREVIOUS CALENDAR WEEK (Last Sunday - Last Saturday)
                // For trending: Compare this week vs same full previous week
                const prevWeekStart = new Date(thisWeekStart);
                prevWeekStart.setDate(prevWeekStart.getDate() - 7); // Previous Sunday
                prevWeekStart.setHours(0, 0, 0, 0);
                
                const prevWeekEnd = new Date(thisWeekStart);
                prevWeekEnd.setDate(prevWeekEnd.getDate() - 1); // Last Saturday
                prevWeekEnd.setHours(23, 59, 59, 999);
                
                // ============================================
                // TRACKING VARIABLES
                // ============================================
                
                // Total (all-time)
                let totalDistance = 0;
                let totalSteps = 0;
                let totalPushups = 0;
                let totalPullups = 0;
                let totalRollerAbs = 0;
                let totalDips = 0;
                let totalSquats = 0;
                let totalSitups = 0;
                let totalBiking = 0;
                let totalDogWalk = 0;
                let totalHiking = 0;
                let totalRunning = 0;
                let totalWalking = 0;
                let totalStairs = 0;
                
                // This calendar week (for display)
                let thisWeekDistance = 0;
                let thisWeekSteps = 0;
                let thisWeekPushups = 0;
                let thisWeekPullups = 0;
                let thisWeekRollerAbs = 0;
                let thisWeekDips = 0;
                let thisWeekSquats = 0;
                let thisWeekSitups = 0;
                let thisWeekBiking = 0;
                let thisWeekDogWalk = 0;
                let thisWeekHiking = 0;
                let thisWeekRunning = 0;
                let thisWeekWalking = 0;
                let thisWeekStairs = 0;
                
                // Previous calendar week (for trending comparison)
                let prevWeekDistance = 0;
                let prevWeekSteps = 0;
                let prevWeekPushups = 0;
                let prevWeekPullups = 0;
                let prevWeekRollerAbs = 0;
                let prevWeekDips = 0;
                let prevWeekSquats = 0;
                let prevWeekSitups = 0;
                let prevWeekBiking = 0;
                let prevWeekDogWalk = 0;
                let prevWeekHiking = 0;
                let prevWeekRunning = 0;
                let prevWeekWalking = 0;
                let prevWeekStairs = 0;
                
                // Track unique strength days (Sets are better for counting unique days)
                let strengthDaysTotal = new Set();
                let strengthDaysThisWeek = new Set();
                let strengthDaysPrevWeek = new Set();
                
                // Track parent category days (for favorite cards)
                const parentCategoryDays = {
                    arm: { total: new Set(), thisWeek: new Set(), prevWeek: new Set() },
                    back: { total: new Set(), thisWeek: new Set(), prevWeek: new Set() },
                    chest: { total: new Set(), thisWeek: new Set(), prevWeek: new Set() },
                    core: { total: new Set(), thisWeek: new Set(), prevWeek: new Set() },
                    fullbody: { total: new Set(), thisWeek: new Set(), prevWeek: new Set() },
                    glutes: { total: new Set(), thisWeek: new Set(), prevWeek: new Set() },
                    leg: { total: new Set(), thisWeek: new Set(), prevWeek: new Set() },
                    shoulder: { total: new Set(), thisWeek: new Set(), prevWeek: new Set() },
                    stretch: { total: new Set(), thisWeek: new Set(), prevWeek: new Set() }
                };

                // ============================================
                // PROCESS ALL ACTIVITIES
                // ============================================
                this.data.activities.forEach(activity => {
                    // Parse date at noon to avoid timezone issues
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    
                    // Check which periods this activity belongs to
                    const isThisWeek = activityDate >= thisWeekStart && activityDate <= now;
                    const isPrevWeek = activityDate >= prevWeekStart && activityDate <= prevWeekEnd;
                    
                    // ========== DISTANCE ACTIVITIES ==========
                    if (activity.distance) {
                        totalDistance += activity.distance;
                        if (isThisWeek) thisWeekDistance += activity.distance;
                        if (isPrevWeek) prevWeekDistance += activity.distance;
                        
                        // Track by specific distance type
                        if (activity.type === 'biking') {
                            totalBiking += activity.distance;
                            if (isThisWeek) thisWeekBiking += activity.distance;
                            if (isPrevWeek) prevWeekBiking += activity.distance;
                        } else if (activity.type === 'dog') {
                            totalDogWalk += activity.distance;
                            if (isThisWeek) thisWeekDogWalk += activity.distance;
                            if (isPrevWeek) prevWeekDogWalk += activity.distance;
                        } else if (activity.type === 'hiking') {
                            totalHiking += activity.distance;
                            if (isThisWeek) thisWeekHiking += activity.distance;
                            if (isPrevWeek) prevWeekHiking += activity.distance;
                        } else if (activity.type === 'run') {
                            totalRunning += activity.distance;
                            if (isThisWeek) thisWeekRunning += activity.distance;
                            if (isPrevWeek) prevWeekRunning += activity.distance;
                        } else if (activity.type === 'walk') {
                            totalWalking += activity.distance;
                            if (isThisWeek) thisWeekWalking += activity.distance;
                            if (isPrevWeek) prevWeekWalking += activity.distance;
                        }
                    }

                    // ========== STAIRS (FLOORS) ==========
                    if (activity.floors) {
                        totalStairs += activity.floors;
                        if (isThisWeek) thisWeekStairs += activity.floors;
                        if (isPrevWeek) prevWeekStairs += activity.floors;
                    }

                    // ========== STEPS ==========
                    if (activity.steps) {
                        totalSteps += activity.steps;
                        if (isThisWeek) thisWeekSteps += activity.steps;
                        if (isPrevWeek) prevWeekSteps += activity.steps;
                    }

                    // ========== REPS (EXERCISES) ==========
                    if (activity.reps) {
                        if (activity.type === 'pushups') {
                            totalPushups += activity.reps;
                            if (isThisWeek) thisWeekPushups += activity.reps;
                            if (isPrevWeek) prevWeekPushups += activity.reps;
                        } else if (activity.type === 'pullups') {
                            totalPullups += activity.reps;
                            if (isThisWeek) thisWeekPullups += activity.reps;
                            if (isPrevWeek) prevWeekPullups += activity.reps;
                        } else if (activity.type === 'rollerabs' || activity.type === 'abwheelrollout') {
                            totalRollerAbs += activity.reps;
                            if (isThisWeek) thisWeekRollerAbs += activity.reps;
                            if (isPrevWeek) prevWeekRollerAbs += activity.reps;
                        } else if (activity.type === 'dips') {
                            totalDips += activity.reps;
                            if (isThisWeek) thisWeekDips += activity.reps;
                            if (isPrevWeek) prevWeekDips += activity.reps;
                        } else if (activity.type === 'squats') {
                            totalSquats += activity.reps;
                            if (isThisWeek) thisWeekSquats += activity.reps;
                            if (isPrevWeek) prevWeekSquats += activity.reps;
                        } else if (activity.type === 'situps') {
                            totalSitups += activity.reps;
                            if (isThisWeek) thisWeekSitups += activity.reps;
                            if (isPrevWeek) prevWeekSitups += activity.reps;
                        }
                    }

                    // ========== PARENT CATEGORY TRACKING (for favorite cards) ==========
                    // Track days when each parent category was logged
                    if (['arm', 'back', 'chest', 'core', 'fullbody', 'glutes', 'leg', 'shoulder', 'stretch'].includes(activity.type)) {
                        parentCategoryDays[activity.type].total.add(activity.date);
                        if (isThisWeek) parentCategoryDays[activity.type].thisWeek.add(activity.date);
                        if (isPrevWeek) parentCategoryDays[activity.type].prevWeek.add(activity.date);
                    }
                    // Also track if this is a sub-exercise (e.g., 'arm-bicep-curls' with category='arm')
                    if (activity.category && ['arm', 'back', 'chest', 'core', 'glutes', 'legs', 'shoulder'].includes(activity.category)) {
                        const cat = activity.category === 'legs' ? 'leg' : activity.category;
                        parentCategoryDays[cat].total.add(activity.date);
                        if (isThisWeek) parentCategoryDays[cat].thisWeek.add(activity.date);
                        if (isPrevWeek) parentCategoryDays[cat].prevWeek.add(activity.date);
                    }

                    // ========== STRENGTH DAYS ==========
                    // Count days with 2+ strength exercises (parent categories OR sub-exercises with category='strength')
                    // We'll process this after the loop to check the count per day
                });

                // ============================================
                // COUNT STRENGTH DAYS (2+ exercises per day)
                // ============================================
                const strengthExercisesByDate = {
                    total: {},
                    thisWeek: {},
                    prevWeek: {}
                };
                
                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    const isThisWeek = activityDate >= thisWeekStart && activityDate <= now;
                    const isPrevWeek = activityDate >= prevWeekStart && activityDate <= prevWeekEnd;
                    
                    // Check if this is a strength activity (parent category OR sub-exercise)
                    const isStrengthParent = ['arm', 'back', 'chest', 'core', 'fullbody', 'glutes', 'leg', 'shoulder'].includes(activity.type);
                    const isStrengthSub = activity.category && ['arm', 'back', 'chest', 'core', 'glutes', 'legs', 'shoulder'].includes(activity.category);
                    
                    if (isStrengthParent || isStrengthSub) {
                        // Count exercises per date
                        if (!strengthExercisesByDate.total[activity.date]) {
                            strengthExercisesByDate.total[activity.date] = 0;
                        }
                        strengthExercisesByDate.total[activity.date]++;
                        
                        if (isThisWeek) {
                            if (!strengthExercisesByDate.thisWeek[activity.date]) {
                                strengthExercisesByDate.thisWeek[activity.date] = 0;
                            }
                            strengthExercisesByDate.thisWeek[activity.date]++;
                        }
                        
                        if (isPrevWeek) {
                            if (!strengthExercisesByDate.prevWeek[activity.date]) {
                                strengthExercisesByDate.prevWeek[activity.date] = 0;
                            }
                            strengthExercisesByDate.prevWeek[activity.date]++;
                        }
                    }
                });
                
                // Only count days with 2+ exercises
                Object.keys(strengthExercisesByDate.total).forEach(date => {
                    if (strengthExercisesByDate.total[date] >= 2) {
                        strengthDaysTotal.add(date);
                    }
                });
                
                Object.keys(strengthExercisesByDate.thisWeek).forEach(date => {
                    if (strengthExercisesByDate.thisWeek[date] >= 2) {
                        strengthDaysThisWeek.add(date);
                    }
                });
                
                Object.keys(strengthExercisesByDate.prevWeek).forEach(date => {
                    if (strengthExercisesByDate.prevWeek[date] >= 2) {
                        strengthDaysPrevWeek.add(date);
                    }
                });

                // ============================================
                // CONVERT KM TO MILES (if needed)
                // ============================================
                if (this.data.goals.unitPreference === 'miles') {
                    const KM_TO_MILES = 1.60934;
                    
                    // Total
                    totalDistance = totalDistance / KM_TO_MILES;
                    totalBiking = totalBiking / KM_TO_MILES;
                    totalDogWalk = totalDogWalk / KM_TO_MILES;
                    totalHiking = totalHiking / KM_TO_MILES;
                    totalRunning = totalRunning / KM_TO_MILES;
                    totalWalking = totalWalking / KM_TO_MILES;
                    
                    // This Week
                    thisWeekDistance = thisWeekDistance / KM_TO_MILES;
                    thisWeekBiking = thisWeekBiking / KM_TO_MILES;
                    thisWeekDogWalk = thisWeekDogWalk / KM_TO_MILES;
                    thisWeekHiking = thisWeekHiking / KM_TO_MILES;
                    thisWeekRunning = thisWeekRunning / KM_TO_MILES;
                    thisWeekWalking = thisWeekWalking / KM_TO_MILES;
                    
                    // Previous Week
                    prevWeekDistance = prevWeekDistance / KM_TO_MILES;
                    prevWeekBiking = prevWeekBiking / KM_TO_MILES;
                    prevWeekDogWalk = prevWeekDogWalk / KM_TO_MILES;
                    prevWeekHiking = prevWeekHiking / KM_TO_MILES;
                    prevWeekRunning = prevWeekRunning / KM_TO_MILES;
                    prevWeekWalking = prevWeekWalking / KM_TO_MILES;
                }

                // ============================================
                // RETURN ALL CALCULATED STATS
                // ============================================
                return {
                    // Distance (rounded to 1 decimal)
                    totalDistance: Math.round(totalDistance * 10) / 10,
                    thisWeekDistance: Math.round(thisWeekDistance * 10) / 10,
                    prevWeekDistance: Math.round(prevWeekDistance * 10) / 10,
                    
                    // Steps (whole numbers)
                    totalSteps,
                    thisWeekSteps,
                    prevWeekSteps,
                    
                    // Exercises - Reps (whole numbers)
                    totalPushups,
                    thisWeekPushups,
                    prevWeekPushups,
                    totalPullups,
                    thisWeekPullups,
                    prevWeekPullups,
                    totalRollerAbs,
                    thisWeekRollerAbs,
                    prevWeekRollerAbs,
                    totalDips,
                    thisWeekDips,
                    prevWeekDips,
                    totalSquats,
                    thisWeekSquats,
                    prevWeekSquats,
                    totalSitups,
                    thisWeekSitups,
                    prevWeekSitups,
                    
                    // Distance by Type (rounded to 1 decimal)
                    totalBiking: Math.round(totalBiking * 10) / 10,
                    thisWeekBiking: Math.round(thisWeekBiking * 10) / 10,
                    prevWeekBiking: Math.round(prevWeekBiking * 10) / 10,
                    totalDogWalk: Math.round(totalDogWalk * 10) / 10,
                    thisWeekDogWalk: Math.round(thisWeekDogWalk * 10) / 10,
                    prevWeekDogWalk: Math.round(prevWeekDogWalk * 10) / 10,
                    totalHiking: Math.round(totalHiking * 10) / 10,
                    thisWeekHiking: Math.round(thisWeekHiking * 10) / 10,
                    prevWeekHiking: Math.round(prevWeekHiking * 10) / 10,
                    totalRunning: Math.round(totalRunning * 10) / 10,
                    thisWeekRunning: Math.round(thisWeekRunning * 10) / 10,
                    prevWeekRunning: Math.round(prevWeekRunning * 10) / 10,
                    totalWalking: Math.round(totalWalking * 10) / 10,
                    thisWeekWalking: Math.round(thisWeekWalking * 10) / 10,
                    prevWeekWalking: Math.round(prevWeekWalking * 10) / 10,
                    
                    // Stairs (whole numbers)
                    totalStairs,
                    thisWeekStairs,
                    prevWeekStairs,
                    
                    // Strength Days (count of unique days)
                    totalStrengthDays: strengthDaysTotal.size,
                    thisWeekStrengthDays: strengthDaysThisWeek.size,
                    prevWeekStrengthDays: strengthDaysPrevWeek.size,
                    
                    // Parent Category Days (for favorite cards)
                    armDays: parentCategoryDays.arm.total.size,
                    thisWeekArmDays: parentCategoryDays.arm.thisWeek.size,
                    prevWeekArmDays: parentCategoryDays.arm.prevWeek.size,
                    backDays: parentCategoryDays.back.total.size,
                    thisWeekBackDays: parentCategoryDays.back.thisWeek.size,
                    prevWeekBackDays: parentCategoryDays.back.prevWeek.size,
                    chestDays: parentCategoryDays.chest.total.size,
                    thisWeekChestDays: parentCategoryDays.chest.thisWeek.size,
                    prevWeekChestDays: parentCategoryDays.chest.prevWeek.size,
                    coreDays: parentCategoryDays.core.total.size,
                    thisWeekCoreDays: parentCategoryDays.core.thisWeek.size,
                    prevWeekCoreDays: parentCategoryDays.core.prevWeek.size,
                    fullbodyDays: parentCategoryDays.fullbody.total.size,
                    thisWeekFullbodyDays: parentCategoryDays.fullbody.thisWeek.size,
                    prevWeekFullbodyDays: parentCategoryDays.fullbody.prevWeek.size,
                    glutesDays: parentCategoryDays.glutes.total.size,
                    thisWeekGlutesDays: parentCategoryDays.glutes.thisWeek.size,
                    prevWeekGlutesDays: parentCategoryDays.glutes.prevWeek.size,
                    legDays: parentCategoryDays.leg.total.size,
                    thisWeekLegDays: parentCategoryDays.leg.thisWeek.size,
                    prevWeekLegDays: parentCategoryDays.leg.prevWeek.size,
                    shoulderDays: parentCategoryDays.shoulder.total.size,
                    thisWeekShoulderDays: parentCategoryDays.shoulder.thisWeek.size,
                    prevWeekShoulderDays: parentCategoryDays.shoulder.prevWeek.size,
                    stretchDays: parentCategoryDays.stretch.total.size,
                    thisWeekStretchDays: parentCategoryDays.stretch.thisWeek.size,
                    prevWeekStretchDays: parentCategoryDays.stretch.prevWeek.size,
                    
                    // Weight data
                    currentWeight: this.getWeightStats().current
                };
            },

            // Calculate stats for a custom exercise
            getCustomExerciseStats(categoryId, exerciseId) {
                const now = new Date();
                now.setHours(23, 59, 59, 999);
                
                // THIS CALENDAR WEEK (Sunday - Today)
                const thisWeekStart = new Date(now);
                thisWeekStart.setDate(now.getDate() - now.getDay());
                thisWeekStart.setHours(0, 0, 0, 0);
                
                // PREVIOUS CALENDAR WEEK (Last Sunday - Last Saturday)
                const prevWeekStart = new Date(thisWeekStart);
                prevWeekStart.setDate(prevWeekStart.getDate() - 7);
                prevWeekStart.setHours(0, 0, 0, 0);
                
                const prevWeekEnd = new Date(thisWeekStart);
                prevWeekEnd.setDate(prevWeekEnd.getDate() - 1);
                prevWeekEnd.setHours(23, 59, 59, 999);
                
                let total = 0;
                let thisWeek = 0;
                let prevWeek = 0;
                const uniqueDaysTotal = new Set();
                const uniqueDaysThisWeek = new Set();
                const uniqueDaysPrevWeek = new Set();
                
                // Get exercise to check trackingType
                let exerciseTrackingType = 'reps';
                const category = this.data.customCategories?.find(c => c.id === categoryId);
                if (category) {
                    const exercise = category.exercises?.find(e => e.id === exerciseId);
                    if (exercise) exerciseTrackingType = exercise.trackingType;
                }
                
                // Build the key we're looking for
                const customKey = `custom-${categoryId}-${exerciseId}`;
                
                // Sum up values for this custom exercise
                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T00:00:00');
                    
                    if (activity.type === customKey) {
                        if (exerciseTrackingType === 'logday') {
                            // Count unique days
                            uniqueDaysTotal.add(activity.date);
                            if (activityDate >= thisWeekStart && activityDate <= now) {
                                uniqueDaysThisWeek.add(activity.date);
                            }
                            if (activityDate >= prevWeekStart && activityDate <= prevWeekEnd) {
                                uniqueDaysPrevWeek.add(activity.date);
                            }
                        } else if (exerciseTrackingType === 'distance' && activity.distance) {
                            // Sum distance
                            const value = parseFloat(activity.distance) || 0;
                            total += value;
                            
                            if (activityDate >= thisWeekStart && activityDate <= now) {
                                thisWeek += value;
                            }
                            
                            if (activityDate >= prevWeekStart && activityDate <= prevWeekEnd) {
                                prevWeek += value;
                            }
                        } else if (exerciseTrackingType === 'reps' && activity.reps) {
                            // Sum reps
                            const value = parseFloat(activity.reps) || 0;
                            total += value;
                            
                            if (activityDate >= thisWeekStart && activityDate <= now) {
                                thisWeek += value;
                            }
                            
                            if (activityDate >= prevWeekStart && activityDate <= prevWeekEnd) {
                                prevWeek += value;
                            }
                        }
                    }
                });
                
                // Return days for logday, values for reps/distance
                if (exerciseTrackingType === 'logday') {
                    return { 
                        total: uniqueDaysTotal.size, 
                        thisWeek: uniqueDaysThisWeek.size, 
                        prevWeek: uniqueDaysPrevWeek.size 
                    };
                } else if (exerciseTrackingType === 'distance') {
                    // Convert km to miles if user preference is miles
                    const KM_TO_MILES = 1.60934;
                    if (this.data.goals.unitPreference === 'miles') {
                        return {
                            total: Math.round((total / KM_TO_MILES) * 10) / 10,
                            thisWeek: Math.round((thisWeek / KM_TO_MILES) * 10) / 10,
                            prevWeek: Math.round((prevWeek / KM_TO_MILES) * 10) / 10
                        };
                    } else {
                        return { total, thisWeek, prevWeek };
                    }
                } else {
                    // Reps - return as-is
                    return { total, thisWeek, prevWeek };
                }
            },

            // Update dashboard (FIXED: toggle buttons sync with data + custom cards)
            updateDashboard() {
                const stats = this.calculateStats();
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                const isWeekView = this.data.currentView.statsView === 'week';
                
                // FIX: Update toggle buttons to match current view
                document.querySelectorAll('.stats-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (isWeekView) {
                    document.querySelector('.stats-toggle-btn:first-child').classList.add('active');
                } else {
                    document.querySelector('.stats-toggle-btn:last-child').classList.add('active');
                }

                // ========== FIXED CARDS (Miles, Strength Days, Steps) ==========
                const milesValue = isWeekView ? stats.thisWeekDistance : stats.totalDistance;
                const workoutsValue = isWeekView ? stats.thisWeekStrengthDays : stats.totalStrengthDays;
                const stepsValue = isWeekView ? stats.thisWeekSteps : stats.totalSteps;
                
                // Animate numbers
                this.animateCountUp(document.getElementById('stat-miles'), milesValue);
                this.animateCountUp(document.getElementById('stat-workouts'), workoutsValue);
                this.animateCountUp(document.getElementById('stat-steps'), stepsValue);

                // ========== TRENDING ARROWS (Week View Only) ==========
                if (isWeekView) {
                    // v1.5.2: Compare THIS WEEK vs PREVIOUS CALENDAR WEEK
                    // Only show arrow if current value > 0
                    const milesTrend = milesValue > 0 ? this.getTrendIndicator(milesValue, stats.prevWeekDistance) : '';
                    const workoutsTrend = workoutsValue > 0 ? this.getTrendIndicator(workoutsValue, stats.prevWeekStrengthDays) : '';
                    const stepsTrend = stepsValue > 0 ? this.getTrendIndicator(stepsValue, stats.prevWeekSteps) : '';
                    
                    document.getElementById('stat-miles-label').textContent = `Distance (${unit})`;
                    document.getElementById('stat-workouts-label').textContent = 'Strength Days';
                    document.getElementById('stat-steps-label').textContent = 'Steps';
                    
                    document.getElementById('stat-miles-trend').innerHTML = milesTrend;
                    document.getElementById('stat-workouts-trend').innerHTML = workoutsTrend;
                    document.getElementById('stat-steps-trend').innerHTML = stepsTrend;
                } else {
                    // All Time view: No trends
                    document.getElementById('stat-miles-label').textContent = `Distance (${unit})`;
                    document.getElementById('stat-workouts-label').textContent = 'Strength Days';
                    document.getElementById('stat-steps-label').textContent = 'Steps';
                    
                    document.getElementById('stat-miles-trend').innerHTML = '';
                    document.getElementById('stat-workouts-trend').innerHTML = '';
                    document.getElementById('stat-steps-trend').innerHTML = '';
                }

                // ROW 2: Update custom cards based on user preferences
                this.renderCustomCards(stats, isWeekView);

                // Render comparison bar graphs
                this.renderBarGraphs(stats);

                // Update weight summary
                this.updateWeightSummary();

                // Annual progress (always total)
                const annualGoal = this.data.goals.annualMiles;
                const progress = Math.min(100, Math.round((stats.totalDistance / annualGoal) * 100));
                document.getElementById('annual-progress-percent').textContent = `${progress}%`;
                document.getElementById('annual-progress-bar').style.width = `${progress}%`;
                document.getElementById('annual-progress-current').textContent = `${stats.totalDistance} ${unit}`;
                document.getElementById('annual-progress-goal').textContent = `${annualGoal} ${unit}`;

                // Recent milestones
                const milestoneList = document.getElementById('milestone-list');
                if (this.data.milestones.length === 0) {
                    milestoneList.innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 14px;">No milestones yet. Keep going!</p>';
                } else {
                    const recentMilestones = this.data.milestones.slice(-5).reverse();
                    milestoneList.innerHTML = recentMilestones.map(m => `
                        <div class="milestone-item">
                            <div class="milestone-icon">${m.icon}</div>
                            <div class="milestone-text">${m.title}</div>
                        </div>
                    `).join('');
                }
            },

            // Render custom dashboard cards (Row 2)
            renderCustomCards(stats, isWeekView) {
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                // v1.5.2: Map stat names to their values (thisWeek for display, prevWeek for trending)
                const statMap = {
                    // Rep-based exercises
                    'pushups': {
                        label: 'Push-ups',
                        thisWeekValue: stats.thisWeekPushups,
                        prevWeekValue: stats.prevWeekPushups,
                        totalValue: stats.totalPushups
                    },
                    'pullups': {
                        label: 'Pull-ups',
                        thisWeekValue: stats.thisWeekPullups,
                        prevWeekValue: stats.prevWeekPullups,
                        totalValue: stats.totalPullups
                    },
                    'rollerabs': {
                        label: 'Ab Wheel Rollout',
                        thisWeekValue: stats.thisWeekRollerAbs,
                        prevWeekValue: stats.prevWeekRollerAbs,
                        totalValue: stats.totalRollerAbs
                    },
                    'dips': {
                        label: 'Dips',
                        thisWeekValue: stats.thisWeekDips,
                        prevWeekValue: stats.prevWeekDips,
                        totalValue: stats.totalDips
                    },
                    'squats': {
                        label: 'Squats',
                        thisWeekValue: stats.thisWeekSquats,
                        prevWeekValue: stats.prevWeekSquats,
                        totalValue: stats.totalSquats
                    },
                    'situps': {
                        label: 'Sit-ups',
                        thisWeekValue: stats.thisWeekSitups,
                        prevWeekValue: stats.prevWeekSitups,
                        totalValue: stats.totalSitups
                    },
                    // Distance-based activities
                    'biking': {
                        label: `Biking (${unit})`,
                        thisWeekValue: stats.thisWeekBiking,
                        prevWeekValue: stats.prevWeekBiking,
                        totalValue: stats.totalBiking
                    },
                    'dog': {
                        label: `Dog Walking (${unit})`,
                        thisWeekValue: stats.thisWeekDogWalk,
                        prevWeekValue: stats.prevWeekDogWalk,
                        totalValue: stats.totalDogWalk
                    },
                    'hiking': {
                        label: `Hiking (${unit})`,
                        thisWeekValue: stats.thisWeekHiking,
                        prevWeekValue: stats.prevWeekHiking,
                        totalValue: stats.totalHiking
                    },
                    'run': {
                        label: `Running (${unit})`,
                        thisWeekValue: stats.thisWeekRunning,
                        prevWeekValue: stats.prevWeekRunning,
                        totalValue: stats.totalRunning
                    },
                    'walk': {
                        label: `Walking (${unit})`,
                        thisWeekValue: stats.thisWeekWalking,
                        prevWeekValue: stats.prevWeekWalking,
                        totalValue: stats.totalWalking
                    },
                    'stairs': {
                        label: 'Stairs (floors)',
                        thisWeekValue: stats.thisWeekStairs,
                        prevWeekValue: stats.prevWeekStairs,
                        totalValue: stats.totalStairs
                    },
                    
                    // ========== PARENT CATEGORIES (day counts) ==========
                    'arm': {
                        label: 'Arm Day',
                        thisWeekValue: stats.thisWeekArmDays,
                        prevWeekValue: stats.prevWeekArmDays,
                        totalValue: stats.armDays
                    },
                    'back': {
                        label: 'Back Day',
                        thisWeekValue: stats.thisWeekBackDays,
                        prevWeekValue: stats.prevWeekBackDays,
                        totalValue: stats.backDays
                    },
                    'chest': {
                        label: 'Chest Day',
                        thisWeekValue: stats.thisWeekChestDays,
                        prevWeekValue: stats.prevWeekChestDays,
                        totalValue: stats.chestDays
                    },
                    'core': {
                        label: 'Core Day',
                        thisWeekValue: stats.thisWeekCoreDays,
                        prevWeekValue: stats.prevWeekCoreDays,
                        totalValue: stats.coreDays
                    },
                    'fullbody': {
                        label: 'Full Body Day',
                        thisWeekValue: stats.thisWeekFullbodyDays,
                        prevWeekValue: stats.prevWeekFullbodyDays,
                        totalValue: stats.fullbodyDays
                    },
                    'glutes': {
                        label: 'Glutes Day',
                        thisWeekValue: stats.thisWeekGlutesDays,
                        prevWeekValue: stats.prevWeekGlutesDays,
                        totalValue: stats.glutesDays
                    },
                    'leg': {
                        label: 'Leg Day',
                        thisWeekValue: stats.thisWeekLegDays,
                        prevWeekValue: stats.prevWeekLegDays,
                        totalValue: stats.legDays
                    },
                    'shoulder': {
                        label: 'Shoulder Day',
                        thisWeekValue: stats.thisWeekShoulderDays,
                        prevWeekValue: stats.prevWeekShoulderDays,
                        totalValue: stats.shoulderDays
                    },
                    'stretch': {
                        label: 'Stretch Day',
                        thisWeekValue: stats.thisWeekStretchDays,
                        prevWeekValue: stats.prevWeekStretchDays,
                        totalValue: stats.stretchDays
                    },
                    
                    // ========== SUB-EXERCISES (mapped to parent stats - same as parent for now) ==========
                    // Arm Day sub-exercises
                    'arm-bicep-curls': { label: 'Bicep Curls', thisWeekValue: stats.thisWeekArmDays, prevWeekValue: stats.prevWeekArmDays, totalValue: stats.armDays },
                    'arm-forearm-curls': { label: 'Forearm Curls', thisWeekValue: stats.thisWeekArmDays, prevWeekValue: stats.prevWeekArmDays, totalValue: stats.armDays },
                    'arm-hammer-curls': { label: 'Hammer Curls', thisWeekValue: stats.thisWeekArmDays, prevWeekValue: stats.prevWeekArmDays, totalValue: stats.armDays },
                    'arm-tricep-dips': { label: 'Tricep Dips', thisWeekValue: stats.thisWeekArmDays, prevWeekValue: stats.prevWeekArmDays, totalValue: stats.armDays },
                    'arm-triceps-extensions': { label: 'Triceps Extensions', thisWeekValue: stats.thisWeekArmDays, prevWeekValue: stats.prevWeekArmDays, totalValue: stats.armDays },
                    // Back Day sub-exercises
                    'back-deadlifts': { label: 'Deadlifts', thisWeekValue: stats.thisWeekBackDays, prevWeekValue: stats.prevWeekBackDays, totalValue: stats.backDays },
                    'back-face-pulls': { label: 'Face Pulls', thisWeekValue: stats.thisWeekBackDays, prevWeekValue: stats.prevWeekBackDays, totalValue: stats.backDays },
                    'back-lat-pulldowns': { label: 'Lat Pulldowns', thisWeekValue: stats.thisWeekBackDays, prevWeekValue: stats.prevWeekBackDays, totalValue: stats.backDays },
                    'back-pullups': { label: 'Pull-ups', thisWeekValue: stats.thisWeekPullups, prevWeekValue: stats.prevWeekPullups, totalValue: stats.totalPullups },
                    'back-rows': { label: 'Rows', thisWeekValue: stats.thisWeekBackDays, prevWeekValue: stats.prevWeekBackDays, totalValue: stats.backDays },
                    // Chest Day sub-exercises
                    'chest-bench-press': { label: 'Bench Press', thisWeekValue: stats.thisWeekChestDays, prevWeekValue: stats.prevWeekChestDays, totalValue: stats.chestDays },
                    'chest-chest-flys': { label: 'Chest Flys', thisWeekValue: stats.thisWeekChestDays, prevWeekValue: stats.prevWeekChestDays, totalValue: stats.chestDays },
                    'chest-dips': { label: 'Dips', thisWeekValue: stats.thisWeekDips, prevWeekValue: stats.prevWeekDips, totalValue: stats.totalDips },
                    'chest-incline-press': { label: 'Incline Press', thisWeekValue: stats.thisWeekChestDays, prevWeekValue: stats.prevWeekChestDays, totalValue: stats.chestDays },
                    'chest-pushups': { label: 'Push-ups', thisWeekValue: stats.thisWeekPushups, prevWeekValue: stats.prevWeekPushups, totalValue: stats.totalPushups },
                    // Core Day sub-exercises
                    'core-ab-wheel-rollout': { label: 'Ab Wheel Rollout', thisWeekValue: stats.thisWeekRollerAbs, prevWeekValue: stats.prevWeekRollerAbs, totalValue: stats.totalRollerAbs },
                    'core-leg-raises': { label: 'Leg Raises', thisWeekValue: stats.thisWeekCoreDays, prevWeekValue: stats.prevWeekCoreDays, totalValue: stats.coreDays },
                    'core-planks': { label: 'Planks', thisWeekValue: stats.thisWeekCoreDays, prevWeekValue: stats.prevWeekCoreDays, totalValue: stats.coreDays },
                    'core-russian-twists': { label: 'Russian Twists', thisWeekValue: stats.thisWeekCoreDays, prevWeekValue: stats.prevWeekCoreDays, totalValue: stats.coreDays },
                    'core-situps': { label: 'Sit-ups', thisWeekValue: stats.thisWeekSitups, prevWeekValue: stats.prevWeekSitups, totalValue: stats.totalSitups },
                    // Glutes Day sub-exercises
                    'glutes-bulgarian-split-squats': { label: 'Bulgarian Split Squats', thisWeekValue: stats.thisWeekGlutesDays, prevWeekValue: stats.prevWeekGlutesDays, totalValue: stats.glutesDays },
                    'glutes-donkey-kicks': { label: 'Donkey Kicks', thisWeekValue: stats.thisWeekGlutesDays, prevWeekValue: stats.prevWeekGlutesDays, totalValue: stats.glutesDays },
                    'glutes-glute-bridges': { label: 'Glute Bridges', thisWeekValue: stats.thisWeekGlutesDays, prevWeekValue: stats.prevWeekGlutesDays, totalValue: stats.glutesDays },
                    'glutes-hip-thrusts': { label: 'Hip Thrusts', thisWeekValue: stats.thisWeekGlutesDays, prevWeekValue: stats.prevWeekGlutesDays, totalValue: stats.glutesDays },
                    'glutes-step-ups': { label: 'Step-ups', thisWeekValue: stats.thisWeekGlutesDays, prevWeekValue: stats.prevWeekGlutesDays, totalValue: stats.glutesDays },
                    // Leg Day sub-exercises
                    'legs-calf-raises': { label: 'Calf Raises', thisWeekValue: stats.thisWeekLegDays, prevWeekValue: stats.prevWeekLegDays, totalValue: stats.legDays },
                    'legs-leg-press': { label: 'Leg Press', thisWeekValue: stats.thisWeekLegDays, prevWeekValue: stats.prevWeekLegDays, totalValue: stats.legDays },
                    'legs-lunges': { label: 'Lunges', thisWeekValue: stats.thisWeekLegDays, prevWeekValue: stats.prevWeekLegDays, totalValue: stats.legDays },
                    'legs-romanian-deadlifts': { label: 'Romanian Deadlifts', thisWeekValue: stats.thisWeekLegDays, prevWeekValue: stats.prevWeekLegDays, totalValue: stats.legDays },
                    'legs-squats': { label: 'Squats', thisWeekValue: stats.thisWeekSquats, prevWeekValue: stats.prevWeekSquats, totalValue: stats.totalSquats },
                    // Shoulder Day sub-exercises
                    'shoulder-front-raises': { label: 'Front Raises', thisWeekValue: stats.thisWeekShoulderDays, prevWeekValue: stats.prevWeekShoulderDays, totalValue: stats.shoulderDays },
                    'shoulder-lateral-raises': { label: 'Lateral Raises', thisWeekValue: stats.thisWeekShoulderDays, prevWeekValue: stats.prevWeekShoulderDays, totalValue: stats.shoulderDays },
                    'shoulder-rear-delt-flys': { label: 'Rear Delt Flys', thisWeekValue: stats.thisWeekShoulderDays, prevWeekValue: stats.prevWeekShoulderDays, totalValue: stats.shoulderDays },
                    'shoulder-shoulder-press': { label: 'Shoulder Press', thisWeekValue: stats.thisWeekShoulderDays, prevWeekValue: stats.prevWeekShoulderDays, totalValue: stats.shoulderDays },
                    'shoulder-shrugs': { label: 'Shrugs', thisWeekValue: stats.thisWeekShoulderDays, prevWeekValue: stats.prevWeekShoulderDays, totalValue: stats.shoulderDays }
                };

                // ========== ADD CUSTOM CATEGORY EXERCISES TO STAT MAP ==========
                if (this.data.customCategories && this.data.customCategories.length > 0) {
                    this.data.customCategories.forEach(category => {
                        if (category.exercises && category.exercises.length > 0) {
                            category.exercises.forEach(ex => {
                                const key = `custom-${category.id}-${ex.id}`;
                                // Calculate stats for this custom exercise
                                const customStats = this.getCustomExerciseStats(category.id, ex.id);
                                statMap[key] = {
                                    label: ex.name,
                                    thisWeekValue: customStats.thisWeek || 0,
                                    prevWeekValue: customStats.prevWeek || 0,
                                    totalValue: customStats.total || 0
                                };
                            });
                        }
                    });
                }

                // ========== RENDER EACH CUSTOM CARD ==========
                for (let i = 0; i < 3; i++) {
                    const cardType = this.data.customDashboardCards[i];
                    const cardData = statMap[cardType];
                    
                    if (cardData) {
                        // Display value: this week or all time (with fallback to 0)
                        const value = isWeekView ? (cardData.thisWeekValue || 0) : (cardData.totalValue || 0);
                        const element = document.getElementById(`custom-stat-${i + 1}`);
                        const labelElement = document.getElementById(`custom-label-${i + 1}`);
                        const trendElement = document.getElementById(`custom-trend-${i + 1}`);
                        
                        // Animate the display value
                        this.animateCountUp(element, value);
                        
                        // Set label with unit for distance-based custom exercises
                        let displayLabel = cardData.label;
                        
                        // Check if this is a custom exercise with distance tracking
                        if (cardType && cardType.startsWith('custom-')) {
                            const parts = cardType.split('-');
                            if (parts.length === 3) {
                                const categoryId = parseInt(parts[1]);
                                const exerciseId = parseInt(parts[2]);
                                const category = this.data.customCategories?.find(c => c.id === categoryId);
                                if (category) {
                                    const exercise = category.exercises?.find(e => e.id === exerciseId);
                                    if (exercise && exercise.trackingType === 'distance') {
                                        const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                                        displayLabel = `${cardData.label} (${unit})`;
                                    }
                                }
                            }
                        }
                        
                        labelElement.textContent = displayLabel;
                        
                        // ========== TRENDING (Week View Only) ==========
                        if (isWeekView) {
                            // Special handling for weight card
                            if (cardType === 'weight' && value > 0) {
                                const weightStats = this.getWeightStats();
                                let trendHTML = '';
                                if (weightStats.trend === 'up') {
                                    trendHTML = '<span class="trend-indicator up" style="font-size: 10px;"></span>';
                                } else if (weightStats.trend === 'down') {
                                    trendHTML = '<span class="trend-indicator down" style="font-size: 10px;"></span>';
                                } else if (weightStats.trend === 'stable') {
                                    trendHTML = '<span class="trend-indicator stable" style="font-size: 10px;"></span>';
                                }
                                trendElement.innerHTML = trendHTML;
                            } else {
                                // v1.5.2: Compare THIS WEEK vs PREVIOUS WEEK
                                const trendHTML = value > 0 ? this.getTrendIndicator(value, cardData.prevWeekValue || 0) : '';
                                trendElement.innerHTML = trendHTML;
                            }
                        } else {
                            // All Time view: No trends
                            trendElement.innerHTML = '';
                        }
                    }
                }
            },

            // Open customize modal
            openCustomizeModal() {
                // Add custom category exercises to dropdowns dynamically
                this.populateCustomCategoriesInDropdowns();
                
                // Set current selections in dropdowns
                for (let i = 0; i < 3; i++) {
                    const select = document.getElementById(`custom-slot-${i + 1}`);
                    select.value = this.data.customDashboardCards[i];
                }
                
                document.getElementById('customize-overlay').classList.add('show');
                document.getElementById('customize-modal').classList.add('show');
            },

            // Populate custom category exercises in all dropdowns
            populateCustomCategoriesInDropdowns() {
                // Remove existing custom category optgroups first
                for (let i = 1; i <= 3; i++) {
                    const select = document.getElementById(`custom-slot-${i}`);
                    const existingCustomGroups = select.querySelectorAll('optgroup[data-custom="true"]');
                    existingCustomGroups.forEach(g => g.remove());
                }
                
                // Add custom categories if any exist
                if (this.data.customCategories && this.data.customCategories.length > 0) {
                    this.data.customCategories.forEach(category => {
                        if (category.exercises && category.exercises.length > 0) {
                            for (let i = 1; i <= 3; i++) {
                                const select = document.getElementById(`custom-slot-${i}`);
                                const optgroup = document.createElement('optgroup');
                                optgroup.label = `${category.name} (Custom)`;
                                optgroup.setAttribute('data-custom', 'true');
                                
                                category.exercises.forEach(ex => {
                                    const option = document.createElement('option');
                                    option.value = `custom-${category.id}-${ex.id}`;
                                    option.textContent = ex.name;
                                    optgroup.appendChild(option);
                                });
                                
                                select.appendChild(optgroup);
                            }
                        }
                    });
                }
            },

            // Close customize modal
            closeCustomizeModal() {
                document.getElementById('customize-overlay').classList.remove('show');
                document.getElementById('customize-modal').classList.remove('show');
            },

            // Save custom cards preferences
            saveCustomCards() {
                const slot1 = document.getElementById('custom-slot-1').value;
                const slot2 = document.getElementById('custom-slot-2').value;
                const slot3 = document.getElementById('custom-slot-3').value;

                // Validation: Check for duplicates
                const selections = [slot1, slot2, slot3];
                const uniqueSelections = new Set(selections);
                
                if (uniqueSelections.size !== 3) {
                    alert('Please select 3 different stats for your dashboard cards.');
                    return;
                }

                // Save preferences
                this.data.customDashboardCards = selections;
                this.saveData();

                // Update dashboard
                this.updateDashboard();

                // Close modal
                this.closeCustomizeModal();
            },

            // Set stats view (week or total)
            setStatsView(view) {
                this.data.currentView.statsView = view;
                
                // Update toggle buttons
                document.querySelectorAll('.stats-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Refresh dashboard
                this.updateDashboard();
            },

            // Render calendar
            renderCalendar() {
                const year = this.data.currentView.calendarYear;
                const month = this.data.currentView.calendarMonth;
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                
                document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const prevLastDay = new Date(year, month, 0);
                
                const firstDayOfWeek = firstDay.getDay();
                const daysInMonth = lastDay.getDate();
                const daysInPrevMonth = prevLastDay.getDate();

                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = `
                    <div class="calendar-day-label">Sun</div>
                    <div class="calendar-day-label">Mon</div>
                    <div class="calendar-day-label">Tue</div>
                    <div class="calendar-day-label">Wed</div>
                    <div class="calendar-day-label">Thu</div>
                    <div class="calendar-day-label">Fri</div>
                    <div class="calendar-day-label">Sat</div>
                `;

                // Previous month days
                for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                    const day = daysInPrevMonth - i;
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.textContent = day;
                    grid.appendChild(dayDiv);
                }

                // Current month days
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const activities = this.data.activities.filter(a => a.date === date);
                    
                    // Get habits for this date
                    const completedHabits = this.getHabitsForDate(date);
                    const habitChecks = completedHabits.length > 0 
                        ? completedHabits.map(h => `<span style="color: ${h.color || '#10b981'};"></span>`).join('')
                        : '';
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.style.cursor = 'pointer';
                    dayDiv.onclick = () => this.showDayDetail(date);
                    
                    if (activities.length > 0) {
                        dayDiv.classList.add('has-activity');
                    }
                    
                    if (today.getDate() === day && today.getMonth() === month && today.getFullYear() === year) {
                        dayDiv.classList.add('today');
                    }
                    
                    dayDiv.innerHTML = `
                        ${habitChecks ? `<div class="habit-checks">${habitChecks}</div>` : ''}
                        ${day}
                        ${activities.length > 0 ? `
                            <div class="activity-dots">
                                ${activities.slice(0, 4).map(() => '<div class="activity-dot"></div>').join('')}
                            </div>
                        ` : ''}
                    `;
                    
                    grid.appendChild(dayDiv);
                }

                // Next month days
                const remainingDays = 42 - (firstDayOfWeek + daysInMonth);
                for (let day = 1; day <= remainingDays; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.textContent = day;
                    grid.appendChild(dayDiv);
                }

                // Render activity summary
                this.renderActivitySummary();
                this.renderHabitSummary();
            },

            // Toggle activity report expand/collapse
            toggleActivityReport() {
                const content = document.getElementById('activity-report-content');
                const toggle = document.getElementById('activity-report-toggle');
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggle.querySelector('span:last-child').textContent = '';
                } else {
                    content.classList.add('expanded');
                    toggle.querySelector('span:last-child').textContent = '';
                }
            },
            
            toggleHabitReport() {
                const content = document.getElementById('habit-report-content');
                const toggle = document.getElementById('habit-report-toggle');
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggle.querySelector('span:last-child').textContent = '';
                } else {
                    content.classList.add('expanded');
                    toggle.querySelector('span:last-child').textContent = '';
                }
            },
            
            // Format large numbers with k/M suffix for display
            formatCompactNumber(value) {
                if (value >= 1000000) {
                    return (value / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
                } else if (value >= 1000) {
                    return (value / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
                }
                return value.toLocaleString();
            },

            // Render activity summary for calendar screen (month + all-time)
            renderActivitySummary() {
                const summaryList = document.getElementById('activity-summary-list');
                const stats = this.calculateStats();
                const monthStats = this.calculateMonthStats();
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                const summaryItems = [];
                
                // Helper to add item with week, month and total
                const addItem = (name, weekValue, monthValue, totalValue, suffix) => {
                    if (totalValue > 0) {
                        summaryItems.push({
                            name,
                            week: weekValue > 0 ? `${this.formatCompactNumber(weekValue)}${suffix}` : '-',
                            month: monthValue > 0 ? `${this.formatCompactNumber(monthValue)}${suffix}` : '-',
                            total: `${this.formatCompactNumber(totalValue)}${suffix}`
                        });
                    }
                };
                
                // Strength exercises
                addItem('Push-ups', stats.thisWeekPushups, monthStats.monthPushups, stats.totalPushups, ' reps');
                addItem('Pull-ups', stats.thisWeekPullups, monthStats.monthPullups, stats.totalPullups, ' reps');
                addItem('Ab Wheel Rollout', stats.thisWeekRollerAbs, monthStats.monthRollerAbs, stats.totalRollerAbs, ' reps');
                addItem('Dips', stats.thisWeekDips, monthStats.monthDips, stats.totalDips, ' reps');
                addItem('Squats', stats.thisWeekSquats, monthStats.monthSquats, stats.totalSquats, ' reps');
                addItem('Sit-ups', stats.thisWeekSitups, monthStats.monthSitups, stats.totalSitups, ' reps');
                
                // Cardio activities
                if (stats.totalRunning > 0) {
                    summaryItems.push({
                        name: 'Running',
                        week: stats.thisWeekRunning > 0 ? `${this.formatCompactNumber(stats.thisWeekRunning)} ${unit}` : '-',
                        month: monthStats.monthRunning > 0 ? `${this.formatCompactNumber(monthStats.monthRunning)} ${unit}` : '-',
                        total: `${this.formatCompactNumber(stats.totalRunning)} ${unit}`
                    });
                }
                if (stats.totalWalking > 0) {
                    summaryItems.push({
                        name: 'Walking',
                        week: stats.thisWeekWalking > 0 ? `${this.formatCompactNumber(stats.thisWeekWalking)} ${unit}` : '-',
                        month: monthStats.monthWalking > 0 ? `${this.formatCompactNumber(monthStats.monthWalking)} ${unit}` : '-',
                        total: `${this.formatCompactNumber(stats.totalWalking)} ${unit}`
                    });
                }
                if (stats.totalBiking > 0) {
                    summaryItems.push({
                        name: 'Biking',
                        week: stats.thisWeekBiking > 0 ? `${this.formatCompactNumber(stats.thisWeekBiking)} ${unit}` : '-',
                        month: monthStats.monthBiking > 0 ? `${this.formatCompactNumber(monthStats.monthBiking)} ${unit}` : '-',
                        total: `${this.formatCompactNumber(stats.totalBiking)} ${unit}`
                    });
                }
                if (stats.totalDogWalk > 0) {
                    summaryItems.push({
                        name: 'Dog Walking',
                        week: stats.thisWeekDogWalk > 0 ? `${this.formatCompactNumber(stats.thisWeekDogWalk)} ${unit}` : '-',
                        month: monthStats.monthDogWalk > 0 ? `${this.formatCompactNumber(monthStats.monthDogWalk)} ${unit}` : '-',
                        total: `${this.formatCompactNumber(stats.totalDogWalk)} ${unit}`
                    });
                }
                if (stats.totalHiking > 0) {
                    summaryItems.push({
                        name: 'Hiking',
                        week: stats.thisWeekHiking > 0 ? `${this.formatCompactNumber(stats.thisWeekHiking)} ${unit}` : '-',
                        month: monthStats.monthHiking > 0 ? `${this.formatCompactNumber(monthStats.monthHiking)} ${unit}` : '-',
                        total: `${this.formatCompactNumber(stats.totalHiking)} ${unit}`
                    });
                }
                
                // Other
                addItem('Stairs', stats.thisWeekStairs, monthStats.monthStairs, stats.totalStairs, ' floors');
                addItem('Steps', stats.thisWeekSteps, monthStats.monthSteps, stats.totalSteps, '');
                
                // Totals
                addItem('Strength Days', stats.thisWeekStrengthDays, monthStats.monthStrengthDays, stats.totalStrengthDays, ' days');
                if (stats.totalDistance > 0) {
                    summaryItems.push({
                        name: 'Total Distance',
                        week: stats.thisWeekDistance > 0 ? `${this.formatCompactNumber(stats.thisWeekDistance)} ${unit}` : '-',
                        month: monthStats.monthDistance > 0 ? `${this.formatCompactNumber(monthStats.monthDistance)} ${unit}` : '-',
                        total: `${this.formatCompactNumber(stats.totalDistance)} ${unit}`
                    });
                }
                
                // Custom category exercises (separate array for display after divider)
                const customItems = [];
                if (this.data.customCategories && this.data.customCategories.length > 0) {
                    this.data.customCategories.forEach(category => {
                        if (category.exercises && category.exercises.length > 0) {
                            category.exercises.forEach(ex => {
                                const exerciseKey = `custom-${category.id}-${ex.id}`;
                                
                                // Calculate stats for this custom exercise
                                const weekStats = this.getCustomExerciseStatsByPeriod(exerciseKey, 'week');
                                const monthStatsCustom = this.getCustomExerciseStatsByPeriod(exerciseKey, 'month');
                                const totalStatsCustom = this.getCustomExerciseStatsByPeriod(exerciseKey, 'total');
                                
                                // Only add if there's activity
                                if (totalStatsCustom.value > 0) {
                                    const suffix = ex.trackingType === 'reps' ? ' reps' : 
                                                   ex.trackingType === 'distance' ? ` ${unit}` : 
                                                   ' days';
                                    
                                    customItems.push({
                                        name: ex.name,
                                        week: weekStats.value > 0 ? `${this.formatCompactNumber(weekStats.value)}${suffix}` : '-',
                                        month: monthStatsCustom.value > 0 ? `${this.formatCompactNumber(monthStatsCustom.value)}${suffix}` : '-',
                                        total: `${this.formatCompactNumber(totalStatsCustom.value)}${suffix}`,
                                        isCustom: true
                                    });
                                }
                            });
                        }
                    });
                }
                
                if (summaryItems.length === 0 && customItems.length === 0) {
                    summaryList.innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 14px; padding: 20px 0;">No activities logged yet.</p>';
                } else {
                    // Match Habit Report format exactly - using grid layout
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                       'July', 'August', 'September', 'October', 'November', 'December'];
                    const displayedMonthName = monthNames[this.data.currentView.calendarMonth];
                    
                    let html = `
                        <div style="display: grid; grid-template-columns: 1.3fr 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid #3d3d3d; font-size: 11px; font-weight: 700; color: #9ca3af;">
                            <div style="text-align: left; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Activity</div>
                            <div style="text-align: right; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Current Week</div>
                            <div style="text-align: right; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${displayedMonthName}</div>
                            <div style="text-align: right; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">All Time</div>
                        </div>
                    `;
                    
                    // Regular activity data rows
                    html += summaryItems.map(item => `
                        <div style="display: grid; grid-template-columns: 1.3fr 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid #2d2d2d; font-size: 12px;">
                            <div style="color: #9ca3af; text-align: left; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                            <div style="text-align: right; color: var(--primary); font-weight: 700; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.week}</div>
                            <div style="text-align: right; color: var(--primary-light); font-weight: 700; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.month}</div>
                            <div style="text-align: right; color: #9ca3af; font-weight: 700; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.total}</div>
                        </div>
                    `).join('');
                    
                    // Add custom categories after divider if they exist
                    if (customItems.length > 0) {
                        // Add divider line
                        html += `<div style="margin: 12px 0; border-top: 1px solid #3d3d3d;"></div>`;
                        
                        // Custom activity data rows with gold text for activity name
                        html += customItems.map(item => `
                            <div style="display: grid; grid-template-columns: 1.3fr 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid #2d2d2d; font-size: 12px;">
                                <div style="color: #d4af37; text-align: left; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                                <div style="text-align: right; color: var(--primary); font-weight: 700; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.week}</div>
                                <div style="text-align: right; color: var(--primary-light); font-weight: 700; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.month}</div>
                                <div style="text-align: right; color: #9ca3af; font-weight: 700; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.total}</div>
                            </div>
                        `).join('');
                    }
                    
                    summaryList.innerHTML = html;
                }
            },
            
            // Render habit summary for calendar screen
            renderHabitSummary() {
                const summaryList = document.getElementById('habit-summary-list');
                
                if (!this.data.habits || this.data.habits.length === 0) {
                    summaryList.innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 14px;">No habits created yet.</p>';
                    return;
                }
                
                // Current week calculation (always real-world current week)
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                startOfWeek.setHours(0, 0, 0, 0);
                
                // Use displayed calendar month (not current real-world month)
                const year = this.data.currentView.calendarYear;
                const month = this.data.currentView.calendarMonth;
                const startOfMonth = new Date(year, month, 1);
                startOfMonth.setHours(0, 0, 0, 0);
                const endOfMonth = new Date(year, month + 1, 0);
                endOfMonth.setHours(23, 59, 59, 999);
                
                // Get month name for header
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const displayedMonthName = monthNames[month];
                
                const habitStats = this.data.habits.map(habit => {
                    let weekDays = 0;
                    let monthDays = 0;
                    let totalDays = (habit.completions || []).length;
                    
                    // Count completions for week and month
                    (habit.completions || []).forEach(dateStr => {
                        const logDate = new Date(dateStr + 'T12:00:00');
                        if (logDate >= startOfWeek) weekDays++;
                        if (logDate >= startOfMonth && logDate <= endOfMonth) monthDays++;
                    });
                    
                    return {
                        name: habit.name || 'Unnamed Habit',
                        color: habit.color || '#10b981',
                        weekDays,
                        monthDays,
                        totalDays
                    };
                });
                
                const html = `
                    <div style="display: grid; grid-template-columns: 1.3fr 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid #3d3d3d; font-size: 11px; font-weight: 700; color: #9ca3af;">
                        <div style="text-align: left; min-width: 0;"></div>
                        <div style="text-align: right; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Current Week</div>
                        <div style="text-align: right; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${displayedMonthName}</div>
                        <div style="text-align: right; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">All Time</div>
                    </div>
                    ${habitStats.map(habit => `
                        <div style="display: grid; grid-template-columns: 1.3fr 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid #2d2d2d; font-size: 12px;">
                            <div style="display: flex; align-items: center; gap: 6px; min-width: 0; overflow: hidden;">
                                <div style="width: 10px; height: 10px; border-radius: 2px; background: ${habit.color}; flex-shrink: 0;"></div>
                                <span style="color: #e8e8e8; font-weight: 600; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${habit.name}</span>
                            </div>
                            <div style="text-align: right; color: var(--primary); font-weight: 700; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${habit.weekDays}/7</div>
                            <div style="text-align: right; color: var(--primary-light); font-weight: 700; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${habit.monthDays}/${endOfMonth.getDate()}</div>
                            <div style="text-align: right; color: #9ca3af; font-weight: 700; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${habit.totalDays}</div>
                        </div>
                    `).join('')}
                `;
                
                summaryList.innerHTML = html;
            },

            // Calculate month-to-date stats
            calculateMonthStats() {
                // Use the displayed calendar month, not the current real-world month
                const year = this.data.currentView.calendarYear;
                const month = this.data.currentView.calendarMonth;
                
                const startOfMonth = new Date(year, month, 1);
                startOfMonth.setHours(0, 0, 0, 0);
                
                const endOfMonth = new Date(year, month + 1, 0);
                endOfMonth.setHours(23, 59, 59, 999);
                
                let monthDistance = 0;
                let monthPushups = 0;
                let monthPullups = 0;
                let monthRollerAbs = 0;
                let monthDips = 0;
                let monthSquats = 0;
                let monthSitups = 0;
                let monthBiking = 0;
                let monthDogWalk = 0;
                let monthHiking = 0;
                let monthRunning = 0;
                let monthWalking = 0;
                let monthStairs = 0;
                let monthSteps = 0;
                let monthStrengthDays = new Set();
                
                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    const isThisMonth = activityDate >= startOfMonth && activityDate <= endOfMonth;
                    
                    if (isThisMonth) {
                        // Distance
                        if (activity.distance) {
                            monthDistance += activity.distance;
                            if (activity.type === 'biking') monthBiking += activity.distance;
                            else if (activity.type === 'dog') monthDogWalk += activity.distance;
                            else if (activity.type === 'hiking') monthHiking += activity.distance;
                            else if (activity.type === 'run') monthRunning += activity.distance;
                            else if (activity.type === 'walk') monthWalking += activity.distance;
                        }
                        
                        // Stairs and Steps
                        if (activity.floors) monthStairs += activity.floors;
                        if (activity.steps) monthSteps += activity.steps;
                        
                        // Reps
                        if (activity.reps) {
                            if (activity.type === 'pushups') monthPushups += activity.reps;
                            else if (activity.type === 'pullups') monthPullups += activity.reps;
                            else if (activity.type === 'rollerabs') monthRollerAbs += activity.reps;
                            else if (activity.type === 'dips') monthDips += activity.reps;
                            else if (activity.type === 'squats') monthSquats += activity.reps;
                            else if (activity.type === 'situps') monthSitups += activity.reps;
                        }
                        
                        // Strength days
                        if (['arm', 'back', 'chest', 'core', 'fullbody', 'leg', 'shoulder'].includes(activity.type)) {
                            monthStrengthDays.add(activity.date);
                        }
                    }
                });
                
                // Convert distances to preferred unit
                if (this.data.goals.unitPreference === 'miles') {
                    monthDistance = monthDistance / 1.60934;
                    monthBiking = monthBiking / 1.60934;
                    monthDogWalk = monthDogWalk / 1.60934;
                    monthHiking = monthHiking / 1.60934;
                    monthRunning = monthRunning / 1.60934;
                    monthWalking = monthWalking / 1.60934;
                }
                
                return {
                    monthDistance: Math.round(monthDistance * 10) / 10,
                    monthPushups,
                    monthPullups,
                    monthRollerAbs,
                    monthDips,
                    monthSquats,
                    monthSitups,
                    monthBiking: Math.round(monthBiking * 10) / 10,
                    monthDogWalk: Math.round(monthDogWalk * 10) / 10,
                    monthHiking: Math.round(monthHiking * 10) / 10,
                    monthRunning: Math.round(monthRunning * 10) / 10,
                    monthWalking: Math.round(monthWalking * 10) / 10,
                    monthStairs,
                    monthSteps,
                    monthStrengthDays: monthStrengthDays.size
                };
            },

            // Change calendar month
            changeMonth(delta) {
                this.data.currentView.calendarMonth += delta;
                if (this.data.currentView.calendarMonth > 11) {
                    this.data.currentView.calendarMonth = 0;
                    this.data.currentView.calendarYear++;
                } else if (this.data.currentView.calendarMonth < 0) {
                    this.data.currentView.calendarMonth = 11;
                    this.data.currentView.calendarYear--;
                }
                this.renderCalendar();
            },

            // Get custom exercise stats for a specific time period
            getCustomExerciseStatsByPeriod(exerciseKey, period) {
                const now = new Date();
                let startDate;
                let endDate;
                
                if (period === 'week') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                } else if (period === 'month') {
                    // Use the displayed calendar month, not current real-world month
                    const year = this.data.currentView.calendarYear;
                    const month = this.data.currentView.calendarMonth;
                    startDate = new Date(year, month, 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(year, month + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                } else {
                    // 'total' - all time
                    startDate = new Date(0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                }
                
                const activities = this.data.activities.filter(a => {
                    const actDate = new Date(a.date + 'T12:00:00');
                    return a.type === exerciseKey && actDate >= startDate && actDate <= endDate;
                });
                
                // Sum up values based on tracking type
                let totalValue = 0;
                activities.forEach(a => {
                    if (a.reps) {
                        totalValue += a.reps;
                    } else if (a.distance) {
                        totalValue += a.distance;
                    } else {
                        totalValue += 1; // logday - count days
                    }
                });
                
                return { value: totalValue };
            },

            // Update goals UI
            updateGoalsUI() {
                const setVal = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.value = val;
                };
                const setText = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = val;
                };

                setVal('unit-preference', this.data.goals.unitPreference);
                setVal('initial-weight-preference',
                    (this.data.goals.initialWeight !== undefined && this.data.goals.initialWeight !== null)
                        ? this.data.goals.initialWeight
                        : ''
                );
                setVal('annual-goal', this.data.goals.annualMiles);
                setVal('workout-frequency', this.data.goals.workoutFrequency);
                setVal('monthly-goal', this.data.goals.monthlyMiles);

                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                setText('milestone-unit', unit);
            },

            // Save goals
            saveGoals() {
                const oldUnit = this.data.goals.unitPreference;
                const newUnit = document.getElementById('unit-preference').value;
                
                this.data.goals.unitPreference = newUnit;
const initialWeightInput = document.getElementById('initial-weight-preference');
                if (initialWeightInput) {
                    const v = parseFloat(initialWeightInput.value);
                    this.data.goals.initialWeight = (!isNaN(v) && v > 0) ? v : null;
                }
                this.data.goals.annualMiles = parseInt(document.getElementById('annual-goal').value);
                this.data.goals.workoutFrequency = parseInt(document.getElementById('workout-frequency').value);
                this.data.goals.monthlyMiles = parseInt(document.getElementById('monthly-goal').value);
                
                // Save habit changes from edit mode
                this.data.habits.forEach(habit => {
                    const nameInput = document.getElementById(`habit-name-${habit.id}`);
                    const colorInput = document.getElementById(`habit-color-${habit.id}`);
                    
                    if (nameInput) {
                        habit.name = nameInput.value;
                    }
                    
                    if (colorInput) {
                        habit.color = colorInput.value;
                    }
                });
                
                this.saveData();
                this.updateGoalsUI();
                this.updateWeightInputDisplay();
                this.updateDashboard();
                // Refresh PALS eligibility toggles (e.g., weight leaderboard gating)
                this.updatePalsUI();
                this.renderHabits(); // Re-render to return to display mode
                this.refreshActivityRows(); // Refresh custom categories in activity rows
                
                const successMsg = document.getElementById('settings-success');
                successMsg.classList.add('show');
                setTimeout(() => {
                    successMsg.classList.remove('show');
                }, 3000);
            },

            // Export data
            exportData() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `juststep-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            },

            // Handle import file selection
            handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        this.importData(importedData);
                    } catch (error) {
                        alert('Error reading file. Please make sure it\'s a valid JustStep export file.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
                
                // Reset file input so same file can be imported again
                event.target.value = '';
            },

            // Import and merge data
            importData(importedData) {
                // Validate data structure
                if (!importedData || !importedData.activities || !Array.isArray(importedData.activities)) {
                    alert('Invalid data file. Please export from JustStep and try again.');
                    return;
                }

                let newActivities = 0;
                let duplicates = 0;

                // Merge activities (skip duplicates based on date + type + timestamp)
                importedData.activities.forEach(importActivity => {
                    const isDuplicate = this.data.activities.some(existing => 
                        existing.date === importActivity.date && 
                        existing.type === importActivity.type &&
                        existing.timestamp === importActivity.timestamp
                    );
                    
                    if (!isDuplicate) {
                        this.data.activities.push(importActivity);
                        newActivities++;
                    } else {
                        duplicates++;
                    }
                });

                // Replace goals completely
                if (importedData.goals) {
                    this.data.goals = { ...importedData.goals };
                }

                // Merge milestones (skip duplicates by type + value)
                if (importedData.milestones && Array.isArray(importedData.milestones)) {
                    importedData.milestones.forEach(importMilestone => {
                        const isDuplicate = this.data.milestones.some(existing =>
                            existing.type === importMilestone.type &&
                            existing.value === importMilestone.value
                        );
                        
                        if (!isDuplicate) {
                            this.data.milestones.push(importMilestone);
                        }
                    });
                }

                // Import custom dashboard cards if present, otherwise use defaults
                if (importedData.customDashboardCards && Array.isArray(importedData.customDashboardCards)) {
                    this.data.customDashboardCards = importedData.customDashboardCards;
                } else {
                    // Set default if not in imported data (backward compatibility)
                    this.data.customDashboardCards = ['pushups', 'pullups', 'rollerabs'];
                }

                // Merge weights (skip duplicates by date)
                if (importedData.weights && Array.isArray(importedData.weights)) {
                    importedData.weights.forEach(importWeight => {
                        const isDuplicate = this.data.weights.some(existing =>
                            existing.date === importWeight.date
                        );
                        
                        if (!isDuplicate) {
                            this.data.weights.push(importWeight);
                        }
                    });
                    // Sort weights by date
                    this.data.weights.sort((a, b) => new Date(a.date) - new Date(b.date));
                }

                // Preserve current view settings
                // (don't import currentView to avoid unexpected screen changes)

                // Save merged data
                this.saveData();

                // Update all views
                this.updateGoalsUI();
                this.updateDashboard();
                this.renderCalendar();

                // Show success message
                const successMsg = document.getElementById('import-success');
                successMsg.textContent = `Imported ${newActivities} activities${duplicates > 0 ? `, skipped ${duplicates} duplicates` : ''}`;
                successMsg.classList.add('show');
                setTimeout(() => {
                    successMsg.classList.remove('show');
                }, 4000);
            },

            // Show screen
            showScreen(screenName) {
                // Update screens
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(`${screenName}-screen`).classList.add('active');
                
                // Update tabs - find the correct tab by screen name
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Map screen names to tab text for matching
                const screenToTabText = {
                    'log': 'Tracker',
                    'dashboard': 'Dashboard',
                    'calendar': 'Calendar',
                    'goals': 'Goals',
                    'pals': 'Pals',
                    'leaderboard': 'Leaderboard'
                };
                
                // Find and activate the correct tab
                const tabText = screenToTabText[screenName];
                if (tabText) {
                    const tabs = document.querySelectorAll('.nav-tab');
                    tabs.forEach(tab => {
                        if (tab.textContent.trim() === tabText) {
                            tab.classList.add('active');
                        }
                    });
                }
                
                this.data.currentView.screen = screenName;

                // Refresh data for specific screens
                if (screenName === 'dashboard') {
                    this.updateDashboard();
                } else if (screenName === 'calendar') {
                    this.renderCalendar();
                } else if (screenName === 'goals') {
                    this.renderHabits(); // Render habits when viewing Goals
                } else if (screenName === 'leaderboard') {
                    // Best-effort sync before loading leaderboard (do not block UI)
                    this.syncMyStatsToFirebase()
                        .then(() => this.renderLeaderboard())
                        .catch(() => this.renderLeaderboard());
                }
            },

            // Get display name for any activity type (handles old, new, and custom exercises)
            getActivityDisplayName(activity) {
                // Standard activity names mapping (handles old and new exercise names)
                const activityNames = {
                    'walk': 'Walking',
                    'run': 'Running',
                    'dog': 'Dog Walking',
                    'hiking': 'Hiking',
                    'biking': 'Biking',
                    'stairs': 'Stairmaster',
                    'steps': 'Steps',
                    'pushups': 'Push-ups',
                    'pullups': 'Pull-ups',
                    'rollerabs': 'Ab Wheel Rollout',
                    'abwheelrollout': 'Ab Wheel Rollout',
                    'dips': 'Dips',
                    'squats': 'Squats',
                    'situps': 'Sit-ups',
                    'leg': 'Leg Day',
                    'chest': 'Chest Day',
                    'shoulder': 'Shoulder Day',
                    'core': 'Core Day',
                    'arm': 'Arm Day',
                    'back': 'Back Day',
                    'fullbody': 'Full Body Day',
                    'stretch': 'Stretch Day',
                    // New detailed exercises
                    'bicepcurls': 'Bicep Curls',
                    'forearmcurls': 'Forearm Curls',
                    'hammercurls': 'Hammer Curls',
                    'tricepdips': 'Tricep Dips',
                    'tricepsextensions': 'Triceps Extensions',
                    'deadlifts': 'Deadlifts',
                    'facepulls': 'Face Pulls',
                    'latpulldowns': 'Lat Pulldowns',
                    'rows': 'Rows',
                    'benchpress': 'Bench Press',
                    'chestflys': 'Chest Flys',
                    'inclinepress': 'Incline Press',
                    'legraises': 'Leg Raises',
                    'planks': 'Planks',
                    'russiantwists': 'Russian Twists',
                    'bulgariansplitsquats': 'Bulgarian Split Squats',
                    'donkeykicks': 'Donkey Kicks',
                    'glutebridges': 'Glute Bridges',
                    'hipthrusts': 'Hip Thrusts',
                    'stepups': 'Step-Ups',
                    'calfraises': 'Calf Raises',
                    'legpress': 'Leg Press',
                    'lunges': 'Lunges',
                    'romaniandeadlifts': 'Romanian Deadlifts',
                    'frontraises': 'Front Raises',
                    'lateralraises': 'Lateral Raises',
                    'reardeltflys': 'Rear Delt Flys',
                    'shoulderpress': 'Shoulder Press',
                    'shrugs': 'Shrugs'
                };
                
                // Check if it's a standard activity
                if (activityNames[activity.type]) {
                    return activityNames[activity.type];
                }
                
                // Check if it's a custom exercise (format: custom-categoryId-exerciseId)
                if (activity.type && activity.type.startsWith('custom-')) {
                    const parts = activity.type.split('-');
                    if (parts.length === 3) {
                        const categoryId = parseInt(parts[1]);
                        const exerciseId = parseInt(parts[2]);
                        
                        // Look up the exercise name in customCategories
                        if (this.data.customCategories && this.data.customCategories.length > 0) {
                            const category = this.data.customCategories.find(c => c.id === categoryId);
                            if (category && category.exercises) {
                                const exercise = category.exercises.find(e => e.id === exerciseId);
                                if (exercise && exercise.name) {
                                    return exercise.name;
                                }
                            }
                        }
                    }
                }
                
                // Fallback to the raw type
                return activity.type;
            },

            // Show day detail modal
            showDayDetail(date) {
                const activities = this.data.activities.filter(a => a.date === date);
                const dateObj = new Date(date + 'T12:00:00');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const formattedDate = `${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateObj.getFullYear()}`;
                
                document.getElementById('day-detail-date').textContent = formattedDate;
                
                const content = document.getElementById('day-detail-content');
                
                if (activities.length === 0) {
                    content.innerHTML = `
                        <div class="empty-day">
                            <div class="empty-day-icon"></div>
                            <div class="empty-day-text">No activities logged for this day</div>
                        </div>
                    `;
                } else {
                    const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                    
                    // Group and calculate totals
                    let totalDistance = 0;
                    let totalSteps = 0;
                    let totalPushups = 0;
                    let totalPullups = 0;
                    let totalRollerAbs = 0;
                    let totalDips = 0;
                    let totalSquats = 0;
                    let totalSitups = 0;
                    let totalStairs = 0;
                    let workoutCount = 0;
                    
                    // Track custom exercises dynamically by their ID key
                    const customExerciseTotals = {};
                    
                    const activityHTML = activities.map((activity, index) => {
                        let valueText = '';
                        if (activity.distance) {
                            const displayDistance = this.data.goals.unitPreference === 'miles' 
                                ? (activity.distance / 1.60934).toFixed(1)
                                : activity.distance.toFixed(1);
                            valueText = `${displayDistance} ${unit}`;
                            totalDistance += activity.distance;
                        } else if (activity.floors) {
                            valueText = `${activity.floors} floors`;
                            totalStairs += activity.floors;
                        } else if (activity.steps) {
                            valueText = `${activity.steps.toLocaleString()} steps`;
                            totalSteps += activity.steps;
                        } else if (activity.reps) {
                            valueText = `${activity.reps} reps`;
                            // Track by type
                            if (activity.type === 'pushups') totalPushups += activity.reps;
                            else if (activity.type === 'pullups') totalPullups += activity.reps;
                            else if (activity.type === 'rollerabs' || activity.type === 'abwheelrollout') totalRollerAbs += activity.reps;
                            else if (activity.type === 'dips') totalDips += activity.reps;
                            else if (activity.type === 'squats') totalSquats += activity.reps;
                            else if (activity.type === 'situps') totalSitups += activity.reps;
                            else if (activity.type && activity.type.startsWith('custom-')) {
                                // Custom exercise with reps
                                if (!customExerciseTotals[activity.type]) {
                                    customExerciseTotals[activity.type] = {
                                        name: this.getActivityDisplayName(activity),
                                        reps: 0
                                    };
                                }
                                customExerciseTotals[activity.type].reps += activity.reps;
                            }
                        } else {
                            valueText = 'Completed';
                            workoutCount++;
                        }
                        
                        return `
                            <div class="day-activity-item" data-activity-index="${this.data.activities.indexOf(activity)}">
                                <div class="day-activity-info">
                                    <div class="day-activity-type">${this.getActivityDisplayName(activity)}</div>
                                    <div class="day-activity-value">${valueText}</div>
                                </div>
                                <button class="day-activity-delete" onclick="app.deleteActivity(${this.data.activities.indexOf(activity)})">Delete</button>
                            </div>
                        `;
                    }).join('');
                    
                    // Build totals section (FIXED: "exercises" instead of "workouts")
                    const totals = [];
                    if (totalDistance > 0) {
                        const displayDistance = this.data.goals.unitPreference === 'miles' 
                            ? (totalDistance / 1.60934).toFixed(1)
                            : totalDistance.toFixed(1);
                        totals.push(`${displayDistance} ${unit} total`);
                    }
                    if (totalSteps > 0) {
                        totals.push(`${totalSteps.toLocaleString()} steps`);
                    }
                    if (totalPushups > 0) {
                        totals.push(`${totalPushups} push-ups`);
                    }
                    if (totalPullups > 0) {
                        totals.push(`${totalPullups} pull-ups`);
                    }
                    if (totalRollerAbs > 0) {
                        totals.push(`${totalRollerAbs} ab wheel rollout`);
                    }
                    if (totalDips > 0) {
                        totals.push(`${totalDips} dips`);
                    }
                    if (totalSquats > 0) {
                        totals.push(`${totalSquats} squats`);
                    }
                    if (totalSitups > 0) {
                        totals.push(`${totalSitups} sit-ups`);
                    }
                    if (totalStairs > 0) {
                        totals.push(`${totalStairs} floors`);
                    }
                    
                    // Add custom exercise totals dynamically
                    Object.keys(customExerciseTotals).forEach(key => {
                        const custom = customExerciseTotals[key];
                        if (custom.reps > 0) {
                            totals.push(`${custom.reps} ${custom.name.toLowerCase()}`);
                        }
                    });
                    
                    if (workoutCount > 0) {
                        totals.push(`${workoutCount} exercise${workoutCount > 1 ? 's' : ''}`);
                    }
                    
                    content.innerHTML = `
                        <div class="day-activity-list">
                            ${activityHTML}
                        </div>
                        ${totals.length > 0 ? `
                            <div class="day-totals">
                                <div class="day-totals-title">Day Summary</div>
                                <div class="day-totals-content">
                                    ${totals.join('  ')}
                                </div>
                            </div>
                        ` : ''}
                    `;
                }
                
                // ADD HABITS SECTION
                const completedHabits = this.getHabitsForDate(date);
                
                if (this.data.habits && this.data.habits.length > 0) {
                    let habitsHTML = '<h3 style="margin-top: 20px; margin-bottom: 12px; color: #9ca3af; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">HABITS</h3>';
                    
                    habitsHTML += this.data.habits.map(habit => {
                        const isCompleted = completedHabits.some(h => h.id === habit.id);
                        return `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 10px; background: #2d2d2d; border-radius: 8px;">
                                <input type="checkbox" 
                                       ${isCompleted ? 'checked' : ''} 
                                       onchange="app.toggleHabitCompletion(${habit.id}, '${date}')"
                                       style="cursor: pointer; width: 18px; height: 18px;">
                                <span style="color: #e8e8e8; font-size: 14px; flex: 1;">${habit.name || 'Unnamed habit'}</span>
                            </div>
                        `;
                    }).join('');
                    
                    content.innerHTML += habitsHTML;
                }
                
                document.getElementById('day-overlay').classList.add('show');
                document.getElementById('day-detail-modal').classList.add('show');
            },

            // Close day detail modal
            closeDayDetail() {
                document.getElementById('day-overlay').classList.remove('show');
                document.getElementById('day-detail-modal').classList.remove('show');
            },

            // Delete activity
            deleteActivity(activityIndex) {
                if (!confirm('Are you sure you want to delete this activity?')) {
                    return;
                }
                
                this.data.activities.splice(activityIndex, 1);
                this.saveData();
                
                // Refresh all views
                this.updateDashboard();
                this.renderCalendar();
                
                // Reopen the day detail with updated data
                const dateInput = document.getElementById('day-detail-date').textContent;
                const activities = this.data.activities.filter(a => {
                    const activityDate = new Date(a.date + 'T12:00:00');
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                       'July', 'August', 'September', 'October', 'November', 'December'];
                    const formattedDate = `${monthNames[activityDate.getMonth()]} ${activityDate.getDate()}, ${activityDate.getFullYear()}`;
                    return formattedDate === dateInput;
                });
                
                if (activities.length > 0) {
                    this.showDayDetail(activities[0].date);
                } else {
                    this.closeDayDetail();
                }
            },

            // Update weight input display based on unit preference
            updateWeightInputDisplay() {
                const weightUnitDisplay = document.getElementById('weight-unit-display');
                if (weightUnitDisplay) {
                    weightUnitDisplay.textContent = 'lbs';
                }
},

            // Log weight entry
            logWeight() {
                const dateInput = document.getElementById('log-date').value;
                const weightInput = document.getElementById('weight-input');
                const weight = parseFloat(weightInput.value);

                if (!weight || weight <= 0) {
                    alert('Please enter a valid weight');
                    return;
                }

                // Initial weight is recommended for all-time % calculations, but not required to log weight.
                if (this.data.goals.initialWeight === null || this.data.goals.initialWeight === undefined) {
                    const proceed = confirm('Initial Weight is not set. You can still log weight, but all-time % change will not be available until you set Initial Weight in Settings  Goals. Continue?');
                    if (!proceed) return;
                }

                // Check if weight entry already exists for this date
                const existingIndex = this.data.weights.findIndex(w => w.date === dateInput);
                
                const weightEntry = {
                    date: dateInput,
                    weight: weight,
                    unit: this.data.goals.weightUnit
                };

                if (existingIndex >= 0) {
                    // Replace existing entry
                    this.data.weights[existingIndex] = weightEntry;
                } else {
                    // Add new entry
                    this.data.weights.push(weightEntry);
                }

                // Sort weights by date
                this.data.weights.sort((a, b) => new Date(a.date) - new Date(b.date));

                this.saveData();
                this.updateDashboard();
                // Refresh PALS eligibility toggles (e.g., weight leaderboard gating)
                this.updatePalsUI();
                
                // Sync to Firebase if PALS is set up
                if (this.data.pals.myPalCode) {
                    this.syncMyStatsToFirebase();
                }

                // Clear input and show success
                weightInput.value = '';
                alert(`Weight logged: ${weight} lbs`);
            },
            
            toggleWeightInfoModal() {
                const modal = document.getElementById('weight-info-modal');
                if (modal) {
                    modal.classList.toggle('active');
                }
            },
            
            toggleHabitInfoModal() {
                const modal = document.getElementById('habit-info-modal');
                if (modal) {
                    modal.classList.toggle('active');
                }
            },
            
            // Weekly Report Functions
            showWeeklyReport(weekStartDate) {
                // Store navigation state (Sunday start date in local time)
                const now = new Date();
                const currentWeekStart = new Date(now);
                currentWeekStart.setDate(now.getDate() - now.getDay());
                currentWeekStart.setHours(0, 0, 0, 0);

                let targetStart = currentWeekStart;
                if (weekStartDate) {
                    const d = typeof weekStartDate === 'string'
                        ? new Date(weekStartDate + 'T00:00:00')
                        : new Date(weekStartDate);
                    d.setHours(0, 0, 0, 0);
                    d.setDate(d.getDate() - d.getDay());
                    targetStart = d;
                }

                this.weeklyReportViewStart = targetStart.toISOString().split('T')[0];

                this.renderWeeklyReport(this.weeklyReportViewStart);
                const modal = document.getElementById('weekly-report-modal');
                if (modal) {
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                }
            },

            navigateWeeklyReport(direction) {
                // direction: -1 previous week, +1 next week
                const now = new Date();
                const currentWeekStart = new Date(now);
                currentWeekStart.setDate(now.getDate() - now.getDay());
                currentWeekStart.setHours(0, 0, 0, 0);

                const base = this.weeklyReportViewStart
                    ? new Date(this.weeklyReportViewStart + 'T00:00:00')
                    : new Date(currentWeekStart);

                base.setHours(0, 0, 0, 0);
                base.setDate(base.getDate() + (direction * 7));

                // Do not allow navigating past the current week
                if (base > currentWeekStart) {
                    base.setTime(currentWeekStart.getTime());
                }

                this.weeklyReportViewStart = base.toISOString().split('T')[0];
                this.renderWeeklyReport(this.weeklyReportViewStart);
            },

            closeWeeklyReport() {
                const modal = document.getElementById('weekly-report-modal');
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = ''; // Restore scrolling
                }

                // Mark this Sunday's report as seen (only when today is Sunday)
                const now = new Date();
                if (now.getDay() === 0) {
                    const sundayDate = now.toISOString().split('T')[0];
                    localStorage.setItem('lastWeeklyReportSunday', sundayDate);
                }
            },

            renderWeeklyReport(weekStartDate) {
                const container = document.getElementById('weekly-report-content');
                if (!container) return;
                
                // Calculate week range (Sunday to Saturday)
                const now = new Date();
                const currentWeekStart = new Date(now);
                currentWeekStart.setDate(now.getDate() - now.getDay());
                currentWeekStart.setHours(0, 0, 0, 0);

                let startOfWeek = new Date(currentWeekStart);
                if (weekStartDate) {
                    const d = typeof weekStartDate === 'string'
                        ? new Date(weekStartDate + 'T00:00:00')
                        : new Date(weekStartDate);
                    d.setHours(0, 0, 0, 0);
                    d.setDate(d.getDate() - d.getDay());
                    startOfWeek = d;
                }

                // Keep navigation state in sync
                this.weeklyReportViewStart = startOfWeek.toISOString().split('T')[0];
const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);
                
                // Calculate last week range
                const lastWeekStart = new Date(startOfWeek);
                lastWeekStart.setDate(lastWeekStart.getDate() - 7);
                const lastWeekEnd = new Date(endOfWeek);
                lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);
                
                // Format date range
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const startMonth = monthNames[startOfWeek.getMonth()];
                const endMonth = monthNames[endOfWeek.getMonth()];
                const startDay = startOfWeek.getDate();
                const endDay = endOfWeek.getDate();
                const year = endOfWeek.getFullYear();
                
                const dateRange = startMonth === endMonth 
                    ? `${startMonth} ${startDay}-${endDay}, ${year}`
                    : `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`;
                

                const isCurrentWeek = startOfWeek.getTime() === currentWeekStart.getTime();
                // Get activities for this week and last week
                const thisWeekActivities = this.data.activities.filter(a => {
                    const actDate = new Date(a.date + 'T12:00:00');
                    return actDate >= startOfWeek && actDate <= endOfWeek;
                });
                
                const lastWeekActivities = this.data.activities.filter(a => {
                    const actDate = new Date(a.date + 'T12:00:00');
                    return actDate >= lastWeekStart && actDate <= lastWeekEnd;
                });
                
                // Calculate chart data - STEPS ONLY (not distance)
                const thisWeekSteps = [0, 0, 0, 0, 0, 0, 0]; // Sun-Sat
                const lastWeekSteps = [0, 0, 0, 0, 0, 0, 0];
                
                thisWeekActivities.forEach(a => {
                    if (a.steps) {
                        const actDate = new Date(a.date + 'T12:00:00');
                        const dayIndex = actDate.getDay();
                        thisWeekSteps[dayIndex] += a.steps;
                    }
                });
                
                lastWeekActivities.forEach(a => {
                    if (a.steps) {
                        const actDate = new Date(a.date + 'T12:00:00');
                        const dayIndex = actDate.getDay();
                        lastWeekSteps[dayIndex] += a.steps;
                    }
                });
                
                const maxChartValue = Math.max(...thisWeekSteps, ...lastWeekSteps, 1);
                
                // Aggregate activities by type for THIS WEEK
                const thisWeekTotals = {};
                thisWeekActivities.forEach(a => {
                    const key = a.type;
                    if (!thisWeekTotals[key]) {
                        thisWeekTotals[key] = { steps: 0, distance: 0, reps: 0, floors: 0, days: new Set() };
                    }
                    if (a.steps) thisWeekTotals[key].steps += a.steps;
                    if (a.distance) thisWeekTotals[key].distance += a.distance;
                    if (a.reps) thisWeekTotals[key].reps += a.reps;
                    if (a.floors) thisWeekTotals[key].floors += a.floors;
                    thisWeekTotals[key].days.add(a.date);
                });
                
                // Aggregate activities by type for LAST WEEK
                const lastWeekTotals = {};
                lastWeekActivities.forEach(a => {
                    const key = a.type;
                    if (!lastWeekTotals[key]) {
                        lastWeekTotals[key] = { steps: 0, distance: 0, reps: 0, floors: 0, days: new Set() };
                    }
                    if (a.steps) lastWeekTotals[key].steps += a.steps;
                    if (a.distance) lastWeekTotals[key].distance += a.distance;
                    if (a.reps) lastWeekTotals[key].reps += a.reps;
                    if (a.floors) lastWeekTotals[key].floors += a.floors;
                    lastWeekTotals[key].days.add(a.date);
                });
                
                // Get unit preference
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                // Build activity lists with comparisons
                const cardioActivities = [];
                const strengthActivities = [];
                
                Object.keys(thisWeekTotals).forEach(activityType => {
                    const thisWeek = thisWeekTotals[activityType];
                    const lastWeek = lastWeekTotals[activityType] || { steps: 0, distance: 0, reps: 0, floors: 0, days: new Set() };
                    const activityName = this.getActivityTypeName(activityType);
                    
                    // Skip activities that ONLY have steps (steps shown in chart only, not in lists)
                    const hasOnlySteps = thisWeek.steps > 0 && 
                                        thisWeek.distance === 0 && 
                                        thisWeek.reps === 0 && 
                                        thisWeek.floors === 0;
                    if (hasOnlySteps) {
                        return; // This is a steps-only activity, skip it
                    }
                    
                    // CARDIO: Distance-based (NOT STEPS), Stairs
                    if (thisWeek.distance > 0) {
                        let thisDistance = thisWeek.distance;
                        let lastDistance = lastWeek.distance;
                        if (this.data.goals.unitPreference === 'miles') {
                            thisDistance = thisDistance / 1.60934;
                            lastDistance = lastDistance / 1.60934;
                        }
                        
                        const diff = thisDistance - lastDistance;
                        const comparison = diff > 0 ? `+${diff.toFixed(1)}` : diff < 0 ? diff.toFixed(1) : '=';
                        
                        cardioActivities.push({
                            name: activityName,
                            value: thisDistance.toFixed(1),
                            unit: unit,
                            comparison: comparison,
                            isIncrease: diff > 0,
                            isDecrease: diff < 0
                        });
                    }
                    
                    if (thisWeek.floors > 0) {
                        const diff = thisWeek.floors - lastWeek.floors;
                        const comparison = diff > 0 ? `+${diff}` : diff < 0 ? `${diff}` : '=';
                        
                        cardioActivities.push({
                            name: activityName,
                            value: thisWeek.floors.toLocaleString(),
                            unit: thisWeek.floors === 1 ? 'floor' : 'floors',
                            comparison: comparison,
                            isIncrease: diff > 0,
                            isDecrease: diff < 0
                        });
                    }
                    
                    // STRENGTH: Reps-based, Log days
                    if (thisWeek.reps > 0) {
                        const diff = thisWeek.reps - lastWeek.reps;
                        const comparison = diff > 0 ? `+${diff}` : diff < 0 ? `${diff}` : '=';
                        
                        strengthActivities.push({
                            name: activityName,
                            value: thisWeek.reps.toLocaleString(),
                            unit: 'reps',
                            comparison: comparison,
                            isIncrease: diff > 0,
                            isDecrease: diff < 0
                        });
                    }
                    
                    // Log day activities (only if no reps/distance/floors/steps)
                    if (thisWeek.days.size > 0 && thisWeek.reps === 0 && thisWeek.distance === 0 && thisWeek.floors === 0 && thisWeek.steps === 0) {
                        const diff = thisWeek.days.size - lastWeek.days.size;
                        const comparison = diff > 0 ? `+${diff}` : diff < 0 ? `${diff}` : '=';
                        
                        strengthActivities.push({
                            name: activityName,
                            value: thisWeek.days.size,
                            unit: thisWeek.days.size === 1 ? 'day' : 'days',
                            comparison: comparison,
                            isIncrease: diff > 0,
                            isDecrease: diff < 0
                        });
                    }
                });
                
                // Generate HTML
                let html = `
                    <div class="weekly-report-shell">
                    <div class="weekly-report-header">
                        <button class="weekly-report-nav-btn" onclick="app.navigateWeeklyReport(-1)" aria-label="Previous week"></button>
                        <div style="flex: 1; text-align: center;">
                            <div class="weekly-report-title">Weekly Summary Ready</div>
                            <div class="weekly-report-date">${dateRange}</div>
                        </div>
                        <button class="weekly-report-nav-btn" onclick="app.navigateWeeklyReport(1)" ${isCurrentWeek ? 'disabled' : ''} aria-label="Next week"></button>
                    </div>
                    <div class="weekly-report-body">
                    
                    <div class="weekly-report-chart-section">
                        <div class="weekly-report-chart-title">Daily Steps</div>
                        <div style="max-width: 62.5%; margin: 0 auto;">
                            <div style="display: flex; gap: 8px; align-items: stretch;">
                                <div class="weekly-report-chart" style="flex: 1; position: relative;">
                `;
                
                // Calculate raw max and round UP to next 2k increment
                const rawMax = Math.max(...thisWeekSteps, ...lastWeekSteps, 1);
                const scaledMax = Math.max(Math.ceil(rawMax / 2000) * 2000, 2000); // Minimum 2k scale
                
                // Find last week's peak for reference line
                const lastWeekPeak = Math.max(...lastWeekSteps);
                
                // Generate Y-axis labels (5 ticks: 0%, 25%, 50%, 75%, 100%)
                const yAxisLabels = [];
                for (let i = 4; i >= 0; i--) {
                    const value = (scaledMax * i) / 4;
                    let label = '0';
                    if (value >= 1000) {
                        label = (value / 1000).toFixed(0) + 'k';
                    } else if (value > 0) {
                        label = Math.round(value).toString();
                    }
                    yAxisLabels.push({ value, label, percent: (i * 25) });
                }
                
                // Add reference line at last week's peak
                const peakPercent = scaledMax > 0 ? (lastWeekPeak / scaledMax * 100) : 0;
                
                if (lastWeekPeak > 0) {
                    html += `
                        <div style="
                            position: absolute;
                            left: 0;
                            right: 0;
                            bottom: ${peakPercent}%;
                            border-top: 1px dashed rgba(255,255,255,0.9);
                            opacity: 0.9;
                            pointer-events: none;
                            z-index: 0;
                        "></div>
                    `;
                }
                
                // Generate overlaid bars (use scaledMax for height calculations)
                thisWeekSteps.forEach((thisValue, index) => {
                    const lastValue = lastWeekSteps[index];
                    const thisHeight = scaledMax > 0 ? (thisValue / scaledMax * 100) : 0;
                    const lastHeight = scaledMax > 0 ? (lastValue / scaledMax * 100) : 0;
                    
                    html += `
                        <div class="weekly-report-chart-bar-container" style="position: relative;">
                            ${lastValue > 0 ? `
                            <div style="
                                position: absolute;
                                bottom: 0;
                                width: 4px;
                                height: ${Math.max(lastHeight, 8)}%;
                                border: 1px dashed rgba(255,255,255,0.85);
                                border-bottom: none;
                                border-radius: 4px 4px 0 0;
                                opacity: 0.5;
                                box-sizing: border-box;
                            "></div>
                            ` : ''}
                            ${thisValue > 0 ? `
                            <div class="weekly-report-chart-bar" style="height: ${Math.max(thisHeight, 8)}%; position: relative; z-index: 1;"></div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                            </div>
                            <div style="display: flex; flex-direction: column; justify-content: space-between; padding: 0 4px; font-size: 9px; color: #6b7280; font-weight: 600; min-width: 32px; text-align: left;">
                `;
                
                // Add Y-axis labels
                yAxisLabels.forEach(tick => {
                    html += `<div style="line-height: 1;">${tick.label}</div>`;
                });
                
                html += `
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; padding: 0 20px;">
                            <div style="flex: 1; display: flex; justify-content: space-around; gap: 8px;">
                                <span style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; font-weight: 600;">S</span>
                                <span style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; font-weight: 600;">M</span>
                                <span style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; font-weight: 600;">T</span>
                                <span style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; font-weight: 600;">W</span>
                                <span style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; font-weight: 600;">T</span>
                                <span style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; font-weight: 600;">F</span>
                                <span style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; font-weight: 600;">S</span>
                            </div>
                            <div style="min-width: 32px;"></div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="weekly-report-stats-section">
                        <div class="weekly-report-stat-column">
                            <div class="weekly-report-stat-column-title">Cardio</div>
                `;
                
                if (cardioActivities.length === 0) {
                    html += `<div class="weekly-report-stat-item"><span class="weekly-report-stat-label" style="color: #6b7280;">No cardio logged</span></div>`;
                } else {
                    cardioActivities.forEach(item => {
                        const compColor = item.isIncrease ? '#10b981' : item.isDecrease ? '#ef4444' : 'var(--primary-light)';
                        html += `
                            <div class="weekly-report-stat-item">
                                <span class="weekly-report-stat-label" title="${item.name}">${item.name}</span>
                                <span class="weekly-report-stat-value">
                                    ${item.value} ${item.unit}
                                    <span class="weekly-report-stat-comp" style="color: ${compColor};">${item.comparison}</span>
                                </span>
                            </div>
                        `;
                    });
                }
                
                html += `
                        </div>
                        <div class="weekly-report-stat-column">
                            <div class="weekly-report-stat-column-title">Strength</div>
                `;
                
                if (strengthActivities.length === 0) {
                    html += `<div class="weekly-report-stat-item"><span class="weekly-report-stat-label" style="color: #6b7280;">No strength logged</span></div>`;
                } else {
                    strengthActivities.forEach(item => {
                        const compColor = item.isIncrease ? '#10b981' : item.isDecrease ? '#ef4444' : 'var(--primary-light)';
                        html += `
                            <div class="weekly-report-stat-item">
                                <span class="weekly-report-stat-label" title="${item.name}">${item.name}</span>
                                <span class="weekly-report-stat-value">
                                    ${item.value} ${item.unit}
                                    <span class="weekly-report-stat-comp" style="color: ${compColor};">${item.comparison}</span>
                                </span>
                            </div>
                        `;
                    });
                }
                
                html += `
                        </div>
                    </div>
                    
                    </div>
                    <div class="weekly-report-footer">
                    <div class="weekly-report-actions">
                        <button class="weekly-report-action-btn" onclick="app.closeWeeklyReport()">Dismiss</button>
                        <button class="weekly-report-action-btn" onclick="app.closeWeeklyReport(); app.showScreen('calendar')">Go to Calendar</button>
                        <button class="weekly-report-action-btn primary" onclick="app.saveWeeklyReportImage()">Save Image</button>
                    </div>
                `;
                
                container.innerHTML = html;
            },
            
            getActivityTypeName(type) {
                // Map activity types to display names
                const nameMap = {
                    'run': 'Running',
                    'walk': 'Walking',
                    'biking': 'Biking',
                    'dog': 'Dog Walking',
                    'hiking': 'Hiking',
                    'pushups': 'Push-ups',
                    'pullups': 'Pull-ups',
                    'rollerabs': 'Ab Wheel Rollout',
                    'dips': 'Dips',
                    'squats': 'Squats',
                    'situps': 'Sit-ups',
                    'arm': 'Arm Day',
                    'back': 'Back Day',
                    'chest': 'Chest Day',
                    'core': 'Core Day',
                    'fullbody': 'Full Body',
                    'leg': 'Leg Day',
                    'shoulder': 'Shoulder Day',
                    'stairs': 'Stairs'
                };
                
                // Check if it's a custom exercise
                if (type && type.startsWith && type.startsWith('custom-')) {
                    const parts = type.split('-');
                    if (parts.length === 3) {
                        const categoryIdNum = parseInt(parts[1], 10);
                        const exerciseIdNum = parseInt(parts[2], 10);
                        const categoryIdStr = parts[1];
                        const exerciseIdStr = parts[2];

                        const category = this.data.customCategories?.find(c => String(c.id) === categoryIdStr || c.id === categoryIdNum);
                        if (category) {
                            const exercise = category.exercises?.find(e => String(e.id) === exerciseIdStr || e.id === exerciseIdNum);
                            if (exercise) {
                                return exercise.name;
                            }
                        }
                    }
                }
                
                return nameMap[type] || (type ? type.charAt(0).toUpperCase() + type.slice(1) : 'Unknown');
            },
            
            saveWeeklyReportImage() {
                alert('Save Image feature coming soon! This will capture the report as a PNG.');
                // TODO: Implement html2canvas or similar library
                this.closeWeeklyReport();
            },

            // Show Track Activity info modal
            showTrackInfo() {
                const modal = document.getElementById('track-info-modal');
                if (modal) {
                    modal.classList.add('active');
                }
            },

            // Show Dashboard info modal
            showDashboardInfo() {
                const modal = document.getElementById('dashboard-info-modal');
                if (modal) {
                    modal.classList.add('active');
                }
            },

            // Show Goals info modal
            showGoalsInfo() {
                const modal = document.getElementById('goals-info-modal');
                if (modal) {
                    modal.classList.add('active');
                }
            },

            // Show Leaderboard info modal
            showLeaderboardInfo() {
                const modal = document.getElementById('leaderboard-info-modal');
                if (modal) {
                    modal.classList.add('active');
                }
            },

            // Close info modals
            closeInfoModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                }
            },

            // Get weight statistics and trends
            getWeightStats() {
                if (!this.data.weights || this.data.weights.length === 0) {
                    const initial = (this.data.goals.initialWeight !== null && this.data.goals.initialWeight !== undefined)
                        ? Number(this.data.goals.initialWeight)
                        : null;

                    if (initial !== null && !isNaN(initial) && initial > 0) {
                        return {
                            current: initial,
                            trend: 'stable',
                            trendValue: 0,
                            unit: this.data.goals.weightUnit,
                            trendIsVsInitial: true
                        };
                    }

                    return {
                        current: null,
                        trend: null,
                        trendValue: 0,
                        unit: this.data.goals.weightUnit,
                        trendIsVsInitial: false
                    };
                }

                // Get most recent weight
                const sortedWeights = [...this.data.weights].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                const current = sortedWeights[0];

                // Determine trend value
                // If initialWeight is set, show change vs initial (profile baseline).
                // Otherwise, fall back to 7-day trend.
                const initial = (this.data.goals.initialWeight !== null && this.data.goals.initialWeight !== undefined)
                    ? Number(this.data.goals.initialWeight)
                    : null;

                let trend = 'stable';
                let trendValue = 0;

                if (initial !== null && !isNaN(initial) && initial > 0) {
                    trendValue = current.weight - initial;
                    if (Math.abs(trendValue) < 0.5) {
                        trend = 'stable';
                    } else if (trendValue > 0) {
                        trend = 'up';
                    } else {
                        trend = 'down';
                    }
                } else {
                    // Get weight from 7 days ago for trend
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

                    const pastWeight = this.data.weights.find(w => w.date <= sevenDaysAgoStr);

                    if (pastWeight) {
                        trendValue = current.weight - pastWeight.weight;
                        if (Math.abs(trendValue) < 0.5) {
                            trend = 'stable';
                        } else if (trendValue > 0) {
                            trend = 'up';
                        } else {
                            trend = 'down';
                        }
                    }
                }

                return {
                    current: current.weight,
                    trend: trend,
                    trendValue: trendValue,
                    unit: current.unit,
                    trendIsVsInitial: (initial !== null && !isNaN(initial) && initial > 0)
                };
            },

            // Calculate weight loss (starting weight - current weight)
            calculateWeightLoss() {
                // Standard: signed percent change from initial to current (negative = loss, positive = gain)
                return this.calculateWeightChangePctAllTime();
            },

            calculateWeightChangePctAllTime() {
                if (!this.data.weights || this.data.weights.length === 0) return null;

                // Sort weights by date to get current (latest)
                const sorted = [...this.data.weights].sort((a, b) => new Date(a.date) - new Date(b.date));
                const current = sorted[sorted.length - 1]?.weight;

                // Standard baseline: initialWeight (profile attribute)
                const baseline = Number(this.data.goals.initialWeight);

                if (!baseline || baseline <= 0 || !current || current <= 0) return null;

                const pct = ((current - baseline) / baseline) * 100;
                return Math.round(pct * 10) / 10; // 1 decimal
            },

            calculateWeightChangePctForPeriod(period) {
                // period: 'week' | 'month'
                if (!this.data.weights || this.data.weights.length === 0) return null;

                const now = new Date();
                const thisStart = new Date(now);
                const thisEnd = new Date(now);

                if (period === 'week') {
                    // This week: Sunday 00:00 to Saturday 23:59:59
                    const day = thisStart.getDay(); // 0 = Sunday
                    thisStart.setDate(thisStart.getDate() - day);
                    thisStart.setHours(0, 0, 0, 0);

                    thisEnd.setTime(thisStart.getTime());
                    thisEnd.setDate(thisStart.getDate() + 7);
                } else if (period === 'month') {
                    // This month: 1st day 00:00 to last day 23:59:59
                    thisStart.setDate(1);
                    thisStart.setHours(0, 0, 0, 0);

                    thisEnd.setFullYear(thisStart.getFullYear(), thisStart.getMonth() + 1, 1);
                    thisEnd.setHours(0, 0, 0, 0);
                } else {
                    return null;
                }

                // Get latest weight from THIS period
                const thisWeights = this.data.weights
                    .map(w => ({...w, _d: new Date(w.date + 'T00:00:00')}))
                    .filter(w => w._d >= thisStart && w._d < thisEnd)
                    .sort((a, b) => a._d - b._d);

                if (thisWeights.length === 0) return null;

                const currentWeight = thisWeights[thisWeights.length - 1].weight;

                // Get latest weight from LAST period
                const lastStart = new Date(thisStart);
                const lastEnd = new Date(thisStart);

                if (period === 'week') {
                    lastStart.setDate(lastStart.getDate() - 7);
                } else if (period === 'month') {
                    lastStart.setMonth(lastStart.getMonth() - 1);
                }

                const lastWeights = this.data.weights
                    .map(w => ({...w, _d: new Date(w.date + 'T00:00:00')}))
                    .filter(w => w._d >= lastStart && w._d < lastEnd)
                    .sort((a, b) => a._d - b._d);

                let previousWeight;

                if (lastWeights.length === 0) {
                    // Fallback: Use earliest weight entry ever (for new users or first period)
                    const allWeights = [...this.data.weights]
                        .map(w => ({...w, _d: new Date(w.date + 'T00:00:00')}))
                        .sort((a, b) => a._d - b._d);
                    
                    if (allWeights.length === 0) return null;
                    previousWeight = allWeights[0].weight;
                } else {
                    previousWeight = lastWeights[lastWeights.length - 1].weight;
                }

                if (!previousWeight || previousWeight <= 0 || !currentWeight || currentWeight <= 0) return null;

                const pct = ((currentWeight - previousWeight) / previousWeight) * 100;
                return Math.round(pct * 10) / 10;
            },

            
            // Signed weight change in lbs from initial weight to latest (negative = loss, positive = gain)
            calculateWeightChangeLbsAllTime() {
                if (!this.data.weights || this.data.weights.length === 0) return null;

                const sorted = [...this.data.weights].sort((a, b) => new Date(a.date) - new Date(b.date));
                const current = sorted[sorted.length - 1]?.weight;

                const baseline = Number(this.data.goals.initialWeight);
                if (!baseline || baseline <= 0 || !current || current <= 0) return null;

                const delta = current - baseline;
                return Math.round(delta * 10) / 10; // 1 decimal
            },

            // Signed weight change in lbs within a period window (week/month); compares this period vs last period
            calculateWeightChangeLbsForPeriod(period) {
                if (!this.data.weights || this.data.weights.length === 0) return null;

                const now = new Date();
                const thisStart = new Date(now);
                const thisEnd = new Date(now);

                if (period === 'week') {
                    // This week: Sunday 00:00 to Saturday 23:59:59
                    const day = thisStart.getDay(); // 0 = Sunday
                    thisStart.setDate(thisStart.getDate() - day);
                    thisStart.setHours(0, 0, 0, 0);

                    thisEnd.setTime(thisStart.getTime());
                    thisEnd.setDate(thisStart.getDate() + 7);
                } else if (period === 'month') {
                    // This month: 1st day 00:00 to last day 23:59:59
                    thisStart.setDate(1);
                    thisStart.setHours(0, 0, 0, 0);

                    thisEnd.setMonth(thisStart.getMonth() + 1);
                    thisEnd.setDate(1);
                    thisEnd.setHours(0, 0, 0, 0);
                } else {
                    return null;
                }

                // Get latest weight from THIS period
                const thisWeights = this.data.weights
                    .map(w => ({...w, _d: new Date(w.date + 'T00:00:00')}))
                    .filter(w => w._d >= thisStart && w._d < thisEnd)
                    .sort((a, b) => a._d - b._d);

                if (thisWeights.length === 0) return null;

                const currentWeight = thisWeights[thisWeights.length - 1].weight;

                // Get latest weight from LAST period
                const lastStart = new Date(thisStart);
                const lastEnd = new Date(thisStart);

                if (period === 'week') {
                    lastStart.setDate(lastStart.getDate() - 7);
                } else if (period === 'month') {
                    lastStart.setMonth(lastStart.getMonth() - 1);
                }

                const lastWeights = this.data.weights
                    .map(w => ({...w, _d: new Date(w.date + 'T00:00:00')}))
                    .filter(w => w._d >= lastStart && w._d < lastEnd)
                    .sort((a, b) => a._d - b._d);

                let previousWeight;

                if (lastWeights.length === 0) {
                    // Fallback: Use earliest weight entry ever (for new users or first period)
                    const allWeights = [...this.data.weights]
                        .map(w => ({...w, _d: new Date(w.date + 'T00:00:00')}))
                        .sort((a, b) => a._d - b._d);
                    
                    if (allWeights.length === 0) return null;
                    previousWeight = allWeights[0].weight;
                } else {
                    previousWeight = lastWeights[lastWeights.length - 1].weight;
                }

                if (!previousWeight || previousWeight <= 0 || !currentWeight || currentWeight <= 0) return null;

                const delta = currentWeight - previousWeight;
                return Math.round(delta * 10) / 10;
            },
// Animate count-up for numbers
            animateCountUp(element, target, duration = 800) {
                const start = 0;
                const startTime = performance.now();
                const isDecimal = !Number.isInteger(target);

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const current = start + (target - start) * easeOut;
                    
                    if (isDecimal) {
                        element.textContent = current.toFixed(1);
                    } else {
                        element.textContent = Math.floor(current).toLocaleString();
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        if (isDecimal) {
                            element.textContent = target.toFixed(1);
                        } else {
                            element.textContent = target.toLocaleString();
                        }
                    }
                };

                requestAnimationFrame(animate);
            },

            // Render bar graphs for week/month comparisons
            renderBarGraphs(stats) {
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                // Calculate this week vs last week
                const today = new Date();
                const lastWeekStart = new Date(today);
                lastWeekStart.setDate(today.getDate() - 14);
                const lastWeekEnd = new Date(today);
                lastWeekEnd.setDate(today.getDate() - 7);

                let lastWeekDistance = 0;
                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    if (activityDate >= lastWeekStart && activityDate < lastWeekEnd && activity.distance) {
                        lastWeekDistance += activity.distance;
                    }
                });

                if (this.data.goals.unitPreference === 'miles') {
                    lastWeekDistance = lastWeekDistance / 1.60934;
                }
                lastWeekDistance = Math.round(lastWeekDistance * 10) / 10;

                // Calculate this month vs last month
                const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);

                let thisMonthDistance = 0;
                let lastMonthDistance = 0;

                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    if (activityDate >= thisMonthStart && activity.distance) {
                        thisMonthDistance += activity.distance;
                    }
                    if (activityDate >= lastMonthStart && activityDate <= lastMonthEnd && activity.distance) {
                        lastMonthDistance += activity.distance;
                    }
                });

                if (this.data.goals.unitPreference === 'miles') {
                    thisMonthDistance = thisMonthDistance / 1.60934;
                    lastMonthDistance = lastMonthDistance / 1.60934;
                }
                thisMonthDistance = Math.round(thisMonthDistance * 10) / 10;
                lastMonthDistance = Math.round(lastMonthDistance * 10) / 10;

                // Render week comparison
                const maxWeek = Math.max(stats.thisWeekDistance, lastWeekDistance, 1);
                const weekCurrentPercent = (stats.thisWeekDistance / maxWeek) * 100;
                const weekPreviousPercent = (lastWeekDistance / maxWeek) * 100;

                document.getElementById('week-current-bar').style.width = `${weekCurrentPercent}%`;
                document.getElementById('week-previous-bar').style.width = `${weekPreviousPercent}%`;
                document.getElementById('week-current-value').textContent = `${stats.thisWeekDistance} ${unit}`;
                document.getElementById('week-previous-value').textContent = `${lastWeekDistance} ${unit}`;

                // Render month comparison
                const maxMonth = Math.max(thisMonthDistance, lastMonthDistance, 1);
                const monthCurrentPercent = (thisMonthDistance / maxMonth) * 100;
                const monthPreviousPercent = (lastMonthDistance / maxMonth) * 100;

                document.getElementById('month-current-bar').style.width = `${monthCurrentPercent}%`;
                document.getElementById('month-previous-bar').style.width = `${monthPreviousPercent}%`;
                document.getElementById('month-current-value').textContent = `${thisMonthDistance} ${unit}`;
                document.getElementById('month-previous-value').textContent = `${lastMonthDistance} ${unit}`;
            },

            // Get trend indicator for comparing current vs previous values
            getTrendIndicator(current, previous) {
                // Don't show trend if current value is 0 (nothing to trend from)
                if (!current || current === 0) {
                    return '';
                }
                
                // Don't show trend if no previous data to compare against
                if (!previous || previous === 0) {
                    return ''; // No trend if no previous data
                }
                
                const diff = current - previous;
                const percentChange = Math.abs((diff / previous) * 100);
                
                // Only show trend if change is significant (>5%)
                if (percentChange < 5) {
                    return '';
                }
                
                if (diff > 0) {
                    return '<span class="trend-indicator up" style="font-size: 11px; margin-left: 4px;"></span>';
                } else if (diff < 0) {
                    return '<span class="trend-indicator down" style="font-size: 11px; margin-left: 4px;\"></span>';
                } else {
                    return '';
                }
            },

            // Update weight summary card on dashboard
            updateWeightSummary() {
                const weightStats = this.getWeightStats();
                const weightCard = document.getElementById('weight-summary-card');
                
                if (weightStats.current) {
                    // Show weight card
                    weightCard.style.display = 'block';
                    
                    // Update weight value
                    document.getElementById('weight-display-value').textContent = weightStats.current.toFixed(1);
                    document.getElementById('weight-display-unit').textContent = weightStats.unit;
                    
                    // Update trend indicator
                    const trendElement = document.getElementById('weight-trend-indicator');
                    const trendLabel = (weightStats.trendIsVsInitial) ? ' since start' : '';
                    if (weightStats.trend === 'up') {
                        trendElement.innerHTML = '<span class="trend-indicator up"> +' + Number(weightStats.trendValue).toFixed(1) + ' ' + weightStats.unit + trendLabel + '</span>';
                    } else if (weightStats.trend === 'down') {
                        trendElement.innerHTML = '<span class="trend-indicator down"> ' + Number(weightStats.trendValue).toFixed(1) + ' ' + weightStats.unit + trendLabel + '</span>';
                    } else {
                        trendElement.innerHTML = '<span class="trend-indicator stable"> No change' + trendLabel + '</span>';
                    }
                    
                    // Render weight history
                    this.renderWeightHistory();
                } else {
                    // Hide weight card if no data
                    weightCard.style.display = 'none';
                }
            },

            // Toggle weight history expand/collapse
            toggleWeightHistory() {
                const historyList = document.getElementById('weight-history-list');
                const toggleBtn = document.getElementById('weight-history-toggle');
                
                if (historyList.classList.contains('expanded')) {
                    historyList.classList.remove('expanded');
                    toggleBtn.textContent = 'View History ';
                } else {
                    historyList.classList.add('expanded');
                    toggleBtn.textContent = 'Hide History ';
                }
            },

            // Render weight history list
            renderWeightHistory() {
                const historyList = document.getElementById('weight-history-list');
                
                if (!this.data.weights || this.data.weights.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 8px; font-size: 12px;">No weight entries yet</div>';
                    return;
                }

                // Sort by date descending (newest first)
                const sortedWeights = [...this.data.weights].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );

                historyList.innerHTML = sortedWeights.map((entry, index) => {
                    const date = new Date(entry.date + 'T12:00:00');
                    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    return `
                        <div class="weight-entry">
                            <div class="weight-entry-date">${formattedDate}</div>
                            <div class="weight-entry-value">${entry.weight.toFixed(1)} ${entry.unit}</div>
                            <div class="weight-entry-actions">
                                <button class="weight-entry-btn weight-entry-edit" onclick="app.editWeight('${entry.date}')">Edit</button>
                                <button class="weight-entry-btn weight-entry-delete" onclick="app.deleteWeight('${entry.date}')"></button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // Edit weight entry
            editWeight(date) {
                const entry = this.data.weights.find(w => w.date === date);
                if (!entry) return;

                const newWeight = prompt(`Edit weight for ${date}:`, entry.weight);
                if (newWeight === null) return; // Cancelled

                const parsedWeight = parseFloat(newWeight);
                if (isNaN(parsedWeight) || parsedWeight <= 0) {
                    alert('Please enter a valid weight');
                    return;
                }

                // Update the entry
                entry.weight = parsedWeight;
                
                this.saveData();
                this.updateWeightSummary();
                this.updateDashboard();
                
                // Sync to Firebase if PALS is set up
                if (this.data.pals.myPalCode) {
                    this.syncMyStatsToFirebase();
                }
            },

            // Delete weight entry
            deleteWeight(date) {
                if (!confirm(`Delete weight entry for ${date}?`)) return;

                // Remove the entry
                this.data.weights = this.data.weights.filter(w => w.date !== date);
                
                this.saveData();
                this.updateWeightSummary();
                this.updateDashboard();
                
                // Sync to Firebase if PALS is set up
                if (this.data.pals.myPalCode) {
                    this.syncMyStatsToFirebase();
                }
            },

            // ============================================
            // PALS FEATURE (v1.7.0)
            // ============================================

            // Initialize Firebase
            initFirebase() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyAT7pbbabXIpOOvNJTqqAn0IrjG8Ipl4K8",
                        authDomain: "juststep.firebaseapp.com",
                        projectId: "juststep",
                        storageBucket: "juststep.firebasestorage.app",
                        messagingSenderId: "366703889902",
                        appId: "1:366703889902:web:ee5150cb30477773e4d2ff",
                        measurementId: "G-HGGTFEK172"
                    };

                    this.firebase = firebase.initializeApp(firebaseConfig);
                    this.db = firebase.firestore();
                    console.log(' Firebase initialized');
                } catch (error) {
                    console.error('Firebase init error:', error);
                }
            },

            // Update PALS UI
            updatePalsUI() {
                // Update display elements in compact design
                const shareCodeDisplay = document.getElementById('display-pal-code');
                const displayNameDisplay = document.getElementById('display-display-name');
                const shareCodeBtn = document.getElementById('pal-code-btn');
                
                if (shareCodeDisplay) {
                    shareCodeDisplay.textContent = this.data.pals.myPalCode || 'Not set';
                }
                
                if (displayNameDisplay) {
                    displayNameDisplay.textContent = this.data.pals.displayName || 'Not set';
                }
                
                // Update button text based on whether code exists
                if (shareCodeBtn) {
                    if (this.data.pals.myPalCode) {
                        shareCodeBtn.textContent = 'Share';
                        shareCodeBtn.style.background = 'var(--primary-dark)';
                    } else {
                        shareCodeBtn.textContent = 'Set Code';
                        shareCodeBtn.style.background = '#6b7280';
                    }
                }
                
                // Update checkbox
                const hasPalCode = !!(this.data.pals && this.data.pals.myPalCode);
                const checkbox = document.getElementById('join-leaderboard');
                if (checkbox) {
                    // Only allow leaderboard participation once PAL Code is set
                    checkbox.checked = (this.data.pals.joinedLeaderboard || false) && hasPalCode;
                    checkbox.disabled = !hasPalCode;
                    checkbox.style.opacity = checkbox.disabled ? '0.5' : '1';
                    checkbox.style.cursor = checkbox.disabled ? 'not-allowed' : 'pointer';
                }

                const weightCheckbox = document.getElementById('join-weight-leaderboard');
                if (weightCheckbox) {
                    const eligibleForWeight = this.isWeightLeaderboardEligible();
                    // Weight leaderboard only available when:
                    // 1) PAL Code exists
                    // 2) User is in leaderboards (Steps/Distance)
                    // 3) Initial weight + at least one weigh-in exist
                    const canToggleWeight = hasPalCode && (this.data.pals.joinedLeaderboard || false) && eligibleForWeight;

                    weightCheckbox.checked = (this.data.pals.joinWeightLeaderboard || false) && canToggleWeight;
                    weightCheckbox.disabled = !canToggleWeight;
                    weightCheckbox.style.opacity = weightCheckbox.disabled ? '0.5' : '1';
                    weightCheckbox.style.cursor = weightCheckbox.disabled ? 'not-allowed' : 'pointer';
                }

                // Share Weight with Pals checkbox
                const shareWeightCheckbox = document.getElementById('share-weight-with-pals');
                if (shareWeightCheckbox) {
                    // Can share weight with pals if PAL Code exists
                    shareWeightCheckbox.checked = (this.data.pals.shareWeightWithPals || false) && hasPalCode;
                    shareWeightCheckbox.disabled = !hasPalCode;
                    shareWeightCheckbox.style.opacity = shareWeightCheckbox.disabled ? '0.5' : '1';
                    shareWeightCheckbox.style.cursor = shareWeightCheckbox.disabled ? 'not-allowed' : 'pointer';
                }

                this.renderPalsList();
                this.renderLeaderboard();
            },


            // Weight leaderboard eligibility:
            // Requires Initial Weight in Goals AND at least one weigh-in logged.
            isWeightLeaderboardEligible() {
                const iw = this.data && this.data.goals ? this.data.goals.initialWeight : null;
                const hasInitial = iw !== null && iw !== '' && !Number.isNaN(Number(iw));
                const hasWeighIns = Array.isArray(this.data.weights) && this.data.weights.length > 0;
                return hasInitial && hasWeighIns;
            },

            // Toggle leaderboard participation (Steps/Distance).
            // Only allowed once PAL Code is set.
            async toggleLeaderboard() {
                const checkbox = document.getElementById('join-leaderboard');
                const hasPalCode = !!(this.data.pals && this.data.pals.myPalCode);

                if (!hasPalCode) {
                    if (checkbox) checkbox.checked = false;
                    this.data.pals.joinedLeaderboard = false;
                    this.data.pals.joinWeightLeaderboard = false;
                    this.saveData();
                    this.updatePalsUI();
                    alert('Create your PAL Code first to join the leaderboards.');
                    return;
                }

                const joined = !!(checkbox && checkbox.checked);
                this.data.pals.joinedLeaderboard = joined;

                // If leaving leaderboards, also leave weight leaderboard
                if (!joined) {
                    this.data.pals.joinWeightLeaderboard = false;
                    const weightCheckbox = document.getElementById('join-weight-leaderboard');
                    if (weightCheckbox) weightCheckbox.checked = false;
                }

                this.saveData();
                this.updatePalsUI();

                // Sync if possible (non-blocking)
                try { await this.syncMyStatsToFirebase(); } catch (e) {}
            },

            // Toggle Weight leaderboard opt-in.
            // Only enabled once eligibility requirements are met.
            async toggleWeightLeaderboardOptIn() {
                const weightCheckbox = document.getElementById('join-weight-leaderboard');
                const hasPalCode = !!(this.data.pals && this.data.pals.myPalCode);

                if (!hasPalCode || !(this.data.pals.joinedLeaderboard || false)) {
                    if (weightCheckbox) weightCheckbox.checked = false;
                    this.data.pals.joinWeightLeaderboard = false;
                    this.saveData();
                    this.updatePalsUI();
                    return;
                }

                if (!this.isWeightLeaderboardEligible()) {
                    if (weightCheckbox) weightCheckbox.checked = false;
                    this.data.pals.joinWeightLeaderboard = false;
                    this.saveData();
                    this.updatePalsUI();
                    alert('To join the Weight leaderboard, add your Initial Weight in Goals and log at least one weigh-in.');
                    return;
                }

                this.data.pals.joinWeightLeaderboard = !!(weightCheckbox && weightCheckbox.checked);
                this.saveData();
                this.updatePalsUI();

                // Sync if possible (non-blocking)
                try { await this.syncMyStatsToFirebase(); } catch (e) {}
            },

            // Toggle share weight with pals
            async toggleShareWeightWithPals() {
                const checkbox = document.getElementById('share-weight-with-pals');
                const hasPalCode = !!(this.data.pals && this.data.pals.myPalCode);

                if (!hasPalCode) {
                    if (checkbox) checkbox.checked = false;
                    this.data.pals.shareWeightWithPals = false;
                    this.saveData();
                    this.updatePalsUI();
                    return;
                }

                this.data.pals.shareWeightWithPals = !!(checkbox && checkbox.checked);
                this.saveData();
                this.updatePalsUI();

                // Sync if possible (non-blocking)
                try { await this.syncMyStatsToFirebase(); } catch (e) {}
            },

            // Share my code via text/messaging
            
// -------- PAL Code / Display Name modal helpers (v1.7.0) --------
createModalOverlay(titleText) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.background = 'rgba(0,0,0,0.6)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '9999';

    const modal = document.createElement('div');
    modal.style.width = 'min(420px, 92vw)';
    modal.style.background = '#1f1f1f';
    modal.style.border = '1px solid rgba(255,255,255,0.08)';
    modal.style.borderRadius = '16px';
    modal.style.boxShadow = '0 20px 60px rgba(0,0,0,0.55)';
    modal.style.padding = '18px';

    const title = document.createElement('div');
    title.textContent = titleText;
    title.style.fontSize = '18px';
    title.style.fontWeight = '700';
    title.style.color = '#fff';
    title.style.marginBottom = '10px';

    modal.appendChild(title);
    overlay.appendChild(modal);

    return { overlay, modal };
},

promptModal({ title, bodyNode, okText='OK', cancelText='Cancel' }) {
    return new Promise((resolve) => {
        const { overlay, modal } = this.createModalOverlay(title);

        const bodyWrap = document.createElement('div');
        bodyWrap.appendChild(bodyNode);
        modal.appendChild(bodyWrap);

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '10px';
        actions.style.marginTop = '14px';

        const btnCancel = document.createElement('button');
        btnCancel.textContent = cancelText;
        btnCancel.style.flex = '1';
        btnCancel.className = 'secondary-btn';
        btnCancel.onclick = () => {
            document.body.removeChild(overlay);
            resolve(null);
        };

        const btnOk = document.createElement('button');
        btnOk.textContent = okText;
        btnOk.style.flex = '1';
        btnOk.className = 'primary-btn';
        btnOk.onclick = () => {
            document.body.removeChild(overlay);
            resolve(true);
        };

        actions.appendChild(btnCancel);
        actions.appendChild(btnOk);
        modal.appendChild(actions);

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                document.body.removeChild(overlay);
                resolve(null);
            }
        });

        document.body.appendChild(overlay);
    });
},

async promptForPalCode() {
    const wrap = document.createElement('div');

    const desc = document.createElement('div');
    desc.textContent = 'Enter a 4-digit PAL Code (numbers only). Leading zeros are allowed.';
    desc.style.color = 'rgba(255,255,255,0.75)';
    desc.style.fontSize = '13px';
    desc.style.marginBottom = '12px';
    wrap.appendChild(desc);

    const input = document.createElement('input');
    input.type = 'tel';
    input.inputMode = 'numeric';
    input.autocomplete = 'one-time-code';
    input.placeholder = '0000';
    input.maxLength = 4;
    input.style.width = '100%';
    input.style.padding = '12px 14px';
    input.style.borderRadius = '12px';
    input.style.border = '1px solid rgba(255,255,255,0.12)';
    input.style.background = '#121212';
    input.style.color = '#fff';
    input.style.fontSize = '18px';
    input.style.letterSpacing = '4px';

    input.addEventListener('input', () => {
        input.value = input.value.replace(/\D/g, '').slice(0, 4);
    });

    wrap.appendChild(input);

    // show modal
    const result = await this.promptModal({ title: 'Create Your PAL Code', bodyNode: wrap, okText: 'OK', cancelText: 'Cancel' });
    if (!result) return null;

    const code = (input.value || '').trim();
    if (!/^\d{4}$/.test(code)) {
        alert(' PAL Code must be exactly 4 digits (example: 0042).');
        return await this.promptForPalCode();
    }
    return code;
},

async promptForDisplayName() {
    const wrap = document.createElement('div');

    const desc = document.createElement('div');
    desc.textContent = 'Enter the display name you want Pals to see.';
    desc.style.color = 'rgba(255,255,255,0.75)';
    desc.style.fontSize = '13px';
    desc.style.marginBottom = '12px';
    wrap.appendChild(desc);

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Display name';
    input.maxLength = 20;
    input.style.width = '100%';
    input.style.padding = '12px 14px';
    input.style.borderRadius = '12px';
    input.style.border = '1px solid rgba(255,255,255,0.12)';
    input.style.background = '#121212';
    input.style.color = '#fff';
    input.style.fontSize = '16px';

    wrap.appendChild(input);

    const result = await this.promptModal({ title: 'Set Display Name', bodyNode: wrap, okText: 'OK', cancelText: 'Cancel' });
    if (!result) return null;

    const name = (input.value || '').trim();
    if (!name) {
        alert(' Display Name cannot be empty.');
        return await this.promptForDisplayName();
    }
    return name;
},


shareMyPalCode() {
                const code = this.data.pals.myPalCode;
                if (!code) {
                    alert('Please save your PAL Code first!');
                    return;
                }

                const message = `Hey! Join me on JustStep fitness tracker! Add my code: ${code}`;
                
                // Try Web Share API (works on mobile)
                if (navigator.share) {
                    navigator.share({
                        title: 'JustStep - Join Me!',
                        text: message
                    }).catch(err => {
                        console.log('Share cancelled or failed:', err);
                    });
                } else {
                    // Fallback - copy to clipboard
                    navigator.clipboard.writeText(message).then(() => {
                        alert('Message copied to clipboard! Paste it in a text message.');
                    }).catch(() => {
                        // Final fallback - show alert with code
                        alert(message);
                    });
                }
            },

            // Save display name
            async saveDisplayName() {
                const name = document.getElementById('display-name').value.trim();
                
                if (!name) {
                    alert('Please enter a display name');
                    return;
                }

                this.data.pals.displayName = name;
                this.saveData();

                // Sync to Firebase
                await this.syncMyStatsToFirebase();

                const successEl = document.getElementById('display-name-success');
                successEl.classList.add('show');
                setTimeout(() => successEl.classList.remove('show'), 3000);
            },

            // Edit display name (button in MY PROFILE)
            async editDisplayName() {
                const current = (this.data.pals.displayName || '').trim();
                const entered = prompt('Edit your display name:', current);
                if (entered === null) return; // cancelled

                const name = String(entered).trim();
                if (!name) {
                    alert('Please enter a display name');
                    return;
                }

                this.data.pals.displayName = name;
                this.saveData();
                this.updatePalsUI();
                await this.syncMyStatsToFirebase();
            },

            // Prompt for a 4-digit PAL code using a numeric keyboard on mobile
            promptFourDigitPalCode() {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('palcode-prompt-overlay');
                    const input = document.getElementById('palcode-prompt-input');
                    const cancelBtn = document.getElementById('palcode-prompt-cancel');
                    const okBtn = document.getElementById('palcode-prompt-ok');
                    const msg = document.getElementById('palcode-prompt-message');

                    if (!overlay || !input || !cancelBtn || !okBtn || !msg) {
                        // Fallback to browser prompt (should be rare)
                        const raw = prompt(
                            'Create your PAL Code (4 digits):\n' +
                            'Numbers only (example: 0042).\n\n' +
                            'Note: Your PAL Code cannot be changed later.'
                        );
                        resolve(raw === null ? null : String(raw).trim());
                        return;
                    }

                    msg.textContent = 'Create your PAL Code (4 digits)';
                    input.value = '';
                    overlay.style.display = 'flex';

                    // Focus after display so mobile shows numeric keypad
                    setTimeout(() => {
                        input.focus();
                        input.select();
                    }, 50);

                    const cleanup = () => {
                        overlay.style.display = 'none';
                        cancelBtn.removeEventListener('click', onCancel);
                        okBtn.removeEventListener('click', onOk);
                        input.removeEventListener('keydown', onKeyDown);
                    };

                    const onCancel = () => {
                        cleanup();
                        resolve(null);
                    };

                    const onOk = () => {
                        const code = String(input.value || '').trim();
                        cleanup();
                        resolve(code);
                    };

                    const onKeyDown = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            onOk();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            onCancel();
                        }
                    };

                    cancelBtn.addEventListener('click', onCancel);
                    okBtn.addEventListener('click', onOk);
                    input.addEventListener('keydown', onKeyDown);
                });
            },

            // Edit PAL Code (inline prompt)

// Handle PAL Code button (Set Code or Share)
async handlePalCodeButton() {
    if (this.data.pals.myPalCode) {
        // Already has code - share it
        this.shareMyPalCode();
    } else {
        // No code - prompt to create
        await this.createPalCode();
    }
},

// Create PAL Code
// Create PAL Code
async createPalCode() {
    // PAL Code creation flow (4 digits)
    while (true) {
        const code = await this.promptFourDigitPalCode();
        if (code === null) return; // cancelled
        if (!/^\d{4}$/.test(code)) {
            alert(' Invalid PAL Code. Please enter exactly 4 digits (e.g., 0042).');
            continue;
        }

        const confirmLock = confirm(
            'Your PAL Code cannot be changed later.\n\n' +
            'Use PAL Code: ' + code + ' ?'
        );
        if (!confirmLock) continue;

        // Prompt for Display Name
        let displayName = '';
        while (!displayName) {
            const entered = prompt(
                'Enter your display name (shown to pals and on leaderboards):',
                (this.data.pals.displayName || '').trim()
            );
            if (entered === null) return; // cancelled
            displayName = String(entered).trim();
        }

        if (!this.db) {
            console.error('Firebase is not initialized (db is missing).');
            alert(' Firebase is not available. Please try again.');
            return;
        }

        try {
            const docRef = this.db.collection('users').doc(code);

            // Claim the code transactionally (protects against race conditions)
            await this.db.runTransaction(async (transaction) => {
                const doc = await transaction.get(docRef);
                if (doc.exists) throw new Error('CODE_TAKEN');

                // Snapshot stats at creation time (optional fields for leaderboards)
                const stats = this.calculateStats();
                const monthStats = this.calculateMonthStats();
                const weightStats = this.getWeightStats();
                const currentWeight = weightStats ? weightStats.current : null;
                const initialWeight = (this.data.goals.initialWeight !== null && this.data.goals.initialWeight !== undefined && this.data.goals.initialWeight !== '')
                    ? Number(this.data.goals.initialWeight)
                    : null;
                const weightLost = (initialWeight !== null && currentWeight !== null)
                    ? (initialWeight - currentWeight)
                    : null;
                const weightChangeLbsAllTime = this.calculateWeightChangeLbsAllTime();
                const weightChangePctThisWeek = this.calculateWeightChangePctForPeriod('week');
                const weightChangePctThisMonth = this.calculateWeightChangePctForPeriod('month');
                const weightChangeLbsThisWeek = this.calculateWeightChangeLbsForPeriod('week');
                const weightChangeLbsThisMonth = this.calculateWeightChangeLbsForPeriod('month');

                transaction.set(docRef, {
                    palCode: code,
                    displayName: displayName,
                    pals: [],
                    joinedLeaderboard: false,
                    joinWeightLeaderboard: false,

                    // Distance / steps / exercises snapshot
                    thisWeekDistance: stats.thisWeekDistance,
                    thisMonthDistance: monthStats.monthDistance,
                    totalDistance: stats.totalDistance,
                    thisWeekSteps: stats.thisWeekSteps,
                    thisMonthSteps: monthStats.monthSteps,
                    totalSteps: stats.totalSteps,
                    thisWeekPushups: stats.thisWeekPushups,
                    thisMonthPushups: monthStats.monthPushups,
                    totalPushups: stats.totalPushups,
                    thisWeekPullups: stats.thisWeekPullups,
                    thisMonthPullups: monthStats.monthPullups,
                    totalPullups: stats.totalPullups,
                    thisWeekSitups: stats.thisWeekSitups,
                    thisMonthSitups: monthStats.monthSitups,
                    totalSitups: stats.totalSitups,
                    thisWeekSquats: stats.thisWeekSquats,
                    thisMonthSquats: monthStats.monthSquats,
                    totalSquats: stats.totalSquats,

                    // Weight stats snapshot (leaderboard uses opt-in flag)
                    currentWeight: currentWeight,
                    initialWeight: initialWeight,
                    weightLost: weightLost,
                    weightChangeLbsAllTime: weightChangeLbsAllTime,
                    weightChangePctThisWeek: weightChangePctThisWeek,
                    weightChangePctThisMonth: weightChangePctThisMonth,
                    weightChangeLbsThisWeek: weightChangeLbsThisWeek,
                    weightChangeLbsThisMonth: weightChangeLbsThisMonth,

                    lastUpdated: new Date().toISOString()
                });
            });

            // Only persist locally after Firebase claim succeeds
            this.data.pals.myPalCode = code;
            this.data.pals.displayName = displayName;
            this.saveData();
            this.updatePalsUI();

            // Best-effort stats sync (merge update)
            await this.syncMyStatsToFirebase();

            alert(' PAL Code created! You can now share it.');
            return;
        } catch (err) {
            if (String(err && err.message) === 'CODE_TAKEN') {
                alert(' That PAL Code is already taken. Please try another.');
                continue;
            }
            console.error(err);
            alert(' Error creating PAL Code. Please try again.');
            return;
        }
    }
},
            // Sync my stats to Firebase
                        async syncMyStatsToFirebase() {
                if (!this.data.pals.myPalCode || !this.db) return;

                try {
                    const stats = this.calculateStats();
                    const monthStats = this.calculateMonthStats();

                    const weightStats = this.getWeightStats();
                    const currentWeight = (weightStats && weightStats.current !== undefined) ? weightStats.current : null;

                    const initialWeight = (this.data.goals.initialWeight !== null && this.data.goals.initialWeight !== undefined && this.data.goals.initialWeight !== '')
                        ? Number(this.data.goals.initialWeight)
                        : null;

                    const weightChangePctAllTime = this.calculateWeightChangePctAllTime();
                    const weightChangeLbsAllTime = this.calculateWeightChangeLbsAllTime();
                    const weightChangePctThisWeek = this.calculateWeightChangePctForPeriod('week');
                    const weightChangePctThisMonth = this.calculateWeightChangePctForPeriod('month');
                    const weightChangeLbsThisWeek = this.calculateWeightChangeLbsForPeriod('week');
                    const weightChangeLbsThisMonth = this.calculateWeightChangeLbsForPeriod('month');

                    const today = new Date().toISOString().split('T')[0];

                    const payload = {
                        palCode: this.data.pals.myPalCode,
                        displayName: this.data.pals.displayName || this.data.pals.myPalCode,
                        joinedLeaderboard: this.data.pals.joinedLeaderboard || false,
                        joinWeightLeaderboard: this.data.pals.joinWeightLeaderboard || false,
                        shareWeightWithPals: this.data.pals.shareWeightWithPals || false,
                        lastActivityDate: today,
                        stats: {
                            thisWeekDistance: stats.thisWeekDistance,
                            thisWeekStrengthDays: stats.thisWeekStrengthDays,
                            thisWeekSteps: stats.thisWeekSteps,
                            thisMonthDistance: monthStats.monthDistance,
                            thisMonthStrengthDays: monthStats.monthStrengthDays,
                            thisMonthSteps: monthStats.monthSteps,
                            totalDistance: stats.totalDistance,
                            totalSteps: stats.totalSteps,
                            totalStrengthDays: stats.totalStrengthDays,
                            thisWeekPushups: stats.thisWeekPushups,
                            thisMonthPushups: monthStats.monthPushups,
                            totalPushups: stats.totalPushups,
                            thisWeekPullups: stats.thisWeekPullups,
                            thisMonthPullups: monthStats.monthPullups,
                            totalPullups: stats.totalPullups,
                            thisWeekRollerAbs: stats.thisWeekRollerAbs,
                            thisMonthRollerAbs: monthStats.monthRollerAbs,
                            totalRollerAbs: stats.totalRollerAbs,
                            thisWeekDips: stats.thisWeekDips,
                            thisMonthDips: monthStats.monthDips,
                            totalDips: stats.totalDips,
                            thisWeekSquats: stats.thisWeekSquats,
                            thisMonthSquats: monthStats.monthSquats,
                            totalSquats: stats.totalSquats,
                            thisWeekSitups: stats.thisWeekSitups,
                            thisMonthSitups: monthStats.monthSitups,
                            totalSitups: stats.totalSitups,
                            thisWeekRunning: stats.thisWeekRunning,
                            thisMonthRunning: monthStats.monthRunning,
                            totalRunning: stats.totalRunning,
                            thisWeekWalking: stats.thisWeekWalking,
                            thisMonthWalking: monthStats.monthWalking,
                            totalWalking: stats.totalWalking,
                            thisWeekBiking: stats.thisWeekBiking,
                            thisMonthBiking: monthStats.monthBiking,
                            totalBiking: stats.totalBiking,
                            thisWeekDogWalk: stats.thisWeekDogWalk,
                            thisMonthDogWalk: monthStats.monthDogWalk,
                            totalDogWalk: stats.totalDogWalk,
                            thisWeekHiking: stats.thisWeekHiking,
                            thisMonthHiking: monthStats.monthHiking,
                            totalHiking: stats.totalHiking,
                            thisWeekStairs: stats.thisWeekStairs,
                            thisMonthStairs: monthStats.monthStairs,
                            totalStairs: stats.totalStairs,
                            // Only sync weight if user has opted to share with pals
                            weight: (this.data.pals.shareWeightWithPals || false) ? currentWeight : null,
                            weightChangePctThisWeek: weightChangePctThisWeek,
                            weightChangePctThisMonth: weightChangePctThisMonth,
                            weightChangePctAllTime: weightChangePctAllTime,
                            weightChangeLbsThisWeek: weightChangeLbsThisWeek,
                            weightChangeLbsThisMonth: weightChangeLbsThisMonth,
                            weightChangeLbsAllTime: weightChangeLbsAllTime
                        },
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await this.db.collection('users')
                        .doc(this.data.pals.myPalCode)
                        .set(payload, { merge: true });

                    console.log(' Stats synced to Firebase');
                } catch (error) {
                    console.error('Error syncing stats:', error);
                }
            },

            // Add pal
            async addPal() {
                const code = document.getElementById('add-pal-code').value.trim();
                const errorEl = document.getElementById('add-pal-error');
                const successEl = document.getElementById('add-pal-success');
                
                errorEl.classList.remove('show');
                successEl.classList.remove('show');

                if (!code) {
                    errorEl.textContent = 'Please enter a PAL Code';
                    errorEl.classList.add('show');
                    return;
                }

                // Format: 4 digits
                if (!/^\d{4}$/.test(code)) {
                    errorEl.textContent = 'Invalid PAL Code. Use 4 digits (example: 0042).';
                    errorEl.classList.add('show');
                    return;
                }


                if (code === this.data.pals.myPalCode) {
                    errorEl.textContent = "You can't add yourself!";
                    errorEl.classList.add('show');
                    return;
                }

                // Check if already added
                if (this.data.pals.friends.find(f => f.palCode === code)) {
                    errorEl.textContent = 'Already added this pal!';
                    errorEl.classList.add('show');
                    return;
                }

                // Fetch pal's data from Firebase
                try {
                    const doc = await this.db.collection('users').doc(code).get();
                    
                    if (!doc.exists) {
                        errorEl.textContent = 'PAL Code not found. Make sure your pal has set up their profile!';
                        errorEl.classList.add('show');
                        return;
                    }

                    const palData = doc.data();
                    
                    // Add to friends list
                    this.data.pals.friends.push({
                        palCode: code,
                        displayName: palData.displayName || code,
                        stats: palData.stats || {},
                        shareWeightWithPals: palData.shareWeightWithPals || false,
                        lastSync: new Date().toISOString()
                    });

                    this.saveData();
                    this.updatePalsUI();

                    document.getElementById('add-pal-code').value = '';
                    successEl.classList.add('show');
                    setTimeout(() => successEl.classList.remove('show'), 3000);
                } catch (error) {
                    console.error('Error adding pal:', error);
                    errorEl.textContent = 'Error adding pal. Try again!';
                    errorEl.classList.add('show');
                }
            },

            // Remove pal
            removePal(palCode) {
                if (!confirm(`Remove this pal?`)) return;

                this.data.pals.friends = this.data.pals.friends.filter(f => f.palCode !== palCode);
                this.saveData();
                this.updatePalsUI();
            },

            // Refresh pal's stats
            async refreshPalStats(palCode) {
                try {
                    const doc = await this.db.collection('users').doc(palCode).get();
                    
                    if (doc.exists) {
                        const palData = doc.data();
                        const friend = this.data.pals.friends.find(f => f.palCode === palCode);
                        if (friend) {
                            friend.stats = palData.stats || {};
                            friend.displayName = palData.displayName || palCode;
                            friend.shareWeightWithPals = palData.shareWeightWithPals || false;
                            friend.lastSync = new Date().toISOString();
                            this.saveData();
                            this.updatePalsUI();
                        }
                    }
                } catch (error) {
                    console.error('Error refreshing pal stats:', error);
                }
            },

            // Render pals list
            renderPalsList() {
                const listEl = document.getElementById('pals-list');
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                const weightUnit = 'lbs';
// Show empty state if no pals
                if (!this.data.pals.friends || this.data.pals.friends.length === 0) {
                    listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No pals yet. Add one above!</p>';
                    return;
                }

                // Build HTML for each pal
                listEl.innerHTML = this.data.pals.friends.map(pal => {
                    const stats = pal.stats || {};
                    const expandedClass = pal.expanded ? 'expanded' : '';
                    const arrow = pal.expanded ? '' : '';
                    
                    const activityItems = [];
                    
                    // Helper function to add activity rows
                    const addItem = (name, weekVal, monthVal, totalVal, suffix = '') => {
                        activityItems.push({
                            name,
                            week: weekVal > 0 ? `${weekVal.toLocaleString()}${suffix}` : '-',
                            month: monthVal > 0 ? `${monthVal.toLocaleString()}${suffix}` : '-',
                            total: totalVal > 0 ? `${totalVal.toLocaleString()}${suffix}` : '-'
                        });
                    };
                    
                    // Strength exercises
                    if (stats.totalPushups > 0 || stats.thisWeekPushups > 0) {
                        addItem('Push-ups', stats.thisWeekPushups || 0, stats.thisMonthPushups || 0, stats.totalPushups || 0, ' reps');
                    }
                    if (stats.totalPullups > 0 || stats.thisWeekPullups > 0) {
                        addItem('Pull-ups', stats.thisWeekPullups || 0, stats.thisMonthPullups || 0, stats.totalPullups || 0, ' reps');
                    }
                    if (stats.totalRollerAbs > 0 || stats.thisWeekRollerAbs > 0) {
                        addItem('Ab Wheel Rollout', stats.thisWeekRollerAbs || 0, stats.thisMonthRollerAbs || 0, stats.totalRollerAbs || 0, ' reps');
                    }
                    if (stats.totalDips > 0 || stats.thisWeekDips > 0) {
                        addItem('Dips', stats.thisWeekDips || 0, stats.thisMonthDips || 0, stats.totalDips || 0, ' reps');
                    }
                    if (stats.totalSquats > 0 || stats.thisWeekSquats > 0) {
                        addItem('Squats', stats.thisWeekSquats || 0, stats.thisMonthSquats || 0, stats.totalSquats || 0, ' reps');
                    }
                    if (stats.totalSitups > 0 || stats.thisWeekSitups > 0) {
                        addItem('Sit-ups', stats.thisWeekSitups || 0, stats.thisMonthSitups || 0, stats.totalSitups || 0, ' reps');
                    }
                    
                    // Cardio activities
                    if (stats.totalRunning > 0 || stats.thisWeekRunning > 0) {
                        addItem('Running', stats.thisWeekRunning || 0, stats.thisMonthRunning || 0, stats.totalRunning || 0, ` ${unit}`);
                    }
                    if (stats.totalWalking > 0 || stats.thisWeekWalking > 0) {
                        addItem('Walking', stats.thisWeekWalking || 0, stats.thisMonthWalking || 0, stats.totalWalking || 0, ` ${unit}`);
                    }
                    if (stats.totalBiking > 0 || stats.thisWeekBiking > 0) {
                        addItem('Biking', stats.thisWeekBiking || 0, stats.thisMonthBiking || 0, stats.totalBiking || 0, ` ${unit}`);
                    }
                    if (stats.totalDogWalk > 0 || stats.thisWeekDogWalk > 0) {
                        addItem('Dog Walking', stats.thisWeekDogWalk || 0, stats.thisMonthDogWalk || 0, stats.totalDogWalk || 0, ` ${unit}`);
                    }
                    if (stats.totalHiking > 0 || stats.thisWeekHiking > 0) {
                        addItem('Hiking', stats.thisWeekHiking || 0, stats.thisMonthHiking || 0, stats.totalHiking || 0, ` ${unit}`);
                    }
                    
                    // Other activities
                    if (stats.totalStairs > 0 || stats.thisWeekStairs > 0) {
                        addItem('Stairs', stats.thisWeekStairs || 0, stats.thisMonthStairs || 0, stats.totalStairs || 0, ' floors');
                    }
                    if (stats.totalSteps > 0 || stats.thisWeekSteps > 0) {
                        addItem('Steps', stats.thisWeekSteps || 0, stats.thisMonthSteps || 0, stats.totalSteps || 0);
                    }
                    
                    // Totals
                    addItem('Strength Days', stats.thisWeekStrengthDays || 0, stats.thisMonthStrengthDays || 0, stats.totalStrengthDays || 0, ' days');
                    if (stats.totalDistance > 0 || stats.thisWeekDistance > 0) {
                        addItem('Total Distance', stats.thisWeekDistance || 0, stats.thisMonthDistance || 0, stats.totalDistance || 0, ` ${unit}`);
                    }
                    
                    // Weight row - only show if pal has opted to share weight
                    if (pal.shareWeightWithPals === true) {
                        const weekChange = stats.weightChangeLbsThisWeek !== null && stats.weightChangeLbsThisWeek !== undefined ? stats.weightChangeLbsThisWeek : null;
                        const monthChange = stats.weightChangeLbsThisMonth !== null && stats.weightChangeLbsThisMonth !== undefined ? stats.weightChangeLbsThisMonth : null;
                        const totalChange = stats.weightChangeLbsAllTime !== null && stats.weightChangeLbsAllTime !== undefined ? stats.weightChangeLbsAllTime : null;
                        
                        const formatChange = (val) => {
                            if (val === null || val === undefined) return '-';
                            if (val === 0) return '0.0 lbs';
                            return `${val > 0 ? '+' : ''}${val} lbs`;
                        };
                        
                        activityItems.push({
                            name: 'Weight',
                            week: formatChange(weekChange),
                            month: formatChange(monthChange),
                            total: formatChange(totalChange)
                        });
                    }
                    
                    // Build activity table HTML
                    let activityTableHTML = '';
                    if (activityItems.length > 0) {
                        activityTableHTML = `
                            <div class="pal-activity-report">
                                <div class="pal-activity-header">
                                    <div class="pal-activity-col-name">Activity</div>
                                    <div class="pal-activity-col-value">Week</div>
                                    <div class="pal-activity-col-value">Month</div>
                                    <div class="pal-activity-col-value">All-Time</div>
                                </div>
                                ${activityItems.map(item => `
                                    <div class="pal-activity-row">
                                        <div class="pal-activity-col-name">${item.name}</div>
                                        <div class="pal-activity-col-value pal-week">${item.week}</div>
                                        <div class="pal-activity-col-value pal-month">${item.month}</div>
                                        <div class="pal-activity-col-value pal-total">${item.total}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    // Quick stats for collapsed view
                    const stepsValue = stats.thisWeekSteps || 0;
                    const stepsText = stepsValue >= 1000 ? (stepsValue / 1000).toFixed(1) + 'k' : stepsValue.toString();
                    const distanceValue = stats.thisWeekDistance || 0;
                    const distanceText = distanceValue.toFixed(1) + ' mi';
                    
                    // Return pal card HTML
                    return `
                        <div class="pal-card ${expandedClass}">
                            <div class="pal-header" onclick="app.togglePalExpanded('${pal.palCode}')">
                                <div class="pal-header-info">
                                    <div class="pal-name">${pal.displayName}</div>
                                    <span class="pal-divider"></span>
                                    <div class="pal-quick-stats">${stepsText} steps  ${distanceText}</div>
                                </div>
                                <div class="pal-expand-icon">${arrow}</div>
                            </div>
                            <div class="pal-stats-expanded">
                                <div class="pal-id-display">PAL Code: ${pal.palCode}</div>
                                ${activityTableHTML}
                                <div class="pal-actions">
                                    <button class="pal-btn pal-btn-remove" onclick="app.removePal('${pal.palCode}')">Remove</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // Toggle pal card expanded state
            togglePalExpanded(palCode) {
                const pal = this.data.pals.friends.find(f => f.palCode === palCode);
                if (pal) {
                    pal.expanded = !pal.expanded;
                    this.saveData();
                    this.renderPalsList();
                }
            },

            // Refresh all pals stats
            async refreshAllPals() {
                const btn = document.getElementById('refresh-all-pals-btn');
                if (btn) {
                    btn.textContent = 'Refreshing...';
                    btn.disabled = true;
                }

                for (const pal of this.data.pals.friends) {
                    await this.refreshPalStats(pal.palCode);
                }

                if (btn) {
                    btn.textContent = ' Refresh All';
                    btn.disabled = false;
                }
                
                alert('All pals refreshed!');
            },

            // Render leaderboard
            // Set leaderboard mode (global or friends)
            setLeaderboardMode(mode) {
                this.leaderboardMode = mode;
                
                // Remove active from both buttons first
                document.getElementById('lb-global-btn').classList.remove('active');
                document.getElementById('lb-friends-btn').classList.remove('active');
                
                // Update inline styles for proper toggle
                const globalBtn = document.getElementById('lb-global-btn');
                const friendsBtn = document.getElementById('lb-friends-btn');
                
                if (mode === 'global') {
                    globalBtn.classList.add('active');
                    globalBtn.style.background = 'var(--primary-dark)';
                    globalBtn.style.color = 'white';
                    friendsBtn.style.background = '#2d2d2d';
                    friendsBtn.style.color = '#9ca3af';
                } else {
                    friendsBtn.classList.add('active');
                    friendsBtn.style.background = 'var(--primary-dark)';
                    friendsBtn.style.color = 'white';
                    globalBtn.style.background = '#2d2d2d';
                    globalBtn.style.color = '#9ca3af';
                }
                
                this.renderLeaderboard();
            },

            // Helper: Calculate days between two dates
            daysBetween(date1Str, date2Str) {
                const d1 = new Date(date1Str);
                const d2 = new Date(date2Str);
                const diffTime = Math.abs(d2 - d1);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            },

            async renderLeaderboard() {
                const listEl = document.getElementById('leaderboard-list');
                const period = document.getElementById('leaderboard-period').value;
                const baseMetric = document.getElementById('leaderboard-metric').value;
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                const weightUnit = 'lbs';

                // Update metric based on period
                let metric = baseMetric;
                if (period === 'month') {
                    metric = baseMetric.replace('thisWeek', 'thisMonth');
                } else if (period === 'total') {
                    metric = baseMetric.replace('thisWeek', 'total').replace('Distance', 'Distance');
                }

                // Check Firebase connection
                if (!this.db) {
                    listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">Connecting to leaderboard...</p>';
                    return;
                }

                try {
                    let snapshot;
                    
                    if (this.leaderboardMode === 'global') {
                        // GLOBAL: Show all users who opted in
                        snapshot = await this.db.collection('users')
                            .where('joinedLeaderboard', '==', true)
                            .get();
                    } else {
                        // FRIENDS: Show only added friends who OPTED IN + current user (if opted in)
                        const friendCodes = this.data.pals.friends.map(f => f.palCode);
                        if (friendCodes.length === 0 && !this.data.pals.myPalCode) {
                            listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">Add friends to see their rankings!</p>';
                            return;
                        }
                        
                        // Add current user to the list ONLY if they have opted into leaderboards
                        const allCodes = [...friendCodes];
                        if (this.data.pals.myPalCode && 
                            this.data.pals.joinedLeaderboard && 
                            !allCodes.includes(this.data.pals.myPalCode)) {
                            allCodes.push(this.data.pals.myPalCode);
                        }
                        
                        // Fetch friends + user data, but ONLY include those who opted in
                        const friendsData = [];
                        for (const code of allCodes) {
                            const doc = await this.db.collection('users').doc(code).get();
                            if (doc.exists) {
                                const data = doc.data();
                                // ONLY add if they joined the leaderboard
                                if (data.joinedLeaderboard === true) {
                                    friendsData.push(doc);
                                }
                            }
                        }
                        
                        // If no friends have opted in, show message
                        if (friendsData.length === 0) {
                            listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">None of your friends have opted into leaderboards yet!</p>';
                            return;
                        }
                        
                        snapshot = { docs: friendsData };
                    }

                    const participants = [];
                    const today = new Date().toISOString().split('T')[0];

                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        
                        // Calculate days and hours since last activity
                        const lastActivity = data.lastActivityDate || '';
                        const daysInactive = lastActivity ? this.daysBetween(lastActivity, today) : 999;
                        
                        // Calculate hours inactive for emoji status
                        let hoursInactive = 999;
                        if (lastActivity) {
                            const lastDate = new Date(lastActivity);
                            const nowDate = new Date(today);
                            hoursInactive = Math.floor((nowDate - lastDate) / (1000 * 60 * 60));
                        }
                        
                        // Determine emoji status based on hours
                        let statusIndicator = '';
                        if (hoursInactive < 16) {
                            statusIndicator = ''; // 0-16 hours
                        } else if (hoursInactive < 32) {
                            statusIndicator = ''; // 16-32 hours
                        } else {
                            statusIndicator = ''; // 32+ hours (shows in all leaderboards until 21 days)
                        }
                        
                        // REMOVE users with 21+ days of inactivity (from all leaderboards)
                        if (daysInactive >= 21) return;
                        
                        // For "This Week" only: hide users inactive 48+ hours (keeps data fresh)
                        if (period === 'week' && daysInactive >= 2) return;

                        // Weight leaderboard is optional per user
                        if (metric === 'weight' && !(data.joinWeightLeaderboard === true)) return;

                        let value = null;
                        let valueLbs = null;

                        if (metric === 'weight') {
                            // Leaderboard period toggle drives which weight % and lbs delta to use
                            if (period === 'week') {
                                value = (data.stats && data.stats.weightChangePctThisWeek !== undefined) ? data.stats.weightChangePctThisWeek : null;
                                valueLbs = (data.stats && data.stats.weightChangeLbsThisWeek !== undefined) ? data.stats.weightChangeLbsThisWeek : null;
                            } else if (period === 'month') {
                                value = (data.stats && data.stats.weightChangePctThisMonth !== undefined) ? data.stats.weightChangePctThisMonth : null;
                                valueLbs = (data.stats && data.stats.weightChangeLbsThisMonth !== undefined) ? data.stats.weightChangeLbsThisMonth : null;
                            } else {
                                value = (data.stats && data.stats.weightChangePctAllTime !== undefined) ? data.stats.weightChangePctAllTime : null;
                                valueLbs = (data.stats && data.stats.weightChangeLbsAllTime !== undefined) ? data.stats.weightChangeLbsAllTime : null;
                            }
                        } else {
                            value = data.stats?.[metric] ?? 0;
                        // Hide weight entries until at least one weigh-in exists
                        if (metric === 'weight' && (value === null || value === undefined)) return;

                        }

                        participants.push({
                            palCode: data.palCode,
                            displayName: data.displayName || data.palCode,
                            value: value,
                            valueLbs: valueLbs,
                            isMe: data.palCode === this.data.pals.myPalCode,
                            statusIndicator: statusIndicator, // Emoji based on hours inactive
                            lastActivityDate: lastActivity,
                            daysInactive: daysInactive,
                            hoursInactive: hoursInactive
                        });
                    });

                    // Handle empty leaderboard
                    if (participants.length === 0) {
                        listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No active users found. Join to be first!</p>';
                        return;
                    }

                    // Sort + rank participants
                    let rankedParticipants = [];
                    let unrankedParticipants = [];

                    if (metric === 'weight') {
                        rankedParticipants = participants.filter(p => p.value !== null && p.value !== undefined && !Number.isNaN(Number(p.value)));
                        unrankedParticipants = participants.filter(p => p.value === null || p.value === undefined || Number.isNaN(Number(p.value)));

                        // Weight: more negative (loss) ranks higher
                        rankedParticipants.sort((a, b) => Number(a.value) - Number(b.value));
                    } else {
                        // Steps/Distance: treat 0 or missing as "no data" (unranked, no rank number)
                        participants.forEach(p => {
                            const v = Number(p.value);
                            if (Number.isFinite(v) && v > 0) {
                                rankedParticipants.push(p);
                            } else {
                                unrankedParticipants.push(p);
                            }
                        });

                        rankedParticipants.sort((a, b) => Number(b.value) - Number(a.value));
                        // Keep unranked stable and readable
                        unrankedParticipants.sort((a, b) => String(a.displayName || '').localeCompare(String(b.displayName || '')));
                    }

                    // Competition ranking (1, 1, 3, ...)
                    let lastRankedValue = null;
                    let currentRank = 0;
                    let rankedCount = 0;

                    rankedParticipants.forEach(p => {
                        rankedCount += 1;
                        const v = Number(p.value);
                        const isTie = lastRankedValue !== null && Math.abs(v - lastRankedValue) < 1e-9;
                        if (!isTie) currentRank = rankedCount;
                        p.rank = currentRank;
                        lastRankedValue = v;
                    });

                    unrankedParticipants.forEach(p => { p.rank = ''; });

                    const orderedParticipants = [...rankedParticipants, ...unrankedParticipants];

                    // Get max value for progress bar scaling
                    const maxValue = (metric === 'weight')
                        ? Math.max(...rankedParticipants.map(p => Math.abs(Number(p.value))), 1)
                        : (rankedParticipants.length ? Number(rankedParticipants[0].value) : 1);

                    // Determine unit suffix
                    let suffix = '';
                    if (metric.includes('Distance')) {
                        suffix = ` ${unit}`;
                    } else if (metric.includes('Steps')) {
                        suffix = ' steps';
                    } else if (metric === 'weight') {
                        suffix = '';
                    }

                    // Render leaderboard items
                    listEl.innerHTML = orderedParticipants.map((p, index) => {
                        const rank = p.rank;
                        const progressPercent = (rank === '' || maxValue <= 0) ? 0 : ((metric === 'weight' ? Math.abs(Number(p.value ?? 0)) : Number(p.value ?? 0)) / maxValue) * 100;
                        const highlight = p.isMe ? 'highlight' : '';
                        
                        // Determine rank class for medal colors
                        let rankClass = '';
                        if (rank === 1) {
                            rankClass = 'rank-1';
                        } else if (rank === 2) {
                            rankClass = 'rank-2';
                        } else if (rank === 3) {
                            rankClass = 'rank-3';
                        } else if (rank !== '') {
                            rankClass = 'rank-regular';
                        }
                        
                        // Format weight change (% + lbs)
                        let displayValue = p.value;
                        if (metric === 'weight') {
                            if (p.value === null || p.value === undefined) {
                                displayValue = '--';
                            } else {
                                const n = Number(p.value);
                                const signedPct = (n > 0 ? `+${n.toFixed(1)}` : n.toFixed(1));
                                let lbsPart = '';
                                if (p.valueLbs !== null && p.valueLbs !== undefined) {
                                    const l = Number(p.valueLbs);
                                    const signedLbs = (l > 0 ? `+${l.toFixed(1)}` : l.toFixed(1));
                                    lbsPart = ` (${signedLbs} ${weightUnit})`;
                                }
                                displayValue = `${signedPct}%${lbsPart}`;
                            }
                        }

                        
                        return `
                            <div class="leaderboard-item-card ${rankClass} ${highlight}">
                                <div class="leaderboard-item-header">
                                    <span class="leaderboard-rank">${rank}</span>
                                    <span class="leaderboard-name">
                                        ${p.displayName}${p.isMe ? ' (You)' : ''} ${p.statusIndicator}
                                    </span>
                                    <span class="leaderboard-value">${displayValue}${suffix}</span>
                                </div>
                                <div class="leaderboard-progress-bar">
                                    <div class="leaderboard-progress-fill" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');

                } catch (error) {
                    console.error('Error loading leaderboard:', error);
                    listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">Error loading leaderboard. Try again!</p>';
                }
            },

            // ============================================
            // HABITS FEATURE FUNCTIONS
            // ============================================

            // Initialize habits UI
            initHabits() {
                if (!this.data.habits) {
                    this.data.habits = [];
                }
                this.renderHabits();
            },

            // Render habits list
            renderHabits() {
                const container = document.getElementById('habits-list');
                const addBtn = document.getElementById('add-habit-btn');
                
                if (!container) return; // Not on Goals screen
                
                if (this.data.habits.length === 0) {
                    container.innerHTML = '<p style="color: #6b7280; font-size: 14px; text-align: center; padding: 20px 0;">No habits yet. Add up to 3!</p>';
                    if (addBtn) addBtn.style.display = 'block';
                    return;
                }
                
                container.innerHTML = this.data.habits.map((habit, index) => {
                    const habitColor = habit.color || '#10b981';
                    return `
                    <div class="habit-item" id="habit-${habit.id}">
                        <!-- Display Mode -->
                        <div class="habit-display" id="habit-display-${habit.id}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <div style="width: 14px; height: 14px; border-radius: 3px; background: ${habitColor}; flex-shrink: 0;"></div>
                                    <div style="font-size: 13px; color: #e8e8e8; font-weight: 500;">${habit.name || 'Unnamed habit'}</div>
                                </div>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="app.editHabit(${habit.id})" 
                                            style="padding: 4px 8px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 5px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                        Edit
                                    </button>
                                    <button onclick="app.removeHabit(${habit.id})" 
                                            style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; width: 24px; height: 24px; padding: 0;"></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Edit Mode (hidden by default) -->
                        <div class="habit-edit" id="habit-edit-${habit.id}" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="habit-name-${habit.id}" value="${habit.name || ''}" 
                                       style="background: #1a1a1a; border: 1px solid #3d3d3d; color: #e8e8e8; padding: 6px 10px; border-radius: 6px; flex: 1; font-size: 14px;" 
                                       placeholder="Habit name...">
                                <button onclick="app.removeHabit(${habit.id})" 
                                        style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; width: 28px; height: 28px; flex-shrink: 0;"></button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <label style="font-size: 13px; color: #9ca3af;">Color:</label>
                                <input type="hidden" id="habit-color-${habit.id}" value="${habitColor}">
                                <div id="habit-color-display-${habit.id}" 
                                     onclick="app.openHabitColorPicker(${habit.id})"
                                     style="width: 40px; height: 28px; background: ${habitColor}; border: 1px solid #3d3d3d; border-radius: 6px; cursor: pointer;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <button onclick="app.cancelEditHabit(${habit.id})" 
                                        style="padding: 8px 12px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                    Cancel
                                </button>
                                <button onclick="app.saveHabit(${habit.id})" 
                                        style="padding: 8px 12px; background: var(--primary-dark); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
                
                // Show/hide add button based on limit
                if (addBtn) {
                    addBtn.style.display = this.data.habits.length >= 3 ? 'none' : 'block';
                }
            },

            // Add new habit
            addHabit() {
                if (this.data.habits.length >= 3) {
                    alert('Maximum 3 habits reached!');
                    return;
                }

                // Prompt for habit name first
                let name = prompt('Enter habit name:');
                if (name === null) return; // cancelled
                name = name.trim();
                if (!name) {
                    alert('Habit name is required.');
                    return;
                }

                // Then prompt for color using the existing color wheel modal (same as App Theme)
                this.openColorWheel((color) => {
                    if (!color) return; // safety; modal cancel does not call callback
                    const newHabit = {
                        id: Date.now(),
                        name,
                        color,
                        completions: []
                    };

                    this.data.habits.push(newHabit);
                    this.saveData();
                    this.renderHabits();
                });
            },

            // Remove habit
            removeHabit(id) {
                if (confirm('Remove this habit?')) {
                    this.data.habits = this.data.habits.filter(h => h.id !== id);
                    this.saveData();
                    this.renderHabits();
                    this.renderCalendar();
                }
            },

            // Update habit name
            updateHabitName(id, name) {
                const habit = this.data.habits.find(h => h.id === id);
                if (habit) {
                    habit.name = name;
                    this.saveData();
                }
            },

            // Update habit frequency
            updateHabitFrequency(id, frequency) {
                const habit = this.data.habits.find(h => h.id === id);
                if (habit) {
                    habit.frequency = frequency;
                    this.saveData();
                }
            },

            // Edit habit - show edit mode
            editHabit(id) {
                document.getElementById(`habit-display-${id}`).style.display = 'none';
                document.getElementById(`habit-edit-${id}`).style.display = 'block';
            },

            // Cancel edit - return to display mode
            cancelEditHabit(id) {
                document.getElementById(`habit-display-${id}`).style.display = 'block';
                document.getElementById(`habit-edit-${id}`).style.display = 'none';
            },

            // Save individual habit
            saveHabit(id) {
                const habit = this.data.habits.find(h => h.id === id);
                if (!habit) return;
                
                // Get values from inputs
                const nameInput = document.getElementById(`habit-name-${id}`);
                const colorInput = document.getElementById(`habit-color-${id}`);
                
                if (nameInput) {
                    habit.name = nameInput.value;
                }
                
                if (colorInput) {
                    habit.color = colorInput.value;
                }
                
                // Save to localStorage
                this.saveData();
                
                // Re-render to show updated display mode
                this.renderHabits();
            },

            // Toggle habit completion for a date
            toggleHabitCompletion(habitId, dateStr) {
                const habit = this.data.habits.find(h => h.id === habitId);
                if (!habit) return;
                
                if (!habit.completions) habit.completions = [];
                
                const index = habit.completions.indexOf(dateStr);
                if (index > -1) {
                    habit.completions.splice(index, 1);
                } else {
                    habit.completions.push(dateStr);
                }
                
                this.saveData();
                this.renderCalendar();
                this.renderHabitSummary();
            },

            // Get habits completed on a date
            getHabitsForDate(dateStr) {
                if (!this.data.habits) return [];
                return this.data.habits.filter(h => h.completions && h.completions.includes(dateStr));
            },

            // ========== CUSTOM CATEGORY FUNCTIONS ==========
            
            // Initialize custom categories
            initCustomCategories() {
                if (!this.data.customCategories) {
                    this.data.customCategories = [];
                }
                this.renderCustomCategories();
            },

            // Render custom categories list
            renderCustomCategories() {
                const container = document.getElementById('custom-categories-list');
                const addBtn = document.getElementById('add-custom-category-btn');
                
                if (!this.data.customCategories || this.data.customCategories.length === 0) {
                    container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 8px 0; font-size: 13px;">No custom categories yet</p>';
                    if (addBtn) addBtn.style.display = 'block';
                    return;
                }
                
                // Show/hide add button based on limit
                if (addBtn) {
                    addBtn.style.display = this.data.customCategories.length >= 3 ? 'none' : 'block';
                }
                
                let html = '';
                this.data.customCategories.forEach(category => {
                    const exerciseCount = category.exercises ? category.exercises.length : 0;
                    html += `
                        <div class="habit-item">
                            <div id="category-display-${category.id}" style="display: flex; flex-direction: column; gap: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #e8e8e8; font-size: 13px;">${category.name}</div>
                                        <div style="font-size: 11px; color: #9ca3af;">${exerciseCount}/5 exercises</div>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        <button onclick="app.renameCategoryName(${category.id})" style="padding: 4px 8px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                            Edit
                                        </button>
                                        <button onclick="app.manageExercises(${category.id})" style="padding: 4px 8px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                            Manage
                                        </button>
                                        <button onclick="app.removeCustomCategory(${category.id})" style="padding: 4px 8px; background: #7f1d1d; color: #fca5a5; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            },

            // Add custom category
            addCustomCategory() {
                if (this.data.customCategories.length >= 3) {
                    alert('Maximum 3 custom categories reached!');
                    return;
                }
                
                let name = prompt('Enter category name (letters only, max 20 chars):');
                if (name === null) return;
                name = name.trim();
                
                // Validate: letters only, max 20 chars
                if (!name) {
                    alert('Category name is required.');
                    return;
                }
                if (!/^[a-zA-Z\s]+$/.test(name)) {
                    alert('Category name must contain letters only.');
                    return;
                }
                if (name.length > 20) {
                    alert('Category name must be 20 characters or less.');
                    return;
                }
                
                const newCategory = {
                    id: Date.now(),
                    name,
                    exercises: []
                };
                
                this.data.customCategories.push(newCategory);
                this.saveData();
                this.renderCustomCategories();
            },

            // Remove custom category
            removeCustomCategory(id) {
                if (confirm('Delete this custom category and all its exercises?')) {
                    this.data.customCategories = this.data.customCategories.filter(c => c.id !== id);
                    this.saveData();
                    this.renderCustomCategories();
                    this.updateDashboard();
                }
            },

            // Manage exercises in category
            manageExercises(categoryId) {
                const category = this.data.customCategories.find(c => c.id === categoryId);
                if (!category) return;
                
                // Create modal content
                let html = `
                    <div class="overlay" id="manage-exercises-overlay" onclick="app.closeManageExercises()" style="display: block;"></div>
                    <div class="customize-modal" id="manage-exercises-modal" style="display: block;">
                        <div class="customize-modal-header"> Manage: ${category.name}</div>
                        <div style="max-height: 400px; overflow-y: auto; margin-bottom: 12px;">
                `;
                
                // Show existing exercises
                if (category.exercises && category.exercises.length > 0) {
                    category.exercises.forEach(ex => {
                        const trackingLabel = ex.trackingType === 'reps' ? 'Reps' : ex.trackingType === 'distance' ? 'Distance' : 'Log Day';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #2d2d2d; border-radius: 6px; margin-bottom: 6px;">
                                <div>
                                    <div style="font-weight: 600; color: #e8e8e8; font-size: 13px;">${ex.name}</div>
                                    <div style="font-size: 11px; color: #9ca3af;">(${trackingLabel})</div>
                                </div>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="app.renameExercise(${categoryId}, ${ex.id})" style="padding: 4px 8px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                        Edit
                                    </button>
                                    <button onclick="app.removeExercise(${categoryId}, ${ex.id})" style="padding: 4px 8px; background: #7f1d1d; color: #fca5a5; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #6b7280; text-align: center; padding: 16px 0; font-size: 13px;">No exercises yet</p>';
                }
                
                html += '</div>';
                
                // Add exercise button
                if (!category.exercises || category.exercises.length < 5) {
                    html += `
                        <button onclick="app.addExerciseToCategory(${categoryId})" style="width: 100%; padding: 10px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 8px;">
                            + Add Exercise
                        </button>
                    `;
                }
                
                html += `
                    <button onclick="app.closeManageExercises()" style="width: 100%; padding: 10px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Done
                    </button>
                    </div>
                `;
                
                // Add to page
                document.body.insertAdjacentHTML('beforeend', html);
            },

            // Close manage exercises modal
            closeManageExercises() {
                const overlay = document.getElementById('manage-exercises-overlay');
                const modal = document.getElementById('manage-exercises-modal');
                if (overlay) overlay.remove();
                if (modal) modal.remove();
            },

            // Add exercise to category
            addExerciseToCategory(categoryId) {
                const category = this.data.customCategories.find(c => c.id === categoryId);
                if (!category) return;
                
                if (category.exercises && category.exercises.length >= 5) {
                    alert('Maximum 5 exercises per category reached!');
                    return;
                }
                
                let name = prompt('Enter exercise name (letters only, max 20 chars):');
                if (name === null) return;
                name = name.trim();
                
                // Validate
                if (!name) {
                    alert('Exercise name is required.');
                    return;
                }
                if (!/^[a-zA-Z\s]+$/.test(name)) {
                    alert('Exercise name must contain letters only.');
                    return;
                }
                if (name.length > 20) {
                    alert('Exercise name must be 20 characters or less.');
                    return;
                }
                
                // Show tracking type selection modal
                this.showTrackingTypeModal(categoryId, name);
            },

            // Show tracking type selection modal
            showTrackingTypeModal(categoryId, exerciseName) {
                const html = `
                    <div class="overlay" id="tracking-type-overlay" onclick="app.closeTrackingTypeModal()" style="display: block;"></div>
                    <div class="customize-modal" id="tracking-type-modal" style="display: block; max-width: 320px;">
                        <div class="customize-modal-header">Track With</div>
                        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 16px; text-align: center;">
                            How do you want to track "${exerciseName}"?
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button onclick="app.confirmTrackingType(${categoryId}, '${exerciseName}', 'reps')" 
                                    style="width: 100%; padding: 12px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                Reps
                            </button>
                            <button onclick="app.confirmTrackingType(${categoryId}, '${exerciseName}', 'distance')" 
                                    style="width: 100%; padding: 12px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                Distance
                            </button>
                            <button onclick="app.confirmTrackingType(${categoryId}, '${exerciseName}', 'logday')" 
                                    style="width: 100%; padding: 12px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                Log Day
                            </button>
                            <button onclick="app.closeTrackingTypeModal()" 
                                    style="width: 100%; padding: 10px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', html);
            },

            // Close tracking type modal
            closeTrackingTypeModal() {
                const overlay = document.getElementById('tracking-type-overlay');
                const modal = document.getElementById('tracking-type-modal');
                if (overlay) overlay.remove();
                if (modal) modal.remove();
            },

            // Confirm tracking type and create exercise
            confirmTrackingType(categoryId, exerciseName, trackingType) {
                const category = this.data.customCategories.find(c => c.id === categoryId);
                if (!category) return;
                
                const newExercise = {
                    id: Date.now(),
                    name: exerciseName,
                    trackingType
                };
                
                if (!category.exercises) category.exercises = [];
                category.exercises.push(newExercise);
                this.saveData();
                
                // Close tracking modal
                this.closeTrackingTypeModal();
                
                // Refresh manage exercises modal
                this.closeManageExercises();
                this.manageExercises(categoryId);
                this.renderCustomCategories();
            },

            // Remove exercise from category
            removeExercise(categoryId, exerciseId) {
                const category = this.data.customCategories.find(c => c.id === categoryId);
                if (!category) return;
                
                if (confirm('Delete this exercise?')) {
                    category.exercises = category.exercises.filter(e => e.id !== exerciseId);
                    this.saveData();
                    
                    // Refresh modal
                    this.closeManageExercises();
                    this.manageExercises(categoryId);
                    this.renderCustomCategories();
                    this.updateDashboard();
                }
            },

            // Rename category name
            renameCategoryName(categoryId) {
                const category = this.data.customCategories.find(c => c.id === categoryId);
                if (!category) return;
                
                let newName = prompt('Enter new category name (letters only, max 20 chars):', category.name);
                if (newName === null) return;
                newName = newName.trim();
                
                // Validate
                if (!newName) {
                    alert('Category name is required.');
                    return;
                }
                if (!/^[a-zA-Z\s]+$/.test(newName)) {
                    alert('Category name must contain letters only.');
                    return;
                }
                if (newName.length > 20) {
                    alert('Category name must be 20 characters or less.');
                    return;
                }
                
                category.name = newName;
                this.saveData();
                this.renderCustomCategories();
            },

            // Rename exercise
            renameExercise(categoryId, exerciseId) {
                const category = this.data.customCategories.find(c => c.id === categoryId);
                if (!category) return;
                
                const exercise = category.exercises.find(e => e.id === exerciseId);
                if (!exercise) return;
                
                let newName = prompt('Enter new exercise name (letters only, max 20 chars):', exercise.name);
                if (newName === null) return;
                newName = newName.trim();
                
                // Validate
                if (!newName) {
                    alert('Exercise name is required.');
                    return;
                }
                if (!/^[a-zA-Z\s]+$/.test(newName)) {
                    alert('Exercise name must contain letters only.');
                    return;
                }
                if (newName.length > 20) {
                    alert('Exercise name must be 20 characters or less.');
                    return;
                }
                
                exercise.name = newName;
                this.saveData();
                
                // Refresh modal
                this.closeManageExercises();
                this.manageExercises(categoryId);
                this.renderCustomCategories();
            },

            // Toggle custom category info modal
            toggleCustomCategoryInfoModal() {
                const modal = document.getElementById('custom-category-info-modal');
                modal.classList.toggle('active');
            },

            // Theme Functions
            loadTheme() {
                const savedTheme = localStorage.getItem('appTheme') || 'blue';
                this.applyTheme(savedTheme);
            },

            setTheme(theme) {
                localStorage.setItem('appTheme', theme);
                this.applyTheme(theme);
            },

            applyTheme(theme) {
                // Remove all theme classes
                document.documentElement.removeAttribute('data-theme');
                
                // Apply new theme (blue is default, no attribute needed)
                if (theme !== 'blue') {
                    document.documentElement.setAttribute('data-theme', theme);
                }

                // Update active state in theme selector
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.getAttribute('data-theme') === theme) {
                        option.classList.add('active');
                    }
                });
            },

            // Color Palette Functions
            // Color Wheel Implementation
            selectedColor: '#2563eb',
            currentColorCallback: null,
            colorWheelCanvas: null,
            colorWheelCtx: null,
            
            // Draw color wheel on canvas
            drawColorWheel() {
                const canvas = document.getElementById('color-wheel-canvas');
                if (!canvas) return;
                
                this.colorWheelCanvas = canvas;
                this.colorWheelCtx = canvas.getContext('2d');
                
                const ctx = this.colorWheelCtx;
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = canvas.width / 2;
                
                // Create image data for pixel-by-pixel drawing (no banding!)
                const imageData = ctx.createImageData(canvas.width, canvas.height);
                const data = imageData.data;
                
                // Draw color wheel pixel by pixel - Option B gradient
                for (let x = 0; x < canvas.width; x++) {
                    for (let y = 0; y < canvas.height; y++) {
                        const dx = x - centerX;
                        const dy = y - centerY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // Skip pixels outside circle
                        if (distance > radius) {
                            continue;
                        }
                        
                        // Calculate angle (hue) - 0 to 360
                        let angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        if (angle < 0) angle += 360;
                        
                        // Calculate distance ratio (0 = center, 1 = edge)
                        const distanceRatio = distance / radius;
                        
                        // Option B gradient: Light color center  Pure color  Dark edge
                        let saturation, lightness;
                        
                        if (distanceRatio < 0.6) {
                            // Center to 60%: Light color (80% sat, 70% light)  Pure color (100% sat, 50% light)
                            const t = distanceRatio / 0.6;
                            saturation = 80 + (20 * t); // 80%  100%
                            lightness = 70 - (20 * t);  // 70%  50%
                        } else {
                            // 60% to edge: Pure color (100% sat, 50% light)  Dark (100% sat, 30% light)
                            const t = (distanceRatio - 0.6) / 0.4;
                            saturation = 100;
                            lightness = 50 - (20 * t);  // 50%  30%
                        }
                        
                        // Convert HSL to RGB
                        const rgb = this.hslToRgb(angle / 360, saturation / 100, lightness / 100);
                        
                        // Set pixel
                        const pixelIndex = (y * canvas.width + x) * 4;
                        data[pixelIndex] = rgb[0];     // R
                        data[pixelIndex + 1] = rgb[1]; // G
                        data[pixelIndex + 2] = rgb[2]; // B
                        data[pixelIndex + 3] = 255;    // A
                    }
                }
                
                // Put the image data on canvas
                ctx.putImageData(imageData, 0, 0);
                
                // Add magnifier event listeners
                this.isColorWheelDragging = false;
                
                const startMagnifier = (e) => {
                    e.preventDefault();
                    this.isColorWheelDragging = true;
                    this.updateMagnifier(e);
                };
                
                const moveMagnifier = (e) => {
                    if (this.isColorWheelDragging) {
                        e.preventDefault();
                        this.updateMagnifier(e);
                    }
                };
                
                const endMagnifier = (e) => {
                    if (this.isColorWheelDragging) {
                        e.preventDefault();
                        this.isColorWheelDragging = false;
                        this.hideMagnifier();
                        this.handleColorWheelClick(e);
                    }
                };
                
                // Mouse events
                canvas.onmousedown = startMagnifier;
                canvas.onmousemove = moveMagnifier;
                canvas.onmouseup = endMagnifier;
                canvas.onmouseleave = () => {
                    this.isColorWheelDragging = false;
                    this.hideMagnifier();
                };
                
                // Touch events
                canvas.ontouchstart = startMagnifier;
                canvas.ontouchmove = moveMagnifier;
                canvas.ontouchend = endMagnifier;
            },
            
            // Update magnifier position and content
            updateMagnifier(event) {
                const canvas = this.colorWheelCanvas;
                const rect = canvas.getBoundingClientRect();
                
                // Get position (handle both mouse and touch)
                let clientX, clientY;
                if (event.touches && event.touches[0]) {
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                // Check if within circle
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const radius = canvas.width / 2;
                
                if (distance > radius) return;
                
                // Show magnifier and instruction
                const magnifier = document.getElementById('color-magnifier');
                const instruction = document.getElementById('magnifier-instruction');
                magnifier.style.display = 'block';
                instruction.style.display = 'block';
                
                // Position magnifier (offset so finger doesn't cover it)
                const magnifierSize = 120;
                const offsetY = -magnifierSize - 20; // Above finger
                magnifier.style.left = `${x - magnifierSize / 2}px`;
                magnifier.style.top = `${y + offsetY}px`;
                
                // Draw magnified content
                const magnifierCanvas = document.getElementById('magnifier-canvas');
                const magnifierCtx = magnifierCanvas.getContext('2d');
                
                // Clear magnifier
                magnifierCtx.clearRect(0, 0, magnifierSize, magnifierSize);
                
                // Calculate source area (3x zoom)
                const sourceSize = magnifierSize / 3;
                const sourceX = x - sourceSize / 2;
                const sourceY = y - sourceSize / 2;
                
                // Draw magnified section
                magnifierCtx.drawImage(
                    canvas,
                    sourceX, sourceY, sourceSize, sourceSize,
                    0, 0, magnifierSize, magnifierSize
                );
                
                // Draw center crosshair
                magnifierCtx.strokeStyle = 'white';
                magnifierCtx.lineWidth = 2;
                magnifierCtx.beginPath();
                magnifierCtx.moveTo(magnifierSize / 2 - 10, magnifierSize / 2);
                magnifierCtx.lineTo(magnifierSize / 2 + 10, magnifierSize / 2);
                magnifierCtx.moveTo(magnifierSize / 2, magnifierSize / 2 - 10);
                magnifierCtx.lineTo(magnifierSize / 2, magnifierSize / 2 + 10);
                magnifierCtx.stroke();
                
                // Update color preview
                const imageData = this.colorWheelCtx.getImageData(x, y, 1, 1);
                const pixel = imageData.data;
                const color = `#${this.rgbToHex(pixel[0], pixel[1], pixel[2])}`;
                this.selectedColor = color;
                document.getElementById('selected-color-preview').style.background = color;
            },
            
            // Hide magnifier
            hideMagnifier() {
                document.getElementById('color-magnifier').style.display = 'none';
                document.getElementById('magnifier-instruction').style.display = 'none';
            },
            
            // Handle color wheel click (for final selection)
            handleColorWheelClick(event) {
                const canvas = this.colorWheelCanvas;
                const rect = canvas.getBoundingClientRect();
                
                // Get position (handle both mouse and touch)
                let clientX, clientY;
                if (event.changedTouches && event.changedTouches[0]) {
                    clientX = event.changedTouches[0].clientX;
                    clientY = event.changedTouches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                // Check if click is within circle
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const radius = canvas.width / 2;
                
                if (distance > radius) return; // Outside circle
                
                // Color already set by updateMagnifier, just confirm it's set
                if (!this.selectedColor) {
                    const imageData = this.colorWheelCtx.getImageData(x, y, 1, 1);
                    const pixel = imageData.data;
                    const color = `#${this.rgbToHex(pixel[0], pixel[1], pixel[2])}`;
                    this.selectedColor = color;
                    document.getElementById('selected-color-preview').style.background = color;
                }
            },
            
            // Convert HSL to RGB
            hslToRgb(h, s, l) {
                let r, g, b;
                
                if (s === 0) {
                    r = g = b = l; // Achromatic
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };
                    
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                
                return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
            },
            
            // Convert RGB to Hex
            rgbToHex(r, g, b) {
                return [r, g, b].map(x => {
                    const hex = x.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
            },
            
            // Open color wheel modal
            openColorWheel(callback) {
                this.currentColorCallback = callback;
                const modal = document.getElementById('color-wheel-modal');
                modal.style.display = 'flex';
                
                // Draw wheel after modal is visible
                setTimeout(() => this.drawColorWheel(), 50);
            },
            
            // Confirm color wheel selection
            confirmColorWheelSelection() {
                if (this.selectedColor && this.currentColorCallback) {
                    this.currentColorCallback(this.selectedColor);
                }
                this.closeColorWheel();
            },
            
            // Close color wheel modal
            closeColorWheel() {
                document.getElementById('color-wheel-modal').style.display = 'none';
                this.currentColorCallback = null;
            },
            
            // Open theme color picker
            openThemeColorPicker() {
                this.openColorWheel((color) => {
                    // Apply theme with selected color
                    this.applyCustomThemeColor(color);
                    this.data.themeColor = color; // Save as hex color
                    this.saveData();
                });
            },
            
            // Apply custom theme color
            applyCustomThemeColor(color) {
                // Convert hex to RGB for CSS variables
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                
                // Calculate lighter shade (add 30% towards white)
                const lighterR = Math.min(255, Math.floor(r + (255 - r) * 0.3));
                const lighterG = Math.min(255, Math.floor(g + (255 - g) * 0.3));
                const lighterB = Math.min(255, Math.floor(b + (255 - b) * 0.3));
                
                // Calculate darker shades
                const darkerR = Math.floor(r * 0.8);
                const darkerG = Math.floor(g * 0.8);
                const darkerB = Math.floor(b * 0.8);
                
                const darkestR = Math.floor(r * 0.6);
                const darkestG = Math.floor(g * 0.6);
                const darkestB = Math.floor(b * 0.6);
                
                // Apply to CSS variables
                document.documentElement.style.setProperty('--primary', color);
                document.documentElement.style.setProperty('--primary-light', `rgb(${lighterR}, ${lighterG}, ${lighterB})`);
                document.documentElement.style.setProperty('--primary-dark', `rgb(${darkerR}, ${darkerG}, ${darkerB})`);
                document.documentElement.style.setProperty('--primary-darker', `rgb(${darkestR}, ${darkestG}, ${darkestB})`);
            },

            // Reset theme to default blue
            resetThemeToDefault() {
                // Clear custom theme color
                this.data.themeColor = 'blue';
                this.saveData();
                
                // Remove all theme attributes and custom styles
                document.documentElement.removeAttribute('data-theme');
                document.documentElement.style.removeProperty('--primary');
                document.documentElement.style.removeProperty('--primary-light');
                document.documentElement.style.removeProperty('--primary-dark');
                document.documentElement.style.removeProperty('--primary-darker');
                
                // Apply default blue theme
                this.applyTheme('blue');
                
                // Show confirmation
                alert('Theme reset to default blue!');
            },
            
            // Open habit color picker
            openHabitColorPicker(habitId) {
                this.openColorWheel((color) => {
                    const colorInput = document.getElementById(`habit-color-${habitId}`);
                    const colorDisplay = document.getElementById(`habit-color-display-${habitId}`);
                    if (colorInput) {
                        colorInput.value = color;
                    }
                    if (colorDisplay) {
                        colorDisplay.style.background = color;
                    }
                });
            }
        };

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>

<!-- PAL Code numeric prompt modal (for mobile numeric keyboard) -->
<div id="palcode-prompt-overlay" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center;">
  <div style="width: min(360px, 90vw); background: #111; border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 16px; box-shadow: 0 16px 50px rgba(0,0,0,0.5);">
    <div id="palcode-prompt-message" style="font-size: 14px; font-weight: 700; color: rgba(255,255,255,0.92); margin-bottom: 10px;">Create your PAL Code (4 digits)</div>
    <input id="palcode-prompt-input" type="tel" inputmode="numeric" pattern="\\d{4}" maxlength="4" placeholder="0000" style="width: 100%; padding: 10px 12px; background: #1a1a1a; border: 1px solid #3d3d3d; border-radius: 10px; color: #e8e8e8; font-size: 16px; box-sizing: border-box;" />
    <div style="display:flex; gap: 10px; margin-top: 12px;">
      <button id="palcode-prompt-cancel" style="flex:1; height: 38px; background: #2a2a2a; color: rgba(255,255,255,0.88); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; font-weight: 700; cursor: pointer;">Cancel</button>
      <button id="palcode-prompt-ok" style="flex:1; height: 38px; background: var(--primary); color: #fff; border: none; border-radius: 10px; font-weight: 800; cursor: pointer;">OK</button>
    </div>
  </div>
</div>

<!-- Service Worker Registration -->
<script>
// Register service worker for PWA functionality and auto-updates
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
            .then(registration => {
                console.log(' Service Worker registered successfully');
                
                // Check for updates immediately on load
                registration.update();
                
                // Check for updates every 60 seconds (iOS-friendly)
                setInterval(() => {
                    registration.update();
                }, 60000);
                
                // Listen for new service worker updates
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log(' New version found, installing...');
                    
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'activated' && !navigator.serviceWorker.controller) {
                            // First install
                            console.log(' Service Worker activated (first install)');
                        } else if (newWorker.state === 'activated') {
                            // Update found - reload to get new version
                            console.log(' New version activated, reloading...');
                            window.location.reload();
                        }
                    });
                });
                
                // Handle controlling service worker change (for updates)
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        console.log(' Controller changed, reloading...');
                        window.location.reload();
                    }
                });
            })
            .catch(error => {
                console.warn(' Service Worker registration failed:', error);
            });
    });
}
</script>
</body>
</html>