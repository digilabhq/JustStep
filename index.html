<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="var(--primary)">
    <title>JustStep</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* Theme Variables */
        :root {
            --primary: #2563eb;
            --primary-light: #60a5fa;
            --primary-dark: #1e40af;
            --primary-darker: #1d4ed8;
            --primary-medium: #3b82f6;
        }

        [data-theme="green"] {
            --primary: #10b981;
            --primary-light: #34d399;
            --primary-dark: #059669;
            --primary-darker: #047857;
            --primary-medium: #10b981;
        }

        [data-theme="pink"] {
            --primary: #ec4899;
            --primary-light: #f472b6;
            --primary-dark: #db2777;
            --primary-darker: #be185d;
            --primary-medium: #ec4899;
        }

        [data-theme="purple"] {
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --primary-dark: #7c3aed;
            --primary-darker: #6d28d9;
            --primary-medium: #8b5cf6;
        }

        [data-theme="red"] {
            --primary: #ef4444;
            --primary-light: #f87171;
            --primary-dark: #dc2626;
            --primary-darker: #b91c1c;
            --primary-medium: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide number input spinner arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e8e8e8;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: #1a1a1a;
            min-height: 100vh;
            position: relative;
            padding-bottom: 70px;
        }

        /* App Logo Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
            padding: 10px 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            gap: 8px;
            z-index: 101;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
        }

        .app-header-left {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .app-header-right {
            position: absolute;
            right: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .info-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .info-icon:hover {
            border-color: white;
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .app-version {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }

        .app-logo {
            font-size: 24px;
        }

        .app-name {
            font-size: 22px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }

        /* Navigation */
        .nav-container {
            background: #2d2d2d;
            border-bottom: 1px solid #3d3d3d;
            position: sticky;
            top: 56px;
            z-index: 100;
        }

        .nav-tabs {
            display: flex;
        }

        .nav-tabs.first-row {
            border-bottom: 1px solid #3d3d3d;
        }

        .nav-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 500;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .nav-tab.active {
            color: var(--primary-light);
            border-bottom: 2px solid var(--primary);
        }

        .screen {
            display: none;
            padding: 12px;
            animation: fadeIn 0.3s;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Typography */
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.3px;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 14px;
            margin-bottom: 12px;
        }

        /* Daily Logging Screen */
        .date-selector {
            background: #2d2d2d;
            padding: 5px 8px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .date-selector span {
            filter: brightness(1.5) contrast(1.2);
        }

        .date-selector input {
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #e8e8e8;
            color-scheme: dark;
        }

        .activities-container {
            margin-bottom: 12px;
        }

        .activity-card {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 16px;
            padding: 5px;
            margin-bottom: 12px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        .activity-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .activity-card-title {
            font-size: 13px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remove-activity {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .remove-activity:hover {
            background: #3d1f1f;
            color: #ef4444;
        }

        .activity-type-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            background: #1a1a1a;
            color: #e8e8e8;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color-scheme: dark;
        }

        /* Accordion Styles */
        .activity-accordion {
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            overflow: hidden;
        }

        .accordion-category {
            border-bottom: 1px solid #2d2d2d;
        }

        .accordion-category:last-child {
            border-bottom: none;
        }

        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: #2d2d2d;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .accordion-header:hover {
            background: #3d3d3d;
        }

        .accordion-header.active {
            background: #3d3d3d;
        }

        .accordion-title {
            font-size: 14px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .accordion-count {
            font-size: 12px;
            color: #6b7280;
            margin-left: 8px;
        }

        .accordion-arrow {
            font-size: 12px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
            color: var(--primary-light);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #1a1a1a;
        }

        .accordion-content.active {
            max-height: 500px;
        }

        .accordion-item {
            padding: 10px 14px;
            border-bottom: 1px solid #2d2d2d;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #9ca3af;
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-item:hover {
            background: #2d2d2d;
            color: #e8e8e8;
            padding-left: 18px;
        }

        .accordion-item.selected {
            background: rgba(96, 165, 250, 0.1);
            color: var(--primary-light);
            font-weight: 600;
        }

        .activity-type-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            background: #2d2d2d;
            color: #e8e8e8;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .activity-type-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .activity-value-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .activity-value-input input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            background: #2d2d2d;
            color: #e8e8e8;
            color-scheme: dark;
        }

        .activity-value-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .activity-value-input .unit {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            min-width: 40px;
        }

        .add-activity-button {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            color: var(--primary-light);
            border: 2px dashed #3d3d3d;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-activity-button:active {
            transform: scale(0.98);
            background: #1e3a5f;
        }

        .log-button {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .log-button:active {
            transform: scale(0.98);
            background: var(--primary-darker);
        }

        .workout-confirmed {
            padding: 10px 12px;
            background: #1e3a5f;
            border-radius: 12px;
            color: var(--primary-light);
            font-weight: 600;
            font-size: 14px;
            text-align: center;
        }

        /* Dashboard Screen - Always 3 columns */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        /* Smaller cards on mobile for better fit */
        @media (max-width: 600px) {
            .stats-grid {
                gap: 8px;
            }
            
            .stat-card {
                padding: 5px 3px;
                min-height: 52px;
            }
            
            .stat-value {
                font-size: 15px;
            }
            
            .stat-label {
                font-size: 8px;
            }
        }

        .stat-card {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            padding: 5px 3px;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 60px;
            aspect-ratio: 1.4 / 1;
        }

        /* Gold border for custom/favorite cards */
        .stat-card#custom-card-1,
        .stat-card#custom-card-2,
        .stat-card#custom-card-3 {
            border-color: #d4af37;
        }

        .stat-star {
            font-size: 12px;
            margin-bottom: 2px;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #e8e8e8;
            margin-bottom: 3px;
            text-align: center;
            line-height: 1;
        }

        .stat-label {
            font-size: 9px;
            color: #9ca3af;
            text-transform: capitalize;
            letter-spacing: 0.2px;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }

        .stat-trend {
            font-size: 10px;
            margin-top: 2px;
            text-align: center;
        }

        .progress-card {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .progress-percentage {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-light);
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #3d3d3d;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-medium) 100%);
            border-radius: 8px;
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #9ca3af;
        }

        .milestone-list {
            margin-top: 12px;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #3d3d3d;
        }

        .milestone-item:last-child {
            border-bottom: none;
        }

        .milestone-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
        }

        .milestone-text {
            font-size: 14px;
            font-weight: 500;
            color: #e8e8e8;
        }

        /* Activity Report (Collapsible) */
        .activity-report-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            font-size: 16px;
            font-weight: 700;
            color: #e8e8e8;
            padding: 4px 0;
        }

        .activity-report-toggle:hover {
            color: var(--primary-light);
        }

        .activity-report-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .activity-report-content.expanded {
            max-height: 2000px;
        }

        .activity-summary-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .activity-summary-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 12px;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #2d2d2d;
            font-size: 13px;
        }

        .activity-summary-item:last-child {
            border-bottom: none;
        }

        .activity-summary-name {
            color: #9ca3af;
            font-weight: 600;
        }

        .activity-summary-value {
            color: #e8e8e8;
            font-weight: 600;
            text-align: right;
            min-width: 70px;
        }

        .activity-summary-value.week {
            color: #34d399;
        }

        .activity-summary-value.month {
            color: var(--primary-light);
        }

        .activity-summary-value.total {
            color: #e8e8e8;
            font-weight: 700;
        }

        /* Calendar View */
        .calendar-header {
            text-align: center;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            color: #9ca3af;
        }

        .calendar-month-year {
            font-size: 20px;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-label {
            text-align: center;
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            padding: 5px 0;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            position: relative;
            cursor: pointer;
            color: #e8e8e8;
        }

        .calendar-day.has-activity {
            border-color: var(--primary);
            background: #1e3a5f;
        }

        .calendar-day.today {
            border-color: var(--primary-light);
            font-weight: 700;
        }

        .calendar-day.other-month {
            color: #4b5563;
        }

        .activity-dots {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }

        .activity-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--primary);
        }

        .habit-checks {
            position: absolute;
            top: 3px;
            right: 3px;
            font-size: 7px;
            letter-spacing: -1px;
            line-height: 7px;
            font-weight: 700;
        }

        /* Goals Screen */
        .goal-input {
            margin-bottom: 12px;
        }

        .goal-input label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #e8e8e8;
            margin-bottom: 8px;
        }

        .goal-description {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .goal-input input, .goal-input select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            background: #2d2d2d;
            color: #e8e8e8;
            color-scheme: dark;
        }

        /* Theme Selector */
        .theme-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 6px;
            border: 2px solid #3d3d3d;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
        }

        .theme-option:hover {
            background: rgba(255, 255, 255, 0.03);
            border-color: #4b5563;
        }

        .theme-option.active {
            border-color: var(--primary-light);
            background: rgba(96, 165, 250, 0.1);
        }

        .theme-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .theme-option span {
            font-size: 12px;
            font-weight: 500;
            color: #9ca3af;
        }

        .theme-option.active span {
            color: #e8e8e8;
        }

        .save-button {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            letter-spacing: 0.3px;
        }

        .save-button:active {
            transform: scale(0.98);
            background: #333;
        }

        .info-box {
            margin-top: 32px;
            padding: 5px;
            background: #2d2d2d;
            border-radius: 12px;
        }

        .info-box-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .info-box-content {
            font-size: 13px;
            color: #9ca3af;
            line-height: 1.8;
        }

        /* Milestone Notification */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        .milestone-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 320px;
            z-index: 1000;
            display: none;
        }

        .milestone-notification.show {
            display: block;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .milestone-icon-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 40px;
        }

        .milestone-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .milestone-description {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .milestone-close {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .export-button {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            color: #e8e8e8;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            letter-spacing: 0.3px;
        }

        .export-button:active {
            transform: scale(0.98);
            background: #2d2d2d;
        }

        .success-message {
            background: #1e3a5f;
            color: var(--primary);
            padding: 5px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            display: none;
            text-align: center;
        }

        .success-message.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .error-message {
            background: #3d1f1f;
            color: #ef4444;
            padding: 5px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            display: none;
            text-align: center;
        }

        .error-message.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Leaderboard Redesign */
        .leaderboard-toggle .toggle-btn.active {
            background: var(--primary-dark) !important;
            color: white !important;
        }

        .leaderboard-toggle .toggle-btn:hover {
            background: #3d3d3d;
        }

        .leaderboard-item-card {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            padding: 14px;
            transition: all 0.2s;
        }

        .leaderboard-item-card.highlight {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .leaderboard-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .leaderboard-rank {
            font-size: 16px;
            font-weight: 700;
            color: #9ca3af;
            min-width: 30px;
        }

        .leaderboard-name {
            flex: 1;
            font-size: 15px;
            font-weight: 600;
            color: #e8e8e8;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .leaderboard-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-light);
        }

        .leaderboard-progress-bar {
            width: 100%;
            height: 6px;
            background: #1a1a1a;
            border-radius: 3px;
            overflow: hidden;
        }

        .leaderboard-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 3px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* PALS Section */
        .pals-section {
            background: #2d2d2d;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .pal-card {
            background: transparent;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 6px;
            border: 1px solid #2d2d2d;
            transition: all 0.2s;
        }

        .pal-card:hover {
            border-color: #3d3d3d;
        }

        .pal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .pal-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .pal-expand-icon {
            font-size: 11px;
            color: #6b7280;
            padding: 3px;
            transition: color 0.2s;
        }

        .pal-card.expanded .pal-expand-icon {
            color: var(--primary-light);
        }

        .pal-name {
            font-size: 14px;
            font-weight: 500;
            color: #e8e8e8;
            letter-spacing: -0.01em;
        }

        .pal-code {
            font-size: 10px;
            color: #6b7280;
            font-weight: 400;
            margin-top: 2px;
        }

        .pal-stats-expanded {
            display: none;
            padding: 0 12px 8px 12px;
            border-top: 1px solid #2d2d2d;
        }

        .pal-card.expanded .pal-stats-expanded {
            display: block;
        }

        .pal-activity-report {
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .pal-activity-header {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 12px;
            padding: 4px 0;
            border-bottom: 1px solid #2d2d2d;
            font-weight: 600;
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pal-activity-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 16px;
            padding: 8px 0;
            border-bottom: 1px solid #1a1a1a;
            font-size: 13px;
        }

        .pal-activity-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .pal-activity-col-name {
            color: #9ca3af;
            font-weight: 400;
        }

        .pal-activity-col-value {
            font-weight: 500;
            text-align: right;
            min-width: 60px;
            font-variant-numeric: tabular-nums;
        }

        .pal-activity-header .pal-activity-col-value {
            color: #6b7280;
        }

        .pal-activity-col-value.pal-week {
            color: #34d399;
        }

        .pal-activity-col-value.pal-month {
            color: var(--primary-light);
        }

        .pal-activity-col-value.pal-total {
            color: #e8e8e8;
            font-weight: 600;
        }

        .pal-actions {
            display: flex;
            gap: 8px;
            padding-top: 8px;
        }

        .pal-btn {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #3d3d3d;
            background: transparent;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            color: #9ca3af;
        }

        .pal-btn:hover {
            background: rgba(255, 255, 255, 0.03);
            border-color: #4b5563;
        }

        .pal-btn-remove {
            color: #f87171;
            border-color: #7f1d1d;
        }

        .pal-btn-remove:hover {
            background: rgba(127, 29, 29, 0.1);
            border-color: #991b1b;
        }

        .pal-btn:active {
            transform: scale(0.97);
        }

        .refresh-all-btn {
            width: 100%;
            padding: 10px;
            background: transparent;
            color: var(--primary-light);
            border: 1px solid #2d2d2d;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.15s;
        }

        .refresh-all-btn:hover {
            background: rgba(96, 165, 250, 0.05);
            border-color: #3d3d3d;
        }

        .refresh-all-btn:active {
            transform: scale(0.98);
        }

        .refresh-all-btn:disabled {
            background: transparent;
            color: #4b5563;
            border-color: #2d2d2d;
            cursor: not-allowed;
        }
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 6px;
            border: 1px solid #2d2d2d;
            transition: all 0.15s;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.02);
            border-color: #3d3d3d;
        }

        .leaderboard-rank {
            font-size: 18px;
            font-weight: 500;
            min-width: 28px;
            color: #9ca3af;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-size: 14px;
            font-weight: 500;
            color: #e8e8e8;
            letter-spacing: -0.01em;
        }

        .leaderboard-code {
            font-size: 11px;
            color: #6b7280;
            font-weight: 400;
            margin-top: 2px;
        }

        .leaderboard-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-light);
            font-variant-numeric: tabular-nums;
        }

        /* Day Detail Modal */
        .day-detail-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 360px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .day-detail-modal.show {
            display: block;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .day-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 16px;
            border-bottom: 2px solid #3d3d3d;
        }

        .day-detail-date {
            font-size: 20px;
            font-weight: 700;
            color: #e8e8e8;
        }

        .day-detail-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .day-detail-close:hover {
            background: #3d3d3d;
        }

        .day-activity-list {
            margin-bottom: 12px;
        }

        .day-activity-item {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #3d3d3d;
        }

        .day-activity-info {
            flex: 1;
        }

        .day-activity-type {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: capitalize;
            color: #e8e8e8;
            background: none !important;
        }

        .day-activity-value {
            font-size: 14px;
            color: #9ca3af;
        }

        .day-activity-delete {
            background: #3d1f1f;
            color: #ef4444;
            border: none;
            padding: 5px 8px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-activity-delete:hover {
            background: #4d2626;
            color: #f87171;
        }

        .day-totals {
            background: #1e3a5f;
            padding: 10px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .day-totals-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary-light);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-totals-content {
            font-size: 14px;
            color: #e8e8e8;
            line-height: 1.8;
        }

        .empty-day {
            text-align: center;
            padding: 24px 12px;
            color: #6b7280;
        }

        .empty-day-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-day-text {
            font-size: 14px;
        }

        .calendar-hint {
            text-align: center;
            margin-top: 12px;
            margin-bottom: 12px;
            padding: 5px;
            background: #1e3a5f;
            border-radius: 12px;
            font-size: 13px;
            color: var(--primary-light);
            font-weight: 500;
        }

        /* Stats Toggle */
        .stats-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            background: #2d2d2d;
            padding: 3px;
            border-radius: 12px;
            border: 2px solid #3d3d3d;
        }

        .stats-toggle-btn {
            flex: 1;
            padding: 6px 12px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .stats-toggle-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Welcome Modal */
        .welcome-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .welcome-modal.show {
            display: block;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .welcome-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
            margin: -20px -16px 16px -16px;
            padding: 16px;
            border-radius: 20px 20px 0 0;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 0;
            letter-spacing: -0.5px;
        }

        .welcome-quote {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-light);
            margin: 16px 0;
            font-style: italic;
            line-height: 1.4;
        }

        .welcome-content {
            font-size: 15px;
            color: #d1d5db;
            line-height: 1.8;
            margin: 20px 0;
        }

        .welcome-highlight {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-light);
            margin: 20px 0;
            line-height: 1.6;
        }

        .welcome-tagline {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            margin: 16px 0 24px 0;
            letter-spacing: 0.5px;
        }

        .welcome-video-link {
            display: inline-block;
            color: var(--primary-light);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            transition: color 0.2s;
        }

        .welcome-video-link:hover {
            color: var(--primary-medium);
        }

        .welcome-button {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-darker) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .welcome-button:active {
            transform: scale(0.98);
        }

        /* Customize Dashboard Button */
        .customize-dashboard-btn {
            display: block;
            margin: -20px auto 0;
            background: none;
            border: none;
            color: #d4af37;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 16px;
            transition: color 0.2s;
            text-align: center;
        }

        .customize-dashboard-btn:hover {
            color: #c9a332;
        }

        /* Customize Modal */
        .customize-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            z-index: 1500;
            display: none;
        }

        .customize-modal.show {
            display: block;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .customize-modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #e8e8e8;
        }

        .customize-slot {
            margin-bottom: 12px;
        }

        .customize-slot-label {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 8px;
            display: block;
        }

        .customize-slot select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            background: #1a1a1a;
            color: #e8e8e8;
            cursor: pointer;
        }

        .customize-slot select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .customize-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .customize-modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .customize-modal-btn.save {
            background: var(--primary);
            color: white;
        }

        .customize-modal-btn.save:active {
            transform: scale(0.98);
            background: var(--primary-darker);
        }

        .customize-modal-btn.cancel {
            background: #3d3d3d;
            color: #e8e8e8;
        }

        .customize-modal-btn.cancel:active {
            transform: scale(0.98);
            background: #4d4d4d;
        }

        /* Weight Input Styles */
        .weight-input-section {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 16px;
            padding: 5px;
            margin-top: 32px;
            margin-bottom: 12px;
        }

        .weight-input-header {
            font-size: 13px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .weight-input-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .weight-input-field {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            background: #1a1a1a;
            color: #e8e8e8;
        }

        .weight-input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .weight-unit-label {
            font-size: 16px;
            font-weight: 600;
            color: #9ca3af;
            min-width: 40px;
        }

        .weight-save-btn {
            padding: 14px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-save-btn:active {
            transform: scale(0.98);
            background: var(--primary-darker);
        }

        .weight-save-btn-subtle {
            padding: 8px 16px;
            background: transparent;
            color: var(--primary-light);
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
            width: 100%;
        }

        .weight-save-btn-subtle:hover {
            background: #1e3a5f;
            border-color: var(--primary-light);
        }

        .weight-save-btn-subtle:active {
            transform: scale(0.98);
        }

        /* Trending Indicators */
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
        }

        .trend-indicator.up {
            color: #10b981;
        }

        .trend-indicator.down {
            color: #ef4444;
        }

        .trend-indicator.stable {
            color: #6b7280;
        }

        /* Bar Graph Comparison Styles */
        .comparison-section {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 16px;
            padding: 10px;
            margin-bottom: 12px;
        }

        .comparison-header {
            font-size: 15px;
            font-weight: 700;
            color: #e8e8e8;
            margin-bottom: 12px;
            letter-spacing: -0.3px;
        }

        .comparison-graph {
            margin-bottom: 12px;
        }

        .comparison-graph:last-child {
            margin-bottom: 0;
        }

        .comparison-title {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .bar-label {
            font-size: 13px;
            font-weight: 600;
            color: #9ca3af;
            min-width: 80px;
        }

        .bar-container {
            flex: 1;
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .bar-fill.current-period {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-medium) 100%);
        }

        .bar-fill.previous-period {
            background: linear-gradient(90deg, #6b7280 0%, #9ca3af 100%);
        }

        .bar-value {
            font-size: 12px;
            font-weight: 700;
            color: #e8e8e8;
            min-width: 45px;
            text-align: right;
        }

        /* Number Count-Up Animation */
        .stat-card-value {
            animation: countUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Weight History Expandable Section */
        .weight-history-toggle {
            font-size: 12px;
            color: var(--primary-light);
            cursor: pointer;
            margin-top: 6px;
            text-align: center;
            font-weight: 600;
            user-select: none;
        }

        .weight-history-toggle:hover {
            color: var(--primary-medium);
        }

        .weight-history-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0;
        }

        .weight-history-list.expanded {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
            border-top: 1px solid #3d3d3d;
            padding-top: 12px;
        }

        .weight-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #2d2d2d;
            font-size: 13px;
        }

        .weight-entry:last-child {
            border-bottom: none;
        }

        .weight-entry-date {
            color: #9ca3af;
            font-weight: 600;
            min-width: 80px;
        }

        .weight-entry-value {
            color: #e8e8e8;
            font-weight: 700;
            flex: 1;
            text-align: center;
        }

        .weight-entry-actions {
            display: flex;
            gap: 6px;
        }

        .weight-entry-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-entry-edit {
            background: #1e3a5f;
            color: var(--primary-light);
        }

        .weight-entry-edit:hover {
            background: #2d5a8f;
        }

        .weight-entry-delete {
            background: #3d1f1f;
            color: #ef4444;
        }

        .weight-entry-delete:hover {
            background: #4d2626;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <div class="app-header-left">
                <span class="app-name">JustStep</span>
            </div>
            <div class="app-header-right">
                <div class="info-icon" onclick="app.showWelcome()" title="About JustStep">i</div>
                <div class="app-version" id="app-version-display"></div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="nav-tabs first-row">
                <button class="nav-tab active" onclick="app.showScreen('log')">Tracker</button>
                <button class="nav-tab" onclick="app.showScreen('dashboard')">Dashboard</button>
                <button class="nav-tab" onclick="app.showScreen('calendar')">Calendar</button>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab" onclick="app.showScreen('goals')">Goals</button>
                <button class="nav-tab" onclick="app.showScreen('pals')">Pals</button>
                <button class="nav-tab" onclick="app.showScreen('leaderboard')">Leaderboard</button>
            </div>
        </div>

        <!-- Daily Logging Screen -->
        <div id="log-screen" class="screen active">
            <h1>Track Activity</h1>
            <p class="subtitle">Record today's workout</p>

            <div class="date-selector">
                <span></span>
                <input type="date" id="log-date" value="">
            </div>

            <div id="activities-container" class="activities-container">
                <!-- Activity cards will be added here -->
            </div>

            <button class="add-activity-button" onclick="app.addActivityRow()">
                <span style="font-size: 20px; margin-right: 8px;">+</span>
                Add Activity
            </button>

            <button class="log-button" onclick="app.saveLog()">Save Activity</button>

            <!-- Weight Input Section -->
            <div class="weight-input-section">
                <div class="weight-input-header">Track Weight</div>
                <div class="weight-input-row">
                    <input type="number" 
                           id="weight-input" 
                           class="weight-input-field" 
                           placeholder="Enter weight" 
                           step="0.1"
                           min="0"
                           inputmode="decimal">
                    <span class="weight-unit-label" id="weight-unit-display">lbs</span>
                </div>
                <button class="weight-save-btn-subtle" onclick="app.logWeight()">Save</button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="screen">
            <h1>Dashboard</h1>
            <p class="subtitle">Your progress overview</p>

            <div class="stats-toggle">
                <button class="stats-toggle-btn active" onclick="app.setStatsView('week')">This Week</button>
                <button class="stats-toggle-btn" onclick="app.setStatsView('total')">All Time</button>
            </div>

            <div class="stats-grid">
                <!-- Row 1: Fixed Cards -->
                <div class="stat-card">
                    <div class="stat-value" id="stat-miles">0</div>
                    <div class="stat-label" id="stat-miles-label">Miles</div>
                    <div class="stat-trend" id="stat-miles-trend"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-workouts">0</div>
                    <div class="stat-label" id="stat-workouts-label">Strength Days</div>
                    <div class="stat-trend" id="stat-workouts-trend"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-steps">0</div>
                    <div class="stat-label" id="stat-steps-label">Steps</div>
                    <div class="stat-trend" id="stat-steps-trend"></div>
                </div>
                
                <!-- Row 2: Custom Cards (dynamically rendered) -->
                <div class="stat-card" id="custom-card-1">
                    <div class="stat-value" id="custom-stat-1">0</div>
                    <div class="stat-label" id="custom-label-1">Push-ups</div>
                    <div class="stat-trend" id="custom-trend-1"></div>
                </div>
                <div class="stat-card" id="custom-card-2">
                    <div class="stat-value" id="custom-stat-2">0</div>
                    <div class="stat-label" id="custom-label-2">Pull-ups</div>
                    <div class="stat-trend" id="custom-trend-2"></div>
                </div>
                <div class="stat-card" id="custom-card-3">
                    <div class="stat-value" id="custom-stat-3">0</div>
                    <div class="stat-label" id="custom-label-3">Roller Abs</div>
                    <div class="stat-trend" id="custom-trend-3"></div>
                </div>
            </div>

            <button class="customize-dashboard-btn" onclick="app.openCustomizeModal()">Customize Favorites</button>

            <!-- Comparison Bar Graphs -->
            <div class="comparison-section">
                <div class="comparison-header">Progress Comparison</div>
                
                <div class="comparison-graph">
                    <div class="comparison-title">This Week vs Last Week</div>
                    <div class="bar-row">
                        <div class="bar-label">This Week</div>
                        <div class="bar-container">
                            <div class="bar-fill current-period" id="week-current-bar" style="width: 0%"></div>
                        </div>
                        <div class="bar-value" id="week-current-value">0</div>
                    </div>
                    <div class="bar-row">
                        <div class="bar-label">Last Week</div>
                        <div class="bar-container">
                            <div class="bar-fill previous-period" id="week-previous-bar" style="width: 0%"></div>
                        </div>
                        <div class="bar-value" id="week-previous-value">0</div>
                    </div>
                </div>

                <div class="comparison-graph">
                    <div class="comparison-title">This Month vs Last Month</div>
                    <div class="bar-row">
                        <div class="bar-label">This Month</div>
                        <div class="bar-container">
                            <div class="bar-fill current-period" id="month-current-bar" style="width: 0%"></div>
                        </div>
                        <div class="bar-value" id="month-current-value">0</div>
                    </div>
                    <div class="bar-row">
                        <div class="bar-label">Last Month</div>
                        <div class="bar-container">
                            <div class="bar-fill previous-period" id="month-previous-bar" style="width: 0%"></div>
                        </div>
                        <div class="bar-value" id="month-previous-value">0</div>
                    </div>
                </div>
            </div>

            <!-- Weight Summary (if weight data exists) -->
            <div class="progress-card" id="weight-summary-card" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 0;">
                    <span class="progress-title" style="margin: 0;">Weight</span>
                    <div style="display: flex; align-items: baseline; gap: 6px;">
                        <div style="font-size: 32px; font-weight: 700; color: #e8e8e8;" id="weight-display-value">--</div>
                        <div style="font-size: 14px; color: #9ca3af;" id="weight-display-unit">lbs</div>
                        <div id="weight-trend-indicator"></div>
                    </div>
                </div>
                
                <!-- Weight History Toggle -->
                <div class="weight-history-toggle" id="weight-history-toggle" onclick="app.toggleWeightHistory()">
                    View History 
                </div>
                
                <!-- Weight History List (expandable) -->
                <div class="weight-history-list" id="weight-history-list">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <div class="progress-card">
                <div class="progress-header">
                    <span class="progress-title">Annual Goal</span>
                    <span class="progress-percentage" id="annual-progress-percent">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="annual-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-details">
                    <span id="annual-progress-current">0</span>
                    <span id="annual-progress-goal">420</span>
                </div>
            </div>
            
        </div>

        <!-- Calendar Screen -->
        <div id="calendar-screen" class="screen">
            <div class="calendar-header">
                <button class="calendar-nav" onclick="app.changeMonth(-1)"></button>
                <div class="calendar-month-year" id="calendar-month-year">January 2026</div>
                <button class="calendar-nav" onclick="app.changeMonth(1)"></button>
            </div>

            <div class="calendar-grid" id="calendar-grid">
                <!-- Calendar will be generated here -->
            </div>

            <div class="calendar-hint">
                 Tap any day to see details
            </div>

            <!-- Activity Report (Collapsible) -->
            <div class="progress-card">
                <div class="activity-report-toggle" id="activity-report-toggle" onclick="app.toggleActivityReport()">
                    <span>Activity Report</span>
                    <span></span>
                </div>
                <div class="activity-report-content" id="activity-report-content">
                    <div class="activity-summary-list" id="activity-summary-list">
                        <p style="text-align: center; color: #6b7280; font-size: 14px;">No activities logged yet.</p>
                    </div>
                </div>
            </div>

            <h2>Recent Milestones</h2>
            <div class="progress-card">
                <div class="milestone-list" id="milestone-list">
                    <p style="text-align: center; color: #6b7280; font-size: 14px;">No milestones yet. Keep going!</p>
                </div>
            </div>
            
        </div>

        <!-- Goals Screen -->
        <div id="goals-screen" class="screen">
            <h1>Goals</h1>
            <p class="subtitle">Customize your goals and preferences</p>

            <!-- Slim compact sections -->
            <div style="display: flex; flex-direction: column; gap: 8px;">
                
                <!-- Unit Preference - Inline -->
                <div style="background: #2d2d2d; padding: 10px 14px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Unit Preference</label>
                        <select id="unit-preference" style="width: 220px; padding: 6px 10px; border: 1px solid #3d3d3d; border-radius: 6px; font-size: 13px; font-weight: 600; background: #1a1a1a; color: #e8e8e8;">
                            <option value="miles">Miles</option>
                            <option value="km">Kilometers</option>
                        </select>
                    </div>
                </div>

                <!-- Initial Weight - Inline -->
                <div style="background: #2d2d2d; padding: 10px 14px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Initial Weight</label>
                        <div style="width: 220px; display: flex; align-items: center; gap: 0; padding: 6px 10px; border: 2px solid #3d3d3d; border-radius: 6px; background: #1a1a1a;">
                            <input type="number" id="initial-weight-preference" placeholder="Enter initial weight" inputmode="decimal"
                                   style="flex: 1; min-width: 0; border: none; outline: none; padding: 0; background: transparent; color: #e8e8e8; font-size: 13px; font-weight: 600;">
                            <span style="margin-left: 8px; font-size: 12px; color: #9ca3af; font-weight: 600;">lbs</span>
</div>
                    </div>
                </div>

                <!-- App Theme - Compact -->
                <div style="background: #2d2d2d; padding: 10px 14px; border-radius: 8px;">
                    <label style="font-size: 14px; font-weight: 600; color: #e8e8e8; display: block; margin-bottom: 8px;">App Theme</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <button onclick="app.openThemeColorPicker()" 
                                style="padding: 8px 12px; background: #1a1a1a; color: #e8e8e8; border: 1px solid #3d3d3d; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <span style="width: 16px; height: 16px; border-radius: 50%; background: var(--primary-dark); display: inline-block;"></span>
                            Choose
                        </button>
                        <button onclick="app.resetThemeToDefault()" 
                                style="padding: 8px 12px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Weekly Strength Days Target - Inline -->
                <div style="background: #2d2d2d; padding: 10px 14px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Weekly Strength Days Target</label>
                        <input type="number" id="workout-frequency" value="5" placeholder="5" inputmode="numeric" 
                               style="width: 80px; padding: 6px 10px; border: 1px solid #3d3d3d; border-radius: 6px; font-size: 13px; font-weight: 600; background: #1a1a1a; color: #e8e8e8; text-align: center;">
                    </div>
                </div>

                <!-- Monthly Mileage Target - Inline -->
                <div style="background: #2d2d2d; padding: 10px 14px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Monthly Mileage Target</label>
                        <input type="number" id="monthly-goal" value="35" placeholder="35" inputmode="numeric" 
                               style="width: 80px; padding: 6px 10px; border: 1px solid #3d3d3d; border-radius: 6px; font-size: 13px; font-weight: 600; background: #1a1a1a; color: #e8e8e8; text-align: center;">
                    </div>
                </div>

                <!-- Annual Mileage Target - Inline -->
                <div style="background: #2d2d2d; padding: 10px 14px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label style="font-size: 14px; font-weight: 600; color: #e8e8e8;">Annual Mileage Target</label>
                        <input type="number" id="annual-goal" value="420" placeholder="420" inputmode="numeric" 
                               style="width: 80px; padding: 6px 10px; border: 1px solid #3d3d3d; border-radius: 6px; font-size: 13px; font-weight: 600; background: #1a1a1a; color: #e8e8e8; text-align: center;">
                    </div>
                </div>
            </div>

            <!-- Elegant divider line like monthly days section -->
            <div style="margin: 24px 0; border-top: 1px solid #3d3d3d;"></div>

            <!-- Daily Habits Section -->
            <div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 14px; font-weight: 600; color: #e8e8e8; display: block; margin-bottom: 4px;">Daily Habits (Private)</label>
                    <p style="font-size: 12px; color: #6b7280; margin: 0;">Track up to 3 personal habits - not shared with anyone</p>
                </div>
                
                <div id="habits-list" style="display: flex; flex-direction: column; gap: 6px;">
                    <!-- Habits will be rendered here -->
                </div>
                
                <button class="export-button" onclick="app.addHabit()" id="add-habit-btn" style="margin-top: 10px; padding: 8px 14px; font-size: 13px;">+ Add Habit</button>
            </div>

            <!-- Save Settings -->
            <button class="save-button" onclick="app.saveGoals()" style="margin-top: 24px;">Save Settings</button>
            <div class="success-message" id="settings-success">Settings saved successfully!</div>

            <!-- Elegant divider line -->
            <div style="margin: 24px 0; border-top: 1px solid #3d3d3d;"></div>

            <!-- Data Import/Export -->
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="app.handleImportFile(event)">
                <button class="export-button" onclick="document.getElementById('import-file-input').click()" style="padding: 8px 14px; font-size: 13px;">Import Data</button>
                <button class="export-button" onclick="app.exportData()" style="padding: 8px 14px; font-size: 13px;">Export All Data</button>
            </div>
            <div class="success-message" id="import-success">Data imported successfully!</div>
            
        </div>

        <!-- PALS Screen -->
        <div id="pals-screen" class="screen">
            <h1>Pals</h1>
            <p class="subtitle">Share your fitness journey with friends</p>

            <!-- MY PROFILE Section - Slim Design -->
            <div class="pals-section">
                <h2 style="font-size: 14px; margin-bottom: 8px; color: var(--primary-light); font-weight: 600;">MY PROFILE</h2>
                
                <!-- PAL Code Row -->
                <div style="background: #2d2d2d; border-radius: 8px; padding: 8px 12px; margin-bottom: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">PAL Code</div>
                            <div style="font-size: 14px; color: #e8e8e8; font-weight: 600;" id="display-pal-code">
                                Not set
                            </div>
                        </div>
                        <button id="pal-code-btn" onclick="app.handlePalCodeButton()" 
                                style="width: 55px; height: 32px; flex-shrink: 0; background: var(--primary-dark); color: white; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                            Set Code
                        </button>
                    </div>
                </div>

                <!-- Display Name Row -->
                <div style="background: #2d2d2d; border-radius: 8px; padding: 8px 12px; margin-bottom: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">Display Name</div>
                            <div style="font-size: 14px; color: #e8e8e8; font-weight: 600;" id="display-display-name">
                                Not set
                            </div>
                        </div>
                        <button onclick="app.editDisplayName()" 
                                style="width: 55px; height: 32px; flex-shrink: 0; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                            Edit
                        </button>
                    </div>
                </div>

                <!-- Show in Leaderboards Toggle -->
                <div style="background: #2d2d2d; border-radius: 8px; padding: 8px 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <div style="flex: 1; min-width: 0;">
                            <span style="font-size: 13px; color: #e8e8e8; font-weight: 500; display: block;">Show in Leaderboards</span>
                            <span style="font-size: 10px; color: #6b7280; display: block; margin-top: 2px;">Compete globally with all JustStep users</span>
                        </div>
                        <div style="width: 55px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                            <input type="checkbox" id="join-leaderboard" onchange="app.toggleLeaderboard()" 
                                   style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 10px;">
                        <div style="flex: 1; min-width: 0;">
                            <span style="font-size: 13px; color: var(--text); font-weight: 500; display: block;">Include Weight Leaderboard</span></div>
                        <div style="width: 55px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                            <input type="checkbox" id="join-weight-leaderboard" onchange="app.toggleWeightLeaderboardOptIn()"
                                   style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                        </div>
                    </label>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Requires Initial Weight in Goals and regular weigh-ins.</div>

                </div>
            </div>

            <!-- ADD PAL Section - Compact -->
            <div class="pals-section">
                <h2 style="font-size: 14px; margin-bottom: 8px; color: var(--primary-light); font-weight: 600;">ADD PAL</h2>
                
                <div style="background: #2d2d2d; border-radius: 8px; padding: 8px 12px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="add-pal-code" type="tel" inputmode="numeric" placeholder="Enter PAL Code..." 
                               style="flex: 1; min-width: 0; padding: 6px 10px; background: #1a1a1a; border: 1px solid #3d3d3d; border-radius: 6px; color: #e8e8e8; font-size: 13px; height: 32px; box-sizing: border-box;" 
                               maxlength="4">
                        <button onclick="app.addPal()" 
                                style="width: 55px; height: 32px; flex-shrink: 0; background: var(--primary-dark); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">
                            Add
                        </button>
                    </div>
                </div>
                <div class="success-message" id="add-pal-success" style="margin-top: 6px;">Pal added!</div>
                <div class="error-message" id="add-pal-error" style="margin-top: 6px;"></div>
            </div>

            <!-- MY PALS List - Slim -->
            <div class="pals-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h2 style="font-size: 14px; color: var(--primary-light); font-weight: 600; margin: 0;">MY PALS</h2>
                    <button onclick="app.refreshAllPals()" 
                            style="padding: 4px 10px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 5px; font-size: 11px; cursor: pointer; font-weight: 600;">
                         Refresh All
                    </button>
                </div>
                <div id="pals-list">
                    <p style="color: #6b7280; text-align: center; padding: 16px 0; font-size: 13px;">No pals yet. Add one above!</p>
                </div>
            </div>
            
        </div>

        <!-- Leaderboard Screen -->
        <div id="leaderboard-screen" class="screen">
            <h1>Leaderboard</h1>
            <p class="subtitle">Compete with JustStep users worldwide</p>

            <!-- Toggle: Global / Friends -->
            <div class="leaderboard-toggle" style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button class="toggle-btn active" id="lb-global-btn" onclick="app.setLeaderboardMode('global')" 
                        style="flex: 1; padding: 10px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Global
                </button>
                <button class="toggle-btn" id="lb-friends-btn" onclick="app.setLeaderboardMode('friends')" 
                        style="flex: 1; padding: 10px; background: #2d2d2d; color: #9ca3af; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Friends
                </button>
            </div>

            <!-- Time Period & Metric Dropdowns -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                <select id="leaderboard-metric" onchange="app.renderLeaderboard()" 
                        style="padding: 10px; background: #2d2d2d; border: 1px solid #3d3d3d; border-radius: 8px; color: #e8e8e8; font-size: 14px; cursor: pointer;">
                    <option value="thisWeekDistance">Distance</option>
                    <option value="thisWeekSteps">Steps</option>
                    <option value="weight">Weight</option>
                </select>

                <select id="leaderboard-period" onchange="app.renderLeaderboard()" 
                        style="padding: 10px; background: #2d2d2d; border: 1px solid #3d3d3d; border-radius: 8px; color: #e8e8e8; font-size: 14px; cursor: pointer;">
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="total">All Time</option>
                </select>
            </div>

            <!-- Leaderboard List -->
            <div id="leaderboard-list" style="display: flex; flex-direction: column; gap: 12px;">
                <p style="color: #6b7280; text-align: center; padding: 20px;">Loading leaderboard...</p>
            </div>
            
        </div>
    </div>

    <!-- Milestone Notification -->
    <div class="overlay" id="overlay" onclick="app.closeMilestone()"></div>
    <div class="milestone-notification" id="milestone-notification">
        <div class="milestone-icon-large" id="milestone-icon"></div>
        <div class="milestone-title" id="milestone-title">Milestone Reached</div>
        <div class="milestone-description" id="milestone-description">Great work!</div>
        <button class="milestone-close" onclick="app.closeMilestone()">Continue</button>
    </div>

    <!-- Day Detail Modal -->
    <div class="overlay" id="day-overlay" onclick="app.closeDayDetail()"></div>
    <div class="day-detail-modal" id="day-detail-modal">
        <div class="day-detail-header">
            <div class="day-detail-date" id="day-detail-date">January 15, 2026</div>
            <button class="day-detail-close" onclick="app.closeDayDetail()"></button>
        </div>
        <div id="day-detail-content">
            <!-- Content will be populated dynamically -->
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="overlay" id="welcome-overlay"></div>
    <div class="welcome-modal" id="welcome-modal">
        <div class="welcome-header">
            <div class="welcome-title">Welcome to <span style="color: white; font-weight: 700;">J</span>ustStep</div>
        </div>
        
        <div class="welcome-content">
            Success isn't comfortable. Every workout, every mile, every rep you log here is a step closer to your goals!
            <br><br>
            <span style="color: white; font-weight: 700;">J</span>ust take the next <span style="color: white; font-weight: 700;">S</span>tep.
        </div>
        
        <div class="welcome-tagline">
            Track it. Own it. Grow.
        </div>
        
        <a href="https://www.youtube.com/watch?v=ZuHHYRD6AHQ&t=0" target="_blank" class="welcome-video-link">
            Watch  To Grow, You Must Suffer
        </a>
        
        <button class="welcome-button" onclick="app.closeWelcome()">Let's Go</button>
        
        <div style="text-align: center; color: #6b7280; font-size: 11px; margin-top: 16px;">
            v1.8.0
        </div>
    </div>

    <!-- Customize Dashboard Modal -->
    <div class="overlay" id="customize-overlay" onclick="app.closeCustomizeModal()"></div>
    <div class="customize-modal" id="customize-modal">
        <div class="customize-modal-header"> Customize Your Favorites</div>
        
        <div class="customize-slot">
            <label class="customize-slot-label">Favorite 1</label>
            <select id="custom-slot-1">
                <optgroup label=" CARDIO ">
                    <option value="biking">Biking</option>
                    <option value="dog">Dog Walking</option>
                    <option value="hiking">Hiking</option>
                    <option value="run">Running</option>
                    <option value="stairs">Master Stairs</option>
                    <option value="walk">Walking</option>
                </optgroup>
                <optgroup label=" EXERCISES ">
                    <option value="dips">Dips</option>
                    <option value="pullups">Pull-ups</option>
                    <option value="pushups">Push-ups</option>
                    <option value="rollerabs">Roller Abs</option>
                    <option value="situps">Sit-ups</option>
                    <option value="squats">Squats</option>
                </optgroup>
                <optgroup label=" TRACKING ">
                    <option value="weight">Weight</option>
                </optgroup>
            </select>
        </div>
        
        <div class="customize-slot">
            <label class="customize-slot-label">Favorite 2</label>
            <select id="custom-slot-2">
                <optgroup label=" CARDIO ">
                    <option value="biking">Biking</option>
                    <option value="dog">Dog Walking</option>
                    <option value="hiking">Hiking</option>
                    <option value="run">Running</option>
                    <option value="stairs">Master Stairs</option>
                    <option value="walk">Walking</option>
                </optgroup>
                <optgroup label=" EXERCISES ">
                    <option value="dips">Dips</option>
                    <option value="pullups">Pull-ups</option>
                    <option value="pushups">Push-ups</option>
                    <option value="rollerabs">Roller Abs</option>
                    <option value="situps">Sit-ups</option>
                    <option value="squats">Squats</option>
                </optgroup>
                <optgroup label=" TRACKING ">
                    <option value="weight">Weight</option>
                </optgroup>
            </select>
        </div>
        
        <div class="customize-slot">
            <label class="customize-slot-label">Favorite 3</label>
            <select id="custom-slot-3">
                <optgroup label=" CARDIO ">
                    <option value="biking">Biking</option>
                    <option value="dog">Dog Walking</option>
                    <option value="hiking">Hiking</option>
                    <option value="run">Running</option>
                    <option value="stairs">Master Stairs</option>
                    <option value="walk">Walking</option>
                </optgroup>
                <optgroup label=" EXERCISES ">
                    <option value="dips">Dips</option>
                    <option value="pullups">Pull-ups</option>
                    <option value="pushups">Push-ups</option>
                    <option value="rollerabs">Roller Abs</option>
                    <option value="situps">Sit-ups</option>
                    <option value="squats">Squats</option>
                </optgroup>
                <optgroup label=" TRACKING ">
                    <option value="weight">Weight</option>
                </optgroup>
            </select>
        </div>
        
        <div class="customize-modal-buttons">
            <button class="customize-modal-btn cancel" onclick="app.closeCustomizeModal()">Cancel</button>
            <button class="customize-modal-btn save" onclick="app.saveCustomCards()">Save Favorites</button>
        </div>
    </div>

    <!-- Color Palette Modal -->
    <div id="color-palette-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 340px;">
            <h2 style="margin-bottom: 16px; font-size: 18px;">Select Color</h2>
            <div id="color-palette-grid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; margin-bottom: 16px;">
                <!-- Colors will be rendered here: 10 rows x 8 columns -->
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button onclick="app.closeColorPalette()" 
                        style="width: 100%; padding: 10px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Cancel
                </button>
                <button onclick="app.confirmColorSelection()" 
                        style="width: 100%; padding: 10px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Color Wheel Modal -->
    <div id="color-wheel-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="max-width: 360px; text-align: center; background: #1a1a1a; padding: 24px; border-radius: 12px;">
            <h2 style="margin-bottom: 16px; font-size: 18px; color: #e8e8e8;">Choose Your Color</h2>
            <div style="display: flex; justify-content: center; margin-bottom: 16px;">
                <canvas id="color-wheel-canvas" width="280" height="280" style="cursor: crosshair; border-radius: 50%;"></canvas>
            </div>
            <div id="selected-color-preview" style="width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 16px; border: 3px solid #3d3d3d; background: #2563eb;"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button onclick="app.closeColorWheel()" 
                        style="width: 100%; padding: 10px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Cancel
                </button>
                <button onclick="app.confirmColorWheelSelection()" 
                        style="width: 100%; padding: 10px; background: var(--primary-dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        // App Version
        const APP_VERSION = '1.8.0';
        
        // Main App Object
        const app = {
            data: {
                activities: [], // All logged activities
                weights: [], // Weight tracking: { date, weight, unit }
                goals: {
                    annualMiles: 420,
                    workoutFrequency: 5,
                    monthlyMiles: 35,
                    unitPreference: 'miles',
                    weightUnit: 'lbs',
                    initialWeight: null
                },
                habits: [], // Daily habits: { id, name, frequency: 'daily'|'weekly', completions: [dates] }
                milestones: [],
                currentView: {
                    screen: 'log',
                    statsView: 'week', // 'week' or 'total'
                    calendarMonth: new Date().getMonth(),
                    calendarYear: new Date().getFullYear()
                },
                customDashboardCards: ['pushups', 'pullups', 'rollerabs'], // Row 2 customizable cards
                themeColor: 'blue', // Theme color: blue, green, pink, orange, purple, red
                // PALS v1.7.0
                pals: {
                    myPalCode: '',
                    displayName: '',
                    joinedLeaderboard: false,
                    joinWeightLeaderboard: false,
                    friends: [] // Array of {palCode, displayName, stats, lastSync}
                }
            },
            activityCounter: 0,
            habitCounter: 0,
            leaderboardMode: 'global', // 'global' or 'friends'
            firebase: null, // Firebase instance
            db: null, // Firestore instance

            // Initialize app
            init() {
                // Display version in header
                const vEl = document.getElementById('app-version-display');
                if (vEl) vEl.textContent = `v${APP_VERSION}`;

                console.log(`%cJustStep v${APP_VERSION}`, 'color: var(--primary); font-weight: bold; font-size: 14px;');
                
                // Initialize Firebase
                this.initFirebase();
                
                this.loadData();
                // Ensure statsView is set before updating dashboard
                if (!this.data.currentView.statsView) {
                    this.data.currentView.statsView = 'week';
                }
                // Apply saved theme color
                if (this.data.themeColor) {
                    if (this.data.themeColor.startsWith('#')) {
                        // Custom hex color
                        this.applyCustomThemeColor(this.data.themeColor);
                    } else {
                        // Predefined theme name
                        this.applyTheme(this.data.themeColor);
                    }
                }
                this.checkWelcome();
                this.setupLogDate();
                this.updateWeightInputDisplay();
                this.addActivityRow();
                this.updateDashboard();
                this.renderCalendar();
                this.updateGoalsUI();
                this.initHabits(); // Initialize habits
                this.updatePalsUI();
                this.loadTheme();
                this.registerServiceWorker();
            },

            // Register service worker for auto-updates
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registered');
                            
                            // Check for updates every time app is opened
                            registration.update();
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }
            },

            // Check if welcome modal should show
            checkWelcome() {
                // Check if we've shown welcome today
                const today = new Date().toDateString();
                const lastShown = localStorage.getItem('lastWelcomeShown');
                
                // Show if never shown OR if it's a new calendar day
                if (!lastShown || lastShown !== today) {
                    this.showWelcome();
                }
            },

            // Show welcome modal (called by checkWelcome or info icon)
            showWelcome() {
                document.getElementById('welcome-overlay').classList.add('show');
                document.getElementById('welcome-modal').classList.add('show');
            },

            // Close welcome modal and save today's date
            closeWelcome() {
                document.getElementById('welcome-overlay').classList.remove('show');
                document.getElementById('welcome-modal').classList.remove('show');
                
                // Save today's date so we don't show again until tomorrow
                const today = new Date().toDateString();
                localStorage.setItem('lastWelcomeShown', today);
            },

            // Load data from localStorage
            loadData() {
                const saved = localStorage.getItem('justStepData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.data = { ...this.data, ...parsed };
                    // Ensure statsView exists (for users upgrading from old version)
                    if (!this.data.currentView.statsView) {
                        this.data.currentView.statsView = 'week';
                    }
                    // Ensure customDashboardCards exists (for users upgrading from v1.2.0)
                    if (!this.data.customDashboardCards) {
                        this.data.customDashboardCards = ['pushups', 'pullups', 'rollerabs'];
                    }
                    // Ensure weights array exists (for users upgrading to v1.4.0)
                    if (!this.data.weights) {
                        this.data.weights = [];
                    }
                    // Force weight unit to lbs (unit switching removed)
                    this.data.goals.weightUnit = 'lbs';
                    // Ensure initialWeight exists (for users upgrading to v1.7.0)
                    if (this.data.goals.initialWeight === undefined) {
                        this.data.goals.initialWeight = null;
                    }
                    // Ensure pals exists and friends array is preserved (for users upgrading to v1.7.0)
                    if (!this.data.pals) {
                        this.data.pals = {
                            myPalCode: '',
                            displayName: '',
                            joinedLeaderboard: false,
                            joinWeightLeaderboard: false,
                            friends: []
                        };
                    } else {
                        // Ensure required fields exist on pals (upgrade safety)
                        if (this.data.pals.myPalCode === undefined) this.data.pals.myPalCode = '';
                        if (this.data.pals.displayName === undefined) this.data.pals.displayName = '';
                        if (this.data.pals.joinedLeaderboard === undefined) this.data.pals.joinedLeaderboard = false;
                        if (this.data.pals.joinWeightLeaderboard === undefined) this.data.pals.joinWeightLeaderboard = false;
                        if (!this.data.pals.friends) this.data.pals.friends = [];
                    }
                }
            },

            // Save data to localStorage
            saveData() {
                localStorage.setItem('justStepData', JSON.stringify(this.data));
            },

            // Setup log date input (FIXED: timezone-safe)
            setupLogDate() {
                const dateInput = document.getElementById('log-date');
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            },

            // Add activity row
            addActivityRow() {
                this.activityCounter++;
                const container = document.getElementById('activities-container');
                const isFirst = this.activityCounter === 1;
                
                const activityCard = document.createElement('div');
                activityCard.className = 'activity-card';
                activityCard.id = `activity-${this.activityCounter}`;
                
                activityCard.innerHTML = `
                    <div class="activity-card-header">
                        <span class="activity-card-title">Activity ${this.activityCounter}</span>
                        <button class="remove-activity" onclick="app.removeActivity(${this.activityCounter})" ${isFirst ? 'style="visibility: hidden;"' : ''}></button>
                    </div>
                    
                    <div class="activity-accordion" id="accordion-${this.activityCounter}">
                        <!-- Cardio Category -->
                        <div class="accordion-category">
                            <div class="accordion-header" onclick="app.toggleAccordion(${this.activityCounter}, 'cardio')">
                                <div>
                                    <span class="accordion-title">Cardio</span>
                                    <span class="accordion-count">(6)</span>
                                </div>
                                <span class="accordion-arrow"></span>
                            </div>
                            <div class="accordion-content" id="accordion-${this.activityCounter}-cardio">
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'biking', 'Biking')">Biking</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'dog', 'Dog Walking')">Dog Walking</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'hiking', 'Hiking')">Hiking</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'run', 'Running')">Running</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'stairs', 'Master Stairs')">Master Stairs</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'walk', 'Walking')">Walking</div>
                            </div>
                        </div>
                        
                        <!-- Strength Category -->
                        <div class="accordion-category">
                            <div class="accordion-header" onclick="app.toggleAccordion(${this.activityCounter}, 'strength')">
                                <div>
                                    <span class="accordion-title">Strength</span>
                                    <span class="accordion-count">(7)</span>
                                </div>
                                <span class="accordion-arrow"></span>
                            </div>
                            <div class="accordion-content" id="accordion-${this.activityCounter}-strength">
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'arm', 'Arm Day')">Arm Day</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'back', 'Back Day')">Back Day</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'chest', 'Chest Day')">Chest Day</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'core', 'Core Day')">Core Day</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'fullbody', 'Full Body Day')">Full Body Day</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'leg', 'Leg Day')">Leg Day</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'shoulder', 'Shoulder Day')">Shoulder Day</div>
                            </div>
                        </div>
                        
                        <!-- Single Exercise Category -->
                        <div class="accordion-category">
                            <div class="accordion-header" onclick="app.toggleAccordion(${this.activityCounter}, 'single')">
                                <div>
                                    <span class="accordion-title">Single Exercise</span>
                                    <span class="accordion-count">(6)</span>
                                </div>
                                <span class="accordion-arrow"></span>
                            </div>
                            <div class="accordion-content" id="accordion-${this.activityCounter}-single">
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'dips', 'Dips')">Dips</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'pullups', 'Pull-ups')">Pull-ups</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'pushups', 'Push-ups')">Push-ups</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'rollerabs', 'Roller Abs')">Roller Abs</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'situps', 'Sit-ups')">Sit-ups</div>
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'squats', 'Squats')">Squats</div>
                            </div>
                        </div>
                        
                        <!-- Steps Category -->
                        <div class="accordion-category">
                            <div class="accordion-header" onclick="app.toggleAccordion(${this.activityCounter}, 'steps')">
                                <div>
                                    <span class="accordion-title">Steps</span>
                                    <span class="accordion-count">(1)</span>
                                </div>
                                <span class="accordion-arrow"></span>
                            </div>
                            <div class="accordion-content" id="accordion-${this.activityCounter}-steps-cat">
                                <div class="accordion-item" onclick="app.selectActivity(${this.activityCounter}, 'steps', 'Steps')">Steps</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="selected-activity-${this.activityCounter}" style="margin-top: 12px; font-size: 13px; color: #6b7280; display: none;">
                        <span style="display: flex; justify-content: space-between; align-items: center;">
                            <span>
                                Selected: <span id="selected-name-${this.activityCounter}" style="color: var(--primary-light); font-weight: 600;"></span>
                            </span>
                            <span style="display: flex; gap: 6px;">
                                <button onclick="app.reopenAccordion(${this.activityCounter})" style="background: none; border: 1px solid #3d3d3d; color: #9ca3af; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                                    Change
                                </button>
                                ${isFirst ? `<button onclick="app.cancelActivity(${this.activityCounter})" style="background: none; border: 1px solid #3d3d3d; color: #ef4444; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;">Cancel</button>` : ''}
                            </span>
                        </span>
                    </div>
                    
                    <div id="value-input-${this.activityCounter}">
                        <!-- Value input will be inserted here -->
                    </div>
                `;
                
                container.appendChild(activityCard);
            },

            // Toggle accordion section
            toggleAccordion(id, category) {
                const header = event.target.closest('.accordion-header');
                const content = document.getElementById(`accordion-${id}-${category === 'steps' ? 'steps-cat' : category}`);
                const allContents = document.querySelectorAll(`#accordion-${id} .accordion-content`);
                const allHeaders = document.querySelectorAll(`#accordion-${id} .accordion-header`);
                
                // Close all other sections
                allContents.forEach(c => {
                    if (c !== content) {
                        c.classList.remove('active');
                    }
                });
                allHeaders.forEach(h => {
                    if (h !== header) {
                        h.classList.remove('active');
                    }
                });
                
                // Toggle this section
                header.classList.toggle('active');
                content.classList.toggle('active');
            },

            // Select activity from accordion
            selectActivity(id, activityType, activityName) {
                // Store the selected type
                const accordion = document.getElementById(`accordion-${id}`);
                accordion.dataset.selectedType = activityType;
                
                // Update selected display
                const selectedDiv = document.getElementById(`selected-activity-${id}`);
                const selectedNameSpan = document.getElementById(`selected-name-${id}`);
                selectedDiv.style.display = 'block';
                selectedNameSpan.textContent = activityName;
                
                // Highlight selected item
                const allItems = accordion.querySelectorAll('.accordion-item');
                allItems.forEach(item => item.classList.remove('selected'));
                event.target.classList.add('selected');
                
                // Close all accordions
                const allContents = accordion.querySelectorAll('.accordion-content');
                const allHeaders = accordion.querySelectorAll('.accordion-header');
                allContents.forEach(c => c.classList.remove('active'));
                allHeaders.forEach(h => h.classList.remove('active'));
                
                // HIDE the entire accordion after selection (auto-collapse)
                accordion.style.display = 'none';
                
                // Update value inputs
                this.updateActivityInputs(id, activityType);
            },

            // Re-open accordion to change selection
            reopenAccordion(id) {
                const accordion = document.getElementById(`accordion-${id}`);
                accordion.style.display = 'block';
            },

            // Cancel activity selection (for activity 1)
            cancelActivity(id) {
                const accordion = document.getElementById(`accordion-${id}`);
                const selectedDiv = document.getElementById(`selected-activity-${id}`);
                const valueContainer = document.getElementById(`value-input-${id}`);
                
                // Clear selected type
                delete accordion.dataset.selectedType;
                
                // Hide selected display
                selectedDiv.style.display = 'none';
                
                // Clear value input
                valueContainer.innerHTML = '';
                
                // Show accordion again
                accordion.style.display = 'block';
                
                // Remove selection highlights
                const allItems = accordion.querySelectorAll('.accordion-item');
                allItems.forEach(item => item.classList.remove('selected'));
            },

            // Update activity inputs based on type
            updateActivityInputs(id, activityType) {
                const valueContainer = document.getElementById(`value-input-${id}`);
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                if (!activityType) {
                    valueContainer.innerHTML = '';
                    return;
                }
                
                // For cardio activities (distance-based)
                if (['walk', 'run', 'dog', 'hiking', 'biking'].includes(activityType)) {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" step="0.1" placeholder="0.0" id="value-${id}" inputmode="decimal" />
                            <span class="unit">${unit}</span>
                        </div>
                    `;
                }
                // For stairs (floors)
                else if (activityType === 'stairs') {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                            <span class="unit">floors</span>
                        </div>
                    `;
                }
                // For steps
                else if (activityType === 'steps') {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                            <span class="unit">steps</span>
                        </div>
                    `;
                }
                // For push-ups, pull-ups, roller abs, dips, squats, sit-ups
                else if (['pushups', 'pullups', 'rollerabs', 'dips', 'squats', 'situps'].includes(activityType)) {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                            <span class="unit">reps</span>
                        </div>
                    `;
                }
                // For workout days - no value input needed, but show nothing to avoid confusion
                else {
                    valueContainer.innerHTML = '';
                }
            },

            // Remove activity row
            removeActivity(id) {
                const activityCard = document.getElementById(`activity-${id}`);
                activityCard.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    activityCard.remove();
                }, 300);
            },

            // Save log
            saveLog() {
                const date = document.getElementById('log-date').value;
                if (!date) {
                    alert('Please select a date');
                    return;
                }

                const activities = [];
                const baseTimestamp = Date.now(); // Get timestamp once at start
                
                for (let i = 1; i <= this.activityCounter; i++) {
                    // Get type from accordion dataset (not from type-${i} element which doesn't exist)
                    const accordion = document.getElementById(`accordion-${i}`);
                    if (!accordion) continue;
                    
                    const type = accordion.dataset.selectedType;
                    if (!type) continue; // Skip if no activity selected

                    const activity = {
                        date: date,
                        type: type,
                        timestamp: new Date(baseTimestamp + i).toISOString() // Add i milliseconds to ensure uniqueness
                    };

                    // Get value for cardio and reps-based exercises
                    const valueElement = document.getElementById(`value-${i}`);
                    
                    // Define activities that REQUIRE a value
                    const requiresValue = ['walk', 'run', 'dog', 'hiking', 'biking', 'stairs', 'steps', 'pushups', 'pullups', 'rollerabs', 'dips', 'squats', 'situps'];
                    
                    if (valueElement) {
                        const value = parseFloat(valueElement.value);
                        if (value && value > 0) {
                            if (['walk', 'run', 'dog', 'hiking', 'biking'].includes(type)) {
                                // Convert to km for storage if in miles
                                activity.distance = this.data.goals.unitPreference === 'miles' ? value * 1.60934 : value;
                            } else if (type === 'stairs') {
                                activity.floors = value;
                            } else if (type === 'steps') {
                                activity.steps = value;
                            } else if (['pushups', 'pullups', 'rollerabs', 'dips', 'squats', 'situps'].includes(type)) {
                                activity.reps = value;
                            }
                        } else if (requiresValue.includes(type)) {
                            // ONLY skip if this activity type requires a value but none was entered
                            continue;
                        }
                    } else if (requiresValue.includes(type)) {
                        // No value element found, but activity requires value - skip it
                        continue;
                    }
                    // If we reach here, either:
                    // 1. Activity has a valid value, OR
                    // 2. Activity doesn't require a value (like Strength Days)

                    activities.push(activity);
                }

                if (activities.length === 0) {
                    alert('Please add at least one activity');
                    return;
                }

                // Add to data
                this.data.activities.push(...activities);
                this.saveData();

                // Sync to Firebase (PALS feature)
                this.syncMyStatsToFirebase();

                // Check for milestones
                this.checkMilestones();

                // Clear form
                document.getElementById('activities-container').innerHTML = '';
                this.activityCounter = 0;
                this.addActivityRow();

                // Update UI
                this.updateDashboard();
                this.renderCalendar();

                // Show success
                alert('Activity logged successfully!');
            },

            // Check for milestones
            checkMilestones() {
                const stats = this.calculateStats();
                const newMilestones = [];

                // Check mileage milestones (every 50)
                const milesAchieved = Math.floor(stats.totalDistance / 50) * 50;
                const lastMilageMilestone = this.data.milestones.filter(m => m.type === 'mileage').reduce((max, m) => Math.max(max, m.value), 0);
                
                if (milesAchieved > lastMilageMilestone && milesAchieved > 0) {
                    const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                    newMilestones.push({
                        type: 'mileage',
                        value: milesAchieved,
                        date: new Date().toISOString(),
                        icon: '',
                        title: `${milesAchieved} ${unit} Reached!`,
                        description: `You've logged ${milesAchieved} ${unit}. Keep up the great work!`
                    });
                }

                // Check strength day milestones (every 25 days)
                const strengthDaysAchieved = Math.floor(stats.totalStrengthDays / 25) * 25;
                const lastStrengthDayMilestone = this.data.milestones.filter(m => m.type === 'workout').reduce((max, m) => Math.max(max, m.value), 0);
                
                if (strengthDaysAchieved > lastStrengthDayMilestone && strengthDaysAchieved > 0) {
                    newMilestones.push({
                        type: 'workout',
                        value: strengthDaysAchieved,
                        date: new Date().toISOString(),
                        icon: '',
                        title: `${strengthDaysAchieved} Strength Days Completed!`,
                        description: `Amazing consistency! You've trained on ${strengthDaysAchieved} different days.`
                    });
                }

                // Add new milestones and show notification
                if (newMilestones.length > 0) {
                    this.data.milestones.push(...newMilestones);
                    this.saveData();
                    this.showMilestone(newMilestones[0]);
                }
            },

            // Show milestone notification
            showMilestone(milestone) {
                document.getElementById('milestone-icon').textContent = milestone.icon;
                document.getElementById('milestone-title').textContent = milestone.title;
                document.getElementById('milestone-description').textContent = milestone.description;
                document.getElementById('overlay').classList.add('show');
                document.getElementById('milestone-notification').classList.add('show');
            },

            // Close milestone
            closeMilestone() {
                document.getElementById('overlay').classList.remove('show');
                document.getElementById('milestone-notification').classList.remove('show');
            },

            // Calculate stats
            calculateStats() {
                const now = new Date();
                now.setHours(23, 59, 59, 999); // Set to end of today for comparisons
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                
                // ============================================
                // DATE PERIOD DEFINITIONS (v1.5.2)
                // ============================================
                
                // THIS CALENDAR WEEK (Sunday - Today)
                // For display: "This Week" toggle shows current calendar week progress
                const thisWeekStart = new Date(now);
                thisWeekStart.setDate(now.getDate() - now.getDay()); // This Sunday at midnight
                thisWeekStart.setHours(0, 0, 0, 0);
                
                // PREVIOUS CALENDAR WEEK (Last Sunday - Last Saturday)
                // For trending: Compare this week vs same full previous week
                const prevWeekStart = new Date(thisWeekStart);
                prevWeekStart.setDate(prevWeekStart.getDate() - 7); // Previous Sunday
                prevWeekStart.setHours(0, 0, 0, 0);
                
                const prevWeekEnd = new Date(thisWeekStart);
                prevWeekEnd.setDate(prevWeekEnd.getDate() - 1); // Last Saturday
                prevWeekEnd.setHours(23, 59, 59, 999);
                
                // ============================================
                // TRACKING VARIABLES
                // ============================================
                
                // Total (all-time)
                let totalDistance = 0;
                let totalSteps = 0;
                let totalPushups = 0;
                let totalPullups = 0;
                let totalRollerAbs = 0;
                let totalDips = 0;
                let totalSquats = 0;
                let totalSitups = 0;
                let totalBiking = 0;
                let totalDogWalk = 0;
                let totalHiking = 0;
                let totalRunning = 0;
                let totalWalking = 0;
                let totalStairs = 0;
                
                // This calendar week (for display)
                let thisWeekDistance = 0;
                let thisWeekSteps = 0;
                let thisWeekPushups = 0;
                let thisWeekPullups = 0;
                let thisWeekRollerAbs = 0;
                let thisWeekDips = 0;
                let thisWeekSquats = 0;
                let thisWeekSitups = 0;
                let thisWeekBiking = 0;
                let thisWeekDogWalk = 0;
                let thisWeekHiking = 0;
                let thisWeekRunning = 0;
                let thisWeekWalking = 0;
                let thisWeekStairs = 0;
                
                // Previous calendar week (for trending comparison)
                let prevWeekDistance = 0;
                let prevWeekSteps = 0;
                let prevWeekPushups = 0;
                let prevWeekPullups = 0;
                let prevWeekRollerAbs = 0;
                let prevWeekDips = 0;
                let prevWeekSquats = 0;
                let prevWeekSitups = 0;
                let prevWeekBiking = 0;
                let prevWeekDogWalk = 0;
                let prevWeekHiking = 0;
                let prevWeekRunning = 0;
                let prevWeekWalking = 0;
                let prevWeekStairs = 0;
                
                // Track unique strength days (Sets are better for counting unique days)
                let strengthDaysTotal = new Set();
                let strengthDaysThisWeek = new Set();
                let strengthDaysPrevWeek = new Set();

                // ============================================
                // PROCESS ALL ACTIVITIES
                // ============================================
                this.data.activities.forEach(activity => {
                    // Parse date at noon to avoid timezone issues
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    
                    // Check which periods this activity belongs to
                    const isThisWeek = activityDate >= thisWeekStart && activityDate <= now;
                    const isPrevWeek = activityDate >= prevWeekStart && activityDate <= prevWeekEnd;
                    
                    // ========== DISTANCE ACTIVITIES ==========
                    if (activity.distance) {
                        totalDistance += activity.distance;
                        if (isThisWeek) thisWeekDistance += activity.distance;
                        if (isPrevWeek) prevWeekDistance += activity.distance;
                        
                        // Track by specific distance type
                        if (activity.type === 'biking') {
                            totalBiking += activity.distance;
                            if (isThisWeek) thisWeekBiking += activity.distance;
                            if (isPrevWeek) prevWeekBiking += activity.distance;
                        } else if (activity.type === 'dog') {
                            totalDogWalk += activity.distance;
                            if (isThisWeek) thisWeekDogWalk += activity.distance;
                            if (isPrevWeek) prevWeekDogWalk += activity.distance;
                        } else if (activity.type === 'hiking') {
                            totalHiking += activity.distance;
                            if (isThisWeek) thisWeekHiking += activity.distance;
                            if (isPrevWeek) prevWeekHiking += activity.distance;
                        } else if (activity.type === 'run') {
                            totalRunning += activity.distance;
                            if (isThisWeek) thisWeekRunning += activity.distance;
                            if (isPrevWeek) prevWeekRunning += activity.distance;
                        } else if (activity.type === 'walk') {
                            totalWalking += activity.distance;
                            if (isThisWeek) thisWeekWalking += activity.distance;
                            if (isPrevWeek) prevWeekWalking += activity.distance;
                        }
                    }

                    // ========== STAIRS (FLOORS) ==========
                    if (activity.floors) {
                        totalStairs += activity.floors;
                        if (isThisWeek) thisWeekStairs += activity.floors;
                        if (isPrevWeek) prevWeekStairs += activity.floors;
                    }

                    // ========== STEPS ==========
                    if (activity.steps) {
                        totalSteps += activity.steps;
                        if (isThisWeek) thisWeekSteps += activity.steps;
                        if (isPrevWeek) prevWeekSteps += activity.steps;
                    }

                    // ========== REPS (EXERCISES) ==========
                    if (activity.reps) {
                        if (activity.type === 'pushups') {
                            totalPushups += activity.reps;
                            if (isThisWeek) thisWeekPushups += activity.reps;
                            if (isPrevWeek) prevWeekPushups += activity.reps;
                        } else if (activity.type === 'pullups') {
                            totalPullups += activity.reps;
                            if (isThisWeek) thisWeekPullups += activity.reps;
                            if (isPrevWeek) prevWeekPullups += activity.reps;
                        } else if (activity.type === 'rollerabs') {
                            totalRollerAbs += activity.reps;
                            if (isThisWeek) thisWeekRollerAbs += activity.reps;
                            if (isPrevWeek) prevWeekRollerAbs += activity.reps;
                        } else if (activity.type === 'dips') {
                            totalDips += activity.reps;
                            if (isThisWeek) thisWeekDips += activity.reps;
                            if (isPrevWeek) prevWeekDips += activity.reps;
                        } else if (activity.type === 'squats') {
                            totalSquats += activity.reps;
                            if (isThisWeek) thisWeekSquats += activity.reps;
                            if (isPrevWeek) prevWeekSquats += activity.reps;
                        } else if (activity.type === 'situps') {
                            totalSitups += activity.reps;
                            if (isThisWeek) thisWeekSitups += activity.reps;
                            if (isPrevWeek) prevWeekSitups += activity.reps;
                        }
                    }

                    // ========== STRENGTH DAYS ==========
                    if (['arm', 'back', 'chest', 'core', 'fullbody', 'leg', 'shoulder'].includes(activity.type)) {
                        strengthDaysTotal.add(activity.date);
                        if (isThisWeek) strengthDaysThisWeek.add(activity.date);
                        if (isPrevWeek) strengthDaysPrevWeek.add(activity.date);
                    }
                });

                // ============================================
                // CONVERT KM TO MILES (if needed)
                // ============================================
                if (this.data.goals.unitPreference === 'miles') {
                    const KM_TO_MILES = 1.60934;
                    
                    // Total
                    totalDistance = totalDistance / KM_TO_MILES;
                    totalBiking = totalBiking / KM_TO_MILES;
                    totalDogWalk = totalDogWalk / KM_TO_MILES;
                    totalHiking = totalHiking / KM_TO_MILES;
                    totalRunning = totalRunning / KM_TO_MILES;
                    totalWalking = totalWalking / KM_TO_MILES;
                    
                    // This Week
                    thisWeekDistance = thisWeekDistance / KM_TO_MILES;
                    thisWeekBiking = thisWeekBiking / KM_TO_MILES;
                    thisWeekDogWalk = thisWeekDogWalk / KM_TO_MILES;
                    thisWeekHiking = thisWeekHiking / KM_TO_MILES;
                    thisWeekRunning = thisWeekRunning / KM_TO_MILES;
                    thisWeekWalking = thisWeekWalking / KM_TO_MILES;
                    
                    // Previous Week
                    prevWeekDistance = prevWeekDistance / KM_TO_MILES;
                    prevWeekBiking = prevWeekBiking / KM_TO_MILES;
                    prevWeekDogWalk = prevWeekDogWalk / KM_TO_MILES;
                    prevWeekHiking = prevWeekHiking / KM_TO_MILES;
                    prevWeekRunning = prevWeekRunning / KM_TO_MILES;
                    prevWeekWalking = prevWeekWalking / KM_TO_MILES;
                }

                // ============================================
                // RETURN ALL CALCULATED STATS
                // ============================================
                return {
                    // Distance (rounded to 1 decimal)
                    totalDistance: Math.round(totalDistance * 10) / 10,
                    thisWeekDistance: Math.round(thisWeekDistance * 10) / 10,
                    prevWeekDistance: Math.round(prevWeekDistance * 10) / 10,
                    
                    // Steps (whole numbers)
                    totalSteps,
                    thisWeekSteps,
                    prevWeekSteps,
                    
                    // Exercises - Reps (whole numbers)
                    totalPushups,
                    thisWeekPushups,
                    prevWeekPushups,
                    totalPullups,
                    thisWeekPullups,
                    prevWeekPullups,
                    totalRollerAbs,
                    thisWeekRollerAbs,
                    prevWeekRollerAbs,
                    totalDips,
                    thisWeekDips,
                    prevWeekDips,
                    totalSquats,
                    thisWeekSquats,
                    prevWeekSquats,
                    totalSitups,
                    thisWeekSitups,
                    prevWeekSitups,
                    
                    // Distance by Type (rounded to 1 decimal)
                    totalBiking: Math.round(totalBiking * 10) / 10,
                    thisWeekBiking: Math.round(thisWeekBiking * 10) / 10,
                    prevWeekBiking: Math.round(prevWeekBiking * 10) / 10,
                    totalDogWalk: Math.round(totalDogWalk * 10) / 10,
                    thisWeekDogWalk: Math.round(thisWeekDogWalk * 10) / 10,
                    prevWeekDogWalk: Math.round(prevWeekDogWalk * 10) / 10,
                    totalHiking: Math.round(totalHiking * 10) / 10,
                    thisWeekHiking: Math.round(thisWeekHiking * 10) / 10,
                    prevWeekHiking: Math.round(prevWeekHiking * 10) / 10,
                    totalRunning: Math.round(totalRunning * 10) / 10,
                    thisWeekRunning: Math.round(thisWeekRunning * 10) / 10,
                    prevWeekRunning: Math.round(prevWeekRunning * 10) / 10,
                    totalWalking: Math.round(totalWalking * 10) / 10,
                    thisWeekWalking: Math.round(thisWeekWalking * 10) / 10,
                    prevWeekWalking: Math.round(prevWeekWalking * 10) / 10,
                    
                    // Stairs (whole numbers)
                    totalStairs,
                    thisWeekStairs,
                    prevWeekStairs,
                    
                    // Strength Days (count of unique days)
                    totalStrengthDays: strengthDaysTotal.size,
                    thisWeekStrengthDays: strengthDaysThisWeek.size,
                    prevWeekStrengthDays: strengthDaysPrevWeek.size,
                    
                    // Weight data
                    currentWeight: this.getWeightStats().current
                };
            },

            // Update dashboard (FIXED: toggle buttons sync with data + custom cards)
            updateDashboard() {
                const stats = this.calculateStats();
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                const isWeekView = this.data.currentView.statsView === 'week';
                
                // FIX: Update toggle buttons to match current view
                document.querySelectorAll('.stats-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (isWeekView) {
                    document.querySelector('.stats-toggle-btn:first-child').classList.add('active');
                } else {
                    document.querySelector('.stats-toggle-btn:last-child').classList.add('active');
                }

                // ========== FIXED CARDS (Miles, Strength Days, Steps) ==========
                const milesValue = isWeekView ? stats.thisWeekDistance : stats.totalDistance;
                const workoutsValue = isWeekView ? stats.thisWeekStrengthDays : stats.totalStrengthDays;
                const stepsValue = isWeekView ? stats.thisWeekSteps : stats.totalSteps;
                
                // Animate numbers
                this.animateCountUp(document.getElementById('stat-miles'), milesValue);
                this.animateCountUp(document.getElementById('stat-workouts'), workoutsValue);
                this.animateCountUp(document.getElementById('stat-steps'), stepsValue);

                // ========== TRENDING ARROWS (Week View Only) ==========
                if (isWeekView) {
                    // v1.5.2: Compare THIS WEEK vs PREVIOUS CALENDAR WEEK
                    // Only show arrow if current value > 0
                    const milesTrend = milesValue > 0 ? this.getTrendIndicator(milesValue, stats.prevWeekDistance) : '';
                    const workoutsTrend = workoutsValue > 0 ? this.getTrendIndicator(workoutsValue, stats.prevWeekStrengthDays) : '';
                    const stepsTrend = stepsValue > 0 ? this.getTrendIndicator(stepsValue, stats.prevWeekSteps) : '';
                    
                    document.getElementById('stat-miles-label').textContent = unit;
                    document.getElementById('stat-workouts-label').textContent = 'Strength Days';
                    document.getElementById('stat-steps-label').textContent = 'Steps';
                    
                    document.getElementById('stat-miles-trend').innerHTML = milesTrend;
                    document.getElementById('stat-workouts-trend').innerHTML = workoutsTrend;
                    document.getElementById('stat-steps-trend').innerHTML = stepsTrend;
                } else {
                    // All Time view: No trends
                    document.getElementById('stat-miles-label').textContent = unit;
                    document.getElementById('stat-workouts-label').textContent = 'Strength Days';
                    document.getElementById('stat-steps-label').textContent = 'Steps';
                    
                    document.getElementById('stat-miles-trend').innerHTML = '';
                    document.getElementById('stat-workouts-trend').innerHTML = '';
                    document.getElementById('stat-steps-trend').innerHTML = '';
                }

                // ROW 2: Update custom cards based on user preferences
                this.renderCustomCards(stats, isWeekView);

                // Render comparison bar graphs
                this.renderBarGraphs(stats);

                // Update weight summary
                this.updateWeightSummary();

                // Annual progress (always total)
                const annualGoal = this.data.goals.annualMiles;
                const progress = Math.min(100, Math.round((stats.totalDistance / annualGoal) * 100));
                document.getElementById('annual-progress-percent').textContent = `${progress}%`;
                document.getElementById('annual-progress-bar').style.width = `${progress}%`;
                document.getElementById('annual-progress-current').textContent = `${stats.totalDistance} ${unit}`;
                document.getElementById('annual-progress-goal').textContent = `${annualGoal} ${unit}`;

                // Recent milestones
                const milestoneList = document.getElementById('milestone-list');
                if (this.data.milestones.length === 0) {
                    milestoneList.innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 14px;">No milestones yet. Keep going!</p>';
                } else {
                    const recentMilestones = this.data.milestones.slice(-5).reverse();
                    milestoneList.innerHTML = recentMilestones.map(m => `
                        <div class="milestone-item">
                            <div class="milestone-icon">${m.icon}</div>
                            <div class="milestone-text">${m.title}</div>
                        </div>
                    `).join('');
                }
            },

            // Render custom dashboard cards (Row 2)
            renderCustomCards(stats, isWeekView) {
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                // v1.5.2: Map stat names to their values (thisWeek for display, prevWeek for trending)
                const statMap = {
                    // Rep-based exercises
                    'pushups': {
                        label: 'Push-ups',
                        thisWeekValue: stats.thisWeekPushups,
                        prevWeekValue: stats.prevWeekPushups,
                        totalValue: stats.totalPushups
                    },
                    'pullups': {
                        label: 'Pull-ups',
                        thisWeekValue: stats.thisWeekPullups,
                        prevWeekValue: stats.prevWeekPullups,
                        totalValue: stats.totalPullups
                    },
                    'rollerabs': {
                        label: 'Roller Abs',
                        thisWeekValue: stats.thisWeekRollerAbs,
                        prevWeekValue: stats.prevWeekRollerAbs,
                        totalValue: stats.totalRollerAbs
                    },
                    'dips': {
                        label: 'Dips',
                        thisWeekValue: stats.thisWeekDips,
                        prevWeekValue: stats.prevWeekDips,
                        totalValue: stats.totalDips
                    },
                    'squats': {
                        label: 'Squats',
                        thisWeekValue: stats.thisWeekSquats,
                        prevWeekValue: stats.prevWeekSquats,
                        totalValue: stats.totalSquats
                    },
                    'situps': {
                        label: 'Sit-ups',
                        thisWeekValue: stats.thisWeekSitups,
                        prevWeekValue: stats.prevWeekSitups,
                        totalValue: stats.totalSitups
                    },
                    // Distance-based activities
                    'biking': {
                        label: `Biking (${unit})`,
                        thisWeekValue: stats.thisWeekBiking,
                        prevWeekValue: stats.prevWeekBiking,
                        totalValue: stats.totalBiking
                    },
                    'dog': {
                        label: `Dog Walking (${unit})`,
                        thisWeekValue: stats.thisWeekDogWalk,
                        prevWeekValue: stats.prevWeekDogWalk,
                        totalValue: stats.totalDogWalk
                    },
                    'hiking': {
                        label: `Hiking (${unit})`,
                        thisWeekValue: stats.thisWeekHiking,
                        prevWeekValue: stats.prevWeekHiking,
                        totalValue: stats.totalHiking
                    },
                    'run': {
                        label: `Running (${unit})`,
                        thisWeekValue: stats.thisWeekRunning,
                        prevWeekValue: stats.prevWeekRunning,
                        totalValue: stats.totalRunning
                    },
                    'walk': {
                        label: `Walking (${unit})`,
                        thisWeekValue: stats.thisWeekWalking,
                        prevWeekValue: stats.prevWeekWalking,
                        totalValue: stats.totalWalking
                    },
                    'stairs': {
                        label: 'Stairs (floors)',
                        thisWeekValue: stats.thisWeekStairs,
                        prevWeekValue: stats.prevWeekStairs,
                        totalValue: stats.totalStairs
                    },
                    // Weight tracking (special case)
                    'weight': {
                        label: 'Weight (lbs)',
                        thisWeekValue: stats.currentWeight || 0,
                        prevWeekValue: 0, // Weight uses its own trend logic
                        totalValue: stats.currentWeight || 0
                    }
                };

                // ========== RENDER EACH CUSTOM CARD ==========
                for (let i = 0; i < 3; i++) {
                    const cardType = this.data.customDashboardCards[i];
                    const cardData = statMap[cardType];
                    
                    if (cardData) {
                        // Display value: this week or all time
                        const value = isWeekView ? cardData.thisWeekValue : cardData.totalValue;
                        const element = document.getElementById(`custom-stat-${i + 1}`);
                        const labelElement = document.getElementById(`custom-label-${i + 1}`);
                        const trendElement = document.getElementById(`custom-trend-${i + 1}`);
                        
                        // Animate the display value
                        this.animateCountUp(element, value);
                        
                        // Set label
                        labelElement.textContent = cardData.label;
                        
                        // ========== TRENDING (Week View Only) ==========
                        if (isWeekView) {
                            // Special handling for weight card
                            if (cardType === 'weight' && value > 0) {
                                const weightStats = this.getWeightStats();
                                let trendHTML = '';
                                if (weightStats.trend === 'up') {
                                    trendHTML = '<span class="trend-indicator up" style="font-size: 10px;"></span>';
                                } else if (weightStats.trend === 'down') {
                                    trendHTML = '<span class="trend-indicator down" style="font-size: 10px;"></span>';
                                } else if (weightStats.trend === 'stable') {
                                    trendHTML = '<span class="trend-indicator stable" style="font-size: 10px;"></span>';
                                }
                                trendElement.innerHTML = trendHTML;
                            } else {
                                // v1.5.2: Compare THIS WEEK vs PREVIOUS WEEK
                                const trendHTML = value > 0 ? this.getTrendIndicator(value, cardData.prevWeekValue) : '';
                                trendElement.innerHTML = trendHTML;
                            }
                        } else {
                            // All Time view: No trends
                            trendElement.innerHTML = '';
                        }
                    }
                }
            },

            // Open customize modal
            openCustomizeModal() {
                // Set current selections in dropdowns
                for (let i = 0; i < 3; i++) {
                    const select = document.getElementById(`custom-slot-${i + 1}`);
                    select.value = this.data.customDashboardCards[i];
                }
                
                document.getElementById('customize-overlay').classList.add('show');
                document.getElementById('customize-modal').classList.add('show');
            },

            // Close customize modal
            closeCustomizeModal() {
                document.getElementById('customize-overlay').classList.remove('show');
                document.getElementById('customize-modal').classList.remove('show');
            },

            // Save custom cards preferences
            saveCustomCards() {
                const slot1 = document.getElementById('custom-slot-1').value;
                const slot2 = document.getElementById('custom-slot-2').value;
                const slot3 = document.getElementById('custom-slot-3').value;

                // Validation: Check for duplicates
                const selections = [slot1, slot2, slot3];
                const uniqueSelections = new Set(selections);
                
                if (uniqueSelections.size !== 3) {
                    alert('Please select 3 different stats for your dashboard cards.');
                    return;
                }

                // Save preferences
                this.data.customDashboardCards = selections;
                this.saveData();

                // Update dashboard
                this.updateDashboard();

                // Close modal
                this.closeCustomizeModal();
            },

            // Set stats view (week or total)
            setStatsView(view) {
                this.data.currentView.statsView = view;
                
                // Update toggle buttons
                document.querySelectorAll('.stats-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Refresh dashboard
                this.updateDashboard();
            },

            // Render calendar
            renderCalendar() {
                const year = this.data.currentView.calendarYear;
                const month = this.data.currentView.calendarMonth;
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                
                document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const prevLastDay = new Date(year, month, 0);
                
                const firstDayOfWeek = firstDay.getDay();
                const daysInMonth = lastDay.getDate();
                const daysInPrevMonth = prevLastDay.getDate();

                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = `
                    <div class="calendar-day-label">Sun</div>
                    <div class="calendar-day-label">Mon</div>
                    <div class="calendar-day-label">Tue</div>
                    <div class="calendar-day-label">Wed</div>
                    <div class="calendar-day-label">Thu</div>
                    <div class="calendar-day-label">Fri</div>
                    <div class="calendar-day-label">Sat</div>
                `;

                // Previous month days
                for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                    const day = daysInPrevMonth - i;
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.textContent = day;
                    grid.appendChild(dayDiv);
                }

                // Current month days
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const activities = this.data.activities.filter(a => a.date === date);
                    
                    // Get habits for this date
                    const completedHabits = this.getHabitsForDate(date);
                    const habitChecks = completedHabits.length > 0 
                        ? completedHabits.map(h => `<span style="color: ${h.color || '#10b981'};"></span>`).join('')
                        : '';
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.style.cursor = 'pointer';
                    dayDiv.onclick = () => this.showDayDetail(date);
                    
                    if (activities.length > 0) {
                        dayDiv.classList.add('has-activity');
                    }
                    
                    if (today.getDate() === day && today.getMonth() === month && today.getFullYear() === year) {
                        dayDiv.classList.add('today');
                    }
                    
                    dayDiv.innerHTML = `
                        ${habitChecks ? `<div class="habit-checks">${habitChecks}</div>` : ''}
                        ${day}
                        ${activities.length > 0 ? `
                            <div class="activity-dots">
                                ${activities.slice(0, 4).map(() => '<div class="activity-dot"></div>').join('')}
                            </div>
                        ` : ''}
                    `;
                    
                    grid.appendChild(dayDiv);
                }

                // Next month days
                const remainingDays = 42 - (firstDayOfWeek + daysInMonth);
                for (let day = 1; day <= remainingDays; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.textContent = day;
                    grid.appendChild(dayDiv);
                }

                // Render activity summary
                this.renderActivitySummary();
            },

            // Toggle activity report expand/collapse
            toggleActivityReport() {
                const content = document.getElementById('activity-report-content');
                const toggle = document.getElementById('activity-report-toggle');
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggle.querySelector('span:last-child').textContent = '';
                } else {
                    content.classList.add('expanded');
                    toggle.querySelector('span:last-child').textContent = '';
                }
            },

            // Render activity summary for calendar screen (month + all-time)
            renderActivitySummary() {
                const summaryList = document.getElementById('activity-summary-list');
                const stats = this.calculateStats();
                const monthStats = this.calculateMonthStats();
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                const summaryItems = [];
                
                // Helper to add item with week, month and total
                const addItem = (name, weekValue, monthValue, totalValue, suffix) => {
                    if (totalValue > 0) {
                        summaryItems.push({
                            name,
                            week: weekValue > 0 ? `${weekValue.toLocaleString()}${suffix}` : '-',
                            month: monthValue > 0 ? `${monthValue.toLocaleString()}${suffix}` : '-',
                            total: `${totalValue.toLocaleString()}${suffix}`
                        });
                    }
                };
                
                // Strength exercises
                addItem('Push-ups', stats.thisWeekPushups, monthStats.monthPushups, stats.totalPushups, ' reps');
                addItem('Pull-ups', stats.thisWeekPullups, monthStats.monthPullups, stats.totalPullups, ' reps');
                addItem('Roller Abs', stats.thisWeekRollerAbs, monthStats.monthRollerAbs, stats.totalRollerAbs, ' reps');
                addItem('Dips', stats.thisWeekDips, monthStats.monthDips, stats.totalDips, ' reps');
                addItem('Squats', stats.thisWeekSquats, monthStats.monthSquats, stats.totalSquats, ' reps');
                addItem('Sit-ups', stats.thisWeekSitups, monthStats.monthSitups, stats.totalSitups, ' reps');
                
                // Cardio activities
                if (stats.totalRunning > 0) {
                    summaryItems.push({
                        name: 'Running',
                        week: stats.thisWeekRunning > 0 ? `${stats.thisWeekRunning} ${unit}` : '-',
                        month: monthStats.monthRunning > 0 ? `${monthStats.monthRunning} ${unit}` : '-',
                        total: `${stats.totalRunning} ${unit}`
                    });
                }
                if (stats.totalWalking > 0) {
                    summaryItems.push({
                        name: 'Walking',
                        week: stats.thisWeekWalking > 0 ? `${stats.thisWeekWalking} ${unit}` : '-',
                        month: monthStats.monthWalking > 0 ? `${monthStats.monthWalking} ${unit}` : '-',
                        total: `${stats.totalWalking} ${unit}`
                    });
                }
                if (stats.totalBiking > 0) {
                    summaryItems.push({
                        name: 'Biking',
                        week: stats.thisWeekBiking > 0 ? `${stats.thisWeekBiking} ${unit}` : '-',
                        month: monthStats.monthBiking > 0 ? `${monthStats.monthBiking} ${unit}` : '-',
                        total: `${stats.totalBiking} ${unit}`
                    });
                }
                if (stats.totalDogWalk > 0) {
                    summaryItems.push({
                        name: 'Dog Walking',
                        week: stats.thisWeekDogWalk > 0 ? `${stats.thisWeekDogWalk} ${unit}` : '-',
                        month: monthStats.monthDogWalk > 0 ? `${monthStats.monthDogWalk} ${unit}` : '-',
                        total: `${stats.totalDogWalk} ${unit}`
                    });
                }
                if (stats.totalHiking > 0) {
                    summaryItems.push({
                        name: 'Hiking',
                        week: stats.thisWeekHiking > 0 ? `${stats.thisWeekHiking} ${unit}` : '-',
                        month: monthStats.monthHiking > 0 ? `${monthStats.monthHiking} ${unit}` : '-',
                        total: `${stats.totalHiking} ${unit}`
                    });
                }
                
                // Other
                addItem('Stairs', stats.thisWeekStairs, monthStats.monthStairs, stats.totalStairs, ' floors');
                addItem('Steps', stats.thisWeekSteps, monthStats.monthSteps, stats.totalSteps, '');
                
                // Totals
                addItem('Strength Days', stats.thisWeekStrengthDays, monthStats.monthStrengthDays, stats.totalStrengthDays, ' days');
                if (stats.totalDistance > 0) {
                    summaryItems.push({
                        name: 'Total Distance',
                        week: stats.thisWeekDistance > 0 ? `${stats.thisWeekDistance} ${unit}` : '-',
                        month: monthStats.monthDistance > 0 ? `${monthStats.monthDistance} ${unit}` : '-',
                        total: `${stats.totalDistance} ${unit}`
                    });
                }
                
                if (summaryItems.length === 0) {
                    summaryList.innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 14px; padding: 20px 0;">No activities logged yet.</p>';
                } else {
                    // Header row
                    let html = `
                        <div class="activity-summary-item" style="font-weight: 700; color: #9ca3af; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #3d3d3d;">
                            <div>Activity</div>
                            <div class="activity-summary-value week">Week</div>
                            <div class="activity-summary-value month">Month</div>
                            <div class="activity-summary-value total">All-Time</div>
                        </div>
                    `;
                    
                    // Data rows
                    html += summaryItems.map(item => `
                        <div class="activity-summary-item">
                            <div class="activity-summary-name">${item.name}</div>
                            <div class="activity-summary-value week">${item.week}</div>
                            <div class="activity-summary-value month">${item.month}</div>
                            <div class="activity-summary-value total">${item.total}</div>
                        </div>
                    `).join('');
                    
                    summaryList.innerHTML = html;
                }
            },

            // Calculate month-to-date stats
            calculateMonthStats() {
                const now = new Date();
                now.setHours(23, 59, 59, 999); // Set to end of today for comparisons
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                startOfMonth.setHours(0, 0, 0, 0);
                
                let monthDistance = 0;
                let monthPushups = 0;
                let monthPullups = 0;
                let monthRollerAbs = 0;
                let monthDips = 0;
                let monthSquats = 0;
                let monthSitups = 0;
                let monthBiking = 0;
                let monthDogWalk = 0;
                let monthHiking = 0;
                let monthRunning = 0;
                let monthWalking = 0;
                let monthStairs = 0;
                let monthSteps = 0;
                let monthStrengthDays = new Set();
                
                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    const isThisMonth = activityDate >= startOfMonth && activityDate <= now;
                    
                    if (isThisMonth) {
                        // Distance
                        if (activity.distance) {
                            monthDistance += activity.distance;
                            if (activity.type === 'biking') monthBiking += activity.distance;
                            else if (activity.type === 'dog') monthDogWalk += activity.distance;
                            else if (activity.type === 'hiking') monthHiking += activity.distance;
                            else if (activity.type === 'run') monthRunning += activity.distance;
                            else if (activity.type === 'walk') monthWalking += activity.distance;
                        }
                        
                        // Stairs and Steps
                        if (activity.floors) monthStairs += activity.floors;
                        if (activity.steps) monthSteps += activity.steps;
                        
                        // Reps
                        if (activity.reps) {
                            if (activity.type === 'pushups') monthPushups += activity.reps;
                            else if (activity.type === 'pullups') monthPullups += activity.reps;
                            else if (activity.type === 'rollerabs') monthRollerAbs += activity.reps;
                            else if (activity.type === 'dips') monthDips += activity.reps;
                            else if (activity.type === 'squats') monthSquats += activity.reps;
                            else if (activity.type === 'situps') monthSitups += activity.reps;
                        }
                        
                        // Strength days
                        if (['arm', 'back', 'chest', 'core', 'fullbody', 'leg', 'shoulder'].includes(activity.type)) {
                            monthStrengthDays.add(activity.date);
                        }
                    }
                });
                
                // Convert distances to preferred unit
                if (this.data.goals.unitPreference === 'miles') {
                    monthDistance = monthDistance / 1.60934;
                    monthBiking = monthBiking / 1.60934;
                    monthDogWalk = monthDogWalk / 1.60934;
                    monthHiking = monthHiking / 1.60934;
                    monthRunning = monthRunning / 1.60934;
                    monthWalking = monthWalking / 1.60934;
                }
                
                return {
                    monthDistance: Math.round(monthDistance * 10) / 10,
                    monthPushups,
                    monthPullups,
                    monthRollerAbs,
                    monthDips,
                    monthSquats,
                    monthSitups,
                    monthBiking: Math.round(monthBiking * 10) / 10,
                    monthDogWalk: Math.round(monthDogWalk * 10) / 10,
                    monthHiking: Math.round(monthHiking * 10) / 10,
                    monthRunning: Math.round(monthRunning * 10) / 10,
                    monthWalking: Math.round(monthWalking * 10) / 10,
                    monthStairs,
                    monthSteps,
                    monthStrengthDays: monthStrengthDays.size
                };
            },

            // Change calendar month
            changeMonth(delta) {
                this.data.currentView.calendarMonth += delta;
                if (this.data.currentView.calendarMonth > 11) {
                    this.data.currentView.calendarMonth = 0;
                    this.data.currentView.calendarYear++;
                } else if (this.data.currentView.calendarMonth < 0) {
                    this.data.currentView.calendarMonth = 11;
                    this.data.currentView.calendarYear--;
                }
                this.renderCalendar();
            },

            // Update goals UI
            updateGoalsUI() {
                document.getElementById('unit-preference').value = this.data.goals.unitPreference;
const initialWeightEl = document.getElementById('initial-weight-preference');
                if (initialWeightEl) {
                    initialWeightEl.value = (this.data.goals.initialWeight !== null && this.data.goals.initialWeight !== undefined) ? this.data.goals.initialWeight : '';
                }
                document.getElementById('annual-goal').value = this.data.goals.annualMiles;
                document.getElementById('workout-frequency').value = this.data.goals.workoutFrequency;
                document.getElementById('monthly-goal').value = this.data.goals.monthlyMiles;
                
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                document.getElementById('milestone-unit').textContent = unit;
            },

            // Save goals
            saveGoals() {
                const oldUnit = this.data.goals.unitPreference;
                const newUnit = document.getElementById('unit-preference').value;
                
                this.data.goals.unitPreference = newUnit;
const initialWeightInput = document.getElementById('initial-weight-preference');
                if (initialWeightInput) {
                    const v = parseFloat(initialWeightInput.value);
                    this.data.goals.initialWeight = (!isNaN(v) && v > 0) ? v : null;
                }
                this.data.goals.annualMiles = parseInt(document.getElementById('annual-goal').value);
                this.data.goals.workoutFrequency = parseInt(document.getElementById('workout-frequency').value);
                this.data.goals.monthlyMiles = parseInt(document.getElementById('monthly-goal').value);
                
                // Save habit changes from edit mode
                this.data.habits.forEach(habit => {
                    const nameInput = document.getElementById(`habit-name-${habit.id}`);
                    const colorInput = document.getElementById(`habit-color-${habit.id}`);
                    
                    if (nameInput) {
                        habit.name = nameInput.value;
                    }
                    
                    if (colorInput) {
                        habit.color = colorInput.value;
                    }
                });
                
                this.saveData();
                this.updateGoalsUI();
                this.updateWeightInputDisplay();
                this.updateDashboard();
                this.renderHabits(); // Re-render to return to display mode
                
                const successMsg = document.getElementById('settings-success');
                successMsg.classList.add('show');
                setTimeout(() => {
                    successMsg.classList.remove('show');
                }, 3000);
            },

            // Export data
            exportData() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `juststep-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            },

            // Handle import file selection
            handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        this.importData(importedData);
                    } catch (error) {
                        alert('Error reading file. Please make sure it\'s a valid JustStep export file.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
                
                // Reset file input so same file can be imported again
                event.target.value = '';
            },

            // Import and merge data
            importData(importedData) {
                // Validate data structure
                if (!importedData || !importedData.activities || !Array.isArray(importedData.activities)) {
                    alert('Invalid data file. Please export from JustStep and try again.');
                    return;
                }

                let newActivities = 0;
                let duplicates = 0;

                // Merge activities (skip duplicates based on date + type + timestamp)
                importedData.activities.forEach(importActivity => {
                    const isDuplicate = this.data.activities.some(existing => 
                        existing.date === importActivity.date && 
                        existing.type === importActivity.type &&
                        existing.timestamp === importActivity.timestamp
                    );
                    
                    if (!isDuplicate) {
                        this.data.activities.push(importActivity);
                        newActivities++;
                    } else {
                        duplicates++;
                    }
                });

                // Replace goals completely
                if (importedData.goals) {
                    this.data.goals = { ...importedData.goals };
                }

                // Merge milestones (skip duplicates by type + value)
                if (importedData.milestones && Array.isArray(importedData.milestones)) {
                    importedData.milestones.forEach(importMilestone => {
                        const isDuplicate = this.data.milestones.some(existing =>
                            existing.type === importMilestone.type &&
                            existing.value === importMilestone.value
                        );
                        
                        if (!isDuplicate) {
                            this.data.milestones.push(importMilestone);
                        }
                    });
                }

                // Import custom dashboard cards if present, otherwise use defaults
                if (importedData.customDashboardCards && Array.isArray(importedData.customDashboardCards)) {
                    this.data.customDashboardCards = importedData.customDashboardCards;
                } else {
                    // Set default if not in imported data (backward compatibility)
                    this.data.customDashboardCards = ['pushups', 'pullups', 'rollerabs'];
                }

                // Merge weights (skip duplicates by date)
                if (importedData.weights && Array.isArray(importedData.weights)) {
                    importedData.weights.forEach(importWeight => {
                        const isDuplicate = this.data.weights.some(existing =>
                            existing.date === importWeight.date
                        );
                        
                        if (!isDuplicate) {
                            this.data.weights.push(importWeight);
                        }
                    });
                    // Sort weights by date
                    this.data.weights.sort((a, b) => new Date(a.date) - new Date(b.date));
                }

                // Preserve current view settings
                // (don't import currentView to avoid unexpected screen changes)

                // Save merged data
                this.saveData();

                // Update all views
                this.updateGoalsUI();
                this.updateDashboard();
                this.renderCalendar();

                // Show success message
                const successMsg = document.getElementById('import-success');
                successMsg.textContent = `Imported ${newActivities} activities${duplicates > 0 ? `, skipped ${duplicates} duplicates` : ''}`;
                successMsg.classList.add('show');
                setTimeout(() => {
                    successMsg.classList.remove('show');
                }, 4000);
            },

            // Show screen
            showScreen(screenName) {
                // Update screens
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(`${screenName}-screen`).classList.add('active');
                
                // Update tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
                
                this.data.currentView.screen = screenName;

                // Refresh data for specific screens
                if (screenName === 'dashboard') {
                    this.updateDashboard();
                } else if (screenName === 'calendar') {
                    this.renderCalendar();
                } else if (screenName === 'goals') {
                    this.renderHabits(); // Render habits when viewing Goals
                } else if (screenName === 'leaderboard') {
                    this.renderLeaderboard();
                }
            },

            // Show day detail modal
            showDayDetail(date) {
                const activities = this.data.activities.filter(a => a.date === date);
                const dateObj = new Date(date + 'T12:00:00');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const formattedDate = `${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateObj.getFullYear()}`;
                
                document.getElementById('day-detail-date').textContent = formattedDate;
                
                const content = document.getElementById('day-detail-content');
                
                if (activities.length === 0) {
                    content.innerHTML = `
                        <div class="empty-day">
                            <div class="empty-day-icon"></div>
                            <div class="empty-day-text">No activities logged for this day</div>
                        </div>
                    `;
                } else {
                    const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                    
                    // Group and calculate totals
                    let totalDistance = 0;
                    let totalSteps = 0;
                    let totalPushups = 0;
                    let totalPullups = 0;
                    let totalRollerAbs = 0;
                    let totalDips = 0;
                    let totalSquats = 0;
                    let totalSitups = 0;
                    let totalStairs = 0;
                    let workoutCount = 0;
                    
                    const activityHTML = activities.map((activity, index) => {
                        const activityNames = {
                            'walk': 'Walking',
                            'run': 'Running',
                            'dog': 'Dog Walking',
                            'hiking': 'Hiking',
                            'biking': 'Biking',
                            'stairs': 'Master Stairs',
                            'steps': 'Steps',
                            'pushups': 'Push-ups',
                            'pullups': 'Pull-ups',
                            'rollerabs': 'Roller Abs',
                            'dips': 'Dips',
                            'squats': 'Squats',
                            'situps': 'Sit-ups',
                            'leg': 'Leg Day',
                            'chest': 'Chest Day',
                            'shoulder': 'Shoulder Day',
                            'core': 'Core Day',
                            'arm': 'Arm Day',
                            'back': 'Back Day',
                            'fullbody': 'Full Body Day'
                        };
                        
                        let valueText = '';
                        if (activity.distance) {
                            const displayDistance = this.data.goals.unitPreference === 'miles' 
                                ? (activity.distance / 1.60934).toFixed(1)
                                : activity.distance.toFixed(1);
                            valueText = `${displayDistance} ${unit}`;
                            totalDistance += activity.distance;
                        } else if (activity.floors) {
                            valueText = `${activity.floors} floors`;
                            totalStairs += activity.floors;
                        } else if (activity.steps) {
                            valueText = `${activity.steps.toLocaleString()} steps`;
                            totalSteps += activity.steps;
                        } else if (activity.reps) {
                            valueText = `${activity.reps} reps`;
                            // Track by type
                            if (activity.type === 'pushups') totalPushups += activity.reps;
                            else if (activity.type === 'pullups') totalPullups += activity.reps;
                            else if (activity.type === 'rollerabs') totalRollerAbs += activity.reps;
                            else if (activity.type === 'dips') totalDips += activity.reps;
                            else if (activity.type === 'squats') totalSquats += activity.reps;
                            else if (activity.type === 'situps') totalSitups += activity.reps;
                        } else {
                            valueText = 'Completed';
                            workoutCount++;
                        }
                        
                        return `
                            <div class="day-activity-item" data-activity-index="${this.data.activities.indexOf(activity)}">
                                <div class="day-activity-info">
                                    <div class="day-activity-type">${activityNames[activity.type] || activity.type}</div>
                                    <div class="day-activity-value">${valueText}</div>
                                </div>
                                <button class="day-activity-delete" onclick="app.deleteActivity(${this.data.activities.indexOf(activity)})">Delete</button>
                            </div>
                        `;
                    }).join('');
                    
                    // Build totals section (FIXED: "exercises" instead of "workouts")
                    const totals = [];
                    if (totalDistance > 0) {
                        const displayDistance = this.data.goals.unitPreference === 'miles' 
                            ? (totalDistance / 1.60934).toFixed(1)
                            : totalDistance.toFixed(1);
                        totals.push(`${displayDistance} ${unit} total`);
                    }
                    if (totalSteps > 0) {
                        totals.push(`${totalSteps.toLocaleString()} steps`);
                    }
                    if (totalPushups > 0) {
                        totals.push(`${totalPushups} push-ups`);
                    }
                    if (totalPullups > 0) {
                        totals.push(`${totalPullups} pull-ups`);
                    }
                    if (totalRollerAbs > 0) {
                        totals.push(`${totalRollerAbs} roller abs`);
                    }
                    if (totalDips > 0) {
                        totals.push(`${totalDips} dips`);
                    }
                    if (totalSquats > 0) {
                        totals.push(`${totalSquats} squats`);
                    }
                    if (totalSitups > 0) {
                        totals.push(`${totalSitups} sit-ups`);
                    }
                    if (totalStairs > 0) {
                        totals.push(`${totalStairs} floors`);
                    }
                    if (workoutCount > 0) {
                        totals.push(`${workoutCount} exercise${workoutCount > 1 ? 's' : ''}`);
                    }
                    
                    content.innerHTML = `
                        <div class="day-activity-list">
                            ${activityHTML}
                        </div>
                        ${totals.length > 0 ? `
                            <div class="day-totals">
                                <div class="day-totals-title">Day Summary</div>
                                <div class="day-totals-content">
                                    ${totals.join('  ')}
                                </div>
                            </div>
                        ` : ''}
                    `;
                }
                
                // ADD HABITS SECTION
                const completedHabits = this.getHabitsForDate(date);
                
                if (this.data.habits && this.data.habits.length > 0) {
                    let habitsHTML = '<h3 style="margin-top: 20px; margin-bottom: 12px; color: #9ca3af; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">DAILY HABITS</h3>';
                    
                    habitsHTML += this.data.habits.map(habit => {
                        const isCompleted = completedHabits.some(h => h.id === habit.id);
                        return `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 10px; background: #2d2d2d; border-radius: 8px;">
                                <input type="checkbox" 
                                       ${isCompleted ? 'checked' : ''} 
                                       onchange="app.toggleHabitCompletion(${habit.id}, '${date}')"
                                       style="cursor: pointer; width: 18px; height: 18px;">
                                <span style="color: #e8e8e8; font-size: 14px; flex: 1;">${habit.name || 'Unnamed habit'}</span>
                            </div>
                        `;
                    }).join('');
                    
                    content.innerHTML += habitsHTML;
                }
                
                document.getElementById('day-overlay').classList.add('show');
                document.getElementById('day-detail-modal').classList.add('show');
            },

            // Close day detail modal
            closeDayDetail() {
                document.getElementById('day-overlay').classList.remove('show');
                document.getElementById('day-detail-modal').classList.remove('show');
            },

            // Delete activity
            deleteActivity(activityIndex) {
                if (!confirm('Are you sure you want to delete this activity?')) {
                    return;
                }
                
                this.data.activities.splice(activityIndex, 1);
                this.saveData();
                
                // Refresh all views
                this.updateDashboard();
                this.renderCalendar();
                
                // Reopen the day detail with updated data
                const dateInput = document.getElementById('day-detail-date').textContent;
                const activities = this.data.activities.filter(a => {
                    const activityDate = new Date(a.date + 'T12:00:00');
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                       'July', 'August', 'September', 'October', 'November', 'December'];
                    const formattedDate = `${monthNames[activityDate.getMonth()]} ${activityDate.getDate()}, ${activityDate.getFullYear()}`;
                    return formattedDate === dateInput;
                });
                
                if (activities.length > 0) {
                    this.showDayDetail(activities[0].date);
                } else {
                    this.closeDayDetail();
                }
            },

            // Update weight input display based on unit preference
            updateWeightInputDisplay() {
                const weightUnitDisplay = document.getElementById('weight-unit-display');
                if (weightUnitDisplay) {
                    weightUnitDisplay.textContent = 'lbs';
                }
},

            // Log weight entry
            logWeight() {
                const dateInput = document.getElementById('log-date').value;
                const weightInput = document.getElementById('weight-input');
                const weight = parseFloat(weightInput.value);

                if (!weight || weight <= 0) {
                    alert('Please enter a valid weight');
                    return;
                }

                // Initial weight is recommended for all-time % calculations, but not required to log weight.
                if (this.data.goals.initialWeight === null || this.data.goals.initialWeight === undefined) {
                    const proceed = confirm('Initial Weight is not set. You can still log weight, but all-time % change will not be available until you set Initial Weight in Settings  Goals. Continue?');
                    if (!proceed) return;
                }

                // Check if weight entry already exists for this date
                const existingIndex = this.data.weights.findIndex(w => w.date === dateInput);
                
                const weightEntry = {
                    date: dateInput,
                    weight: weight,
                    unit: this.data.goals.weightUnit
                };

                if (existingIndex >= 0) {
                    // Replace existing entry
                    this.data.weights[existingIndex] = weightEntry;
                } else {
                    // Add new entry
                    this.data.weights.push(weightEntry);
                }

                // Sort weights by date
                this.data.weights.sort((a, b) => new Date(a.date) - new Date(b.date));

                this.saveData();
                this.updateDashboard();
                
                // Sync to Firebase if PALS is set up
                if (this.data.pals.myPalCode) {
                    this.syncMyStatsToFirebase();
                }

                // Clear input and show success
                weightInput.value = '';
                alert(`Weight logged: ${weight} lbs`);
            },

            // Get weight statistics and trends
            getWeightStats() {
                if (!this.data.weights || this.data.weights.length === 0) {
                    const initial = (this.data.goals.initialWeight !== null && this.data.goals.initialWeight !== undefined)
                        ? Number(this.data.goals.initialWeight)
                        : null;

                    if (initial !== null && !isNaN(initial) && initial > 0) {
                        return {
                            current: initial,
                            trend: 'stable',
                            trendValue: 0,
                            unit: this.data.goals.weightUnit,
                            trendIsVsInitial: true
                        };
                    }

                    return {
                        current: null,
                        trend: null,
                        trendValue: 0,
                        unit: this.data.goals.weightUnit,
                        trendIsVsInitial: false
                    };
                }

                // Get most recent weight
                const sortedWeights = [...this.data.weights].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                const current = sortedWeights[0];

                // Determine trend value
                // If initialWeight is set, show change vs initial (profile baseline).
                // Otherwise, fall back to 7-day trend.
                const initial = (this.data.goals.initialWeight !== null && this.data.goals.initialWeight !== undefined)
                    ? Number(this.data.goals.initialWeight)
                    : null;

                let trend = 'stable';
                let trendValue = 0;

                if (initial !== null && !isNaN(initial) && initial > 0) {
                    trendValue = current.weight - initial;
                    if (Math.abs(trendValue) < 0.5) {
                        trend = 'stable';
                    } else if (trendValue > 0) {
                        trend = 'up';
                    } else {
                        trend = 'down';
                    }
                } else {
                    // Get weight from 7 days ago for trend
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

                    const pastWeight = this.data.weights.find(w => w.date <= sevenDaysAgoStr);

                    if (pastWeight) {
                        trendValue = current.weight - pastWeight.weight;
                        if (Math.abs(trendValue) < 0.5) {
                            trend = 'stable';
                        } else if (trendValue > 0) {
                            trend = 'up';
                        } else {
                            trend = 'down';
                        }
                    }
                }

                return {
                    current: current.weight,
                    trend: trend,
                    trendValue: trendValue,
                    unit: current.unit,
                    trendIsVsInitial: (initial !== null && !isNaN(initial) && initial > 0)
                };
            },

            // Calculate weight loss (starting weight - current weight)
            calculateWeightLoss() {
                // Standard: signed percent change from initial to current (negative = loss, positive = gain)
                return this.calculateWeightChangePctAllTime();
            },

            calculateWeightChangePctAllTime() {
                if (!this.data.weights || this.data.weights.length === 0) return null;

                // Sort weights by date to get current (latest)
                const sorted = [...this.data.weights].sort((a, b) => new Date(a.date) - new Date(b.date));
                const current = sorted[sorted.length - 1]?.weight;

                // Standard baseline: initialWeight (profile attribute)
                const baseline = Number(this.data.goals.initialWeight);

                if (!baseline || baseline <= 0 || !current || current <= 0) return null;

                const pct = ((current - baseline) / baseline) * 100;
                return Math.round(pct * 10) / 10; // 1 decimal
            },

            calculateWeightChangePctForPeriod(period) {
                // period: 'week' | 'month'
                if (!this.data.weights || this.data.weights.length === 0) return null;

                const now = new Date();
                const start = new Date(now);
                const end = new Date(now);

                if (period === 'week') {
                    // Sunday-start week: Sunday 00:00 to Saturday 23:59:59
                    const day = start.getDay(); // 0 = Sunday
                    start.setDate(start.getDate() - day);
                    start.setHours(0, 0, 0, 0);

                    end.setTime(start.getTime());
                    end.setDate(start.getDate() + 7);
                } else if (period === 'month') {
                    start.setDate(1);
                    start.setHours(0, 0, 0, 0);

                    end.setFullYear(start.getFullYear(), start.getMonth() + 1, 1);
                    end.setHours(0, 0, 0, 0);
                } else {
                    return null;
                }

                const inRange = this.data.weights
                    .map(w => ({...w, _d: new Date(w.date + 'T00:00:00')}))
                    .filter(w => w._d >= start && w._d < end)
                    .sort((a, b) => a._d - b._d);

                if (inRange.length === 0) return null;

                const first = inRange[0].weight;
                const last = inRange[inRange.length - 1].weight;
                if (!first || first <= 0 || !last || last <= 0) return null;

                const pct = ((last - first) / first) * 100;
                return Math.round(pct * 10) / 10;
            },

            
            // Signed weight change in lbs from initial weight to latest (negative = loss, positive = gain)
            calculateWeightChangeLbsAllTime() {
                if (!this.data.weights || this.data.weights.length === 0) return null;

                const sorted = [...this.data.weights].sort((a, b) => new Date(a.date) - new Date(b.date));
                const current = sorted[sorted.length - 1]?.weight;

                const baseline = Number(this.data.goals.initialWeight);
                if (!baseline || baseline <= 0 || !current || current <= 0) return null;

                const delta = current - baseline;
                return Math.round(delta * 10) / 10; // 1 decimal
            },

            // Signed weight change in lbs within a period window (week/month); uses first vs last in-range
            calculateWeightChangeLbsForPeriod(period) {
                if (!this.data.weights || this.data.weights.length === 0) return null;

                const now = new Date();
                const start = new Date(now);
                const end = new Date(now);

                if (period === 'week') {
                    // Sunday-start week: Sunday 00:00 to Saturday 23:59:59
                    const day = start.getDay(); // 0 = Sunday
                    start.setDate(start.getDate() - day);
                    start.setHours(0, 0, 0, 0);

                    end.setTime(start.getTime());
                    end.setDate(start.getDate() + 7);
                } else if (period === 'month') {
                    start.setDate(1);
                    start.setHours(0, 0, 0, 0);

                    end.setMonth(start.getMonth() + 1);
                    end.setDate(1);
                    end.setHours(0, 0, 0, 0);
                } else {
                    return null;
                }

                const inRange = this.data.weights
                    .map(w => ({...w, _d: new Date(w.date + 'T00:00:00')}))
                    .filter(w => w._d >= start && w._d < end)
                    .sort((a, b) => a._d - b._d);

                if (inRange.length === 0) return null;

                const first = inRange[0].weight;
                const last = inRange[inRange.length - 1].weight;
                if (!first || first <= 0 || !last || last <= 0) return null;

                const delta = last - first;
                return Math.round(delta * 10) / 10;
            },
// Animate count-up for numbers
            animateCountUp(element, target, duration = 800) {
                const start = 0;
                const startTime = performance.now();
                const isDecimal = !Number.isInteger(target);

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const current = start + (target - start) * easeOut;
                    
                    if (isDecimal) {
                        element.textContent = current.toFixed(1);
                    } else {
                        element.textContent = Math.floor(current).toLocaleString();
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        if (isDecimal) {
                            element.textContent = target.toFixed(1);
                        } else {
                            element.textContent = target.toLocaleString();
                        }
                    }
                };

                requestAnimationFrame(animate);
            },

            // Render bar graphs for week/month comparisons
            renderBarGraphs(stats) {
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                // Calculate this week vs last week
                const today = new Date();
                const lastWeekStart = new Date(today);
                lastWeekStart.setDate(today.getDate() - 14);
                const lastWeekEnd = new Date(today);
                lastWeekEnd.setDate(today.getDate() - 7);

                let lastWeekDistance = 0;
                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    if (activityDate >= lastWeekStart && activityDate < lastWeekEnd && activity.distance) {
                        lastWeekDistance += activity.distance;
                    }
                });

                if (this.data.goals.unitPreference === 'miles') {
                    lastWeekDistance = lastWeekDistance / 1.60934;
                }
                lastWeekDistance = Math.round(lastWeekDistance * 10) / 10;

                // Calculate this month vs last month
                const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);

                let thisMonthDistance = 0;
                let lastMonthDistance = 0;

                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    if (activityDate >= thisMonthStart && activity.distance) {
                        thisMonthDistance += activity.distance;
                    }
                    if (activityDate >= lastMonthStart && activityDate <= lastMonthEnd && activity.distance) {
                        lastMonthDistance += activity.distance;
                    }
                });

                if (this.data.goals.unitPreference === 'miles') {
                    thisMonthDistance = thisMonthDistance / 1.60934;
                    lastMonthDistance = lastMonthDistance / 1.60934;
                }
                thisMonthDistance = Math.round(thisMonthDistance * 10) / 10;
                lastMonthDistance = Math.round(lastMonthDistance * 10) / 10;

                // Render week comparison
                const maxWeek = Math.max(stats.thisWeekDistance, lastWeekDistance, 1);
                const weekCurrentPercent = (stats.thisWeekDistance / maxWeek) * 100;
                const weekPreviousPercent = (lastWeekDistance / maxWeek) * 100;

                document.getElementById('week-current-bar').style.width = `${weekCurrentPercent}%`;
                document.getElementById('week-previous-bar').style.width = `${weekPreviousPercent}%`;
                document.getElementById('week-current-value').textContent = `${stats.thisWeekDistance} ${unit}`;
                document.getElementById('week-previous-value').textContent = `${lastWeekDistance} ${unit}`;

                // Render month comparison
                const maxMonth = Math.max(thisMonthDistance, lastMonthDistance, 1);
                const monthCurrentPercent = (thisMonthDistance / maxMonth) * 100;
                const monthPreviousPercent = (lastMonthDistance / maxMonth) * 100;

                document.getElementById('month-current-bar').style.width = `${monthCurrentPercent}%`;
                document.getElementById('month-previous-bar').style.width = `${monthPreviousPercent}%`;
                document.getElementById('month-current-value').textContent = `${thisMonthDistance} ${unit}`;
                document.getElementById('month-previous-value').textContent = `${lastMonthDistance} ${unit}`;
            },

            // Get trend indicator for comparing current vs previous values
            getTrendIndicator(current, previous) {
                // Don't show trend if current value is 0 (nothing to trend from)
                if (!current || current === 0) {
                    return '';
                }
                
                // Don't show trend if no previous data to compare against
                if (!previous || previous === 0) {
                    return ''; // No trend if no previous data
                }
                
                const diff = current - previous;
                const percentChange = Math.abs((diff / previous) * 100);
                
                // Only show trend if change is significant (>5%)
                if (percentChange < 5) {
                    return '';
                }
                
                if (diff > 0) {
                    return '<span class="trend-indicator up" style="font-size: 11px; margin-left: 4px;"></span>';
                } else if (diff < 0) {
                    return '<span class="trend-indicator down" style="font-size: 11px; margin-left: 4px;\"></span>';
                } else {
                    return '';
                }
            },

            // Update weight summary card on dashboard
            updateWeightSummary() {
                const weightStats = this.getWeightStats();
                const weightCard = document.getElementById('weight-summary-card');
                
                if (weightStats.current) {
                    // Show weight card
                    weightCard.style.display = 'block';
                    
                    // Update weight value
                    document.getElementById('weight-display-value').textContent = weightStats.current.toFixed(1);
                    document.getElementById('weight-display-unit').textContent = weightStats.unit;
                    
                    // Update trend indicator
                    const trendElement = document.getElementById('weight-trend-indicator');
                    const trendLabel = (weightStats.trendIsVsInitial) ? ' since start' : '';
                    if (weightStats.trend === 'up') {
                        trendElement.innerHTML = '<span class="trend-indicator up"> +' + Number(weightStats.trendValue).toFixed(1) + ' ' + weightStats.unit + trendLabel + '</span>';
                    } else if (weightStats.trend === 'down') {
                        trendElement.innerHTML = '<span class="trend-indicator down"> ' + Number(weightStats.trendValue).toFixed(1) + ' ' + weightStats.unit + trendLabel + '</span>';
                    } else {
                        trendElement.innerHTML = '<span class="trend-indicator stable"> No change' + trendLabel + '</span>';
                    }
                    
                    // Render weight history
                    this.renderWeightHistory();
                } else {
                    // Hide weight card if no data
                    weightCard.style.display = 'none';
                }
            },

            // Toggle weight history expand/collapse
            toggleWeightHistory() {
                const historyList = document.getElementById('weight-history-list');
                const toggleBtn = document.getElementById('weight-history-toggle');
                
                if (historyList.classList.contains('expanded')) {
                    historyList.classList.remove('expanded');
                    toggleBtn.textContent = 'View History ';
                } else {
                    historyList.classList.add('expanded');
                    toggleBtn.textContent = 'Hide History ';
                }
            },

            // Render weight history list
            renderWeightHistory() {
                const historyList = document.getElementById('weight-history-list');
                
                if (!this.data.weights || this.data.weights.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 8px; font-size: 12px;">No weight entries yet</div>';
                    return;
                }

                // Sort by date descending (newest first)
                const sortedWeights = [...this.data.weights].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );

                historyList.innerHTML = sortedWeights.map((entry, index) => {
                    const date = new Date(entry.date + 'T12:00:00');
                    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    return `
                        <div class="weight-entry">
                            <div class="weight-entry-date">${formattedDate}</div>
                            <div class="weight-entry-value">${entry.weight.toFixed(1)} ${entry.unit}</div>
                            <div class="weight-entry-actions">
                                <button class="weight-entry-btn weight-entry-edit" onclick="app.editWeight('${entry.date}')">Edit</button>
                                <button class="weight-entry-btn weight-entry-delete" onclick="app.deleteWeight('${entry.date}')"></button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // Edit weight entry
            editWeight(date) {
                const entry = this.data.weights.find(w => w.date === date);
                if (!entry) return;

                const newWeight = prompt(`Edit weight for ${date}:`, entry.weight);
                if (newWeight === null) return; // Cancelled

                const parsedWeight = parseFloat(newWeight);
                if (isNaN(parsedWeight) || parsedWeight <= 0) {
                    alert('Please enter a valid weight');
                    return;
                }

                // Update the entry
                entry.weight = parsedWeight;
                
                this.saveData();
                this.updateWeightSummary();
                this.updateDashboard();
                
                // Sync to Firebase if PALS is set up
                if (this.data.pals.myPalCode) {
                    this.syncMyStatsToFirebase();
                }
            },

            // Delete weight entry
            deleteWeight(date) {
                if (!confirm(`Delete weight entry for ${date}?`)) return;

                // Remove the entry
                this.data.weights = this.data.weights.filter(w => w.date !== date);
                
                this.saveData();
                this.updateWeightSummary();
                this.updateDashboard();
                
                // Sync to Firebase if PALS is set up
                if (this.data.pals.myPalCode) {
                    this.syncMyStatsToFirebase();
                }
            },

            // ============================================
            // PALS FEATURE (v1.7.0)
            // ============================================

            // Initialize Firebase
            initFirebase() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyAT7pbbabXIpOOvNJTqqAn0IrjG8Ipl4K8",
                        authDomain: "juststep.firebaseapp.com",
                        projectId: "juststep",
                        storageBucket: "juststep.firebasestorage.app",
                        messagingSenderId: "366703889902",
                        appId: "1:366703889902:web:ee5150cb30477773e4d2ff",
                        measurementId: "G-HGGTFEK172"
                    };

                    this.firebase = firebase.initializeApp(firebaseConfig);
                    this.db = firebase.firestore();
                    console.log(' Firebase initialized');
                } catch (error) {
                    console.error('Firebase init error:', error);
                }
            },

            // Update PALS UI
            updatePalsUI() {
                // Update display elements in compact design
                const shareCodeDisplay = document.getElementById('display-pal-code');
                const displayNameDisplay = document.getElementById('display-display-name');
                const shareCodeBtn = document.getElementById('pal-code-btn');
                
                if (shareCodeDisplay) {
                    shareCodeDisplay.textContent = this.data.pals.myPalCode || 'Not set';
                }
                
                if (displayNameDisplay) {
                    displayNameDisplay.textContent = this.data.pals.displayName || 'Not set';
                }
                
                // Update button text based on whether code exists
                if (shareCodeBtn) {
                    if (this.data.pals.myPalCode) {
                        shareCodeBtn.textContent = 'Share';
                        shareCodeBtn.style.background = 'var(--primary-dark)';
                    } else {
                        shareCodeBtn.textContent = 'Set Code';
                        shareCodeBtn.style.background = '#6b7280';
                    }
                }
                
                // Update checkbox
                const hasPalCode = !!(this.data.pals && this.data.pals.myPalCode);
                const checkbox = document.getElementById('join-leaderboard');
                if (checkbox) {
                    // Only allow leaderboard participation once PAL Code is set
                    checkbox.checked = (this.data.pals.joinedLeaderboard || false) && hasPalCode;
                    checkbox.disabled = !hasPalCode;
                    checkbox.style.opacity = checkbox.disabled ? '0.5' : '1';
                    checkbox.style.cursor = checkbox.disabled ? 'not-allowed' : 'pointer';
                }

                const weightCheckbox = document.getElementById('join-weight-leaderboard');
                if (weightCheckbox) {
                    const eligibleForWeight = this.isWeightLeaderboardEligible();
                    // Weight leaderboard only available when:
                    // 1) PAL Code exists
                    // 2) User is in leaderboards (Steps/Distance)
                    // 3) Initial weight + at least one weigh-in exist
                    const canToggleWeight = hasPalCode && (this.data.pals.joinedLeaderboard || false) && eligibleForWeight;

                    weightCheckbox.checked = (this.data.pals.joinWeightLeaderboard || false) && canToggleWeight;
                    weightCheckbox.disabled = !canToggleWeight;
                    weightCheckbox.style.opacity = weightCheckbox.disabled ? '0.5' : '1';
                    weightCheckbox.style.cursor = weightCheckbox.disabled ? 'not-allowed' : 'pointer';
                }

                this.renderPalsList();
                this.renderLeaderboard();
            },


            // Weight leaderboard eligibility:
            // Requires Initial Weight in Goals AND at least one weigh-in logged.
            isWeightLeaderboardEligible() {
                const iw = this.data && this.data.goals ? this.data.goals.initialWeight : null;
                const hasInitial = iw !== null && iw !== '' && !Number.isNaN(Number(iw));
                const hasWeighIns = Array.isArray(this.data.weights) && this.data.weights.length > 0;
                return hasInitial && hasWeighIns;
            },

            // Toggle leaderboard participation (Steps/Distance).
            // Only allowed once PAL Code is set.
            async toggleLeaderboard() {
                const checkbox = document.getElementById('join-leaderboard');
                const hasPalCode = !!(this.data.pals && this.data.pals.myPalCode);

                if (!hasPalCode) {
                    if (checkbox) checkbox.checked = false;
                    this.data.pals.joinedLeaderboard = false;
                    this.data.pals.joinWeightLeaderboard = false;
                    this.saveData();
                    this.updatePalsUI();
                    alert('Create your PAL Code first to join the leaderboards.');
                    return;
                }

                const joined = !!(checkbox && checkbox.checked);
                this.data.pals.joinedLeaderboard = joined;

                // If leaving leaderboards, also leave weight leaderboard
                if (!joined) {
                    this.data.pals.joinWeightLeaderboard = false;
                    const weightCheckbox = document.getElementById('join-weight-leaderboard');
                    if (weightCheckbox) weightCheckbox.checked = false;
                }

                this.saveData();
                this.updatePalsUI();

                // Sync if possible (non-blocking)
                try { await this.syncStatsToFirebase(); } catch (e) {}
            },

            // Toggle Weight leaderboard opt-in.
            // Only enabled once eligibility requirements are met.
            async toggleWeightLeaderboardOptIn() {
                const weightCheckbox = document.getElementById('join-weight-leaderboard');
                const hasPalCode = !!(this.data.pals && this.data.pals.myPalCode);

                if (!hasPalCode || !(this.data.pals.joinedLeaderboard || false)) {
                    if (weightCheckbox) weightCheckbox.checked = false;
                    this.data.pals.joinWeightLeaderboard = false;
                    this.saveData();
                    this.updatePalsUI();
                    return;
                }

                if (!this.isWeightLeaderboardEligible()) {
                    if (weightCheckbox) weightCheckbox.checked = false;
                    this.data.pals.joinWeightLeaderboard = false;
                    this.saveData();
                    this.updatePalsUI();
                    alert('To join the Weight leaderboard, add your Initial Weight in Goals and log at least one weigh-in.');
                    return;
                }

                this.data.pals.joinWeightLeaderboard = !!(weightCheckbox && weightCheckbox.checked);
                this.saveData();
                this.updatePalsUI();

                // Sync if possible (non-blocking)
                try { await this.syncStatsToFirebase(); } catch (e) {}
            },

            // Share my code via text/messaging
            
// -------- PAL Code / Display Name modal helpers (v1.7.0) --------
createModalOverlay(titleText) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.background = 'rgba(0,0,0,0.6)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '9999';

    const modal = document.createElement('div');
    modal.style.width = 'min(420px, 92vw)';
    modal.style.background = '#1f1f1f';
    modal.style.border = '1px solid rgba(255,255,255,0.08)';
    modal.style.borderRadius = '16px';
    modal.style.boxShadow = '0 20px 60px rgba(0,0,0,0.55)';
    modal.style.padding = '18px';

    const title = document.createElement('div');
    title.textContent = titleText;
    title.style.fontSize = '18px';
    title.style.fontWeight = '700';
    title.style.color = '#fff';
    title.style.marginBottom = '10px';

    modal.appendChild(title);
    overlay.appendChild(modal);

    return { overlay, modal };
},

promptModal({ title, bodyNode, okText='OK', cancelText='Cancel' }) {
    return new Promise((resolve) => {
        const { overlay, modal } = this.createModalOverlay(title);

        const bodyWrap = document.createElement('div');
        bodyWrap.appendChild(bodyNode);
        modal.appendChild(bodyWrap);

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '10px';
        actions.style.marginTop = '14px';

        const btnCancel = document.createElement('button');
        btnCancel.textContent = cancelText;
        btnCancel.style.flex = '1';
        btnCancel.className = 'secondary-btn';
        btnCancel.onclick = () => {
            document.body.removeChild(overlay);
            resolve(null);
        };

        const btnOk = document.createElement('button');
        btnOk.textContent = okText;
        btnOk.style.flex = '1';
        btnOk.className = 'primary-btn';
        btnOk.onclick = () => {
            document.body.removeChild(overlay);
            resolve(true);
        };

        actions.appendChild(btnCancel);
        actions.appendChild(btnOk);
        modal.appendChild(actions);

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                document.body.removeChild(overlay);
                resolve(null);
            }
        });

        document.body.appendChild(overlay);
    });
},

async promptForPalCode() {
    const wrap = document.createElement('div');

    const desc = document.createElement('div');
    desc.textContent = 'Enter a 4-digit PAL Code (numbers only). Leading zeros are allowed.';
    desc.style.color = 'rgba(255,255,255,0.75)';
    desc.style.fontSize = '13px';
    desc.style.marginBottom = '12px';
    wrap.appendChild(desc);

    const input = document.createElement('input');
    input.type = 'tel';
    input.inputMode = 'numeric';
    input.autocomplete = 'one-time-code';
    input.placeholder = '0000';
    input.maxLength = 4;
    input.style.width = '100%';
    input.style.padding = '12px 14px';
    input.style.borderRadius = '12px';
    input.style.border = '1px solid rgba(255,255,255,0.12)';
    input.style.background = '#121212';
    input.style.color = '#fff';
    input.style.fontSize = '18px';
    input.style.letterSpacing = '4px';

    input.addEventListener('input', () => {
        input.value = input.value.replace(/\D/g, '').slice(0, 4);
    });

    wrap.appendChild(input);

    // show modal
    const result = await this.promptModal({ title: 'Create Your PAL Code', bodyNode: wrap, okText: 'OK', cancelText: 'Cancel' });
    if (!result) return null;

    const code = (input.value || '').trim();
    if (!/^\d{4}$/.test(code)) {
        alert(' PAL Code must be exactly 4 digits (example: 0042).');
        return await this.promptForPalCode();
    }
    return code;
},

async promptForDisplayName() {
    const wrap = document.createElement('div');

    const desc = document.createElement('div');
    desc.textContent = 'Enter the display name you want Pals to see.';
    desc.style.color = 'rgba(255,255,255,0.75)';
    desc.style.fontSize = '13px';
    desc.style.marginBottom = '12px';
    wrap.appendChild(desc);

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Display name';
    input.maxLength = 20;
    input.style.width = '100%';
    input.style.padding = '12px 14px';
    input.style.borderRadius = '12px';
    input.style.border = '1px solid rgba(255,255,255,0.12)';
    input.style.background = '#121212';
    input.style.color = '#fff';
    input.style.fontSize = '16px';

    wrap.appendChild(input);

    const result = await this.promptModal({ title: 'Set Display Name', bodyNode: wrap, okText: 'OK', cancelText: 'Cancel' });
    if (!result) return null;

    const name = (input.value || '').trim();
    if (!name) {
        alert(' Display Name cannot be empty.');
        return await this.promptForDisplayName();
    }
    return name;
},


shareMyPalCode() {
                const code = this.data.pals.myPalCode;
                if (!code) {
                    alert('Please save your PAL Code first!');
                    return;
                }

                const message = `Hey! Join me on JustStep fitness tracker! Add my code: ${code}`;
                
                // Try Web Share API (works on mobile)
                if (navigator.share) {
                    navigator.share({
                        title: 'JustStep - Join Me!',
                        text: message
                    }).catch(err => {
                        console.log('Share cancelled or failed:', err);
                    });
                } else {
                    // Fallback - copy to clipboard
                    navigator.clipboard.writeText(message).then(() => {
                        alert('Message copied to clipboard! Paste it in a text message.');
                    }).catch(() => {
                        // Final fallback - show alert with code
                        alert(message);
                    });
                }
            },

            // Save display name
            async saveDisplayName() {
                const name = document.getElementById('display-name').value.trim();
                
                if (!name) {
                    alert('Please enter a display name');
                    return;
                }

                this.data.pals.displayName = name;
                this.saveData();

                // Sync to Firebase
                await this.syncMyStatsToFirebase();

                const successEl = document.getElementById('display-name-success');
                successEl.classList.add('show');
                setTimeout(() => successEl.classList.remove('show'), 3000);
            },

            // Edit PAL Code (inline prompt)

// Handle PAL Code button (Set Code or Share)
async handlePalCodeButton() {
    if (this.data.pals.myPalCode) {
        // Already has code - share it
        this.shareMyPalCode();
    } else {
        // No code - prompt to create
        await this.createPalCode();
    }
},

// Create PAL Code
// Create PAL Code
async createPalCode() {
    // PAL Code creation flow (4 digits)
    while (true) {
        const raw = prompt(
            'Create your PAL Code (4 digits):\n' +
            'Numbers only (example: 0042).\n\n' +
            'Note: Your PAL Code cannot be changed later.'
        );
        if (raw === null) return; // cancelled

        const code = String(raw).trim();
        if (!/^\d{4}$/.test(code)) {
            alert(' Invalid PAL Code. Please enter exactly 4 digits (e.g., 0042).');
            continue;
        }

        const confirmLock = confirm(
            'Your PAL Code cannot be changed later.\n\n' +
            'Use PAL Code: ' + code + ' ?'
        );
        if (!confirmLock) continue;

        // Prompt for Display Name
        let displayName = '';
        while (!displayName) {
            const entered = prompt(
                'Enter your display name (shown to pals and on leaderboards):',
                (this.data.pals.displayName || '').trim()
            );
            if (entered === null) return; // cancelled
            displayName = String(entered).trim();
        }

        if (!this.db) {
            console.error('Firebase is not initialized (db is missing).');
            alert(' Firebase is not available. Please try again.');
            return;
        }

        try {
            const docRef = this.db.collection('users').doc(code);

            // Claim the code transactionally (protects against race conditions)
            await this.db.runTransaction(async (transaction) => {
                const doc = await transaction.get(docRef);
                if (doc.exists) throw new Error('CODE_TAKEN');

                // Snapshot stats at creation time (optional fields for leaderboards)
                const stats = this.calculateStats();
                const monthStats = this.calculateMonthStats();
                const weight = this.calculateWeightLoss();
                const weightChangeLbsAllTime = this.calculateWeightChangeLbsAllTime();
                const weightChangePctThisWeek = this.calculateWeightChangePctForPeriod('week');
                const weightChangePctThisMonth = this.calculateWeightChangePctForPeriod('month');
                const weightChangeLbsThisWeek = this.calculateWeightChangeLbsForPeriod('week');
                const weightChangeLbsThisMonth = this.calculateWeightChangeLbsForPeriod('month');

                transaction.set(docRef, {
                    palCode: code,
                    displayName: displayName,
                    pals: [],
                    joinedLeaderboard: false,
                    joinWeightLeaderboard: false,

                    // Distance / steps / exercises snapshot
                    thisWeekDistance: stats.thisWeekDistance,
                    thisMonthDistance: monthStats.monthDistance,
                    totalDistance: stats.totalDistance,
                    thisWeekSteps: stats.thisWeekSteps,
                    thisMonthSteps: monthStats.monthSteps,
                    totalSteps: stats.totalSteps,
                    thisWeekPushups: stats.thisWeekPushups,
                    thisMonthPushups: monthStats.monthPushups,
                    totalPushups: stats.totalPushups,
                    thisWeekPullups: stats.thisWeekPullups,
                    thisMonthPullups: monthStats.monthPullups,
                    totalPullups: stats.totalPullups,
                    thisWeekSitups: stats.thisWeekSitups,
                    thisMonthSitups: monthStats.monthSitups,
                    totalSitups: stats.totalSitups,
                    thisWeekSquats: stats.thisWeekSquats,
                    thisMonthSquats: monthStats.monthSquats,
                    totalSquats: stats.totalSquats,

                    // Weight stats snapshot (leaderboard uses opt-in flag)
                    currentWeight: weight.currentWeight,
                    initialWeight: weight.initialWeight,
                    weightLost: weight.weightLost,
                    weightChangeLbsAllTime: weightChangeLbsAllTime,
                    weightChangePctThisWeek: weightChangePctThisWeek,
                    weightChangePctThisMonth: weightChangePctThisMonth,
                    weightChangeLbsThisWeek: weightChangeLbsThisWeek,
                    weightChangeLbsThisMonth: weightChangeLbsThisMonth,

                    lastUpdated: new Date().toISOString()
                });
            });

            // Only persist locally after Firebase claim succeeds
            this.data.pals.myPalCode = code;
            this.data.pals.displayName = displayName;
            this.saveData();
            this.updatePalsUI();

            // Best-effort stats sync (merge update)
            await this.syncMyStatsToFirebase();

            alert(' PAL Code created! You can now share it.');
            return;
        } catch (err) {
            if (String(err && err.message) === 'CODE_TAKEN') {
                alert(' That PAL Code is already taken. Please try another.');
                continue;
            }
            console.error(err);
            alert(' Error creating PAL Code. Please try again.');
            return;
        }
    }
},
            // Sync my stats to Firebase
            async syncMyStatsToFirebase() {
                if (!this.data.pals.myPalCode || !this.db) return;

                try {
                    const stats = this.calculateStats();
                    const monthStats = this.calculateMonthStats();
                    const weight = this.calculateWeightLoss();
                    const weightChangeLbsAllTime = this.calculateWeightChangeLbsAllTime();
                    const weightChangePctThisWeek = this.calculateWeightChangePctForPeriod('week');
                    const weightChangePctThisMonth = this.calculateWeightChangePctForPeriod('month');
                    const weightChangeLbsThisWeek = this.calculateWeightChangeLbsForPeriod('week');
                    const weightChangeLbsThisMonth = this.calculateWeightChangeLbsForPeriod('month');
                    const today = new Date().toISOString().split('T')[0]; // Get today's date
                    
                    const data = {
                        palCode: this.data.pals.myPalCode,
                        displayName: this.data.pals.displayName || this.data.pals.myPalCode,
                        joinedLeaderboard: this.data.pals.joinedLeaderboard || false,
                        joinWeightLeaderboard: this.data.pals.joinWeightLeaderboard || false,
                        lastActivityDate: today, // Track last activity date for status indicators
                        stats: {
                            // Week totals
                            thisWeekDistance: stats.thisWeekDistance,
                            thisWeekStrengthDays: stats.thisWeekStrengthDays,
                            thisWeekSteps: stats.thisWeekSteps,
                            // Month totals
                            thisMonthDistance: monthStats.monthDistance,
                            thisMonthStrengthDays: monthStats.monthStrengthDays,
                            thisMonthSteps: monthStats.monthSteps,
                            // All-time totals
                            totalDistance: stats.totalDistance,
                            totalSteps: stats.totalSteps,
                            totalStrengthDays: stats.totalStrengthDays,
                            // Strength exercises (week, month, total)
                            thisWeekPushups: stats.thisWeekPushups,
                            thisMonthPushups: monthStats.monthPushups,
                            totalPushups: stats.totalPushups,
                            thisWeekPullups: stats.thisWeekPullups,
                            thisMonthPullups: monthStats.monthPullups,
                            totalPullups: stats.totalPullups,
                            thisWeekRollerAbs: stats.thisWeekRollerAbs,
                            thisMonthRollerAbs: monthStats.monthRollerAbs,
                            totalRollerAbs: stats.totalRollerAbs,
                            thisWeekDips: stats.thisWeekDips,
                            thisMonthDips: monthStats.monthDips,
                            totalDips: stats.totalDips,
                            thisWeekSquats: stats.thisWeekSquats,
                            thisMonthSquats: monthStats.monthSquats,
                            totalSquats: stats.totalSquats,
                            thisWeekSitups: stats.thisWeekSitups,
                            thisMonthSitups: monthStats.monthSitups,
                            totalSitups: stats.totalSitups,
                            // Cardio activities (week, month, total)
                            thisWeekRunning: stats.thisWeekRunning,
                            thisMonthRunning: monthStats.monthRunning,
                            totalRunning: stats.totalRunning,
                            thisWeekWalking: stats.thisWeekWalking,
                            thisMonthWalking: monthStats.monthWalking,
                            totalWalking: stats.totalWalking,
                            thisWeekBiking: stats.thisWeekBiking,
                            thisMonthBiking: monthStats.monthBiking,
                            totalBiking: stats.totalBiking,
                            thisWeekDogWalk: stats.thisWeekDogWalk,
                            thisMonthDogWalk: monthStats.monthDogWalk,
                            totalDogWalk: stats.totalDogWalk,
                            thisWeekHiking: stats.thisWeekHiking,
                            thisMonthHiking: monthStats.monthHiking,
                            totalHiking: stats.totalHiking,
                            // Other (week, month, total)
                            thisWeekStairs: stats.thisWeekStairs,
                            thisMonthStairs: monthStats.monthStairs,
                            totalStairs: stats.totalStairs,
                            // Weight (signed % change; negative = loss)
                            weight: weight,
                            weightChangePctThisWeek: weightChangePctThisWeek,
                            weightChangePctThisMonth: weightChangePctThisMonth,
                            weightChangePctAllTime: weight,
                            weightChangeLbsThisWeek: weightChangeLbsThisWeek,
                            weightChangeLbsThisMonth: weightChangeLbsThisMonth,
                            weightChangeLbsAllTime: weightChangeLbsAllTime
                        },
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await this.db.collection('users').doc(this.data.pals.myPalCode).set({ ...data, palCode: this.data.pals.myPalCode, displayName: (this.data.pals.displayName || '') }, { merge: true });
                    console.log(' Stats synced to Firebase');
                } catch (error) {
                    console.error('Error syncing stats:', error);
                }
            },

            // Add pal
            async addPal() {
                const code = document.getElementById('add-pal-code').value.trim();
                const errorEl = document.getElementById('add-pal-error');
                const successEl = document.getElementById('add-pal-success');
                
                errorEl.classList.remove('show');
                successEl.classList.remove('show');

                if (!code) {
                    errorEl.textContent = 'Please enter a PAL Code';
                    errorEl.classList.add('show');
                    return;
                }

                // Format: 4 digits
                if (!/^\d{4}$/.test(code)) {
                    errorEl.textContent = 'Invalid PAL Code. Use 4 digits (example: 0042).';
                    errorEl.classList.add('show');
                    return;
                }


                if (code === this.data.pals.myPalCode) {
                    errorEl.textContent = "You can't add yourself!";
                    errorEl.classList.add('show');
                    return;
                }

                // Check if already added
                if (this.data.pals.friends.find(f => f.palCode === code)) {
                    errorEl.textContent = 'Already added this pal!';
                    errorEl.classList.add('show');
                    return;
                }

                // Fetch pal's data from Firebase
                try {
                    const doc = await this.db.collection('users').doc(code).get();
                    
                    if (!doc.exists) {
                        errorEl.textContent = 'PAL Code not found. Make sure your pal has set up their profile!';
                        errorEl.classList.add('show');
                        return;
                    }

                    const palData = doc.data();
                    
                    // Add to friends list
                    this.data.pals.friends.push({
                        palCode: code,
                        displayName: palData.displayName || code,
                        stats: palData.stats || {},
                        lastSync: new Date().toISOString()
                    });

                    this.saveData();
                    this.updatePalsUI();

                    document.getElementById('add-pal-code').value = '';
                    successEl.classList.add('show');
                    setTimeout(() => successEl.classList.remove('show'), 3000);
                } catch (error) {
                    console.error('Error adding pal:', error);
                    errorEl.textContent = 'Error adding pal. Try again!';
                    errorEl.classList.add('show');
                }
            },

            // Remove pal
            removePal(palCode) {
                if (!confirm(`Remove this pal?`)) return;

                this.data.pals.friends = this.data.pals.friends.filter(f => f.palCode !== palCode);
                this.saveData();
                this.updatePalsUI();
            },

            // Refresh pal's stats
            async refreshPalStats(palCode) {
                try {
                    const doc = await this.db.collection('users').doc(palCode).get();
                    
                    if (doc.exists) {
                        const palData = doc.data();
                        const friend = this.data.pals.friends.find(f => f.palCode === palCode);
                        if (friend) {
                            friend.stats = palData.stats || {};
                            friend.displayName = palData.displayName || palCode;
                            friend.lastSync = new Date().toISOString();
                            this.saveData();
                            this.updatePalsUI();
                        }
                    }
                } catch (error) {
                    console.error('Error refreshing pal stats:', error);
                }
            },

            // Render pals list
            renderPalsList() {
                const listEl = document.getElementById('pals-list');
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                const weightUnit = 'lbs';
// Show empty state if no pals
                if (!this.data.pals.friends || this.data.pals.friends.length === 0) {
                    listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No pals yet. Add one above!</p>';
                    return;
                }

                // Build HTML for each pal
                listEl.innerHTML = this.data.pals.friends.map(pal => {
                    const stats = pal.stats || {};
                    const expandedClass = pal.expanded ? 'expanded' : '';
                    const arrow = pal.expanded ? '' : '';
                    
                    const activityItems = [];
                    
                    // Helper function to add activity rows
                    const addItem = (name, weekVal, monthVal, totalVal, suffix = '') => {
                        activityItems.push({
                            name,
                            week: weekVal > 0 ? `${weekVal.toLocaleString()}${suffix}` : '-',
                            month: monthVal > 0 ? `${monthVal.toLocaleString()}${suffix}` : '-',
                            total: totalVal > 0 ? `${totalVal.toLocaleString()}${suffix}` : '-'
                        });
                    };
                    
                    // Strength exercises
                    if (stats.totalPushups > 0 || stats.thisWeekPushups > 0) {
                        addItem('Push-ups', stats.thisWeekPushups || 0, stats.thisMonthPushups || 0, stats.totalPushups || 0, ' reps');
                    }
                    if (stats.totalPullups > 0 || stats.thisWeekPullups > 0) {
                        addItem('Pull-ups', stats.thisWeekPullups || 0, stats.thisMonthPullups || 0, stats.totalPullups || 0, ' reps');
                    }
                    if (stats.totalRollerAbs > 0 || stats.thisWeekRollerAbs > 0) {
                        addItem('Roller Abs', stats.thisWeekRollerAbs || 0, stats.thisMonthRollerAbs || 0, stats.totalRollerAbs || 0, ' reps');
                    }
                    if (stats.totalDips > 0 || stats.thisWeekDips > 0) {
                        addItem('Dips', stats.thisWeekDips || 0, stats.thisMonthDips || 0, stats.totalDips || 0, ' reps');
                    }
                    if (stats.totalSquats > 0 || stats.thisWeekSquats > 0) {
                        addItem('Squats', stats.thisWeekSquats || 0, stats.thisMonthSquats || 0, stats.totalSquats || 0, ' reps');
                    }
                    if (stats.totalSitups > 0 || stats.thisWeekSitups > 0) {
                        addItem('Sit-ups', stats.thisWeekSitups || 0, stats.thisMonthSitups || 0, stats.totalSitups || 0, ' reps');
                    }
                    
                    // Cardio activities
                    if (stats.totalRunning > 0 || stats.thisWeekRunning > 0) {
                        addItem('Running', stats.thisWeekRunning || 0, stats.thisMonthRunning || 0, stats.totalRunning || 0, ` ${unit}`);
                    }
                    if (stats.totalWalking > 0 || stats.thisWeekWalking > 0) {
                        addItem('Walking', stats.thisWeekWalking || 0, stats.thisMonthWalking || 0, stats.totalWalking || 0, ` ${unit}`);
                    }
                    if (stats.totalBiking > 0 || stats.thisWeekBiking > 0) {
                        addItem('Biking', stats.thisWeekBiking || 0, stats.thisMonthBiking || 0, stats.totalBiking || 0, ` ${unit}`);
                    }
                    if (stats.totalDogWalk > 0 || stats.thisWeekDogWalk > 0) {
                        addItem('Dog Walking', stats.thisWeekDogWalk || 0, stats.thisMonthDogWalk || 0, stats.totalDogWalk || 0, ` ${unit}`);
                    }
                    if (stats.totalHiking > 0 || stats.thisWeekHiking > 0) {
                        addItem('Hiking', stats.thisWeekHiking || 0, stats.thisMonthHiking || 0, stats.totalHiking || 0, ` ${unit}`);
                    }
                    
                    // Other activities
                    if (stats.totalStairs > 0 || stats.thisWeekStairs > 0) {
                        addItem('Stairs', stats.thisWeekStairs || 0, stats.thisMonthStairs || 0, stats.totalStairs || 0, ' floors');
                    }
                    if (stats.totalSteps > 0 || stats.thisWeekSteps > 0) {
                        addItem('Steps', stats.thisWeekSteps || 0, stats.thisMonthSteps || 0, stats.totalSteps || 0);
                    }
                    
                    // Totals
                    addItem('Strength Days', stats.thisWeekStrengthDays || 0, stats.thisMonthStrengthDays || 0, stats.totalStrengthDays || 0, ' days');
                    if (stats.totalDistance > 0 || stats.thisWeekDistance > 0) {
                        addItem('Total Distance', stats.thisWeekDistance || 0, stats.thisMonthDistance || 0, stats.totalDistance || 0, ` ${unit}`);
                    }
                    
                    // Weight row
                    const weightValue = stats.weight ? (stats.weight > 0 ? `-${stats.weight}` : stats.weight < 0 ? `+${Math.abs(stats.weight)}` : '0') : '0';
                    activityItems.push({
                        name: 'Weight',
                        week: '-',
                        month: '-',
                        total: `${weightValue} ${weightUnit}`
                    });
                    
                    // Build activity table HTML
                    let activityTableHTML = '';
                    if (activityItems.length > 0) {
                        activityTableHTML = `
                            <div class="pal-activity-report">
                                <div class="pal-activity-header">
                                    <div class="pal-activity-col-name">Activity</div>
                                    <div class="pal-activity-col-value">Week</div>
                                    <div class="pal-activity-col-value">Month</div>
                                    <div class="pal-activity-col-value">All-Time</div>
                                </div>
                                ${activityItems.map(item => `
                                    <div class="pal-activity-row">
                                        <div class="pal-activity-col-name">${item.name}</div>
                                        <div class="pal-activity-col-value pal-week">${item.week}</div>
                                        <div class="pal-activity-col-value pal-month">${item.month}</div>
                                        <div class="pal-activity-col-value pal-total">${item.total}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    // Return pal card HTML
                    return `
                        <div class="pal-card ${expandedClass}">
                            <div class="pal-header" onclick="app.togglePalExpanded('${pal.palCode}')">
                                <div>
                                    <div class="pal-name">${pal.displayName}</div>
                                    <div class="pal-code">${pal.palCode}</div>
                                </div>
                                <div class="pal-expand-icon">${arrow}</div>
                            </div>
                            <div class="pal-stats-expanded">
                                ${activityTableHTML}
                            </div>
                            <div class="pal-actions">
                                <button class="pal-btn pal-btn-remove" onclick="app.removePal('${pal.palCode}')">Remove</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // Toggle pal card expanded state
            togglePalExpanded(palCode) {
                const pal = this.data.pals.friends.find(f => f.palCode === palCode);
                if (pal) {
                    pal.expanded = !pal.expanded;
                    this.saveData();
                    this.renderPalsList();
                }
            },

            // Refresh all pals stats
            async refreshAllPals() {
                const btn = document.getElementById('refresh-all-pals-btn');
                if (btn) {
                    btn.textContent = 'Refreshing...';
                    btn.disabled = true;
                }

                for (const pal of this.data.pals.friends) {
                    await this.refreshPalStats(pal.palCode);
                }

                if (btn) {
                    btn.textContent = ' Refresh All';
                    btn.disabled = false;
                }
                
                alert('All pals refreshed!');
            },

            // Render leaderboard
            // Set leaderboard mode (global or friends)
            setLeaderboardMode(mode) {
                this.leaderboardMode = mode;
                
                // Remove active from both buttons first
                document.getElementById('lb-global-btn').classList.remove('active');
                document.getElementById('lb-friends-btn').classList.remove('active');
                
                // Update inline styles for proper toggle
                const globalBtn = document.getElementById('lb-global-btn');
                const friendsBtn = document.getElementById('lb-friends-btn');
                
                if (mode === 'global') {
                    globalBtn.classList.add('active');
                    globalBtn.style.background = 'var(--primary-dark)';
                    globalBtn.style.color = 'white';
                    friendsBtn.style.background = '#2d2d2d';
                    friendsBtn.style.color = '#9ca3af';
                } else {
                    friendsBtn.classList.add('active');
                    friendsBtn.style.background = 'var(--primary-dark)';
                    friendsBtn.style.color = 'white';
                    globalBtn.style.background = '#2d2d2d';
                    globalBtn.style.color = '#9ca3af';
                }
                
                this.renderLeaderboard();
            },

            // Helper: Calculate days between two dates
            daysBetween(date1Str, date2Str) {
                const d1 = new Date(date1Str);
                const d2 = new Date(date2Str);
                const diffTime = Math.abs(d2 - d1);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            },

            async renderLeaderboard() {
                const listEl = document.getElementById('leaderboard-list');
                const period = document.getElementById('leaderboard-period').value;
                const baseMetric = document.getElementById('leaderboard-metric').value;
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                const weightUnit = 'lbs';

                // Update metric based on period
                let metric = baseMetric;
                if (period === 'month') {
                    metric = baseMetric.replace('thisWeek', 'thisMonth');
                } else if (period === 'total') {
                    metric = baseMetric.replace('thisWeek', 'total').replace('Distance', 'Distance');
                }

                // Check Firebase connection
                if (!this.db) {
                    listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">Connecting to leaderboard...</p>';
                    return;
                }

                try {
                    let snapshot;
                    
                    if (this.leaderboardMode === 'global') {
                        // GLOBAL: Show all users who opted in
                        snapshot = await this.db.collection('users')
                            .where('joinedLeaderboard', '==', true)
                            .get();
                    } else {
                        // FRIENDS: Show only added friends who OPTED IN + current user (if opted in)
                        const friendCodes = this.data.pals.friends.map(f => f.palCode);
                        if (friendCodes.length === 0 && !this.data.pals.myPalCode) {
                            listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">Add friends to see their rankings!</p>';
                            return;
                        }
                        
                        // Add current user to the list ONLY if they have opted into leaderboards
                        const allCodes = [...friendCodes];
                        if (this.data.pals.myPalCode && 
                            this.data.pals.joinedLeaderboard && 
                            !allCodes.includes(this.data.pals.myPalCode)) {
                            allCodes.push(this.data.pals.myPalCode);
                        }
                        
                        // Fetch friends + user data, but ONLY include those who opted in
                        const friendsData = [];
                        for (const code of allCodes) {
                            const doc = await this.db.collection('users').doc(code).get();
                            if (doc.exists) {
                                const data = doc.data();
                                // ONLY add if they joined the leaderboard
                                if (data.joinedLeaderboard === true) {
                                    friendsData.push(doc);
                                }
                            }
                        }
                        
                        // If no friends have opted in, show message
                        if (friendsData.length === 0) {
                            listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">None of your friends have opted into leaderboards yet!</p>';
                            return;
                        }
                        
                        snapshot = { docs: friendsData };
                    }

                    const participants = [];
                    const today = new Date().toISOString().split('T')[0];

                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        
                        // Calculate days since last activity
                        const lastActivity = data.lastActivityDate || '';
                        const daysInactive = lastActivity ? this.daysBetween(lastActivity, today) : 999;
                        
                        // REMOVE users with 21+ days of inactivity
                        if (daysInactive >= 21) return;

                        // Weight leaderboard is optional per user
                        if (metric === 'weight' && !(data.joinWeightLeaderboard === true)) return;

                        let value = null;
                        let valueLbs = null;

                        if (metric === 'weight') {
                            // Leaderboard period toggle drives which weight % and lbs delta to use
                            if (period === 'week') {
                                value = (data.stats && data.stats.weightChangePctThisWeek !== undefined) ? data.stats.weightChangePctThisWeek : null;
                                valueLbs = (data.stats && data.stats.weightChangeLbsThisWeek !== undefined) ? data.stats.weightChangeLbsThisWeek : null;
                            } else if (period === 'month') {
                                value = (data.stats && data.stats.weightChangePctThisMonth !== undefined) ? data.stats.weightChangePctThisMonth : null;
                                valueLbs = (data.stats && data.stats.weightChangeLbsThisMonth !== undefined) ? data.stats.weightChangeLbsThisMonth : null;
                            } else {
                                value = (data.stats && data.stats.weightChangePctAllTime !== undefined) ? data.stats.weightChangePctAllTime : null;
                                valueLbs = (data.stats && data.stats.weightChangeLbsAllTime !== undefined) ? data.stats.weightChangeLbsAllTime : null;
                            }
                        } else {
                            value = data.stats?.[metric] ?? 0;
                        // Hide weight entries until at least one weigh-in exists
                        if (metric === 'weight' && (value === null || value === undefined)) return;

                        }

                        // Determine status indicator
                        let statusIndicator = '';
                        if (daysInactive === 0) {
                            statusIndicator = ''; // Logged today
                        } else if (daysInactive >= 2) {
                            statusIndicator = ''; // 2-20 days inactive
                        }
                        // 1 day = no indicator

                        participants.push({
                            palCode: data.palCode,
                            displayName: data.displayName || data.palCode,
                            value: value,
                            valueLbs: valueLbs,
                            isMe: data.palCode === this.data.pals.myPalCode,
                            statusIndicator: statusIndicator
                        });
                    });

                    // Handle empty leaderboard
                    if (participants.length === 0) {
                        listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No active users found. Join to be first!</p>';
                        return;
                    }

                    // Sort + rank participants
                    let rankedParticipants = [];
                    let unrankedParticipants = [];

                    if (metric === 'weight') {
                        rankedParticipants = participants.filter(p => p.value !== null && p.value !== undefined && !Number.isNaN(Number(p.value)));
                        unrankedParticipants = participants.filter(p => p.value === null || p.value === undefined || Number.isNaN(Number(p.value)));

                        // Weight: more negative (loss) ranks higher
                        rankedParticipants.sort((a, b) => Number(a.value) - Number(b.value));
                    } else {
                        // Steps/Distance: treat 0 or missing as "no data" (unranked, no rank number)
                        participants.forEach(p => {
                            const v = Number(p.value);
                            if (Number.isFinite(v) && v > 0) {
                                rankedParticipants.push(p);
                            } else {
                                unrankedParticipants.push(p);
                            }
                        });

                        rankedParticipants.sort((a, b) => Number(b.value) - Number(a.value));
                        // Keep unranked stable and readable
                        unrankedParticipants.sort((a, b) => String(a.displayName || '').localeCompare(String(b.displayName || '')));
                    }

                    // Competition ranking (1, 1, 3, ...)
                    let lastRankedValue = null;
                    let currentRank = 0;
                    let rankedCount = 0;

                    rankedParticipants.forEach(p => {
                        rankedCount += 1;
                        const v = Number(p.value);
                        const isTie = lastRankedValue !== null && Math.abs(v - lastRankedValue) < 1e-9;
                        if (!isTie) currentRank = rankedCount;
                        p.rank = currentRank;
                        lastRankedValue = v;
                    });

                    unrankedParticipants.forEach(p => { p.rank = ''; });

                    const orderedParticipants = [...rankedParticipants, ...unrankedParticipants];

                    // Get max value for progress bar scaling
                    const maxValue = (metric === 'weight')
                        ? Math.max(...rankedParticipants.map(p => Math.abs(Number(p.value))), 1)
                        : (rankedParticipants.length ? Number(rankedParticipants[0].value) : 1);

                    // Determine unit suffix
                    let suffix = '';
                    if (metric.includes('Distance')) {
                        suffix = ` ${unit}`;
                    } else if (metric.includes('Steps')) {
                        suffix = ' steps';
                    } else if (metric === 'weight') {
                        suffix = '';
                    }

                    // Render leaderboard items
                    listEl.innerHTML = orderedParticipants.map((p, index) => {
                        const rank = p.rank;
                        const progressPercent = (rank === '' || maxValue <= 0) ? 0 : ((metric === 'weight' ? Math.abs(Number(p.value ?? 0)) : Number(p.value ?? 0)) / maxValue) * 100;
                        const highlight = p.isMe ? 'highlight' : '';
                        
                        // Format weight change (% + lbs)
                        let displayValue = p.value;
                        if (metric === 'weight') {
                            if (p.value === null || p.value === undefined) {
                                displayValue = '--';
                            } else {
                                const n = Number(p.value);
                                const signedPct = (n > 0 ? `+${n.toFixed(1)}` : n.toFixed(1));
                                let lbsPart = '';
                                if (p.valueLbs !== null && p.valueLbs !== undefined) {
                                    const l = Number(p.valueLbs);
                                    const signedLbs = (l > 0 ? `+${l.toFixed(1)}` : l.toFixed(1));
                                    lbsPart = ` (${signedLbs} ${weightUnit})`;
                                }
                                displayValue = `${signedPct}%${lbsPart}`;
                            }
                        }

                        return `
                            <div class="leaderboard-item-card ${highlight}">
                                <div class="leaderboard-item-header">
                                    <span class="leaderboard-rank">${rank}</span>
                                    <span class="leaderboard-name">
                                        ${p.displayName}${p.isMe ? ' (You)' : ''} ${p.statusIndicator}
                                    </span>
                                    <span class="leaderboard-value">${displayValue}${suffix}</span>
                                </div>
                                <div class="leaderboard-progress-bar">
                                    <div class="leaderboard-progress-fill" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');

                } catch (error) {
                    console.error('Error loading leaderboard:', error);
                    listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">Error loading leaderboard. Try again!</p>';
                }
            },

            // ============================================
            // HABITS FEATURE FUNCTIONS
            // ============================================

            // Initialize habits UI
            initHabits() {
                if (!this.data.habits) {
                    this.data.habits = [];
                }
                this.renderHabits();
            },

            // Render habits list
            renderHabits() {
                const container = document.getElementById('habits-list');
                const addBtn = document.getElementById('add-habit-btn');
                
                if (!container) return; // Not on Goals screen
                
                if (this.data.habits.length === 0) {
                    container.innerHTML = '<p style="color: #6b7280; font-size: 14px; text-align: center; padding: 20px 0;">No habits yet. Add up to 3!</p>';
                    if (addBtn) addBtn.style.display = 'block';
                    return;
                }
                
                container.innerHTML = this.data.habits.map((habit, index) => {
                    const habitColor = habit.color || '#10b981';
                    return `
                    <div class="habit-item" id="habit-${habit.id}" style="background: #2d2d2d; padding: 8px 12px; border-radius: 8px;">
                        <!-- Display Mode -->
                        <div class="habit-display" id="habit-display-${habit.id}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <div style="width: 14px; height: 14px; border-radius: 3px; background: ${habitColor}; flex-shrink: 0;"></div>
                                    <div style="font-size: 13px; color: #e8e8e8; font-weight: 500;">${habit.name || 'Unnamed habit'}</div>
                                </div>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="app.editHabit(${habit.id})" 
                                            style="padding: 4px 8px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 5px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                        Edit
                                    </button>
                                    <button onclick="app.removeHabit(${habit.id})" 
                                            style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; width: 24px; height: 24px; padding: 0;"></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Edit Mode (hidden by default) -->
                        <div class="habit-edit" id="habit-edit-${habit.id}" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="habit-name-${habit.id}" value="${habit.name || ''}" 
                                       style="background: #1a1a1a; border: 1px solid #3d3d3d; color: #e8e8e8; padding: 6px 10px; border-radius: 6px; flex: 1; font-size: 14px;" 
                                       placeholder="Habit name...">
                                <button onclick="app.removeHabit(${habit.id})" 
                                        style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; width: 28px; height: 28px; flex-shrink: 0;"></button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <label style="font-size: 13px; color: #9ca3af;">Color:</label>
                                <input type="hidden" id="habit-color-${habit.id}" value="${habitColor}">
                                <div id="habit-color-display-${habit.id}" 
                                     onclick="app.openHabitColorPicker(${habit.id})"
                                     style="width: 40px; height: 28px; background: ${habitColor}; border: 1px solid #3d3d3d; border-radius: 6px; cursor: pointer;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <button onclick="app.cancelEditHabit(${habit.id})" 
                                        style="padding: 8px 12px; background: #3d3d3d; color: #e8e8e8; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                    Cancel
                                </button>
                                <button onclick="app.saveHabit(${habit.id})" 
                                        style="padding: 8px 12px; background: var(--primary-dark); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
                
                // Show/hide add button based on limit
                if (addBtn) {
                    addBtn.style.display = this.data.habits.length >= 3 ? 'none' : 'block';
                }
            },

            // Add new habit
            addHabit() {
                if (this.data.habits.length >= 3) {
                    alert('Maximum 3 habits reached!');
                    return;
                }

                // Prompt for habit name first
                let name = prompt('Enter habit name:');
                if (name === null) return; // cancelled
                name = name.trim();
                if (!name) {
                    alert('Habit name is required.');
                    return;
                }

                // Then prompt for color using the existing color wheel modal (same as App Theme)
                this.openColorWheel((color) => {
                    if (!color) return; // safety; modal cancel does not call callback
                    const newHabit = {
                        id: Date.now(),
                        name,
                        color,
                        completions: []
                    };

                    this.data.habits.push(newHabit);
                    this.saveData();
                    this.renderHabits();
                });
            },

            // Remove habit
            removeHabit(id) {
                if (confirm('Remove this habit?')) {
                    this.data.habits = this.data.habits.filter(h => h.id !== id);
                    this.saveData();
                    this.renderHabits();
                    this.renderCalendar();
                }
            },

            // Update habit name
            updateHabitName(id, name) {
                const habit = this.data.habits.find(h => h.id === id);
                if (habit) {
                    habit.name = name;
                    this.saveData();
                }
            },

            // Update habit frequency
            updateHabitFrequency(id, frequency) {
                const habit = this.data.habits.find(h => h.id === id);
                if (habit) {
                    habit.frequency = frequency;
                    this.saveData();
                }
            },

            // Edit habit - show edit mode
            editHabit(id) {
                document.getElementById(`habit-display-${id}`).style.display = 'none';
                document.getElementById(`habit-edit-${id}`).style.display = 'block';
            },

            // Cancel edit - return to display mode
            cancelEditHabit(id) {
                document.getElementById(`habit-display-${id}`).style.display = 'block';
                document.getElementById(`habit-edit-${id}`).style.display = 'none';
            },

            // Save individual habit
            saveHabit(id) {
                const habit = this.data.habits.find(h => h.id === id);
                if (!habit) return;
                
                // Get values from inputs
                const nameInput = document.getElementById(`habit-name-${id}`);
                const colorInput = document.getElementById(`habit-color-${id}`);
                
                if (nameInput) {
                    habit.name = nameInput.value;
                }
                
                if (colorInput) {
                    habit.color = colorInput.value;
                }
                
                // Save to localStorage
                this.saveData();
                
                // Re-render to show updated display mode
                this.renderHabits();
            },

            // Toggle habit completion for a date
            toggleHabitCompletion(habitId, dateStr) {
                const habit = this.data.habits.find(h => h.id === habitId);
                if (!habit) return;
                
                if (!habit.completions) habit.completions = [];
                
                const index = habit.completions.indexOf(dateStr);
                if (index > -1) {
                    habit.completions.splice(index, 1);
                } else {
                    habit.completions.push(dateStr);
                }
                
                this.saveData();
                this.renderCalendar();
            },

            // Get habits completed on a date
            getHabitsForDate(dateStr) {
                if (!this.data.habits) return [];
                return this.data.habits.filter(h => h.completions && h.completions.includes(dateStr));
            },

            // Theme Functions
            loadTheme() {
                const savedTheme = localStorage.getItem('appTheme') || 'blue';
                this.applyTheme(savedTheme);
            },

            setTheme(theme) {
                localStorage.setItem('appTheme', theme);
                this.applyTheme(theme);
            },

            applyTheme(theme) {
                // Remove all theme classes
                document.documentElement.removeAttribute('data-theme');
                
                // Apply new theme (blue is default, no attribute needed)
                if (theme !== 'blue') {
                    document.documentElement.setAttribute('data-theme', theme);
                }

                // Update active state in theme selector
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.getAttribute('data-theme') === theme) {
                        option.classList.add('active');
                    }
                });
            },

            // Color Palette Functions
            // Color Wheel Implementation
            selectedColor: '#2563eb',
            currentColorCallback: null,
            colorWheelCanvas: null,
            colorWheelCtx: null,
            
            // Draw color wheel on canvas
            drawColorWheel() {
                const canvas = document.getElementById('color-wheel-canvas');
                if (!canvas) return;
                
                this.colorWheelCanvas = canvas;
                this.colorWheelCtx = canvas.getContext('2d');
                
                const ctx = this.colorWheelCtx;
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = canvas.width / 2;
                
                // Draw color wheel
                for (let angle = 0; angle < 360; angle++) {
                    const startAngle = (angle - 1) * Math.PI / 180;
                    const endAngle = angle * Math.PI / 180;
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    ctx.closePath();
                    
                    const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                    gradient.addColorStop(0, 'white');
                    gradient.addColorStop(0.7, `hsl(${angle}, 100%, 50%)`);
                    gradient.addColorStop(1, `hsl(${angle}, 100%, 30%)`);
                    
                    ctx.fillStyle = gradient;
                    ctx.fill();
                }
                
                // Add click listener
                canvas.onclick = (e) => this.handleColorWheelClick(e);
            },
            
            // Handle color wheel click
            handleColorWheelClick(event) {
                const canvas = this.colorWheelCanvas;
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                // Check if click is within circle
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const radius = canvas.width / 2;
                
                if (distance > radius) return; // Outside circle
                
                // Get color at click position
                const imageData = this.colorWheelCtx.getImageData(x, y, 1, 1);
                const pixel = imageData.data;
                const color = `#${this.rgbToHex(pixel[0], pixel[1], pixel[2])}`;
                
                this.selectedColor = color;
                document.getElementById('selected-color-preview').style.background = color;
            },
            
            // Convert RGB to Hex
            rgbToHex(r, g, b) {
                return [r, g, b].map(x => {
                    const hex = x.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
            },
            
            // Open color wheel modal
            openColorWheel(callback) {
                this.currentColorCallback = callback;
                const modal = document.getElementById('color-wheel-modal');
                modal.style.display = 'flex';
                
                // Draw wheel after modal is visible
                setTimeout(() => this.drawColorWheel(), 50);
            },
            
            // Confirm color wheel selection
            confirmColorWheelSelection() {
                if (this.selectedColor && this.currentColorCallback) {
                    this.currentColorCallback(this.selectedColor);
                }
                this.closeColorWheel();
            },
            
            // Close color wheel modal
            closeColorWheel() {
                document.getElementById('color-wheel-modal').style.display = 'none';
                this.currentColorCallback = null;
            },
            
            // Open theme color picker
            openThemeColorPicker() {
                this.openColorWheel((color) => {
                    // Apply theme with selected color
                    this.applyCustomThemeColor(color);
                    this.data.themeColor = color; // Save as hex color
                    this.saveData();
                });
            },
            
            // Apply custom theme color
            applyCustomThemeColor(color) {
                // Convert hex to RGB for CSS variables
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                
                // Calculate darker shades
                const darkerR = Math.floor(r * 0.8);
                const darkerG = Math.floor(g * 0.8);
                const darkerB = Math.floor(b * 0.8);
                
                const darkestR = Math.floor(r * 0.6);
                const darkestG = Math.floor(g * 0.6);
                const darkestB = Math.floor(b * 0.6);
                
                // Apply to CSS variables
                document.documentElement.style.setProperty('--primary', color);
                document.documentElement.style.setProperty('--primary-light', color);
                document.documentElement.style.setProperty('--primary-dark', `rgb(${darkerR}, ${darkerG}, ${darkerB})`);
                document.documentElement.style.setProperty('--primary-darker', `rgb(${darkestR}, ${darkestG}, ${darkestB})`);
            },

            // Reset theme to default blue
            resetThemeToDefault() {
                // Clear custom theme color
                this.data.themeColor = 'blue';
                this.saveData();
                
                // Remove all theme attributes and custom styles
                document.documentElement.removeAttribute('data-theme');
                document.documentElement.style.removeProperty('--primary');
                document.documentElement.style.removeProperty('--primary-light');
                document.documentElement.style.removeProperty('--primary-dark');
                document.documentElement.style.removeProperty('--primary-darker');
                
                // Apply default blue theme
                this.applyTheme('blue');
                
                // Show confirmation
                alert('Theme reset to default blue!');
            },
            
            // Open habit color picker
            openHabitColorPicker(habitId) {
                this.openColorWheel((color) => {
                    const colorInput = document.getElementById(`habit-color-${habitId}`);
                    const colorDisplay = document.getElementById(`habit-color-display-${habitId}`);
                    if (colorInput) {
                        colorInput.value = color;
                    }
                    if (colorDisplay) {
                        colorDisplay.style.background = color;
                    }
                });
            }
        };

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>