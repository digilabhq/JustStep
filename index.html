<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#2563eb">
    <title>JustStep</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e8e8e8;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: #1a1a1a;
            min-height: 100vh;
            position: relative;
            padding-bottom: 70px;
        }

        /* App Logo Header */
        .app-header {
            background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
            padding: 10px 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: sticky;
            top: 0;
            z-index: 101;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
        }

        .app-logo {
            font-size: 24px;
        }

        .app-name {
            font-size: 22px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: #2d2d2d;
            border-bottom: 1px solid #3d3d3d;
            position: sticky;
            top: 56px;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 500;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .nav-tab.active {
            color: #60a5fa;
            border-bottom: 2px solid #2563eb;
        }

        .screen {
            display: none;
            padding: 12px;
            animation: fadeIn 0.3s;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Typography */
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.3px;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 14px;
            margin-bottom: 12px;
        }

        /* Daily Logging Screen */
        .date-selector {
            background: #2d2d2d;
            padding: 5px 8px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .date-selector span {
            filter: brightness(1.5) contrast(1.2);
        }

        .date-selector input {
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #e8e8e8;
            color-scheme: dark;
        }

        .activities-container {
            margin-bottom: 12px;
        }

        .activity-card {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 16px;
            padding: 5px;
            margin-bottom: 12px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        .activity-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .activity-card-title {
            font-size: 13px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remove-activity {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .remove-activity:hover {
            background: #3d1f1f;
            color: #ef4444;
        }

        .activity-type-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            background: #2d2d2d;
            color: #e8e8e8;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .activity-type-select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .activity-value-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .activity-value-input input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            background: #2d2d2d;
            color: #e8e8e8;
            color-scheme: dark;
        }

        .activity-value-input input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .activity-value-input .unit {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            min-width: 40px;
        }

        .add-activity-button {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            color: #60a5fa;
            border: 2px dashed #3d3d3d;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-activity-button:active {
            transform: scale(0.98);
            background: #1e3a5f;
        }

        .log-button {
            width: 100%;
            padding: 10px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .log-button:active {
            transform: scale(0.98);
            background: #1d4ed8;
        }

        .workout-confirmed {
            padding: 10px 12px;
            background: #1e3a5f;
            border-radius: 12px;
            color: #60a5fa;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
        }

        /* Dashboard Screen - Always 3 columns */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        /* Smaller cards on mobile for better fit */
        @media (max-width: 600px) {
            .stats-grid {
                gap: 8px;
            }
            
            .stat-card {
                padding: 5px 3px;
                min-height: 52px;
            }
            
            .stat-value {
                font-size: 15px;
            }
            
            .stat-label {
                font-size: 8px;
            }
        }

        .stat-card {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            padding: 5px 3px;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 60px;
            aspect-ratio: 1.4 / 1;
        }

        /* Gold border for custom/favorite cards */
        .stat-card#custom-card-1,
        .stat-card#custom-card-2,
        .stat-card#custom-card-3 {
            border-color: #d4af37;
        }

        .stat-star {
            font-size: 12px;
            margin-bottom: 2px;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #e8e8e8;
            margin-bottom: 3px;
            text-align: center;
            line-height: 1;
        }

        .stat-label {
            font-size: 9px;
            color: #9ca3af;
            text-transform: capitalize;
            letter-spacing: 0.2px;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }

        .stat-trend {
            font-size: 10px;
            margin-top: 2px;
            text-align: center;
        }

        .progress-card {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .progress-percentage {
            font-size: 24px;
            font-weight: 700;
            color: #60a5fa;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #3d3d3d;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
            border-radius: 8px;
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #9ca3af;
        }

        .milestone-list {
            margin-top: 12px;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #3d3d3d;
        }

        .milestone-item:last-child {
            border-bottom: none;
        }

        .milestone-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #2563eb;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
        }

        .milestone-text {
            font-size: 14px;
            font-weight: 500;
            color: #e8e8e8;
        }

        /* Activity Report (Collapsible) */
        .activity-report-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            font-size: 16px;
            font-weight: 700;
            color: #e8e8e8;
            padding: 4px 0;
        }

        .activity-report-toggle:hover {
            color: #60a5fa;
        }

        .activity-report-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .activity-report-content.expanded {
            max-height: 2000px;
        }

        .activity-summary-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .activity-summary-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 12px;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #2d2d2d;
            font-size: 13px;
        }

        .activity-summary-item:last-child {
            border-bottom: none;
        }

        .activity-summary-name {
            color: #9ca3af;
            font-weight: 600;
        }

        .activity-summary-value {
            color: #e8e8e8;
            font-weight: 600;
            text-align: right;
            min-width: 70px;
        }

        .activity-summary-value.week {
            color: #34d399;
        }

        .activity-summary-value.month {
            color: #60a5fa;
        }

        .activity-summary-value.total {
            color: #e8e8e8;
            font-weight: 700;
        }

        /* Calendar View */
        .calendar-header {
            text-align: center;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            color: #9ca3af;
        }

        .calendar-month-year {
            font-size: 20px;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-label {
            text-align: center;
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            padding: 5px 0;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            position: relative;
            cursor: pointer;
            color: #e8e8e8;
        }

        .calendar-day.has-activity {
            border-color: #2563eb;
            background: #1e3a5f;
        }

        .calendar-day.today {
            border-color: #60a5fa;
            font-weight: 700;
        }

        .calendar-day.other-month {
            color: #4b5563;
        }

        .activity-dots {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }

        .activity-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #2563eb;
        }

        /* Goals Screen */
        .goal-input {
            margin-bottom: 12px;
        }

        .goal-input label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #e8e8e8;
            margin-bottom: 8px;
        }

        .goal-description {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .goal-input input, .goal-input select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            background: #2d2d2d;
            color: #e8e8e8;
            color-scheme: dark;
        }

        .save-button {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            letter-spacing: 0.3px;
        }

        .save-button:active {
            transform: scale(0.98);
            background: #333;
        }

        .info-box {
            margin-top: 32px;
            padding: 5px;
            background: #2d2d2d;
            border-radius: 12px;
        }

        .info-box-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .info-box-content {
            font-size: 13px;
            color: #9ca3af;
            line-height: 1.8;
        }

        /* Milestone Notification */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        .milestone-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 320px;
            z-index: 1000;
            display: none;
        }

        .milestone-notification.show {
            display: block;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .milestone-icon-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #2563eb;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 40px;
        }

        .milestone-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .milestone-description {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .milestone-close {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .export-button {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            color: #e8e8e8;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            letter-spacing: 0.3px;
        }

        .export-button:active {
            transform: scale(0.98);
            background: #2d2d2d;
        }

        .success-message {
            background: #1e3a5f;
            color: #2563eb;
            padding: 5px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            display: none;
            text-align: center;
        }

        .success-message.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Day Detail Modal */
        .day-detail-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 360px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .day-detail-modal.show {
            display: block;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .day-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 16px;
            border-bottom: 2px solid #3d3d3d;
        }

        .day-detail-date {
            font-size: 20px;
            font-weight: 700;
            color: #e8e8e8;
        }

        .day-detail-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .day-detail-close:hover {
            background: #3d3d3d;
        }

        .day-activity-list {
            margin-bottom: 12px;
        }

        .day-activity-item {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #3d3d3d;
        }

        .day-activity-info {
            flex: 1;
        }

        .day-activity-type {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: capitalize;
            color: #e8e8e8;
            background: none !important;
        }

        .day-activity-value {
            font-size: 14px;
            color: #9ca3af;
        }

        .day-activity-delete {
            background: #3d1f1f;
            color: #ef4444;
            border: none;
            padding: 5px 8px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-activity-delete:hover {
            background: #4d2626;
            color: #f87171;
        }

        .day-totals {
            background: #1e3a5f;
            padding: 10px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .day-totals-title {
            font-size: 13px;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-totals-content {
            font-size: 14px;
            color: #e8e8e8;
            line-height: 1.8;
        }

        .empty-day {
            text-align: center;
            padding: 24px 12px;
            color: #6b7280;
        }

        .empty-day-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-day-text {
            font-size: 14px;
        }

        .calendar-hint {
            text-align: center;
            margin-top: 12px;
            margin-bottom: 12px;
            padding: 5px;
            background: #1e3a5f;
            border-radius: 12px;
            font-size: 13px;
            color: #60a5fa;
            font-weight: 500;
        }

        /* Stats Toggle */
        .stats-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            background: #2d2d2d;
            padding: 3px;
            border-radius: 12px;
            border: 2px solid #3d3d3d;
        }

        .stats-toggle-btn {
            flex: 1;
            padding: 6px 12px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .stats-toggle-btn.active {
            background: #2563eb;
            color: white;
        }

        /* Welcome Modal */
        .welcome-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .welcome-modal.show {
            display: block;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .welcome-header {
            background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
            margin: -20px -16px 16px -16px;
            padding: 16px;
            border-radius: 20px 20px 0 0;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 0;
            letter-spacing: -0.5px;
        }

        .welcome-quote {
            font-size: 20px;
            font-weight: 600;
            color: #60a5fa;
            margin: 16px 0;
            font-style: italic;
            line-height: 1.4;
        }

        .welcome-content {
            font-size: 15px;
            color: #d1d5db;
            line-height: 1.8;
            margin: 20px 0;
        }

        .welcome-highlight {
            font-size: 16px;
            font-weight: 600;
            color: #60a5fa;
            margin: 20px 0;
            line-height: 1.6;
        }

        .welcome-tagline {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            margin: 16px 0 24px 0;
            letter-spacing: 0.5px;
        }

        .welcome-video-link {
            display: inline-block;
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            transition: color 0.2s;
        }

        .welcome-video-link:hover {
            color: #3b82f6;
        }

        .welcome-button {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .welcome-button:active {
            transform: scale(0.98);
        }

        /* Customize Dashboard Button */
        .customize-dashboard-btn {
            display: block;
            margin: -20px auto 0;
            background: none;
            border: none;
            color: #d4af37;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 16px;
            transition: color 0.2s;
            text-align: center;
        }

        .customize-dashboard-btn:hover {
            color: #c9a332;
        }

        /* Customize Modal */
        .customize-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            z-index: 1500;
            display: none;
        }

        .customize-modal.show {
            display: block;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .customize-modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #e8e8e8;
        }

        .customize-slot {
            margin-bottom: 12px;
        }

        .customize-slot-label {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 8px;
            display: block;
        }

        .customize-slot select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            background: #1a1a1a;
            color: #e8e8e8;
            cursor: pointer;
        }

        .customize-slot select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .customize-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .customize-modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .customize-modal-btn.save {
            background: #2563eb;
            color: white;
        }

        .customize-modal-btn.save:active {
            transform: scale(0.98);
            background: #1d4ed8;
        }

        .customize-modal-btn.cancel {
            background: #3d3d3d;
            color: #e8e8e8;
        }

        .customize-modal-btn.cancel:active {
            transform: scale(0.98);
            background: #4d4d4d;
        }

        /* Weight Input Styles */
        .weight-input-section {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 16px;
            padding: 5px;
            margin-top: 32px;
            margin-bottom: 12px;
        }

        .weight-input-header {
            font-size: 13px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .weight-input-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .weight-input-field {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #3d3d3d;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            background: #1a1a1a;
            color: #e8e8e8;
        }

        .weight-input-field:focus {
            outline: none;
            border-color: #2563eb;
        }

        .weight-unit-label {
            font-size: 16px;
            font-weight: 600;
            color: #9ca3af;
            min-width: 40px;
        }

        .weight-save-btn {
            padding: 14px 24px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-save-btn:active {
            transform: scale(0.98);
            background: #1d4ed8;
        }

        .weight-save-btn-subtle {
            padding: 8px 16px;
            background: transparent;
            color: #60a5fa;
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
            width: 100%;
        }

        .weight-save-btn-subtle:hover {
            background: #1e3a5f;
            border-color: #60a5fa;
        }

        .weight-save-btn-subtle:active {
            transform: scale(0.98);
        }

        /* Trending Indicators */
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
        }

        .trend-indicator.up {
            color: #10b981;
        }

        .trend-indicator.down {
            color: #ef4444;
        }

        .trend-indicator.stable {
            color: #6b7280;
        }

        /* Bar Graph Comparison Styles */
        .comparison-section {
            background: #2d2d2d;
            border: 2px solid #3d3d3d;
            border-radius: 16px;
            padding: 10px;
            margin-bottom: 12px;
        }

        .comparison-header {
            font-size: 15px;
            font-weight: 700;
            color: #e8e8e8;
            margin-bottom: 12px;
            letter-spacing: -0.3px;
        }

        .comparison-graph {
            margin-bottom: 12px;
        }

        .comparison-graph:last-child {
            margin-bottom: 0;
        }

        .comparison-title {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .bar-label {
            font-size: 13px;
            font-weight: 600;
            color: #9ca3af;
            min-width: 80px;
        }

        .bar-container {
            flex: 1;
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .bar-fill.current-period {
            background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
        }

        .bar-fill.previous-period {
            background: linear-gradient(90deg, #6b7280 0%, #9ca3af 100%);
        }

        .bar-value {
            font-size: 12px;
            font-weight: 700;
            color: #e8e8e8;
            min-width: 45px;
            text-align: right;
        }

        /* Number Count-Up Animation */
        .stat-card-value {
            animation: countUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Weight History Expandable Section */
        .weight-history-toggle {
            font-size: 12px;
            color: #60a5fa;
            cursor: pointer;
            margin-top: 6px;
            text-align: center;
            font-weight: 600;
            user-select: none;
        }

        .weight-history-toggle:hover {
            color: #3b82f6;
        }

        .weight-history-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0;
        }

        .weight-history-list.expanded {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
            border-top: 1px solid #3d3d3d;
            padding-top: 12px;
        }

        .weight-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #2d2d2d;
            font-size: 13px;
        }

        .weight-entry:last-child {
            border-bottom: none;
        }

        .weight-entry-date {
            color: #9ca3af;
            font-weight: 600;
            min-width: 80px;
        }

        .weight-entry-value {
            color: #e8e8e8;
            font-weight: 700;
            flex: 1;
            text-align: center;
        }

        .weight-entry-actions {
            display: flex;
            gap: 6px;
        }

        .weight-entry-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-entry-edit {
            background: #1e3a5f;
            color: #60a5fa;
        }

        .weight-entry-edit:hover {
            background: #2d5a8f;
        }

        .weight-entry-delete {
            background: #3d1f1f;
            color: #ef4444;
        }

        .weight-entry-delete:hover {
            background: #4d2626;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <span class="app-name">JustStep</span>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="app.showScreen('log')">Tracker</button>
            <button class="nav-tab" onclick="app.showScreen('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="app.showScreen('calendar')">Calendar</button>
            <button class="nav-tab" onclick="app.showScreen('goals')">Goals</button>
        </div>

        <!-- Daily Logging Screen -->
        <div id="log-screen" class="screen active">
            <h1>Track Activity</h1>
            <p class="subtitle">Record today's workout</p>

            <div class="date-selector">
                <span>ðŸ“…</span>
                <input type="date" id="log-date" value="">
            </div>

            <div id="activities-container" class="activities-container">
                <!-- Activity cards will be added here -->
            </div>

            <button class="add-activity-button" onclick="app.addActivityRow()">
                <span style="font-size: 20px; margin-right: 8px;">+</span>
                Add Activity
            </button>

            <button class="log-button" onclick="app.saveLog()">Save Activity</button>

            <!-- Weight Input Section -->
            <div class="weight-input-section">
                <div class="weight-input-header">Track Weight</div>
                <div class="weight-input-row">
                    <input type="number" 
                           id="weight-input" 
                           class="weight-input-field" 
                           placeholder="Enter weight" 
                           step="0.1"
                           min="0"
                           inputmode="decimal">
                    <span class="weight-unit-label" id="weight-unit-display">lbs</span>
                </div>
                <button class="weight-save-btn-subtle" onclick="app.logWeight()">Save</button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="screen">
            <h1>Dashboard</h1>
            <p class="subtitle">Your progress overview</p>

            <div class="stats-toggle">
                <button class="stats-toggle-btn active" onclick="app.setStatsView('week')">This Week</button>
                <button class="stats-toggle-btn" onclick="app.setStatsView('total')">All Time</button>
            </div>

            <div class="stats-grid">
                <!-- Row 1: Fixed Cards -->
                <div class="stat-card">
                    <div class="stat-value" id="stat-miles">0</div>
                    <div class="stat-label" id="stat-miles-label">Miles</div>
                    <div class="stat-trend" id="stat-miles-trend"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-workouts">0</div>
                    <div class="stat-label" id="stat-workouts-label">Strength Days</div>
                    <div class="stat-trend" id="stat-workouts-trend"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-steps">0</div>
                    <div class="stat-label" id="stat-steps-label">Steps</div>
                    <div class="stat-trend" id="stat-steps-trend"></div>
                </div>
                
                <!-- Row 2: Custom Cards (dynamically rendered) -->
                <div class="stat-card" id="custom-card-1">
                    <div class="stat-value" id="custom-stat-1">0</div>
                    <div class="stat-label" id="custom-label-1">Push-ups</div>
                    <div class="stat-trend" id="custom-trend-1"></div>
                </div>
                <div class="stat-card" id="custom-card-2">
                    <div class="stat-value" id="custom-stat-2">0</div>
                    <div class="stat-label" id="custom-label-2">Pull-ups</div>
                    <div class="stat-trend" id="custom-trend-2"></div>
                </div>
                <div class="stat-card" id="custom-card-3">
                    <div class="stat-value" id="custom-stat-3">0</div>
                    <div class="stat-label" id="custom-label-3">Roller Abs</div>
                    <div class="stat-trend" id="custom-trend-3"></div>
                </div>
            </div>

            <button class="customize-dashboard-btn" onclick="app.openCustomizeModal()">Customize Favorites</button>

            <!-- Comparison Bar Graphs -->
            <div class="comparison-section">
                <div class="comparison-header">Progress Comparison</div>
                
                <div class="comparison-graph">
                    <div class="comparison-title">This Week vs Last Week</div>
                    <div class="bar-row">
                        <div class="bar-label">This Week</div>
                        <div class="bar-container">
                            <div class="bar-fill current-period" id="week-current-bar" style="width: 0%"></div>
                        </div>
                        <div class="bar-value" id="week-current-value">0</div>
                    </div>
                    <div class="bar-row">
                        <div class="bar-label">Last Week</div>
                        <div class="bar-container">
                            <div class="bar-fill previous-period" id="week-previous-bar" style="width: 0%"></div>
                        </div>
                        <div class="bar-value" id="week-previous-value">0</div>
                    </div>
                </div>

                <div class="comparison-graph">
                    <div class="comparison-title">This Month vs Last Month</div>
                    <div class="bar-row">
                        <div class="bar-label">This Month</div>
                        <div class="bar-container">
                            <div class="bar-fill current-period" id="month-current-bar" style="width: 0%"></div>
                        </div>
                        <div class="bar-value" id="month-current-value">0</div>
                    </div>
                    <div class="bar-row">
                        <div class="bar-label">Last Month</div>
                        <div class="bar-container">
                            <div class="bar-fill previous-period" id="month-previous-bar" style="width: 0%"></div>
                        </div>
                        <div class="bar-value" id="month-previous-value">0</div>
                    </div>
                </div>
            </div>

            <!-- Weight Summary (if weight data exists) -->
            <div class="progress-card" id="weight-summary-card" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 0;">
                    <span class="progress-title" style="margin: 0;">Weight</span>
                    <div style="display: flex; align-items: baseline; gap: 6px;">
                        <div style="font-size: 32px; font-weight: 700; color: #e8e8e8;" id="weight-display-value">--</div>
                        <div style="font-size: 14px; color: #9ca3af;" id="weight-display-unit">lbs</div>
                        <div id="weight-trend-indicator"></div>
                    </div>
                </div>
                
                <!-- Weight History Toggle -->
                <div class="weight-history-toggle" id="weight-history-toggle" onclick="app.toggleWeightHistory()">
                    View History â–¼
                </div>
                
                <!-- Weight History List (expandable) -->
                <div class="weight-history-list" id="weight-history-list">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <div class="progress-card">
                <div class="progress-header">
                    <span class="progress-title">Annual Goal</span>
                    <span class="progress-percentage" id="annual-progress-percent">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="annual-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-details">
                    <span id="annual-progress-current">0</span>
                    <span id="annual-progress-goal">420</span>
                </div>
            </div>
        </div>

        <!-- Calendar Screen -->
        <div id="calendar-screen" class="screen">
            <div class="calendar-header">
                <button class="calendar-nav" onclick="app.changeMonth(-1)">â€¹</button>
                <div class="calendar-month-year" id="calendar-month-year">January 2026</div>
                <button class="calendar-nav" onclick="app.changeMonth(1)">â€º</button>
            </div>

            <div class="calendar-grid" id="calendar-grid">
                <!-- Calendar will be generated here -->
            </div>

            <div class="calendar-hint">
                ðŸ’¡ Tap any day to see details
            </div>

            <!-- Activity Report (Collapsible) -->
            <div class="progress-card">
                <div class="activity-report-toggle" id="activity-report-toggle" onclick="app.toggleActivityReport()">
                    <span>Activity Report</span>
                    <span>â–¼</span>
                </div>
                <div class="activity-report-content" id="activity-report-content">
                    <div class="activity-summary-list" id="activity-summary-list">
                        <p style="text-align: center; color: #6b7280; font-size: 14px;">No activities logged yet.</p>
                    </div>
                </div>
            </div>

            <h2>Recent Milestones</h2>
            <div class="progress-card">
                <div class="milestone-list" id="milestone-list">
                    <p style="text-align: center; color: #6b7280; font-size: 14px;">No milestones yet. Keep going!</p>
                </div>
            </div>
        </div>

        <!-- Goals Screen -->
        <div id="goals-screen" class="screen">
            <h1>Goals</h1>
            <p class="subtitle">Customize your goals and preferences</p>

            <div class="goal-input">
                <label>Unit Preference</label>
                <p class="goal-description">Choose your preferred distance unit</p>
                <select id="unit-preference">
                    <option value="miles">Miles</option>
                    <option value="km">Kilometers</option>
                </select>
            </div>

            <div class="goal-input">
                <label>Weight Unit</label>
                <p class="goal-description">Choose your preferred weight unit</p>
                <select id="weight-unit-preference">
                    <option value="lbs">Pounds (lbs)</option>
                    <option value="kg">Kilograms (kg)</option>
                </select>
            </div>

            <div class="goal-input">
                <label>Annual Mileage Goal</label>
                <p class="goal-description">Total distance goal for the year</p>
                <input type="number" id="annual-goal" value="420" placeholder="420" inputmode="numeric">
            </div>

            <div class="goal-input">
                <label>Strength Days Target</label>
                <p class="goal-description">How many strength days per week?</p>
                <input type="number" id="workout-frequency" value="5" placeholder="5" inputmode="numeric">
            </div>

            <div class="goal-input">
                <label>Monthly Mileage Target</label>
                <p class="goal-description">Optional: Set a monthly milestone</p>
                <input type="number" id="monthly-goal" value="35" placeholder="35" inputmode="numeric">
            </div>

            <button class="save-button" onclick="app.saveGoals()">Save Settings</button>
            <div class="success-message" id="settings-success">Settings saved successfully!</div>

            <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="app.handleImportFile(event)">
            <button class="export-button" onclick="document.getElementById('import-file-input').click()">Import Data</button>
            <button class="export-button" onclick="app.exportData()">Export All Data</button>
            <div class="success-message" id="import-success">Data imported successfully!</div>
            
            <div style="text-align: center; color: #6b7280; font-size: 12px; margin-top: 32px; padding: 16px 0;">
                v1.5.2
            </div>
        </div>
    </div>

    <!-- Milestone Notification -->
    <div class="overlay" id="overlay" onclick="app.closeMilestone()"></div>
    <div class="milestone-notification" id="milestone-notification">
        <div class="milestone-icon-large" id="milestone-icon">ðŸŽ¯</div>
        <div class="milestone-title" id="milestone-title">Milestone Reached</div>
        <div class="milestone-description" id="milestone-description">Great work!</div>
        <button class="milestone-close" onclick="app.closeMilestone()">Continue</button>
    </div>

    <!-- Day Detail Modal -->
    <div class="overlay" id="day-overlay" onclick="app.closeDayDetail()"></div>
    <div class="day-detail-modal" id="day-detail-modal">
        <div class="day-detail-header">
            <div class="day-detail-date" id="day-detail-date">January 15, 2026</div>
            <button class="day-detail-close" onclick="app.closeDayDetail()">Ã—</button>
        </div>
        <div id="day-detail-content">
            <!-- Content will be populated dynamically -->
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="overlay" id="welcome-overlay"></div>
    <div class="welcome-modal" id="welcome-modal">
        <div class="welcome-header">
            <div class="welcome-title">Welcome to JustStep</div>
        </div>
        
        <div class="welcome-content">
            Success isn't comfortable. Every workout, every mile, every rep you log here is a <span style="color: white; font-weight: 700;">S</span>tep closer to your goals!
            <br><br>
            <span style="color: white; font-weight: 700;">J</span>ust take the next <span style="color: white; font-weight: 700;">S</span>tep.
        </div>
        
        <div class="welcome-highlight">
            The magic you are looking for is in the work you just did.
        </div>
        
        <div class="welcome-tagline">
            Track it. Own it. Grow.
        </div>
        
        <a href="https://www.youtube.com/watch?v=ZuHHYRD6AHQ&t=0" target="_blank" class="welcome-video-link">
            Watch â†’ To Grow, You Must Suffer
        </a>
        
        <button class="welcome-button" onclick="app.closeWelcome()">Let's Go</button>
    </div>

    <!-- Customize Dashboard Modal -->
    <div class="overlay" id="customize-overlay" onclick="app.closeCustomizeModal()"></div>
    <div class="customize-modal" id="customize-modal">
        <div class="customize-modal-header">â­ Customize Your Favorites</div>
        
        <div class="customize-slot">
            <label class="customize-slot-label">Favorite 1</label>
            <select id="custom-slot-1">
                <optgroup label="â”€â”€â”€ CARDIO â”€â”€â”€">
                    <option value="biking">Biking</option>
                    <option value="dog">Dog Walking</option>
                    <option value="hiking">Hiking</option>
                    <option value="run">Running</option>
                    <option value="stairs">Master Stairs</option>
                    <option value="walk">Walking</option>
                </optgroup>
                <optgroup label="â”€â”€â”€ EXERCISES â”€â”€â”€">
                    <option value="dips">Dips</option>
                    <option value="pullups">Pull-ups</option>
                    <option value="pushups">Push-ups</option>
                    <option value="rollerabs">Roller Abs</option>
                    <option value="situps">Sit-ups</option>
                    <option value="squats">Squats</option>
                </optgroup>
                <optgroup label="â”€â”€â”€ TRACKING â”€â”€â”€">
                    <option value="weight">Weight</option>
                </optgroup>
            </select>
        </div>
        
        <div class="customize-slot">
            <label class="customize-slot-label">Favorite 2</label>
            <select id="custom-slot-2">
                <optgroup label="â”€â”€â”€ CARDIO â”€â”€â”€">
                    <option value="biking">Biking</option>
                    <option value="dog">Dog Walking</option>
                    <option value="hiking">Hiking</option>
                    <option value="run">Running</option>
                    <option value="stairs">Master Stairs</option>
                    <option value="walk">Walking</option>
                </optgroup>
                <optgroup label="â”€â”€â”€ EXERCISES â”€â”€â”€">
                    <option value="dips">Dips</option>
                    <option value="pullups">Pull-ups</option>
                    <option value="pushups">Push-ups</option>
                    <option value="rollerabs">Roller Abs</option>
                    <option value="situps">Sit-ups</option>
                    <option value="squats">Squats</option>
                </optgroup>
                <optgroup label="â”€â”€â”€ TRACKING â”€â”€â”€">
                    <option value="weight">Weight</option>
                </optgroup>
            </select>
        </div>
        
        <div class="customize-slot">
            <label class="customize-slot-label">Favorite 3</label>
            <select id="custom-slot-3">
                <optgroup label="â”€â”€â”€ CARDIO â”€â”€â”€">
                    <option value="biking">Biking</option>
                    <option value="dog">Dog Walking</option>
                    <option value="hiking">Hiking</option>
                    <option value="run">Running</option>
                    <option value="stairs">Master Stairs</option>
                    <option value="walk">Walking</option>
                </optgroup>
                <optgroup label="â”€â”€â”€ EXERCISES â”€â”€â”€">
                    <option value="dips">Dips</option>
                    <option value="pullups">Pull-ups</option>
                    <option value="pushups">Push-ups</option>
                    <option value="rollerabs">Roller Abs</option>
                    <option value="situps">Sit-ups</option>
                    <option value="squats">Squats</option>
                </optgroup>
                <optgroup label="â”€â”€â”€ TRACKING â”€â”€â”€">
                    <option value="weight">Weight</option>
                </optgroup>
            </select>
        </div>
        
        <div class="customize-modal-buttons">
            <button class="customize-modal-btn cancel" onclick="app.closeCustomizeModal()">Cancel</button>
            <button class="customize-modal-btn save" onclick="app.saveCustomCards()">Save Favorites</button>
        </div>
    </div>

    <script>
        // App Version
        const APP_VERSION = '1.5.0';
        
        // Main App Object
        const app = {
            data: {
                activities: [], // All logged activities
                weights: [], // Weight tracking: { date, weight, unit }
                goals: {
                    annualMiles: 420,
                    workoutFrequency: 5,
                    monthlyMiles: 35,
                    unitPreference: 'miles',
                    weightUnit: 'lbs'
                },
                milestones: [],
                currentView: {
                    screen: 'log',
                    statsView: 'week', // 'week' or 'total'
                    calendarMonth: new Date().getMonth(),
                    calendarYear: new Date().getFullYear()
                },
                customDashboardCards: ['pushups', 'pullups', 'rollerabs'] // Row 2 customizable cards
            },
            activityCounter: 0,

            // Initialize app
            init() {
                console.log(`%cJustStep v${APP_VERSION}`, 'color: #2563eb; font-weight: bold; font-size: 14px;');
                this.loadData();
                // Ensure statsView is set before updating dashboard
                if (!this.data.currentView.statsView) {
                    this.data.currentView.statsView = 'week';
                }
                this.checkWelcome();
                this.setupLogDate();
                this.updateWeightInputDisplay();
                this.addActivityRow();
                this.updateDashboard();
                this.renderCalendar();
                this.updateGoalsUI();
                this.registerServiceWorker();
            },

            // Register service worker for auto-updates
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registered');
                            
                            // Check for updates every time app is opened
                            registration.update();
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }
            },

            // Check if welcome modal should show
            checkWelcome() {
                // Show welcome modal every time app opens
                document.getElementById('welcome-overlay').classList.add('show');
                document.getElementById('welcome-modal').classList.add('show');
            },

            // Close welcome modal
            closeWelcome() {
                document.getElementById('welcome-overlay').classList.remove('show');
                document.getElementById('welcome-modal').classList.remove('show');
            },

            // Load data from localStorage
            loadData() {
                const saved = localStorage.getItem('justStepData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.data = { ...this.data, ...parsed };
                    // Ensure statsView exists (for users upgrading from old version)
                    if (!this.data.currentView.statsView) {
                        this.data.currentView.statsView = 'week';
                    }
                    // Ensure customDashboardCards exists (for users upgrading from v1.2.0)
                    if (!this.data.customDashboardCards) {
                        this.data.customDashboardCards = ['pushups', 'pullups', 'rollerabs'];
                    }
                    // Ensure weights array exists (for users upgrading to v1.4.0)
                    if (!this.data.weights) {
                        this.data.weights = [];
                    }
                    // Ensure weightUnit exists (for users upgrading to v1.4.0)
                    if (!this.data.goals.weightUnit) {
                        this.data.goals.weightUnit = 'lbs';
                    }
                }
            },

            // Save data to localStorage
            saveData() {
                localStorage.setItem('justStepData', JSON.stringify(this.data));
            },

            // Setup log date input (FIXED: timezone-safe)
            setupLogDate() {
                const dateInput = document.getElementById('log-date');
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            },

            // Add activity row
            addActivityRow() {
                this.activityCounter++;
                const container = document.getElementById('activities-container');
                const isFirst = this.activityCounter === 1;
                
                const activityCard = document.createElement('div');
                activityCard.className = 'activity-card';
                activityCard.id = `activity-${this.activityCounter}`;
                
                activityCard.innerHTML = `
                    <div class="activity-card-header">
                        <span class="activity-card-title">Activity ${this.activityCounter}</span>
                        <button class="remove-activity" onclick="app.removeActivity(${this.activityCounter})" ${isFirst ? 'style="visibility: hidden;"' : ''}>Ã—</button>
                    </div>
                    
                    <select class="activity-type-select" id="type-${this.activityCounter}" onchange="app.updateActivityInputs(${this.activityCounter}, this.value)">
                        <option value="">Select activity type...</option>
                        <optgroup label="â”€â”€â”€ CARDIO â”€â”€â”€">
                            <option value="biking">Biking</option>
                            <option value="dog">Dog Walking</option>
                            <option value="hiking">Hiking</option>
                            <option value="run">Running</option>
                            <option value="stairs">Master Stairs</option>
                            <option value="walk">Walking</option>
                        </optgroup>
                        <optgroup label="â”€â”€â”€ STRENGTH â”€â”€â”€">
                            <option value="arm">Arm Day</option>
                            <option value="back">Back Day</option>
                            <option value="chest">Chest Day</option>
                            <option value="core">Core Day</option>
                            <option value="fullbody">Full Body Day</option>
                            <option value="leg">Leg Day</option>
                            <option value="shoulder">Shoulder Day</option>
                        </optgroup>
                        <optgroup label="â”€â”€â”€ SINGLE EXERCISE â”€â”€â”€">
                            <option value="dips">Dips</option>
                            <option value="pullups">Pull-ups</option>
                            <option value="pushups">Push-ups</option>
                            <option value="rollerabs">Roller Abs</option>
                            <option value="situps">Sit-ups</option>
                            <option value="squats">Squats</option>
                        </optgroup>
                        <optgroup label="â”€â”€â”€ STEPS â”€â”€â”€">
                            <option value="steps">Steps</option>
                        </optgroup>
                    </select>
                    
                    <div id="value-input-${this.activityCounter}">
                        <!-- Value input will be inserted here -->
                    </div>
                `;
                
                container.appendChild(activityCard);
            },

            // Update activity inputs based on type
            updateActivityInputs(id, activityType) {
                const valueContainer = document.getElementById(`value-input-${id}`);
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                if (!activityType) {
                    valueContainer.innerHTML = '';
                    return;
                }
                
                // For cardio activities (distance-based)
                if (['walk', 'run', 'dog', 'hiking', 'biking'].includes(activityType)) {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" step="0.1" placeholder="0.0" id="value-${id}" inputmode="decimal" />
                            <span class="unit">${unit}</span>
                        </div>
                    `;
                }
                // For stairs (floors)
                else if (activityType === 'stairs') {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                            <span class="unit">floors</span>
                        </div>
                    `;
                }
                // For steps
                else if (activityType === 'steps') {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                            <span class="unit">steps</span>
                        </div>
                    `;
                }
                // For push-ups, pull-ups, roller abs, dips, squats, sit-ups
                else if (['pushups', 'pullups', 'rollerabs', 'dips', 'squats', 'situps'].includes(activityType)) {
                    valueContainer.innerHTML = `
                        <div class="activity-value-input">
                            <input type="number" placeholder="0" id="value-${id}" inputmode="numeric" />
                            <span class="unit">reps</span>
                        </div>
                    `;
                }
                // For workout days - no value input needed, but show nothing to avoid confusion
                else {
                    valueContainer.innerHTML = '';
                }
            },

            // Remove activity row
            removeActivity(id) {
                const activityCard = document.getElementById(`activity-${id}`);
                activityCard.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    activityCard.remove();
                }, 300);
            },

            // Save log
            saveLog() {
                const date = document.getElementById('log-date').value;
                if (!date) {
                    alert('Please select a date');
                    return;
                }

                const activities = [];
                const baseTimestamp = Date.now(); // Get timestamp once at start
                
                for (let i = 1; i <= this.activityCounter; i++) {
                    const typeElement = document.getElementById(`type-${i}`);
                    if (!typeElement) continue;
                    
                    const type = typeElement.value;
                    if (!type) continue;

                    const activity = {
                        date: date,
                        type: type,
                        timestamp: new Date(baseTimestamp + i).toISOString() // Add i milliseconds to ensure uniqueness
                    };

                    // Get value for cardio and reps-based exercises
                    const valueElement = document.getElementById(`value-${i}`);
                    if (valueElement) {
                        const value = parseFloat(valueElement.value);
                        if (value && value > 0) {
                            if (['walk', 'run', 'dog', 'hiking', 'biking'].includes(type)) {
                                // Convert to km for storage if in miles
                                activity.distance = this.data.goals.unitPreference === 'miles' ? value * 1.60934 : value;
                            } else if (type === 'stairs') {
                                activity.floors = value;
                            } else if (type === 'steps') {
                                activity.steps = value;
                            } else if (['pushups', 'pullups', 'rollerabs', 'dips', 'squats', 'situps'].includes(type)) {
                                activity.reps = value;
                            }
                        } else if (['walk', 'run', 'dog', 'hiking', 'biking', 'stairs', 'steps', 'pushups', 'pullups', 'rollerabs', 'dips', 'squats', 'situps'].includes(type)) {
                            continue; // Skip if no value entered for activities that need it
                        }
                    }

                    activities.push(activity);
                }

                if (activities.length === 0) {
                    alert('Please add at least one activity');
                    return;
                }

                // Add to data
                this.data.activities.push(...activities);
                this.saveData();

                // Check for milestones
                this.checkMilestones();

                // Clear form
                document.getElementById('activities-container').innerHTML = '';
                this.activityCounter = 0;
                this.addActivityRow();

                // Update UI
                this.updateDashboard();
                this.renderCalendar();

                // Show success
                alert('Activity logged successfully!');
            },

            // Check for milestones
            checkMilestones() {
                const stats = this.calculateStats();
                const newMilestones = [];

                // Check mileage milestones (every 50)
                const milesAchieved = Math.floor(stats.totalDistance / 50) * 50;
                const lastMilageMilestone = this.data.milestones.filter(m => m.type === 'mileage').reduce((max, m) => Math.max(max, m.value), 0);
                
                if (milesAchieved > lastMilageMilestone && milesAchieved > 0) {
                    const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                    newMilestones.push({
                        type: 'mileage',
                        value: milesAchieved,
                        date: new Date().toISOString(),
                        icon: 'ðŸŽ¯',
                        title: `${milesAchieved} ${unit} Reached!`,
                        description: `You've logged ${milesAchieved} ${unit}. Keep up the great work!`
                    });
                }

                // Check strength day milestones (every 25 days)
                const strengthDaysAchieved = Math.floor(stats.totalStrengthDays / 25) * 25;
                const lastStrengthDayMilestone = this.data.milestones.filter(m => m.type === 'workout').reduce((max, m) => Math.max(max, m.value), 0);
                
                if (strengthDaysAchieved > lastStrengthDayMilestone && strengthDaysAchieved > 0) {
                    newMilestones.push({
                        type: 'workout',
                        value: strengthDaysAchieved,
                        date: new Date().toISOString(),
                        icon: 'ðŸ’ª',
                        title: `${strengthDaysAchieved} Strength Days Completed!`,
                        description: `Amazing consistency! You've trained on ${strengthDaysAchieved} different days.`
                    });
                }

                // Add new milestones and show notification
                if (newMilestones.length > 0) {
                    this.data.milestones.push(...newMilestones);
                    this.saveData();
                    this.showMilestone(newMilestones[0]);
                }
            },

            // Show milestone notification
            showMilestone(milestone) {
                document.getElementById('milestone-icon').textContent = milestone.icon;
                document.getElementById('milestone-title').textContent = milestone.title;
                document.getElementById('milestone-description').textContent = milestone.description;
                document.getElementById('overlay').classList.add('show');
                document.getElementById('milestone-notification').classList.add('show');
            },

            // Close milestone
            closeMilestone() {
                document.getElementById('overlay').classList.remove('show');
                document.getElementById('milestone-notification').classList.remove('show');
            },

            // Calculate stats
            calculateStats() {
                const now = new Date();
                now.setHours(23, 59, 59, 999); // Set to end of today for comparisons
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                
                // ============================================
                // DATE PERIOD DEFINITIONS (v1.5.2)
                // ============================================
                
                // THIS CALENDAR WEEK (Sunday - Today)
                // For display: "This Week" toggle shows current calendar week progress
                const thisWeekStart = new Date(now);
                thisWeekStart.setDate(now.getDate() - now.getDay()); // This Sunday at midnight
                thisWeekStart.setHours(0, 0, 0, 0);
                
                // PREVIOUS CALENDAR WEEK (Last Sunday - Last Saturday)
                // For trending: Compare this week vs same full previous week
                const prevWeekStart = new Date(thisWeekStart);
                prevWeekStart.setDate(prevWeekStart.getDate() - 7); // Previous Sunday
                prevWeekStart.setHours(0, 0, 0, 0);
                
                const prevWeekEnd = new Date(thisWeekStart);
                prevWeekEnd.setDate(prevWeekEnd.getDate() - 1); // Last Saturday
                prevWeekEnd.setHours(23, 59, 59, 999);
                
                // ============================================
                // TRACKING VARIABLES
                // ============================================
                
                // Total (all-time)
                let totalDistance = 0;
                let totalSteps = 0;
                let totalPushups = 0;
                let totalPullups = 0;
                let totalRollerAbs = 0;
                let totalDips = 0;
                let totalSquats = 0;
                let totalSitups = 0;
                let totalBiking = 0;
                let totalDogWalk = 0;
                let totalHiking = 0;
                let totalRunning = 0;
                let totalWalking = 0;
                let totalStairs = 0;
                
                // This calendar week (for display)
                let thisWeekDistance = 0;
                let thisWeekSteps = 0;
                let thisWeekPushups = 0;
                let thisWeekPullups = 0;
                let thisWeekRollerAbs = 0;
                let thisWeekDips = 0;
                let thisWeekSquats = 0;
                let thisWeekSitups = 0;
                let thisWeekBiking = 0;
                let thisWeekDogWalk = 0;
                let thisWeekHiking = 0;
                let thisWeekRunning = 0;
                let thisWeekWalking = 0;
                let thisWeekStairs = 0;
                
                // Previous calendar week (for trending comparison)
                let prevWeekDistance = 0;
                let prevWeekSteps = 0;
                let prevWeekPushups = 0;
                let prevWeekPullups = 0;
                let prevWeekRollerAbs = 0;
                let prevWeekDips = 0;
                let prevWeekSquats = 0;
                let prevWeekSitups = 0;
                let prevWeekBiking = 0;
                let prevWeekDogWalk = 0;
                let prevWeekHiking = 0;
                let prevWeekRunning = 0;
                let prevWeekWalking = 0;
                let prevWeekStairs = 0;
                
                // Track unique strength days (Sets are better for counting unique days)
                let strengthDaysTotal = new Set();
                let strengthDaysThisWeek = new Set();
                let strengthDaysPrevWeek = new Set();

                // ============================================
                // PROCESS ALL ACTIVITIES
                // ============================================
                this.data.activities.forEach(activity => {
                    // Parse date at noon to avoid timezone issues
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    
                    // Check which periods this activity belongs to
                    const isThisWeek = activityDate >= thisWeekStart && activityDate <= now;
                    const isPrevWeek = activityDate >= prevWeekStart && activityDate <= prevWeekEnd;
                    
                    // ========== DISTANCE ACTIVITIES ==========
                    if (activity.distance) {
                        totalDistance += activity.distance;
                        if (isThisWeek) thisWeekDistance += activity.distance;
                        if (isPrevWeek) prevWeekDistance += activity.distance;
                        
                        // Track by specific distance type
                        if (activity.type === 'biking') {
                            totalBiking += activity.distance;
                            if (isThisWeek) thisWeekBiking += activity.distance;
                            if (isPrevWeek) prevWeekBiking += activity.distance;
                        } else if (activity.type === 'dog') {
                            totalDogWalk += activity.distance;
                            if (isThisWeek) thisWeekDogWalk += activity.distance;
                            if (isPrevWeek) prevWeekDogWalk += activity.distance;
                        } else if (activity.type === 'hiking') {
                            totalHiking += activity.distance;
                            if (isThisWeek) thisWeekHiking += activity.distance;
                            if (isPrevWeek) prevWeekHiking += activity.distance;
                        } else if (activity.type === 'run') {
                            totalRunning += activity.distance;
                            if (isThisWeek) thisWeekRunning += activity.distance;
                            if (isPrevWeek) prevWeekRunning += activity.distance;
                        } else if (activity.type === 'walk') {
                            totalWalking += activity.distance;
                            if (isThisWeek) thisWeekWalking += activity.distance;
                            if (isPrevWeek) prevWeekWalking += activity.distance;
                        }
                    }

                    // ========== STAIRS (FLOORS) ==========
                    if (activity.floors) {
                        totalStairs += activity.floors;
                        if (isThisWeek) thisWeekStairs += activity.floors;
                        if (isPrevWeek) prevWeekStairs += activity.floors;
                    }

                    // ========== STEPS ==========
                    if (activity.steps) {
                        totalSteps += activity.steps;
                        if (isThisWeek) thisWeekSteps += activity.steps;
                        if (isPrevWeek) prevWeekSteps += activity.steps;
                    }

                    // ========== REPS (EXERCISES) ==========
                    if (activity.reps) {
                        if (activity.type === 'pushups') {
                            totalPushups += activity.reps;
                            if (isThisWeek) thisWeekPushups += activity.reps;
                            if (isPrevWeek) prevWeekPushups += activity.reps;
                        } else if (activity.type === 'pullups') {
                            totalPullups += activity.reps;
                            if (isThisWeek) thisWeekPullups += activity.reps;
                            if (isPrevWeek) prevWeekPullups += activity.reps;
                        } else if (activity.type === 'rollerabs') {
                            totalRollerAbs += activity.reps;
                            if (isThisWeek) thisWeekRollerAbs += activity.reps;
                            if (isPrevWeek) prevWeekRollerAbs += activity.reps;
                        } else if (activity.type === 'dips') {
                            totalDips += activity.reps;
                            if (isThisWeek) thisWeekDips += activity.reps;
                            if (isPrevWeek) prevWeekDips += activity.reps;
                        } else if (activity.type === 'squats') {
                            totalSquats += activity.reps;
                            if (isThisWeek) thisWeekSquats += activity.reps;
                            if (isPrevWeek) prevWeekSquats += activity.reps;
                        } else if (activity.type === 'situps') {
                            totalSitups += activity.reps;
                            if (isThisWeek) thisWeekSitups += activity.reps;
                            if (isPrevWeek) prevWeekSitups += activity.reps;
                        }
                    }

                    // ========== STRENGTH DAYS ==========
                    if (['arm', 'back', 'chest', 'core', 'fullbody', 'leg', 'shoulder'].includes(activity.type)) {
                        strengthDaysTotal.add(activity.date);
                        if (isThisWeek) strengthDaysThisWeek.add(activity.date);
                        if (isPrevWeek) strengthDaysPrevWeek.add(activity.date);
                    }
                });

                // ============================================
                // CONVERT KM TO MILES (if needed)
                // ============================================
                if (this.data.goals.unitPreference === 'miles') {
                    const KM_TO_MILES = 1.60934;
                    
                    // Total
                    totalDistance = totalDistance / KM_TO_MILES;
                    totalBiking = totalBiking / KM_TO_MILES;
                    totalDogWalk = totalDogWalk / KM_TO_MILES;
                    totalHiking = totalHiking / KM_TO_MILES;
                    totalRunning = totalRunning / KM_TO_MILES;
                    totalWalking = totalWalking / KM_TO_MILES;
                    
                    // This Week
                    thisWeekDistance = thisWeekDistance / KM_TO_MILES;
                    thisWeekBiking = thisWeekBiking / KM_TO_MILES;
                    thisWeekDogWalk = thisWeekDogWalk / KM_TO_MILES;
                    thisWeekHiking = thisWeekHiking / KM_TO_MILES;
                    thisWeekRunning = thisWeekRunning / KM_TO_MILES;
                    thisWeekWalking = thisWeekWalking / KM_TO_MILES;
                    
                    // Previous Week
                    prevWeekDistance = prevWeekDistance / KM_TO_MILES;
                    prevWeekBiking = prevWeekBiking / KM_TO_MILES;
                    prevWeekDogWalk = prevWeekDogWalk / KM_TO_MILES;
                    prevWeekHiking = prevWeekHiking / KM_TO_MILES;
                    prevWeekRunning = prevWeekRunning / KM_TO_MILES;
                    prevWeekWalking = prevWeekWalking / KM_TO_MILES;
                }

                // ============================================
                // RETURN ALL CALCULATED STATS
                // ============================================
                return {
                    // Distance (rounded to 1 decimal)
                    totalDistance: Math.round(totalDistance * 10) / 10,
                    thisWeekDistance: Math.round(thisWeekDistance * 10) / 10,
                    prevWeekDistance: Math.round(prevWeekDistance * 10) / 10,
                    
                    // Steps (whole numbers)
                    totalSteps,
                    thisWeekSteps,
                    prevWeekSteps,
                    
                    // Exercises - Reps (whole numbers)
                    totalPushups,
                    thisWeekPushups,
                    prevWeekPushups,
                    totalPullups,
                    thisWeekPullups,
                    prevWeekPullups,
                    totalRollerAbs,
                    thisWeekRollerAbs,
                    prevWeekRollerAbs,
                    totalDips,
                    thisWeekDips,
                    prevWeekDips,
                    totalSquats,
                    thisWeekSquats,
                    prevWeekSquats,
                    totalSitups,
                    thisWeekSitups,
                    prevWeekSitups,
                    
                    // Distance by Type (rounded to 1 decimal)
                    totalBiking: Math.round(totalBiking * 10) / 10,
                    thisWeekBiking: Math.round(thisWeekBiking * 10) / 10,
                    prevWeekBiking: Math.round(prevWeekBiking * 10) / 10,
                    totalDogWalk: Math.round(totalDogWalk * 10) / 10,
                    thisWeekDogWalk: Math.round(thisWeekDogWalk * 10) / 10,
                    prevWeekDogWalk: Math.round(prevWeekDogWalk * 10) / 10,
                    totalHiking: Math.round(totalHiking * 10) / 10,
                    thisWeekHiking: Math.round(thisWeekHiking * 10) / 10,
                    prevWeekHiking: Math.round(prevWeekHiking * 10) / 10,
                    totalRunning: Math.round(totalRunning * 10) / 10,
                    thisWeekRunning: Math.round(thisWeekRunning * 10) / 10,
                    prevWeekRunning: Math.round(prevWeekRunning * 10) / 10,
                    totalWalking: Math.round(totalWalking * 10) / 10,
                    thisWeekWalking: Math.round(thisWeekWalking * 10) / 10,
                    prevWeekWalking: Math.round(prevWeekWalking * 10) / 10,
                    
                    // Stairs (whole numbers)
                    totalStairs,
                    thisWeekStairs,
                    prevWeekStairs,
                    
                    // Strength Days (count of unique days)
                    totalStrengthDays: strengthDaysTotal.size,
                    thisWeekStrengthDays: strengthDaysThisWeek.size,
                    prevWeekStrengthDays: strengthDaysPrevWeek.size,
                    
                    // Weight data
                    currentWeight: this.getWeightStats().current
                };
            },

            // Update dashboard (FIXED: toggle buttons sync with data + custom cards)
            updateDashboard() {
                const stats = this.calculateStats();
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                const isWeekView = this.data.currentView.statsView === 'week';
                
                // FIX: Update toggle buttons to match current view
                document.querySelectorAll('.stats-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (isWeekView) {
                    document.querySelector('.stats-toggle-btn:first-child').classList.add('active');
                } else {
                    document.querySelector('.stats-toggle-btn:last-child').classList.add('active');
                }

                // ========== FIXED CARDS (Miles, Strength Days, Steps) ==========
                const milesValue = isWeekView ? stats.thisWeekDistance : stats.totalDistance;
                const workoutsValue = isWeekView ? stats.thisWeekStrengthDays : stats.totalStrengthDays;
                const stepsValue = isWeekView ? stats.thisWeekSteps : stats.totalSteps;
                
                // Animate numbers
                this.animateCountUp(document.getElementById('stat-miles'), milesValue);
                this.animateCountUp(document.getElementById('stat-workouts'), workoutsValue);
                this.animateCountUp(document.getElementById('stat-steps'), stepsValue);

                // ========== TRENDING ARROWS (Week View Only) ==========
                if (isWeekView) {
                    // v1.5.2: Compare THIS WEEK vs PREVIOUS CALENDAR WEEK
                    // Only show arrow if current value > 0
                    const milesTrend = milesValue > 0 ? this.getTrendIndicator(milesValue, stats.prevWeekDistance) : '';
                    const workoutsTrend = workoutsValue > 0 ? this.getTrendIndicator(workoutsValue, stats.prevWeekStrengthDays) : '';
                    const stepsTrend = stepsValue > 0 ? this.getTrendIndicator(stepsValue, stats.prevWeekSteps) : '';
                    
                    document.getElementById('stat-miles-label').textContent = unit;
                    document.getElementById('stat-workouts-label').textContent = 'Strength Days';
                    document.getElementById('stat-steps-label').textContent = 'Steps';
                    
                    document.getElementById('stat-miles-trend').innerHTML = milesTrend;
                    document.getElementById('stat-workouts-trend').innerHTML = workoutsTrend;
                    document.getElementById('stat-steps-trend').innerHTML = stepsTrend;
                } else {
                    // All Time view: No trends
                    document.getElementById('stat-miles-label').textContent = unit;
                    document.getElementById('stat-workouts-label').textContent = 'Strength Days';
                    document.getElementById('stat-steps-label').textContent = 'Steps';
                    
                    document.getElementById('stat-miles-trend').innerHTML = '';
                    document.getElementById('stat-workouts-trend').innerHTML = '';
                    document.getElementById('stat-steps-trend').innerHTML = '';
                }

                // ROW 2: Update custom cards based on user preferences
                this.renderCustomCards(stats, isWeekView);

                // Render comparison bar graphs
                this.renderBarGraphs(stats);

                // Update weight summary
                this.updateWeightSummary();

                // Annual progress (always total)
                const annualGoal = this.data.goals.annualMiles;
                const progress = Math.min(100, Math.round((stats.totalDistance / annualGoal) * 100));
                document.getElementById('annual-progress-percent').textContent = `${progress}%`;
                document.getElementById('annual-progress-bar').style.width = `${progress}%`;
                document.getElementById('annual-progress-current').textContent = `${stats.totalDistance} ${unit}`;
                document.getElementById('annual-progress-goal').textContent = `${annualGoal} ${unit}`;

                // Recent milestones
                const milestoneList = document.getElementById('milestone-list');
                if (this.data.milestones.length === 0) {
                    milestoneList.innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 14px;">No milestones yet. Keep going!</p>';
                } else {
                    const recentMilestones = this.data.milestones.slice(-5).reverse();
                    milestoneList.innerHTML = recentMilestones.map(m => `
                        <div class="milestone-item">
                            <div class="milestone-icon">${m.icon}</div>
                            <div class="milestone-text">${m.title}</div>
                        </div>
                    `).join('');
                }
            },

            // Render custom dashboard cards (Row 2)
            renderCustomCards(stats, isWeekView) {
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                // v1.5.2: Map stat names to their values (thisWeek for display, prevWeek for trending)
                const statMap = {
                    // Rep-based exercises
                    'pushups': {
                        label: 'Push-ups',
                        thisWeekValue: stats.thisWeekPushups,
                        prevWeekValue: stats.prevWeekPushups,
                        totalValue: stats.totalPushups
                    },
                    'pullups': {
                        label: 'Pull-ups',
                        thisWeekValue: stats.thisWeekPullups,
                        prevWeekValue: stats.prevWeekPullups,
                        totalValue: stats.totalPullups
                    },
                    'rollerabs': {
                        label: 'Roller Abs',
                        thisWeekValue: stats.thisWeekRollerAbs,
                        prevWeekValue: stats.prevWeekRollerAbs,
                        totalValue: stats.totalRollerAbs
                    },
                    'dips': {
                        label: 'Dips',
                        thisWeekValue: stats.thisWeekDips,
                        prevWeekValue: stats.prevWeekDips,
                        totalValue: stats.totalDips
                    },
                    'squats': {
                        label: 'Squats',
                        thisWeekValue: stats.thisWeekSquats,
                        prevWeekValue: stats.prevWeekSquats,
                        totalValue: stats.totalSquats
                    },
                    'situps': {
                        label: 'Sit-ups',
                        thisWeekValue: stats.thisWeekSitups,
                        prevWeekValue: stats.prevWeekSitups,
                        totalValue: stats.totalSitups
                    },
                    // Distance-based activities
                    'biking': {
                        label: `Biking (${unit})`,
                        thisWeekValue: stats.thisWeekBiking,
                        prevWeekValue: stats.prevWeekBiking,
                        totalValue: stats.totalBiking
                    },
                    'dog': {
                        label: `Dog Walking (${unit})`,
                        thisWeekValue: stats.thisWeekDogWalk,
                        prevWeekValue: stats.prevWeekDogWalk,
                        totalValue: stats.totalDogWalk
                    },
                    'hiking': {
                        label: `Hiking (${unit})`,
                        thisWeekValue: stats.thisWeekHiking,
                        prevWeekValue: stats.prevWeekHiking,
                        totalValue: stats.totalHiking
                    },
                    'run': {
                        label: `Running (${unit})`,
                        thisWeekValue: stats.thisWeekRunning,
                        prevWeekValue: stats.prevWeekRunning,
                        totalValue: stats.totalRunning
                    },
                    'walk': {
                        label: `Walking (${unit})`,
                        thisWeekValue: stats.thisWeekWalking,
                        prevWeekValue: stats.prevWeekWalking,
                        totalValue: stats.totalWalking
                    },
                    'stairs': {
                        label: 'Stairs (floors)',
                        thisWeekValue: stats.thisWeekStairs,
                        prevWeekValue: stats.prevWeekStairs,
                        totalValue: stats.totalStairs
                    },
                    // Weight tracking (special case)
                    'weight': {
                        label: `Weight (${this.data.goals.weightUnit})`,
                        thisWeekValue: stats.currentWeight || 0,
                        prevWeekValue: 0, // Weight uses its own trend logic
                        totalValue: stats.currentWeight || 0
                    }
                };

                // ========== RENDER EACH CUSTOM CARD ==========
                for (let i = 0; i < 3; i++) {
                    const cardType = this.data.customDashboardCards[i];
                    const cardData = statMap[cardType];
                    
                    if (cardData) {
                        // Display value: this week or all time
                        const value = isWeekView ? cardData.thisWeekValue : cardData.totalValue;
                        const element = document.getElementById(`custom-stat-${i + 1}`);
                        const labelElement = document.getElementById(`custom-label-${i + 1}`);
                        const trendElement = document.getElementById(`custom-trend-${i + 1}`);
                        
                        // Animate the display value
                        this.animateCountUp(element, value);
                        
                        // Set label
                        labelElement.textContent = cardData.label;
                        
                        // ========== TRENDING (Week View Only) ==========
                        if (isWeekView) {
                            // Special handling for weight card
                            if (cardType === 'weight' && value > 0) {
                                const weightStats = this.getWeightStats();
                                let trendHTML = '';
                                if (weightStats.trend === 'up') {
                                    trendHTML = '<span class="trend-indicator up" style="font-size: 10px;">â†—</span>';
                                } else if (weightStats.trend === 'down') {
                                    trendHTML = '<span class="trend-indicator down" style="font-size: 10px;">â†˜</span>';
                                } else if (weightStats.trend === 'stable') {
                                    trendHTML = '<span class="trend-indicator stable" style="font-size: 10px;">â†’</span>';
                                }
                                trendElement.innerHTML = trendHTML;
                            } else {
                                // v1.5.2: Compare THIS WEEK vs PREVIOUS WEEK
                                const trendHTML = value > 0 ? this.getTrendIndicator(value, cardData.prevWeekValue) : '';
                                trendElement.innerHTML = trendHTML;
                            }
                        } else {
                            // All Time view: No trends
                            trendElement.innerHTML = '';
                        }
                    }
                }
            },

            // Open customize modal
            openCustomizeModal() {
                // Set current selections in dropdowns
                for (let i = 0; i < 3; i++) {
                    const select = document.getElementById(`custom-slot-${i + 1}`);
                    select.value = this.data.customDashboardCards[i];
                }
                
                document.getElementById('customize-overlay').classList.add('show');
                document.getElementById('customize-modal').classList.add('show');
            },

            // Close customize modal
            closeCustomizeModal() {
                document.getElementById('customize-overlay').classList.remove('show');
                document.getElementById('customize-modal').classList.remove('show');
            },

            // Save custom cards preferences
            saveCustomCards() {
                const slot1 = document.getElementById('custom-slot-1').value;
                const slot2 = document.getElementById('custom-slot-2').value;
                const slot3 = document.getElementById('custom-slot-3').value;

                // Validation: Check for duplicates
                const selections = [slot1, slot2, slot3];
                const uniqueSelections = new Set(selections);
                
                if (uniqueSelections.size !== 3) {
                    alert('Please select 3 different stats for your dashboard cards.');
                    return;
                }

                // Save preferences
                this.data.customDashboardCards = selections;
                this.saveData();

                // Update dashboard
                this.updateDashboard();

                // Close modal
                this.closeCustomizeModal();
            },

            // Set stats view (week or total)
            setStatsView(view) {
                this.data.currentView.statsView = view;
                
                // Update toggle buttons
                document.querySelectorAll('.stats-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Refresh dashboard
                this.updateDashboard();
            },

            // Render calendar
            renderCalendar() {
                const year = this.data.currentView.calendarYear;
                const month = this.data.currentView.calendarMonth;
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                
                document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const prevLastDay = new Date(year, month, 0);
                
                const firstDayOfWeek = firstDay.getDay();
                const daysInMonth = lastDay.getDate();
                const daysInPrevMonth = prevLastDay.getDate();

                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = `
                    <div class="calendar-day-label">Sun</div>
                    <div class="calendar-day-label">Mon</div>
                    <div class="calendar-day-label">Tue</div>
                    <div class="calendar-day-label">Wed</div>
                    <div class="calendar-day-label">Thu</div>
                    <div class="calendar-day-label">Fri</div>
                    <div class="calendar-day-label">Sat</div>
                `;

                // Previous month days
                for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                    const day = daysInPrevMonth - i;
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.textContent = day;
                    grid.appendChild(dayDiv);
                }

                // Current month days
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const activities = this.data.activities.filter(a => a.date === date);
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.style.cursor = 'pointer';
                    dayDiv.onclick = () => this.showDayDetail(date);
                    
                    if (activities.length > 0) {
                        dayDiv.classList.add('has-activity');
                    }
                    
                    if (today.getDate() === day && today.getMonth() === month && today.getFullYear() === year) {
                        dayDiv.classList.add('today');
                    }
                    
                    dayDiv.innerHTML = `
                        ${day}
                        ${activities.length > 0 ? `
                            <div class="activity-dots">
                                ${activities.slice(0, 4).map(() => '<div class="activity-dot"></div>').join('')}
                            </div>
                        ` : ''}
                    `;
                    
                    grid.appendChild(dayDiv);
                }

                // Next month days
                const remainingDays = 42 - (firstDayOfWeek + daysInMonth);
                for (let day = 1; day <= remainingDays; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.textContent = day;
                    grid.appendChild(dayDiv);
                }

                // Render activity summary
                this.renderActivitySummary();
            },

            // Toggle activity report expand/collapse
            toggleActivityReport() {
                const content = document.getElementById('activity-report-content');
                const toggle = document.getElementById('activity-report-toggle');
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggle.querySelector('span:last-child').textContent = 'â–¼';
                } else {
                    content.classList.add('expanded');
                    toggle.querySelector('span:last-child').textContent = 'â–²';
                }
            },

            // Render activity summary for calendar screen (month + all-time)
            renderActivitySummary() {
                const summaryList = document.getElementById('activity-summary-list');
                const stats = this.calculateStats();
                const monthStats = this.calculateMonthStats();
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                const summaryItems = [];
                
                // Helper to add item with week, month and total
                const addItem = (name, weekValue, monthValue, totalValue, suffix) => {
                    if (totalValue > 0) {
                        summaryItems.push({
                            name,
                            week: weekValue > 0 ? `${weekValue.toLocaleString()}${suffix}` : '-',
                            month: monthValue > 0 ? `${monthValue.toLocaleString()}${suffix}` : '-',
                            total: `${totalValue.toLocaleString()}${suffix}`
                        });
                    }
                };
                
                // Strength exercises
                addItem('Push-ups', stats.thisWeekPushups, monthStats.monthPushups, stats.totalPushups, ' reps');
                addItem('Pull-ups', stats.thisWeekPullups, monthStats.monthPullups, stats.totalPullups, ' reps');
                addItem('Roller Abs', stats.thisWeekRollerAbs, monthStats.monthRollerAbs, stats.totalRollerAbs, ' reps');
                addItem('Dips', stats.thisWeekDips, monthStats.monthDips, stats.totalDips, ' reps');
                addItem('Squats', stats.thisWeekSquats, monthStats.monthSquats, stats.totalSquats, ' reps');
                addItem('Sit-ups', stats.thisWeekSitups, monthStats.monthSitups, stats.totalSitups, ' reps');
                
                // Cardio activities
                if (stats.totalRunning > 0) {
                    summaryItems.push({
                        name: 'Running',
                        week: stats.thisWeekRunning > 0 ? `${stats.thisWeekRunning} ${unit}` : '-',
                        month: monthStats.monthRunning > 0 ? `${monthStats.monthRunning} ${unit}` : '-',
                        total: `${stats.totalRunning} ${unit}`
                    });
                }
                if (stats.totalWalking > 0) {
                    summaryItems.push({
                        name: 'Walking',
                        week: stats.thisWeekWalking > 0 ? `${stats.thisWeekWalking} ${unit}` : '-',
                        month: monthStats.monthWalking > 0 ? `${monthStats.monthWalking} ${unit}` : '-',
                        total: `${stats.totalWalking} ${unit}`
                    });
                }
                if (stats.totalBiking > 0) {
                    summaryItems.push({
                        name: 'Biking',
                        week: stats.thisWeekBiking > 0 ? `${stats.thisWeekBiking} ${unit}` : '-',
                        month: monthStats.monthBiking > 0 ? `${monthStats.monthBiking} ${unit}` : '-',
                        total: `${stats.totalBiking} ${unit}`
                    });
                }
                if (stats.totalDogWalk > 0) {
                    summaryItems.push({
                        name: 'Dog Walking',
                        week: stats.thisWeekDogWalk > 0 ? `${stats.thisWeekDogWalk} ${unit}` : '-',
                        month: monthStats.monthDogWalk > 0 ? `${monthStats.monthDogWalk} ${unit}` : '-',
                        total: `${stats.totalDogWalk} ${unit}`
                    });
                }
                if (stats.totalHiking > 0) {
                    summaryItems.push({
                        name: 'Hiking',
                        week: stats.thisWeekHiking > 0 ? `${stats.thisWeekHiking} ${unit}` : '-',
                        month: monthStats.monthHiking > 0 ? `${monthStats.monthHiking} ${unit}` : '-',
                        total: `${stats.totalHiking} ${unit}`
                    });
                }
                
                // Other
                addItem('Stairs', stats.thisWeekStairs, monthStats.monthStairs, stats.totalStairs, ' floors');
                addItem('Steps', stats.thisWeekSteps, monthStats.monthSteps, stats.totalSteps, '');
                
                // Totals
                addItem('Strength Days', stats.thisWeekStrengthDays, monthStats.monthStrengthDays, stats.totalStrengthDays, ' days');
                if (stats.totalDistance > 0) {
                    summaryItems.push({
                        name: 'Total Distance',
                        week: stats.thisWeekDistance > 0 ? `${stats.thisWeekDistance} ${unit}` : '-',
                        month: monthStats.monthDistance > 0 ? `${monthStats.monthDistance} ${unit}` : '-',
                        total: `${stats.totalDistance} ${unit}`
                    });
                }
                
                if (summaryItems.length === 0) {
                    summaryList.innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 14px; padding: 20px 0;">No activities logged yet.</p>';
                } else {
                    // Header row
                    let html = `
                        <div class="activity-summary-item" style="font-weight: 700; color: #9ca3af; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #3d3d3d;">
                            <div>Activity</div>
                            <div class="activity-summary-value week">Week</div>
                            <div class="activity-summary-value month">Month</div>
                            <div class="activity-summary-value total">All-Time</div>
                        </div>
                    `;
                    
                    // Data rows
                    html += summaryItems.map(item => `
                        <div class="activity-summary-item">
                            <div class="activity-summary-name">${item.name}</div>
                            <div class="activity-summary-value week">${item.week}</div>
                            <div class="activity-summary-value month">${item.month}</div>
                            <div class="activity-summary-value total">${item.total}</div>
                        </div>
                    `).join('');
                    
                    summaryList.innerHTML = html;
                }
            },

            // Calculate month-to-date stats
            calculateMonthStats() {
                const now = new Date();
                now.setHours(23, 59, 59, 999); // Set to end of today for comparisons
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                startOfMonth.setHours(0, 0, 0, 0);
                
                let monthDistance = 0;
                let monthPushups = 0;
                let monthPullups = 0;
                let monthRollerAbs = 0;
                let monthDips = 0;
                let monthSquats = 0;
                let monthSitups = 0;
                let monthBiking = 0;
                let monthDogWalk = 0;
                let monthHiking = 0;
                let monthRunning = 0;
                let monthWalking = 0;
                let monthStairs = 0;
                let monthSteps = 0;
                let monthStrengthDays = new Set();
                
                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    const isThisMonth = activityDate >= startOfMonth && activityDate <= now;
                    
                    if (isThisMonth) {
                        // Distance
                        if (activity.distance) {
                            monthDistance += activity.distance;
                            if (activity.type === 'biking') monthBiking += activity.distance;
                            else if (activity.type === 'dog') monthDogWalk += activity.distance;
                            else if (activity.type === 'hiking') monthHiking += activity.distance;
                            else if (activity.type === 'run') monthRunning += activity.distance;
                            else if (activity.type === 'walk') monthWalking += activity.distance;
                        }
                        
                        // Stairs and Steps
                        if (activity.floors) monthStairs += activity.floors;
                        if (activity.steps) monthSteps += activity.steps;
                        
                        // Reps
                        if (activity.reps) {
                            if (activity.type === 'pushups') monthPushups += activity.reps;
                            else if (activity.type === 'pullups') monthPullups += activity.reps;
                            else if (activity.type === 'rollerabs') monthRollerAbs += activity.reps;
                            else if (activity.type === 'dips') monthDips += activity.reps;
                            else if (activity.type === 'squats') monthSquats += activity.reps;
                            else if (activity.type === 'situps') monthSitups += activity.reps;
                        }
                        
                        // Strength days
                        if (['arm', 'back', 'chest', 'core', 'fullbody', 'leg', 'shoulder'].includes(activity.type)) {
                            monthStrengthDays.add(activity.date);
                        }
                    }
                });
                
                // Convert distances to preferred unit
                if (this.data.goals.unitPreference === 'miles') {
                    monthDistance = monthDistance / 1.60934;
                    monthBiking = monthBiking / 1.60934;
                    monthDogWalk = monthDogWalk / 1.60934;
                    monthHiking = monthHiking / 1.60934;
                    monthRunning = monthRunning / 1.60934;
                    monthWalking = monthWalking / 1.60934;
                }
                
                return {
                    monthDistance: Math.round(monthDistance * 10) / 10,
                    monthPushups,
                    monthPullups,
                    monthRollerAbs,
                    monthDips,
                    monthSquats,
                    monthSitups,
                    monthBiking: Math.round(monthBiking * 10) / 10,
                    monthDogWalk: Math.round(monthDogWalk * 10) / 10,
                    monthHiking: Math.round(monthHiking * 10) / 10,
                    monthRunning: Math.round(monthRunning * 10) / 10,
                    monthWalking: Math.round(monthWalking * 10) / 10,
                    monthStairs,
                    monthSteps,
                    monthStrengthDays: monthStrengthDays.size
                };
            },

            // Change calendar month
            changeMonth(delta) {
                this.data.currentView.calendarMonth += delta;
                if (this.data.currentView.calendarMonth > 11) {
                    this.data.currentView.calendarMonth = 0;
                    this.data.currentView.calendarYear++;
                } else if (this.data.currentView.calendarMonth < 0) {
                    this.data.currentView.calendarMonth = 11;
                    this.data.currentView.calendarYear--;
                }
                this.renderCalendar();
            },

            // Update goals UI
            updateGoalsUI() {
                document.getElementById('unit-preference').value = this.data.goals.unitPreference;
                document.getElementById('weight-unit-preference').value = this.data.goals.weightUnit;
                document.getElementById('annual-goal').value = this.data.goals.annualMiles;
                document.getElementById('workout-frequency').value = this.data.goals.workoutFrequency;
                document.getElementById('monthly-goal').value = this.data.goals.monthlyMiles;
                
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                document.getElementById('milestone-unit').textContent = unit;
            },

            // Save goals
            saveGoals() {
                const oldUnit = this.data.goals.unitPreference;
                const newUnit = document.getElementById('unit-preference').value;
                
                this.data.goals.unitPreference = newUnit;
                this.data.goals.weightUnit = document.getElementById('weight-unit-preference').value;
                this.data.goals.annualMiles = parseInt(document.getElementById('annual-goal').value);
                this.data.goals.workoutFrequency = parseInt(document.getElementById('workout-frequency').value);
                this.data.goals.monthlyMiles = parseInt(document.getElementById('monthly-goal').value);
                
                this.saveData();
                this.updateGoalsUI();
                this.updateWeightInputDisplay();
                this.updateDashboard();
                
                const successMsg = document.getElementById('settings-success');
                successMsg.classList.add('show');
                setTimeout(() => {
                    successMsg.classList.remove('show');
                }, 3000);
            },

            // Export data
            exportData() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `juststep-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            },

            // Handle import file selection
            handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        this.importData(importedData);
                    } catch (error) {
                        alert('Error reading file. Please make sure it\'s a valid JustStep export file.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
                
                // Reset file input so same file can be imported again
                event.target.value = '';
            },

            // Import and merge data
            importData(importedData) {
                // Validate data structure
                if (!importedData || !importedData.activities || !Array.isArray(importedData.activities)) {
                    alert('Invalid data file. Please export from JustStep and try again.');
                    return;
                }

                let newActivities = 0;
                let duplicates = 0;

                // Merge activities (skip duplicates based on date + type + timestamp)
                importedData.activities.forEach(importActivity => {
                    const isDuplicate = this.data.activities.some(existing => 
                        existing.date === importActivity.date && 
                        existing.type === importActivity.type &&
                        existing.timestamp === importActivity.timestamp
                    );
                    
                    if (!isDuplicate) {
                        this.data.activities.push(importActivity);
                        newActivities++;
                    } else {
                        duplicates++;
                    }
                });

                // Replace goals completely
                if (importedData.goals) {
                    this.data.goals = { ...importedData.goals };
                }

                // Merge milestones (skip duplicates by type + value)
                if (importedData.milestones && Array.isArray(importedData.milestones)) {
                    importedData.milestones.forEach(importMilestone => {
                        const isDuplicate = this.data.milestones.some(existing =>
                            existing.type === importMilestone.type &&
                            existing.value === importMilestone.value
                        );
                        
                        if (!isDuplicate) {
                            this.data.milestones.push(importMilestone);
                        }
                    });
                }

                // Import custom dashboard cards if present, otherwise use defaults
                if (importedData.customDashboardCards && Array.isArray(importedData.customDashboardCards)) {
                    this.data.customDashboardCards = importedData.customDashboardCards;
                } else {
                    // Set default if not in imported data (backward compatibility)
                    this.data.customDashboardCards = ['pushups', 'pullups', 'rollerabs'];
                }

                // Merge weights (skip duplicates by date)
                if (importedData.weights && Array.isArray(importedData.weights)) {
                    importedData.weights.forEach(importWeight => {
                        const isDuplicate = this.data.weights.some(existing =>
                            existing.date === importWeight.date
                        );
                        
                        if (!isDuplicate) {
                            this.data.weights.push(importWeight);
                        }
                    });
                    // Sort weights by date
                    this.data.weights.sort((a, b) => new Date(a.date) - new Date(b.date));
                }

                // Preserve current view settings
                // (don't import currentView to avoid unexpected screen changes)

                // Save merged data
                this.saveData();

                // Update all views
                this.updateGoalsUI();
                this.updateDashboard();
                this.renderCalendar();

                // Show success message
                const successMsg = document.getElementById('import-success');
                successMsg.textContent = `Imported ${newActivities} activities${duplicates > 0 ? `, skipped ${duplicates} duplicates` : ''}`;
                successMsg.classList.add('show');
                setTimeout(() => {
                    successMsg.classList.remove('show');
                }, 4000);
            },

            // Show screen
            showScreen(screenName) {
                // Update screens
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(`${screenName}-screen`).classList.add('active');
                
                // Update tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
                
                this.data.currentView.screen = screenName;

                // Refresh data for specific screens
                if (screenName === 'dashboard') {
                    this.updateDashboard();
                } else if (screenName === 'calendar') {
                    this.renderCalendar();
                }
            },

            // Show day detail modal
            showDayDetail(date) {
                const activities = this.data.activities.filter(a => a.date === date);
                const dateObj = new Date(date + 'T12:00:00');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const formattedDate = `${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateObj.getFullYear()}`;
                
                document.getElementById('day-detail-date').textContent = formattedDate;
                
                const content = document.getElementById('day-detail-content');
                
                if (activities.length === 0) {
                    content.innerHTML = `
                        <div class="empty-day">
                            <div class="empty-day-icon">ðŸ“­</div>
                            <div class="empty-day-text">No activities logged for this day</div>
                        </div>
                    `;
                } else {
                    const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                    
                    // Group and calculate totals
                    let totalDistance = 0;
                    let totalSteps = 0;
                    let totalPushups = 0;
                    let totalPullups = 0;
                    let totalRollerAbs = 0;
                    let totalDips = 0;
                    let totalSquats = 0;
                    let totalSitups = 0;
                    let totalStairs = 0;
                    let workoutCount = 0;
                    
                    const activityHTML = activities.map((activity, index) => {
                        const activityNames = {
                            'walk': 'Walking',
                            'run': 'Running',
                            'dog': 'Dog Walking',
                            'hiking': 'Hiking',
                            'biking': 'Biking',
                            'stairs': 'Master Stairs',
                            'steps': 'Steps',
                            'pushups': 'Push-ups',
                            'pullups': 'Pull-ups',
                            'rollerabs': 'Roller Abs',
                            'dips': 'Dips',
                            'squats': 'Squats',
                            'situps': 'Sit-ups',
                            'leg': 'Leg Day',
                            'chest': 'Chest Day',
                            'shoulder': 'Shoulder Day',
                            'core': 'Core Day',
                            'arm': 'Arm Day',
                            'back': 'Back Day',
                            'fullbody': 'Full Body Day'
                        };
                        
                        let valueText = '';
                        if (activity.distance) {
                            const displayDistance = this.data.goals.unitPreference === 'miles' 
                                ? (activity.distance / 1.60934).toFixed(1)
                                : activity.distance.toFixed(1);
                            valueText = `${displayDistance} ${unit}`;
                            totalDistance += activity.distance;
                        } else if (activity.floors) {
                            valueText = `${activity.floors} floors`;
                            totalStairs += activity.floors;
                        } else if (activity.steps) {
                            valueText = `${activity.steps.toLocaleString()} steps`;
                            totalSteps += activity.steps;
                        } else if (activity.reps) {
                            valueText = `${activity.reps} reps`;
                            // Track by type
                            if (activity.type === 'pushups') totalPushups += activity.reps;
                            else if (activity.type === 'pullups') totalPullups += activity.reps;
                            else if (activity.type === 'rollerabs') totalRollerAbs += activity.reps;
                            else if (activity.type === 'dips') totalDips += activity.reps;
                            else if (activity.type === 'squats') totalSquats += activity.reps;
                            else if (activity.type === 'situps') totalSitups += activity.reps;
                        } else {
                            valueText = 'Completed';
                            workoutCount++;
                        }
                        
                        return `
                            <div class="day-activity-item" data-activity-index="${this.data.activities.indexOf(activity)}">
                                <div class="day-activity-info">
                                    <div class="day-activity-type">${activityNames[activity.type] || activity.type}</div>
                                    <div class="day-activity-value">${valueText}</div>
                                </div>
                                <button class="day-activity-delete" onclick="app.deleteActivity(${this.data.activities.indexOf(activity)})">Delete</button>
                            </div>
                        `;
                    }).join('');
                    
                    // Build totals section (FIXED: "exercises" instead of "workouts")
                    const totals = [];
                    if (totalDistance > 0) {
                        const displayDistance = this.data.goals.unitPreference === 'miles' 
                            ? (totalDistance / 1.60934).toFixed(1)
                            : totalDistance.toFixed(1);
                        totals.push(`${displayDistance} ${unit} total`);
                    }
                    if (totalSteps > 0) {
                        totals.push(`${totalSteps.toLocaleString()} steps`);
                    }
                    if (totalPushups > 0) {
                        totals.push(`${totalPushups} push-ups`);
                    }
                    if (totalPullups > 0) {
                        totals.push(`${totalPullups} pull-ups`);
                    }
                    if (totalRollerAbs > 0) {
                        totals.push(`${totalRollerAbs} roller abs`);
                    }
                    if (totalDips > 0) {
                        totals.push(`${totalDips} dips`);
                    }
                    if (totalSquats > 0) {
                        totals.push(`${totalSquats} squats`);
                    }
                    if (totalSitups > 0) {
                        totals.push(`${totalSitups} sit-ups`);
                    }
                    if (totalStairs > 0) {
                        totals.push(`${totalStairs} floors`);
                    }
                    if (workoutCount > 0) {
                        totals.push(`${workoutCount} exercise${workoutCount > 1 ? 's' : ''}`);
                    }
                    
                    content.innerHTML = `
                        <div class="day-activity-list">
                            ${activityHTML}
                        </div>
                        ${totals.length > 0 ? `
                            <div class="day-totals">
                                <div class="day-totals-title">Day Summary</div>
                                <div class="day-totals-content">
                                    ${totals.join(' â€¢ ')}
                                </div>
                            </div>
                        ` : ''}
                    `;
                }
                
                document.getElementById('day-overlay').classList.add('show');
                document.getElementById('day-detail-modal').classList.add('show');
            },

            // Close day detail modal
            closeDayDetail() {
                document.getElementById('day-overlay').classList.remove('show');
                document.getElementById('day-detail-modal').classList.remove('show');
            },

            // Delete activity
            deleteActivity(activityIndex) {
                if (!confirm('Are you sure you want to delete this activity?')) {
                    return;
                }
                
                this.data.activities.splice(activityIndex, 1);
                this.saveData();
                
                // Refresh all views
                this.updateDashboard();
                this.renderCalendar();
                
                // Reopen the day detail with updated data
                const dateInput = document.getElementById('day-detail-date').textContent;
                const activities = this.data.activities.filter(a => {
                    const activityDate = new Date(a.date + 'T12:00:00');
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                       'July', 'August', 'September', 'October', 'November', 'December'];
                    const formattedDate = `${monthNames[activityDate.getMonth()]} ${activityDate.getDate()}, ${activityDate.getFullYear()}`;
                    return formattedDate === dateInput;
                });
                
                if (activities.length > 0) {
                    this.showDayDetail(activities[0].date);
                } else {
                    this.closeDayDetail();
                }
            },

            // Update weight input display based on unit preference
            updateWeightInputDisplay() {
                const weightUnitDisplay = document.getElementById('weight-unit-display');
                if (weightUnitDisplay) {
                    weightUnitDisplay.textContent = this.data.goals.weightUnit;
                }
            },

            // Log weight entry
            logWeight() {
                const dateInput = document.getElementById('log-date').value;
                const weightInput = document.getElementById('weight-input');
                const weight = parseFloat(weightInput.value);

                if (!weight || weight <= 0) {
                    alert('Please enter a valid weight');
                    return;
                }

                // Check if weight entry already exists for this date
                const existingIndex = this.data.weights.findIndex(w => w.date === dateInput);
                
                const weightEntry = {
                    date: dateInput,
                    weight: weight,
                    unit: this.data.goals.weightUnit
                };

                if (existingIndex >= 0) {
                    // Replace existing entry
                    this.data.weights[existingIndex] = weightEntry;
                } else {
                    // Add new entry
                    this.data.weights.push(weightEntry);
                }

                // Sort weights by date
                this.data.weights.sort((a, b) => new Date(a.date) - new Date(b.date));

                this.saveData();
                this.updateDashboard();

                // Clear input and show success
                weightInput.value = '';
                alert(`Weight logged: ${weight} ${this.data.goals.weightUnit}`);
            },

            // Get weight statistics and trends
            getWeightStats() {
                if (!this.data.weights || this.data.weights.length === 0) {
                    return {
                        current: null,
                        trend: null,
                        trendValue: 0,
                        unit: this.data.goals.weightUnit
                    };
                }

                // Get most recent weight
                const sortedWeights = [...this.data.weights].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                const current = sortedWeights[0];

                // Get weight from 7 days ago for trend
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

                const pastWeight = this.data.weights.find(w => w.date <= sevenDaysAgoStr);

                let trend = 'stable';
                let trendValue = 0;

                if (pastWeight) {
                    trendValue = current.weight - pastWeight.weight;
                    if (Math.abs(trendValue) < 0.5) {
                        trend = 'stable';
                    } else if (trendValue > 0) {
                        trend = 'up';
                    } else {
                        trend = 'down';
                    }
                }

                return {
                    current: current.weight,
                    trend: trend,
                    trendValue: trendValue,
                    unit: current.unit
                };
            },

            // Animate count-up for numbers
            animateCountUp(element, target, duration = 800) {
                const start = 0;
                const startTime = performance.now();
                const isDecimal = !Number.isInteger(target);

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const current = start + (target - start) * easeOut;
                    
                    if (isDecimal) {
                        element.textContent = current.toFixed(1);
                    } else {
                        element.textContent = Math.floor(current).toLocaleString();
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        if (isDecimal) {
                            element.textContent = target.toFixed(1);
                        } else {
                            element.textContent = target.toLocaleString();
                        }
                    }
                };

                requestAnimationFrame(animate);
            },

            // Render bar graphs for week/month comparisons
            renderBarGraphs(stats) {
                const unit = this.data.goals.unitPreference === 'km' ? 'km' : 'miles';
                
                // Calculate this week vs last week
                const today = new Date();
                const lastWeekStart = new Date(today);
                lastWeekStart.setDate(today.getDate() - 14);
                const lastWeekEnd = new Date(today);
                lastWeekEnd.setDate(today.getDate() - 7);

                let lastWeekDistance = 0;
                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    if (activityDate >= lastWeekStart && activityDate < lastWeekEnd && activity.distance) {
                        lastWeekDistance += activity.distance;
                    }
                });

                if (this.data.goals.unitPreference === 'miles') {
                    lastWeekDistance = lastWeekDistance / 1.60934;
                }
                lastWeekDistance = Math.round(lastWeekDistance * 10) / 10;

                // Calculate this month vs last month
                const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);

                let thisMonthDistance = 0;
                let lastMonthDistance = 0;

                this.data.activities.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T12:00:00');
                    if (activityDate >= thisMonthStart && activity.distance) {
                        thisMonthDistance += activity.distance;
                    }
                    if (activityDate >= lastMonthStart && activityDate <= lastMonthEnd && activity.distance) {
                        lastMonthDistance += activity.distance;
                    }
                });

                if (this.data.goals.unitPreference === 'miles') {
                    thisMonthDistance = thisMonthDistance / 1.60934;
                    lastMonthDistance = lastMonthDistance / 1.60934;
                }
                thisMonthDistance = Math.round(thisMonthDistance * 10) / 10;
                lastMonthDistance = Math.round(lastMonthDistance * 10) / 10;

                // Render week comparison
                const maxWeek = Math.max(stats.thisWeekDistance, lastWeekDistance, 1);
                const weekCurrentPercent = (stats.thisWeekDistance / maxWeek) * 100;
                const weekPreviousPercent = (lastWeekDistance / maxWeek) * 100;

                document.getElementById('week-current-bar').style.width = `${weekCurrentPercent}%`;
                document.getElementById('week-previous-bar').style.width = `${weekPreviousPercent}%`;
                document.getElementById('week-current-value').textContent = `${stats.thisWeekDistance} ${unit}`;
                document.getElementById('week-previous-value').textContent = `${lastWeekDistance} ${unit}`;

                // Render month comparison
                const maxMonth = Math.max(thisMonthDistance, lastMonthDistance, 1);
                const monthCurrentPercent = (thisMonthDistance / maxMonth) * 100;
                const monthPreviousPercent = (lastMonthDistance / maxMonth) * 100;

                document.getElementById('month-current-bar').style.width = `${monthCurrentPercent}%`;
                document.getElementById('month-previous-bar').style.width = `${monthPreviousPercent}%`;
                document.getElementById('month-current-value').textContent = `${thisMonthDistance} ${unit}`;
                document.getElementById('month-previous-value').textContent = `${lastMonthDistance} ${unit}`;
            },

            // Get trend indicator for comparing current vs previous values
            getTrendIndicator(current, previous) {
                // Don't show trend if current value is 0 (nothing to trend from)
                if (!current || current === 0) {
                    return '';
                }
                
                // Don't show trend if no previous data to compare against
                if (!previous || previous === 0) {
                    return ''; // No trend if no previous data
                }
                
                const diff = current - previous;
                const percentChange = Math.abs((diff / previous) * 100);
                
                // Only show trend if change is significant (>5%)
                if (percentChange < 5) {
                    return '';
                }
                
                if (diff > 0) {
                    return '<span class="trend-indicator up" style="font-size: 11px; margin-left: 4px;">â†—</span>';
                } else if (diff < 0) {
                    return '<span class="trend-indicator down" style="font-size: 11px; margin-left: 4px;\">â†˜</span>';
                } else {
                    return '';
                }
            },

            // Update weight summary card on dashboard
            updateWeightSummary() {
                const weightStats = this.getWeightStats();
                const weightCard = document.getElementById('weight-summary-card');
                
                if (weightStats.current) {
                    // Show weight card
                    weightCard.style.display = 'block';
                    
                    // Update weight value
                    document.getElementById('weight-display-value').textContent = weightStats.current.toFixed(1);
                    document.getElementById('weight-display-unit').textContent = weightStats.unit;
                    
                    // Update trend indicator
                    const trendElement = document.getElementById('weight-trend-indicator');
                    if (weightStats.trend === 'up') {
                        trendElement.innerHTML = '<span class="trend-indicator up">â†— +' + Math.abs(weightStats.trendValue).toFixed(1) + ' ' + weightStats.unit + '</span>';
                    } else if (weightStats.trend === 'down') {
                        trendElement.innerHTML = '<span class="trend-indicator down">â†˜ ' + weightStats.trendValue.toFixed(1) + ' ' + weightStats.unit + '</span>';
                    } else {
                        trendElement.innerHTML = '<span class="trend-indicator stable">â†’ No change</span>';
                    }
                    
                    // Render weight history
                    this.renderWeightHistory();
                } else {
                    // Hide weight card if no data
                    weightCard.style.display = 'none';
                }
            },

            // Toggle weight history expand/collapse
            toggleWeightHistory() {
                const historyList = document.getElementById('weight-history-list');
                const toggleBtn = document.getElementById('weight-history-toggle');
                
                if (historyList.classList.contains('expanded')) {
                    historyList.classList.remove('expanded');
                    toggleBtn.textContent = 'View History â–¼';
                } else {
                    historyList.classList.add('expanded');
                    toggleBtn.textContent = 'Hide History â–²';
                }
            },

            // Render weight history list
            renderWeightHistory() {
                const historyList = document.getElementById('weight-history-list');
                
                if (!this.data.weights || this.data.weights.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 8px; font-size: 12px;">No weight entries yet</div>';
                    return;
                }

                // Sort by date descending (newest first)
                const sortedWeights = [...this.data.weights].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );

                historyList.innerHTML = sortedWeights.map((entry, index) => {
                    const date = new Date(entry.date + 'T12:00:00');
                    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    return `
                        <div class="weight-entry">
                            <div class="weight-entry-date">${formattedDate}</div>
                            <div class="weight-entry-value">${entry.weight.toFixed(1)} ${entry.unit}</div>
                            <div class="weight-entry-actions">
                                <button class="weight-entry-btn weight-entry-edit" onclick="app.editWeight('${entry.date}')">Edit</button>
                                <button class="weight-entry-btn weight-entry-delete" onclick="app.deleteWeight('${entry.date}')">Ã—</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // Edit weight entry
            editWeight(date) {
                const entry = this.data.weights.find(w => w.date === date);
                if (!entry) return;

                const newWeight = prompt(`Edit weight for ${date}:`, entry.weight);
                if (newWeight === null) return; // Cancelled

                const parsedWeight = parseFloat(newWeight);
                if (isNaN(parsedWeight) || parsedWeight <= 0) {
                    alert('Please enter a valid weight');
                    return;
                }

                // Update the entry
                entry.weight = parsedWeight;
                
                this.saveData();
                this.updateWeightSummary();
                this.updateDashboard();
            },

            // Delete weight entry
            deleteWeight(date) {
                if (!confirm(`Delete weight entry for ${date}?`)) return;

                // Remove the entry
                this.data.weights = this.data.weights.filter(w => w.date !== date);
                
                this.saveData();
                this.updateWeightSummary();
                this.updateDashboard();
            }
        };

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
